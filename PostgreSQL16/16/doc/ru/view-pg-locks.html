<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>54.12. pg_locks</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@lists.postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets Vsnapshot" /><link rel="prev" href="view-pg-indexes.html" title="54.11. pg_indexes" /><link rel="next" href="view-pg-matviews.html" title="54.13. pg_matviews" /></head><body id="docContent" class="container-fluid col-10"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="5" align="center">54.12. <code class="structname">pg_locks</code></th></tr><tr><td width="10%" align="left"><a accesskey="p" href="view-pg-indexes.html" title="54.11. pg_indexes">Пред.</a> </td><td width="10%" align="left"><a accesskey="u" href="views.html" title="Глава 54. Системные представления">Наверх</a></td><th width="60%" align="center">Глава 54. Системные представления</th><td width="10%" align="right"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="10%" align="right"> <a accesskey="n" href="view-pg-matviews.html" title="54.13. pg_matviews">След.</a></td></tr></table><hr /></div><div class="sect1" id="VIEW-PG-LOCKS"><div class="titlepage"><div><div><h2 class="title" style="clear: both">54.12. <code class="structname">pg_locks</code> <a href="#VIEW-PG-LOCKS" class="id_link">#</a></h2></div></div></div><a id="id-1.10.5.16.2" class="indexterm"></a><p>Представление <code class="structname">pg_locks</code> даёт доступ к информации о блокировках, удерживаемых активными процессами на сервере баз данных. Подробнее блокировки рассматриваются в <a class="xref" href="mvcc.html" title="Глава 13. Управление конкурентным доступом">Главе 13</a>.</p><p>Представление <code class="structname">pg_locks</code> содержит одну строку для каждого активного блокируемого объекта, запрошенного режима блокировки и блокирующего процесса. Таким образом, один и тот же блокируемый объект может фигурировать в этом представлении неоднократно, если его блокируют или ожидают блокировки несколько процессов. Однако объекты, свободные от блокировок, в этом представлении отсутствуют вовсе.</p><p>Существует несколько различных типов блокируемых объектов: отношения целиком (например, таблицы), отдельные страницы отношений, отдельные кортежи отношений, идентификаторы транзакций (виртуальные и постоянные) и произвольные объекты баз данных (идентифицируемые по OID класса и OID объекта, так же как в <a class="link" href="catalog-pg-description.html" title="53.19. pg_description"><code class="structname">pg_description</code></a> или <a class="link" href="catalog-pg-depend.html" title="53.18. pg_depend"><code class="structname">pg_depend</code></a>). Кроме того, в виде отдельного блокируемого объекта представлено право расширения отношения, как и право изменения значения <code class="structname">pg_database</code>.<code class="structfield">datfrozenxid</code>. Также могут быть установлены <span class="quote">«<span class="quote">рекомендательные</span>»</span> блокировки, не имеющие предопределённого значения.</p><div class="table" id="id-1.10.5.16.6"><p class="title"><strong>Таблица 54.12. Столбцы <code class="structname">pg_locks</code></strong></p><div class="table-contents"><table class="table" summary="Столбцы pg_locks" border="1"><colgroup><col /></colgroup><thead><tr><th class="catalog_table_entry"><p class="column_definition">Тип столбца</p>
      <p>Описание</p></th></tr></thead><tbody><tr><td class="catalog_table_entry"><p class="column_definition">
       <code class="structfield">locktype</code> <code class="type">text</code>
      </p>
      <p>Тип блокируемого объекта: <code class="literal">relation</code> (отношение), <code class="literal">extend</code> (расширение отношения), <code class="literal">frozenid</code> (замороженный идентификатор), <code class="literal">page</code> (страница), <code class="literal">tuple</code> (кортеж), <code class="literal">transactionid</code> (идентификатор транзакции), <code class="literal">virtualxid</code> (виртуальный идентификатор), <code class="literal">spectoken</code> (спекулятивный маркер), <code class="literal">object</code> (объект), <code class="literal">userlock</code> (пользовательская блокировка), <code class="literal">advisory</code> (рекомендательная) или <code class="literal">applytransaction</code> (применение транзакции). (См. также <a class="xref" href="monitoring-stats.html#WAIT-EVENT-LOCK-TABLE" title="Таблица 28.11. События ожидания, относящиеся к типу Lock">Таблицу 28.11</a>.)</p></td></tr><tr><td class="catalog_table_entry"><p class="column_definition"><code class="structfield">database</code> <code class="type">oid</code> (ссылается на <a class="link" href="catalog-pg-database.html" title="53.15. pg_database"><code class="structname">pg_database</code></a>.<code class="structfield">oid</code>)</p>
      <p>OID базы данных, к которой относится цель блокировки, ноль, если это разделяемый объект, либо NULL, если целью является идентификатор транзакции</p></td></tr><tr><td class="catalog_table_entry"><p class="column_definition"><code class="structfield">relation</code> <code class="type">oid</code> (ссылается на <a class="link" href="catalog-pg-class.html" title="53.11. pg_class"><code class="structname">pg_class</code></a>.<code class="structfield">oid</code>)</p>
      <p>OID отношения, являющегося целью блокировки, либо NULL, если цель блокировки — не отношение или часть отношения</p></td></tr><tr><td class="catalog_table_entry"><p class="column_definition">
       <code class="structfield">page</code> <code class="type">int4</code>
      </p>
      <p>Номер страницы в отношении, являющейся целью блокировки, либо NULL, если цель блокировки — не страница или кортеж отношения</p></td></tr><tr><td class="catalog_table_entry"><p class="column_definition">
       <code class="structfield">tuple</code> <code class="type">int2</code>
      </p>
      <p>Номер кортежа на странице, являющегося целью блокировки, либо NULL, если цель блокировки — не кортеж</p></td></tr><tr><td class="catalog_table_entry"><p class="column_definition">
       <code class="structfield">virtualxid</code> <code class="type">text</code>
      </p>
      <p>Виртуальный идентификатор транзакции, являющийся целью блокировки, либо <code class="literal">NULL</code>, если цель блокировки — другой объект; см. <a class="xref" href="transactions.html" title="Глава 74. Обработка транзакций">Главу 74</a></p></td></tr><tr><td class="catalog_table_entry"><p class="column_definition">
       <code class="structfield">transactionid</code> <code class="type">xid</code>
      </p>
      <p>Идентификатор транзакции, являющийся целью блокировки, либо <code class="literal">NULL</code>, если цель блокировки — другой объект; см. <a class="xref" href="transactions.html" title="Глава 74. Обработка транзакций">Главу 74</a></p></td></tr><tr><td class="catalog_table_entry"><p class="column_definition"><code class="structfield">classid</code> <code class="type">oid</code> (ссылается на <a class="link" href="catalog-pg-class.html" title="53.11. pg_class"><code class="structname">pg_class</code></a>.<code class="structfield">oid</code>)</p>
      <p>OID системного каталога, содержащего цель блокировки, либо NULL, если цель блокировки — не обычный объект базы данных</p></td></tr><tr><td class="catalog_table_entry"><p class="column_definition"><code class="structfield">objid</code> <code class="type">oid</code> (ссылается на какой-либо столбец OID)</p>
      <p>OID цели блокировки в соответствующем системном каталоге, либо NULL, если цель блокировки — не обычный объект базы данных</p></td></tr><tr><td class="catalog_table_entry"><p class="column_definition">
       <code class="structfield">objsubid</code> <code class="type">int2</code>
      </p>
      <p>Номер столбца, являющегося целью блокировки (на саму таблицу указывают <code class="structfield">classid</code> и <code class="structfield">objid</code>), ноль, если это некоторый другой обычный объект базы данных, либо NULL, если цель не обычный объект</p></td></tr><tr><td class="catalog_table_entry"><p class="column_definition">
       <code class="structfield">virtualtransaction</code> <code class="type">text</code>
      </p>
      <p>Виртуальный идентификатор транзакции, удерживающей или ожидающей блокировку</p></td></tr><tr><td class="catalog_table_entry"><p class="column_definition">
       <code class="structfield">pid</code> <code class="type">int4</code>
      </p>
      <p>Идентификатор серверного процесса (PID, Process ID), удерживающего или ожидающего эту блокировку, либо NULL, если блокировка удерживается подготовленной транзакцией</p></td></tr><tr><td class="catalog_table_entry"><p class="column_definition">
       <code class="structfield">mode</code> <code class="type">text</code>
      </p>
      <p>Название режима блокировки, которая удерживается или запрашивается этим процессом (см. <a class="xref" href="explicit-locking.html#LOCKING-TABLES" title="13.3.1. Блокировки на уровне таблицы">Подраздел 13.3.1</a> и <a class="xref" href="transaction-iso.html#XACT-SERIALIZABLE" title="13.2.3. Уровень изоляции Serializable">Подраздел 13.2.3</a>)</p></td></tr><tr><td class="catalog_table_entry"><p class="column_definition">
       <code class="structfield">granted</code> <code class="type">bool</code>
      </p>
      <p>True, если блокировка получена, и false, если она ожидается</p></td></tr><tr><td class="catalog_table_entry"><p class="column_definition">
       <code class="structfield">fastpath</code> <code class="type">bool</code>
      </p>
      <p>True, если блокировка получена по короткому пути, и false, если она получена через основную таблицу блокировок</p></td></tr><tr><td class="catalog_table_entry"><p class="column_definition">
       <code class="structfield">waitstart</code> <code class="type">timestamptz</code>
      </p>
      <p>Время, когда серверный процесс начал ожидать блокировку, или NULL, если блокировка получена. Обратите внимание, что сразу после начала ожидания в этом поле может кратковременно наблюдаться NULL, при том что в <code class="structfield">granted</code> будет <code class="literal">false</code>.</p></td></tr></tbody></table></div></div><br class="table-break" /><p>Признак <code class="structfield">granted</code> устанавливается в строке, представляющей блокировку, удерживаемую указанным процессом. Если он сброшен, этот процесс ждёт блокировки, из чего следует что как минимум один другой процесс удерживает или ожидает блокировку того же объекта в конфликтующем режиме. Ожидающий процесс будет приостановлен до освобождения другой блокировки (или выявления ситуации взаимоблокировки). Один процесс в один момент времени может ожидать получения максимум одной блокировки.</p><p>На протяжении транзакции серверный процесс удерживает исключительную блокировку виртуального идентификатора транзакции. Если транзакции назначается постоянный идентификатор (что обычно происходит, только если транзакция изменяет состояние базы данных), он также удерживает до её завершения блокировку этого постоянного идентификатора. Когда процесс находит необходимым ожидать именно какую-то другую транзакцию, он делает это, запрашивая разделяемую блокировку для идентификатора этой транзакции (виртуального или постоянного, в зависимости от ситуации). Этот запрос будет выполнен, только когда другая транзакция завершится и освободит свои блокировки.</p><p>Хотя кортежи тоже представляют собой блокируемый объект, информация о блокировках строк хранится на диске, а не в памяти, поэтому такие блокировки обычно не показываются в этом представлении. Если процесс ожидает блокировки на уровне строки, он обычно виден в нём как ожидающий постоянного идентификатора транзакции текущего владельца этой блокировки.</p><p>Блокировка спекулятивного добавления состоит из идентификатора транзакции и маркера спекулятивного добавления. Маркер спекулятивного добавления отображается в столбце <code class="structfield">objid</code>.</p><p>Рекомендательные блокировки могут быть получены по ключам, состоящим из одного значения <code class="type">bigint</code> или из двух значений integer. Старшая половина <code class="type">bigint</code> выводится в столбце <code class="structfield">classid</code>, а младшая половина в столбце <code class="structfield">objid</code>, и <code class="structfield">objsubid</code> равен 1. Исходное значение <code class="type">bigint</code> может быть восстановлено выражением <code class="literal">(classid::bigint &lt;&lt; 32) | objid::bigint</code>. Для ключей integer первая часть ключа находится в <code class="structfield">classid</code>, а вторая часть в <code class="structfield">objid</code>, и <code class="structfield">objsubid</code> равна 2. Конкретное предназначение этих ключей определяет пользователь. Рекомендательные блокировки существуют в рамках базы данных, поэтому столбец <code class="structfield">database</code> имеет значение для таких блокировок.</p><p>В параллельном режиме используются блокировки применения транзакции при логической репликации. Идентификатор удалённой транзакции отображается в столбце <code class="structfield">transactionid</code>. Столбец <code class="structfield">objsubid</code> показывает подтип блокировки: 0 — блокировка для синхронизации набора изменений, 1 — блокировка для ожидания завершения транзакции, чтобы обеспечить порядок фиксации.</p><p>Представление <code class="structname">pg_locks</code> даёт общую информацию по всем блокировкам в кластере баз данных, а не только по тем, что относятся к текущей базе. Хотя соединив <code class="structfield">relation</code> с <a class="link" href="catalog-pg-class.html" title="53.11. pg_class"><code class="structname">pg_class</code></a>.<code class="structfield">oid</code>, можно получить заблокированные отношения, это будет работать корректно только для отношений в текущей базе данных (для тех, в блокировках которых столбец <code class="structfield">database</code> содержит OID текущей базы данных или ноль).</p><p>Соединив столбец <code class="structfield">pid</code> со столбцом <code class="structfield">pid</code> представления <a class="link" href="monitoring-stats.html#MONITORING-PG-STAT-ACTIVITY-VIEW" title="28.2.3. pg_stat_activity"><code class="structname">pg_stat_activity</code></a>, можно получить дополнительную информацию о сеансах, удерживающих или ожидающих каждую блокировку, например так: </p><pre class="programlisting">SELECT * FROM pg_locks pl LEFT JOIN pg_stat_activity psa
    ON pl.pid = psa.pid;</pre><p> Также, если вы используете подготовленные транзакции, столбец <code class="structfield">virtualtransaction</code> можно соединить со столбцом <code class="structfield">transaction</code> представления <a class="link" href="view-pg-prepared-xacts.html" title="54.16. pg_prepared_xacts"><code class="structname">pg_prepared_xacts</code></a> для получения дополнительной информации о подготовленных транзакциях, удерживающих блокировки. (Подготовленная транзакция не может ожидать блокировок, но она может продолжать удерживать блокировки, полученные ей в процессе выполнения.) Например: </p><pre class="programlisting">SELECT * FROM pg_locks pl LEFT JOIN pg_prepared_xacts ppx
    ON pl.virtualtransaction = '-1/' || ppx.transaction;</pre><p>Хотя в принципе возможно получить информацию о процессах, которые блокируют другие процессы, соединив представление <code class="structname">pg_locks</code> с ним же, очень трудно сделать это правильно во всех деталях. В частности потому, что такой запрос должен будет знать, какие режимы блокировки конфликтуют с другими. Мало того, представление <code class="structname">pg_locks</code> не показывает, какие процессы стоят перед какими в очередях ожидания блокировок, а также какие процессы являются параллельными рабочими процессами и к каким клиентским сеансам они относятся. Чтобы узнать, каким процессом или процессами блокируется ожидающий процесс, лучше использовать функцию <code class="function">pg_blocking_pids()</code> (см. <a class="xref" href="functions-info.html#FUNCTIONS-INFO-SESSION-TABLE" title="Таблица 9.67. Функции получения информации о сеансе">Таблицу 9.67</a>).</p><p>В представлении <code class="structname">pg_locks</code> показываются данные и из менеджера обычных блокировок, и из менеджера предикатных блокировок, которые являются отдельными механизмами; кроме того, менеджер обычных блокировок подразделяет свои блокировки на обычные и полученные <em class="firstterm">быстрым путём</em>. Абсолютная согласованность всех этих данных не гарантируется. При обращении к этому представлению данные блокировок по быстрому пути (с <code class="structfield">fastpath</code> = <code class="literal">true</code>) собираются по очереди с каждого серверного процесса, без замораживания состояния всего менеджера блокировок, так что существует возможность, что в процессе сбора этой информации блокировки будут освобождены или получены. Заметьте однако, что эти блокировки не должны конфликтовать с любыми другими актуальными блокировками. После того как от всех процессов получены блокировки по быстрому пути, менеджер обычных блокировок замораживается целиком и информация обо всех оставшихся блокировках собирается в атомарной операции. После размораживания этого менеджера, также замораживается менеджер предикатных блокировок, и информация об этих блокировках собирается атомарно. Таким образом, за исключением блокировок по быстрому пути, каждый менеджер блокировок выдаёт согласованный набор результатов, но так как мы не блокируем оба этих менеджера одновременно, блокировки могут быть получены или освобождены после того, как опрашивается менеджер обычных блокировок, и до того, как опрашивается менеджер предикатных блокировок.</p><p>Блокировка менеджера обычных или предикатных блокировок может отразиться на производительности базы данных, если обращаться к этому представлению часто. Эта блокировка удерживается не дольше, чем необходимо для получения данных от менеджеров, но это не исключает возможность снижения производительности.</p></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="view-pg-indexes.html" title="54.11. pg_indexes">Пред.</a> </td><td width="20%" align="center"><a accesskey="u" href="views.html" title="Глава 54. Системные представления">Наверх</a></td><td width="40%" align="right"> <a accesskey="n" href="view-pg-matviews.html" title="54.13. pg_matviews">След.</a></td></tr><tr><td width="40%" align="left" valign="top">54.11. <code class="structname">pg_indexes</code> </td><td width="20%" align="center"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="40%" align="right" valign="top"> 54.13. <code class="structname">pg_matviews</code></td></tr></table></div></body></html>