<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>61.1. Создание нестандартных путей сканирования</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@lists.postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets Vsnapshot" /><link rel="prev" href="custom-scan.html" title="Глава 61. Написание провайдера нестандартного сканирования" /><link rel="next" href="custom-scan-plan.html" title="61.2. Создание нестандартных планов сканирования" /></head><body id="docContent" class="container-fluid col-10"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="5" align="center">61.1. Создание нестандартных путей сканирования</th></tr><tr><td width="10%" align="left"><a accesskey="p" href="custom-scan.html" title="Глава 61. Написание провайдера нестандартного сканирования">Пред.</a> </td><td width="10%" align="left"><a accesskey="u" href="custom-scan.html" title="Глава 61. Написание провайдера нестандартного сканирования">Наверх</a></td><th width="60%" align="center">Глава 61. Написание провайдера нестандартного сканирования</th><td width="10%" align="right"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="10%" align="right"> <a accesskey="n" href="custom-scan-plan.html" title="61.2. Создание нестандартных планов сканирования">След.</a></td></tr></table><hr /></div><div class="sect1" id="CUSTOM-SCAN-PATH"><div class="titlepage"><div><div><h2 class="title" style="clear: both">61.1. Создание нестандартных путей сканирования <a href="#CUSTOM-SCAN-PATH" class="id_link">#</a></h2></div></div></div><div class="toc"><dl class="toc"><dt><span class="sect2"><a href="custom-scan-path.html#CUSTOM-SCAN-PATH-CALLBACKS">61.1.1. Обработчики пути нестандартного сканирования</a></span></dt></dl></div><p>Провайдер нестандартного сканирования обычно добавляет пути для базового отношения, установив следующий обработчик, который вызывается после того, как ядро построит все пути, какие сможет построить для отношения (за исключением путей Gather, которые создаются после этого вызова с тем, чтобы они могли использовать частичные пути, добавленные данным обработчиком): </p><pre class="programlisting">typedef void (*set_rel_pathlist_hook_type) (PlannerInfo *root,
                                            RelOptInfo *rel,
                                            Index rti,
                                            RangeTblEntry *rte);
extern PGDLLIMPORT set_rel_pathlist_hook_type set_rel_pathlist_hook;</pre><p>Хотя эта функция-обработчик может изучать, изменять или удалять пути, сформированные основной системой, провайдер нестандартного сканирования обычно ограничивается созданием объектов <code class="structname">CustomPath</code> и добавлением их в <code class="literal">rel</code> (с помощью <code class="function">add_path</code>). Провайдер нестандартного сканирования отвечает за инициализацию объекта <code class="structname">CustomPath</code>, который описан так: </p><pre class="programlisting">typedef struct CustomPath
{
    Path      path;
    uint32    flags;
    List     *custom_paths;
    List     *custom_private;
    const CustomPathMethods *methods;
} CustomPath;</pre><p>Поле <code class="structfield">path</code> должно инициализироваться как для любого другого пути и включать оценку числа строк, стоимость запуска и общую, а также порядок сортировки, устанавливаемый этим путём. Поле <code class="structfield">flags</code> задаёт битовую маску, которая указывает, поддерживает ли провайдер сканирования определённые необязательные возможности. Поле <code class="structfield">flags</code> должно включать флаг <code class="literal">CUSTOMPATH_SUPPORT_BACKWARD_SCAN</code>, если нестандартный путь поддерживает сканирование назад, <code class="literal">CUSTOMPATH_SUPPORT_MARK_RESTORE</code>, если он поддерживает пометку позиции и её восстановление, и <code class="literal">CUSTOMPATH_SUPPORT_PROJECTION</code>, если он поддерживает проекции. (Если <code class="literal">CUSTOMPATH_SUPPORT_PROJECTION</code> не установлен, узлу сканирования будет предложено только выдать переменные для сканируемого отношения, а если этот флаг установлен, узел сканирования должен иметь возможность вычислять скалярные выражения с этими переменными.) В необязательном поле <code class="structfield">custom_paths</code> задаётся список узлов <code class="structname">Path</code>, используемых данным узлом; они будут преобразованы планировщиком в узлы <code class="structname">Plan</code>. В поле <code class="structfield">custom_private</code> могут быть сохранены внутренние данные нестандартного пути. Сохранять их нужно в форме, которую может принять <code class="literal">nodeToString</code>, чтобы отладочные процедуры, пытающиеся вывести нестандартный путь, работали ожидаемым образом. Поле <code class="structfield">methods</code> должно указывать на объект (обычно статически размещённый), реализующий требуемые методы нестандартного пути, которые подробно описаны ниже.</p><p>Провайдер нестандартного сканирования может также реализовать пути соединений. Как и для базовых отношений, такой путь должен выдавать тот же результат, какой был бы получен обычным соединением, которое он заменяет. Для этого провайдер соединения должен установить следующий обработчик, а затем внутри функции-обработчика создать пути <code class="structname">CustomPath</code> для отношения соединения. </p><pre class="programlisting">typedef void (*set_join_pathlist_hook_type) (PlannerInfo *root,
                                             RelOptInfo *joinrel,
                                             RelOptInfo *outerrel,
                                             RelOptInfo *innerrel,
                                             JoinType jointype,
                                             JoinPathExtraData *extra);
extern PGDLLIMPORT set_join_pathlist_hook_type set_join_pathlist_hook;</pre><p> Этот обработчик будет вызываться многократно для одного отношения соединения с разными сочетаниями внутренних и внешних отношений; задача обработчика — минимизировать при этом дублирующиеся операции.</p><div class="sect2" id="CUSTOM-SCAN-PATH-CALLBACKS"><div class="titlepage"><div><div><h3 class="title">61.1.1. Обработчики пути нестандартного сканирования <a href="#CUSTOM-SCAN-PATH-CALLBACKS" class="id_link">#</a></h3></div></div></div><pre class="programlisting">Plan *(*PlanCustomPath) (PlannerInfo *root,
                         RelOptInfo *rel,
                         CustomPath *best_path,
                         List *tlist,
                         List *clauses,
                         List *custom_plans);</pre><p> Преобразует нестандартный путь в законченный план. Возвращаемым значением обычно будет объект <code class="literal">CustomScan</code>, который этот обработчик должен разместить в памяти и инициализировать. За подробностями обратитесь к <a class="xref" href="custom-scan-plan.html" title="61.2. Создание нестандартных планов сканирования">Разделу 61.2</a>.</p><pre class="programlisting">List *(*ReparameterizeCustomPathByChild) (PlannerInfo *root,
                                          List *custom_private,
                                          RelOptInfo *child_rel);</pre><p> Этот обработчик вызывается при преобразовании пути, параметризованного самым верхним родителем данного дочернего отношения <code class="literal">child_rel</code>, в путь, параметризованный дочерним отношением. Он используется для изменения параметров любых путей или трансляции любых узлов выражений, сохранённых в поле <code class="literal">custom_private</code> переданной структуры <code class="structname">CustomPath</code>. Этот обработчик может по мере необходимости использовать <code class="literal">reparameterize_path_by_child</code>, <code class="literal">adjust_appendrel_attrs</code> или <code class="literal">adjust_appendrel_attrs_multilevel</code>.</p></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="custom-scan.html" title="Глава 61. Написание провайдера нестандартного сканирования">Пред.</a> </td><td width="20%" align="center"><a accesskey="u" href="custom-scan.html" title="Глава 61. Написание провайдера нестандартного сканирования">Наверх</a></td><td width="40%" align="right"> <a accesskey="n" href="custom-scan-plan.html" title="61.2. Создание нестандартных планов сканирования">След.</a></td></tr><tr><td width="40%" align="left" valign="top">Глава 61. Написание провайдера нестандартного сканирования </td><td width="20%" align="center"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="40%" align="right" valign="top"> 61.2. Создание нестандартных планов сканирования</td></tr></table></div></body></html>