<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>46.1. Функции на PL/Python</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@lists.postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets Vsnapshot" /><link rel="prev" href="plpython.html" title="Глава 46. PL/Python — процедурный язык Python" /><link rel="next" href="plpython-data.html" title="46.2. Значения данных" /></head><body id="docContent" class="container-fluid col-10"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="5" align="center">46.1. Функции на PL/Python</th></tr><tr><td width="10%" align="left"><a accesskey="p" href="plpython.html" title="Глава 46. PL/Python — процедурный язык Python">Пред.</a> </td><td width="10%" align="left"><a accesskey="u" href="plpython.html" title="Глава 46. PL/Python — процедурный язык Python">Наверх</a></td><th width="60%" align="center">Глава 46. PL/Python — процедурный язык Python</th><td width="10%" align="right"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="10%" align="right"> <a accesskey="n" href="plpython-data.html" title="46.2. Значения данных">След.</a></td></tr></table><hr /></div><div class="sect1" id="PLPYTHON-FUNCS"><div class="titlepage"><div><div><h2 class="title" style="clear: both">46.1. Функции на PL/Python <a href="#PLPYTHON-FUNCS" class="id_link">#</a></h2></div></div></div><p>Функции на PL/Python объявляются стандартным образом с помощью команды <a class="xref" href="sql-createfunction.html" title="CREATE FUNCTION"><span class="refentrytitle">CREATE FUNCTION</span></a>: </p><pre class="programlisting">CREATE FUNCTION <em class="replaceable"><code>имя_функции</code></em> (<em class="replaceable"><code>аргументы</code></em>)
  RETURNS <em class="replaceable"><code>возвращаемый_тип</code></em>
AS $$
  # Тело функции на PL/Python
$$ LANGUAGE plpython3u;</pre><p>Тело функции содержит просто скрипт на языке Python. Когда вызывается функция, её аргументы передаются в виде элементов списка <code class="varname">args</code>; именованные аргументы также передаются скрипту Python как обычные переменные. С именованными аргументами скрипт обычно лучше читается. Результат из кода Python возвращается обычным способом: командой <code class="literal">return</code> или <code class="literal">yield</code> (в случае функции, возвращающей множество). Если возвращаемое значение не определено, Python возвращает <code class="symbol">None</code>. Исполнитель <span class="application">PL/Python</span> преобразует <code class="symbol">None</code> языка Python в значение NULL языка SQL. В процедуре код Python должен возвращать <code class="symbol">None</code> (обычно для этого процедура завершается без оператора <code class="literal">return</code> или используется оператор <code class="literal">return</code> без аргумента); в противном случае выдаётся ошибка.</p><p>Например, функцию, возвращающее большее из двух целых чисел, можно определить так: </p><pre class="programlisting">CREATE FUNCTION pymax (a integer, b integer)
  RETURNS integer
AS $$
  if a &gt; b:
    return a
  return b
$$ LANGUAGE plpython3u;</pre><p> Код на Python, заданный в качестве тела объявляемой функции, становится телом функции Python. Например, для показанного выше объявления получается функция: </p><pre class="programlisting">def __plpython_procedure_pymax_23456():
  if a &gt; b:
    return a
  return b</pre><p> Здесь 23456 — это OID, который <span class="productname">PostgreSQL</span> присвоил данной функции.</p><p>Значения аргументов задаются в глобальных переменных. Согласно правилам видимости в Python, тонким следствием этого является то, что переменной аргумента нельзя присвоить внутри функции выражение, включающее имя самой этой переменной, если только эта переменная не объявлена глобальной в текущем блоке. Например, следующий код не будет работать: </p><pre class="programlisting">CREATE FUNCTION pystrip(x text)
  RETURNS text
AS $$
  x = x.strip()  # ошибка
  return x
$$ LANGUAGE plpython3u;</pre><p> так как присваивание <code class="varname">x</code> значения делает <code class="varname">x</code> локальной переменной для всего блока, и при этом <code class="varname">x</code> в правой части присваивания оказывается ещё не определённой локальной переменной <code class="varname">x</code>, а не параметром функции PL/Python. Добавив оператор <code class="literal">global</code>, это можно исправить: </p><pre class="programlisting">CREATE FUNCTION pystrip(x text)
  RETURNS text
AS $$
  global x
  x = x.strip()  # теперь всё в порядке
  return x
$$ LANGUAGE plpython3u;</pre><p> Однако рекомендуется не полагаться на такие особенности реализации PL/Python, а принять, что параметры функции предназначены только для чтения.</p></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="plpython.html" title="Глава 46. PL/Python — процедурный язык Python">Пред.</a> </td><td width="20%" align="center"><a accesskey="u" href="plpython.html" title="Глава 46. PL/Python — процедурный язык Python">Наверх</a></td><td width="40%" align="right"> <a accesskey="n" href="plpython-data.html" title="46.2. Значения данных">След.</a></td></tr><tr><td width="40%" align="left" valign="top">Глава 46. PL/Python — процедурный язык Python </td><td width="20%" align="center"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="40%" align="right" valign="top"> 46.2. Значения данных</td></tr></table></div></body></html>