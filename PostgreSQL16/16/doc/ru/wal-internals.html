<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>30.6. Внутреннее устройство WAL</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@lists.postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets Vsnapshot" /><link rel="prev" href="wal-configuration.html" title="30.5. Настройка WAL" /><link rel="next" href="logical-replication.html" title="Глава 31. Логическая репликация" /></head><body id="docContent" class="container-fluid col-10"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="5" align="center">30.6. Внутреннее устройство WAL</th></tr><tr><td width="10%" align="left"><a accesskey="p" href="wal-configuration.html" title="30.5. Настройка WAL">Пред.</a> </td><td width="10%" align="left"><a accesskey="u" href="wal.html" title="Глава 30. Надёжность и журнал предзаписи">Наверх</a></td><th width="60%" align="center">Глава 30. Надёжность и журнал предзаписи</th><td width="10%" align="right"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="10%" align="right"> <a accesskey="n" href="logical-replication.html" title="Глава 31. Логическая репликация">След.</a></td></tr></table><hr /></div><div class="sect1" id="WAL-INTERNALS"><div class="titlepage"><div><div><h2 class="title" style="clear: both">30.6. Внутреннее устройство WAL <a href="#WAL-INTERNALS" class="id_link">#</a></h2></div></div></div><a id="id-1.6.17.8.2" class="indexterm"></a><p><acronym class="acronym">WAL</acronym> включается автоматически; от администратора не требуется никаких действий за исключением того, чтобы убедиться, что выполнены требования файлов <acronym class="acronym">WAL</acronym> к месту на диске, и что выполнены все необходимые действия по тонкой настройке (см. <a class="xref" href="wal-configuration.html" title="30.5. Настройка WAL">Раздел 30.5</a>).</p><p>Записи <acronym class="acronym">WAL</acronym> добавляются в файлы <acronym class="acronym">WAL</acronym> по мере поступления. Позицию добавления в журнал определяет значение <acronym class="acronym">LSN</acronym> (Log Sequence Number, Последовательный номер в журнале), представляющее собой смещение в байтах внутри WAL, монотонно увеличивающееся с каждой новой записью. Значения <acronym class="acronym">LSN</acronym> возвращаются с типом данных <a class="link" href="datatype-pg-lsn.html" title="8.20. Тип pg_lsn"><code class="type">pg_lsn</code></a>. Сравнивая эти значения, можно вычислить объём данных <acronym class="acronym">WAL</acronym> между ними, так что они могут быть полезны для вычисления прогресса при репликации и восстановлении.</p><p>Файлы <acronym class="acronym">WAL</acronym> хранятся в виде набора файлов сегментов в каталоге <code class="filename">pg_wal</code>, находящемся в каталоге данных. Эти файлы обычно имеют размер 16 Мбайт каждый (его можно изменить, передав <span class="application">initdb</span> другое значение в <code class="option">--wal-segsize</code>). Каждый файл сегмента разделяется на страницы, обычно по 8 Кбайт (данный размер может быть изменён указанием configure <code class="option">--with-wal-blocksize</code>). Заголовки записей WAL описываются в <code class="filename">access/xlogrecord.h</code>; содержимое самой записи зависит от типа события, которое сохраняется в журнале. Файлы сегментов имеют имена-номера, которые начинаются с <code class="filename">000000010000000000000001</code> и последовательно увеличиваются. Зацикливание этих номеров не предусмотрено, но для использования всех доступных номеров потребуется очень, очень много времени.</p><p>Имеет смысл размещать WAL на другом диске, отличном от того, где находятся основные файлы базы данных. Для этого можно переместить каталог <code class="filename">pg_wal</code> в другое место (разумеется, когда сервер остановлен) и создать символическую ссылку из исходного места на перемещённый каталог.</p><p>Для <acronym class="acronym">WAL</acronym> важно, чтобы запись в журнал выполнялась до изменений данных в базе. Но этот порядок могут нарушить дисковые устройства<a id="id-1.6.17.8.7.2" class="indexterm"></a>, которые ложно сообщают ядру об успешном завершении записи, хотя фактически они только выполнили кеширование данных и пока не сохранили их на диск. Сбой питания в такой ситуации может привести к неисправимому повреждению данных. Администраторы должны убедиться, что диски, где хранятся файлы <acronym class="acronym">WAL</acronym> <span class="productname">PostgreSQL</span>, не выдают таких ложных сообщений ядру. (См. <a class="xref" href="wal-reliability.html" title="30.1. Надёжность">Раздел 30.1</a>.)</p><p>После выполнения контрольной точки и сброса WAL позиция контрольной точки сохраняется в файл <code class="filename">pg_control</code>. Таким образом, при старте восстановления сервер сперва читает файл <code class="filename">pg_control</code> и затем запись контрольной точки; затем он выполняет операцию REDO, сканируя вперёд от позиции в WAL, обозначенной в записи контрольной точки. Поскольку полное содержимое страниц данных сохраняется в WAL в первой странице после контрольной точки (предполагается, что включён режим <a class="xref" href="runtime-config-wal.html#GUC-FULL-PAGE-WRITES">full_page_writes</a>), все страницы, изменённые с момента контрольной точки, будут восстановлены в целостном состоянии.</p><p>В случае, если файл <code class="filename">pg_control</code> повреждён, мы должны поддерживать возможность сканирования существующих сегментов WAL в обратном порядке — от новых к старым — чтобы найти последнюю контрольную точку. Это пока не реализовано. <code class="filename">pg_control</code> является достаточно маленьким файлом (меньше, чем одна дисковая страница), который не должен попадать под проблему частичной записи, и на момент написания данной документации не было ни одного сообщения о сбоях СУБД исключительно из-за невозможности чтения самого файла <code class="filename">pg_control</code>. Таким образом, хотя теоретически это является слабым местом, на практике проблем с <code class="filename">pg_control</code> не обнаружено.</p></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="wal-configuration.html" title="30.5. Настройка WAL">Пред.</a> </td><td width="20%" align="center"><a accesskey="u" href="wal.html" title="Глава 30. Надёжность и журнал предзаписи">Наверх</a></td><td width="40%" align="right"> <a accesskey="n" href="logical-replication.html" title="Глава 31. Логическая репликация">След.</a></td></tr><tr><td width="40%" align="left" valign="top">30.5. Настройка <acronym class="acronym">WAL</acronym> </td><td width="20%" align="center"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="40%" align="right" valign="top"> Глава 31. Логическая репликация</td></tr></table></div></body></html>