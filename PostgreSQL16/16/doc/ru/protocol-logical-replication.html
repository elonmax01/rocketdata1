<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>55.5. Протокол логической потоковой репликации</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@lists.postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets Vsnapshot" /><link rel="prev" href="protocol-replication.html" title="55.4. Протокол потоковой репликации" /><link rel="next" href="protocol-message-types.html" title="55.6. Типы данных в сообщениях" /></head><body id="docContent" class="container-fluid col-10"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="5" align="center">55.5. Протокол логической потоковой репликации</th></tr><tr><td width="10%" align="left"><a accesskey="p" href="protocol-replication.html" title="55.4. Протокол потоковой репликации">Пред.</a> </td><td width="10%" align="left"><a accesskey="u" href="protocol.html" title="Глава 55. Клиент-серверный протокол">Наверх</a></td><th width="60%" align="center">Глава 55. Клиент-серверный протокол</th><td width="10%" align="right"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="10%" align="right"> <a accesskey="n" href="protocol-message-types.html" title="55.6. Типы данных в сообщениях">След.</a></td></tr></table><hr /></div><div class="sect1" id="PROTOCOL-LOGICAL-REPLICATION"><div class="titlepage"><div><div><h2 class="title" style="clear: both">55.5. Протокол логической потоковой репликации <a href="#PROTOCOL-LOGICAL-REPLICATION" class="id_link">#</a></h2></div></div></div><div class="toc"><dl class="toc"><dt><span class="sect2"><a href="protocol-logical-replication.html#PROTOCOL-LOGICAL-REPLICATION-PARAMS">55.5.1. Параметры протокола логической потоковой репликации</a></span></dt><dt><span class="sect2"><a href="protocol-logical-replication.html#PROTOCOL-LOGICAL-MESSAGES">55.5.2. Сообщения протокола логической репликации</a></span></dt><dt><span class="sect2"><a href="protocol-logical-replication.html#PROTOCOL-LOGICAL-MESSAGES-FLOW">55.5.3. Поток сообщений протокола логической репликации</a></span></dt></dl></div><p>В этом разделе описывается протокол логической репликации, регламентирующий поток сообщений, который запускается командой репликации <code class="literal">START_REPLICATION</code> <code class="literal">SLOT</code> <em class="replaceable"><code>имя_слота</code></em> <code class="literal">LOGICAL</code>.</p><p>Протокол логической потоковой репликации построен на примитивах протокола физической потоковой репликации.</p><p>В логическом декодировании <span class="productname">PostgreSQL</span> поддерживаются модули вывода. Стандартный модуль <code class="literal">pgoutput</code> используется для встроенной логической репликации.</p><div class="sect2" id="PROTOCOL-LOGICAL-REPLICATION-PARAMS"><div class="titlepage"><div><div><h3 class="title">55.5.1. Параметры протокола логической потоковой репликации <a href="#PROTOCOL-LOGICAL-REPLICATION-PARAMS" class="id_link">#</a></h3></div></div></div><p>Используя команду <code class="literal">START_REPLICATION</code>, модуль <code class="literal">pgoutput</code> принимает следующие параметры: </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">proto_version</span></dt><dd><p>Версия протокола. В настоящее время поддерживаются только версии <code class="literal">1</code>, <code class="literal">2</code>, <code class="literal">3</code> и <code class="literal">4</code>. Необходимо указывать только рабочую версию.</p><p>Версия <code class="literal">2</code>, позволяющая передавать в потоке большие выполняющиеся транзакции, поддерживается только с серверами версии 14 и выше.</p><p>Версия <code class="literal">3</code>, позволяющая передавать фиксацию транзакций в двух фазах, поддерживается только с серверами версии 15 и выше.</p><p>Версия <code class="literal">4</code>, позволяющая параллельно передавать в потоке большие выполняющиеся транзакции, поддерживается только с серверами версии 16 и выше.</p></dd><dt><span class="term">publication_names</span></dt><dd><p>Список разделённых запятыми имён публикаций, на которые подписывается клиент (будет получать их изменения). Имена отдельных публикаций обрабатываются как стандартные имена объектов и могут так же заключаться в кавычки при необходимости. Требуется указывать хотя бы одно имя публикации.</p></dd><dt><span class="term">binary</span></dt><dd><p>Логический параметр, указывающий использовать режим двоичной передачи. Этот режим работает быстрее текстового, но чуть менее устойчив.</p></dd><dt><span class="term">messages</span></dt><dd><p>Логический параметр, который включает отправку сообщений, написанных функцией <code class="function">pg_logical_emit_message</code>.</p></dd><dt><span class="term">streaming</span></dt><dd><p>Логический параметр, позволяющий включить потоковую передачу текущих транзакций. Он принимает дополнительное значение <code class="literal">parallel</code>, чтобы включить отправку дополнительной информации с некоторыми сообщениями, которые будут использоваться для параллельного выполнения. Для включения параметра требуется протокол не ниже версии <code class="literal">2</code>. При указании значения <code class="literal">parallel</code> требуется протокол не ниже версии <code class="literal">4</code>.</p></dd><dt><span class="term">two_phase</span></dt><dd><p>Логический параметр, включающий двухфазные транзакции. Для его включения требуется протокол не ниже версии <code class="literal">3</code>.</p></dd><dt><span class="term">origin</span></dt><dd><p>Параметр для отправки изменений по их происхождению. Возможные значения: <code class="literal">none</code>, чтобы отправлять только те изменения, для которых не указан источник, или <code class="literal">any</code>, чтобы отправлять изменения независимо от их происхождения. Данный параметр можно использовать, чтобы избежать зацикливаний (бесконечной репликации одних и тех же данных) между узлами репликации.</p></dd></dl></div></div><div class="sect2" id="PROTOCOL-LOGICAL-MESSAGES"><div class="titlepage"><div><div><h3 class="title">55.5.2. Сообщения протокола логической репликации <a href="#PROTOCOL-LOGICAL-MESSAGES" class="id_link">#</a></h3></div></div></div><p>Отдельные сообщения протокола рассматриваются в следующих подразделах. Собственно сообщения описаны в <a class="xref" href="protocol-logicalrep-message-formats.html" title="55.9. Форматы сообщений логической репликации">Раздел 55.9</a>.</p><p>Все сообщения верхнего уровня начинаются с байта, определяющего тип сообщения. Хотя он представлен в коде символьным типом, это знаковый байт без явно заданной кодировки.</p><p>Так как в протоколе потоковой репликации передаётся длина сообщения, нет необходимости указывать длину в заголовках сообщений верхнего уровня.</p></div><div class="sect2" id="PROTOCOL-LOGICAL-MESSAGES-FLOW"><div class="titlepage"><div><div><h3 class="title">55.5.3. Поток сообщений протокола логической репликации <a href="#PROTOCOL-LOGICAL-MESSAGES-FLOW" class="id_link">#</a></h3></div></div></div><p>За исключением команды <code class="literal">START_REPLICATION</code> и сообщений о прогрессе воспроизведения, весь информационный поток направлен от сервера к клиенту.</p><p>Протокол логической репликации передаёт отдельные транзакции одну за другой. Это значит, что все сообщения между парой сообщений Begin и Commit относятся к одной транзакции. Точно так же к одной транзакции относятся все сообщения между парой сообщений Begin Prepare и Prepare. Этот протокол также передаёт содержимое больших транзакций по ходу их выполнения между парой сообщений Stream Start и Stream Stop. Последний поток для такой транзакции содержит сообщение Stream Commit или Stream Abort.</p><p>Каждая передаваемая транзакция содержит ноль или более сообщений DML (Insert, Update, Delete). В каскадной схеме она может также содержать сообщения Origin. Это сообщение показывает, что транзакция пришла с другого узла в схеме репликации. Так как этим узлом в контексте протокола логической репликации может быть что угодно, единственным идентификатором является его имя. Как воспринимать это имя (если это вообще нужно), определяют нижестоящие узлы. Сообщение Origin всегда передаётся перед всеми остальными сообщениями DML в транзакции.</p><p>Каждое DML-сообщение содержит идентификатор (OID) отношения, который указывает на целевое отношение на стороне публикации. Перед первым DML-сообщением для данного OID отношения будет отправлено сообщение Relation, описывающее схему данного отношения. Впоследствии будет отправлено новое сообщение Relation, если определение отношения изменится после отправки последнего сообщения Relation. (В протоколе предполагается, что клиент сможет кешировать метаданные для достаточно большого числа отношений.)</p><p>В сообщениях Relation типы столбцов определяются идентификаторами (OID). Для встроенного типа предполагается, что клиент может разрешить этот OID локально, поэтому никакие дополнительные данные не нужны. Однако для любых других типов перед сообщением Relation будет передаваться сообщение Type, связывающее имя типа с определённым OID. Таким образом, клиент, которому нужно однозначно определять типы столбцов в отношении, должен кешировать содержимое сообщений Type, и в случае обнаружения полученного OID в кеше использовать эту информацию, а в противном случае разрешать его локально.</p></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="protocol-replication.html" title="55.4. Протокол потоковой репликации">Пред.</a> </td><td width="20%" align="center"><a accesskey="u" href="protocol.html" title="Глава 55. Клиент-серверный протокол">Наверх</a></td><td width="40%" align="right"> <a accesskey="n" href="protocol-message-types.html" title="55.6. Типы данных в сообщениях">След.</a></td></tr><tr><td width="40%" align="left" valign="top">55.4. Протокол потоковой репликации </td><td width="20%" align="center"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="40%" align="right" valign="top"> 55.6. Типы данных в сообщениях</td></tr></table></div></body></html>