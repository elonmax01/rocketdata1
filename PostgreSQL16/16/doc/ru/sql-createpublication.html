<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>CREATE PUBLICATION</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@lists.postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets Vsnapshot" /><link rel="prev" href="sql-createprocedure.html" title="CREATE PROCEDURE" /><link rel="next" href="sql-createrole.html" title="CREATE ROLE" /></head><body id="docContent" class="container-fluid col-10"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="5" align="center">CREATE PUBLICATION</th></tr><tr><td width="10%" align="left"><a accesskey="p" href="sql-createprocedure.html" title="CREATE PROCEDURE">Пред.</a> </td><td width="10%" align="left"><a accesskey="u" href="sql-commands.html" title="Команды SQL">Наверх</a></td><th width="60%" align="center">Команды SQL</th><td width="10%" align="right"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="10%" align="right"> <a accesskey="n" href="sql-createrole.html" title="CREATE ROLE">След.</a></td></tr></table><hr /></div><div class="refentry" id="SQL-CREATEPUBLICATION"><div class="titlepage"></div><a id="id-1.9.3.77.1" class="indexterm"></a><div class="refnamediv"><h2><span class="refentrytitle">CREATE PUBLICATION</span></h2><p>CREATE PUBLICATION — создать публикацию</p></div><div class="refsynopsisdiv"><h2>Синтаксис</h2><pre class="synopsis">CREATE PUBLICATION <em class="replaceable"><code>имя</code></em>
    [ FOR ALL TABLES
      | FOR <em class="replaceable"><code>объект_публикации</code></em> [, ... ] ]
    [ WITH ( <em class="replaceable"><code>параметр_публикации</code></em> [= <em class="replaceable"><code>значение</code></em>] [, ... ] ) ]

<span class="phrase">где <em class="replaceable"><code>объект_публикации</code></em> может быть следующим:</span>

    TABLE [ ONLY ] <em class="replaceable"><code>имя_таблицы</code></em> [ * ] [ ( <em class="replaceable"><code>имя_столбца</code></em> [, ... ] ) ] [ WHERE ( <em class="replaceable"><code>выражение</code></em> ) ] [, ... ]
    TABLES IN SCHEMA { <em class="replaceable"><code>имя_схемы</code></em> | CURRENT_SCHEMA } [, ... ]</pre></div><div class="refsect1" id="id-1.9.3.77.5"><h2>Описание</h2><p><code class="command">CREATE PUBLICATION</code> создаёт новую публикацию в текущей базе данных. Имя публикации должно отличаться от имён других существующих публикаций в текущей базе.</p><p>Публикация по сути является группой таблиц, изменения в данных которых должны реплицироваться с использованием логической репликации. Подробнее о том, как публикации вписываются в схему логической репликации, рассказывается в <a class="xref" href="logical-replication-publication.html" title="31.1. Публикация">Разделе 31.1</a>.</p></div><div class="refsect1" id="id-1.9.3.77.6"><h2>Параметры</h2><div class="variablelist"><dl class="variablelist"><dt id="SQL-CREATEPUBLICATION-NAME"><span class="term"><em class="replaceable"><code>имя</code></em></span> <a href="#SQL-CREATEPUBLICATION-NAME" class="id_link">#</a></dt><dd><p>Имя новой публикации.</p></dd><dt id="SQL-CREATEPUBLICATION-FOR-TABLE"><span class="term"><code class="literal">FOR TABLE</code></span> <a href="#SQL-CREATEPUBLICATION-FOR-TABLE" class="id_link">#</a></dt><dd><p>Задаёт список таблиц, добавляемых в публикацию. Если перед именем таблицы указано <code class="literal">ONLY</code>, в публикацию добавляется только заданная таблица. Без <code class="literal">ONLY</code> добавляется и заданная таблица, и все её потомки (если таковые есть). После имени таблицы можно добавить необязательное указание <code class="literal">*</code>, чтобы явно обозначить, что должны включаться и все дочерние таблицы. Однако это не распространяется на секционированные таблицы. Секции секционированной таблицы всегда неявно считаются частью публикации, поэтому они никогда не добавляются в публикацию явным образом.</p><p>Если указано необязательное предложение <code class="literal">WHERE</code>, оно определяет выражение <em class="firstterm">фильтра строк</em>. Строки, для которых <em class="replaceable"><code>выражение</code></em> выдаёт false или null, не будут публиковаться. Заметьте, что выражение нужно заключать в круглые скобки. Это предложение не действует на команды <code class="literal">TRUNCATE</code>.</p><p>Если указан список столбцов, реплицируются только указанные столбцы. Если список столбцов не задан, через эту публикацию будут реплицироваться все столбцы таблицы, в том числе столбцы, добавленные позже. На команды <code class="literal">TRUNCATE</code> это ограничение не действуют. Подробнее о списках столбцов рассказывается в <a class="xref" href="logical-replication-col-lists.html" title="31.4. Списки столбцов">Разделе 31.4</a>.</p><p>В публикацию могут включаться только постоянные базовые и секционированные таблицы. Временные, нежурналируемые и сторонние таблицы, а также материализованные и обычные представления не могут входить в публикацию.</p><p>Указать список столбцов в публикации, которая также публикует все таблицы в схеме (<code class="literal">FOR TABLES IN SCHEMA</code>), нельзя.</p><p>Когда в публикацию добавляется секционированная таблица, все её существующие и будущие секции неявно становятся частью публикации. Поэтому даже операции, выполняемые непосредственно с секцией, также публикуются через публикации, в которые включена её родительская таблица.</p></dd><dt id="SQL-CREATEPUBLICATION-FOR-ALL-TABLES"><span class="term"><code class="literal">FOR ALL TABLES</code></span> <a href="#SQL-CREATEPUBLICATION-FOR-ALL-TABLES" class="id_link">#</a></dt><dd><p>Устанавливает, что данная публикация охватывает изменения во всех таблицах в базе данных, включая таблицы, которые будут созданы позже.</p></dd><dt id="SQL-CREATEPUBLICATION-FOR-TABLES-IN-SCHEMA"><span class="term"><code class="literal">FOR TABLES IN SCHEMA</code></span> <a href="#SQL-CREATEPUBLICATION-FOR-TABLES-IN-SCHEMA" class="id_link">#</a></dt><dd><p>Устанавливает, что данная публикация охватывает изменения во всех таблицах в указанном списке схем, включая таблицы, которые будут созданы позже.</p><p>Указать схему, когда публикация также публикует таблицу со списком столбцом, нельзя.</p><p>В публикацию будут включены только постоянные базовые и секционированные таблицы, присутствующие в схеме. Временные, нежурналируемые, сторонние таблицы, материализованные представления и обычные представления из этой схемы в публикацию не войдут.</p><p>Когда секционированная таблица публикуется посредством публикации схемы, все её существующие и будущие секции неявно становятся частью публикации, независимо от того, относятся ли к опубликованной схеме или нет. Поэтому даже операции, выполняемые непосредственно с секцией, также публикуются через публикации, в которые включена её родительская таблица.</p></dd><dt id="SQL-CREATEPUBLICATION-WITH"><span class="term"><code class="literal">WITH ( <em class="replaceable"><code>параметр_публикации</code></em> [= <em class="replaceable"><code>значение</code></em>] [, ... ] )</code></span> <a href="#SQL-CREATEPUBLICATION-WITH" class="id_link">#</a></dt><dd><p>В этом предложении могут задаваться следующие необязательные параметры публикации: </p><div class="variablelist"><dl class="variablelist"><dt id="SQL-CREATEPUBLICATION-WITH-PUBLISH"><span class="term"><code class="literal">publish</code> (<code class="type">string</code>)</span> <a href="#SQL-CREATEPUBLICATION-WITH-PUBLISH" class="id_link">#</a></dt><dd><p>Этот параметр определяет, какие операции DML будет передавать новая публикация её подписчикам. В качестве его значения через запятую задаётся список операций из следующих: <code class="literal">insert</code>, <code class="literal">update</code>, <code class="literal">delete</code> и <code class="literal">truncate</code>. По умолчанию публикуются все действия, так что этот параметр имеет значение по умолчанию <code class="literal">'insert, update, delete, truncate'</code>.</p><p>Этот параметр влияет только на операции DML. В частности, он не учитывается, когда копируются существующие данные таблиц при начальной синхронизации данных (см. <a class="xref" href="logical-replication-architecture.html#LOGICAL-REPLICATION-SNAPSHOT" title="31.7.1. Начальный снимок">Подраздел 31.7.1</a>) для логической репликации.</p></dd><dt id="SQL-CREATEPUBLICATION-WITH-PUBLISH-VIA-PARTITION-ROOT"><span class="term"><code class="literal">publish_via_partition_root</code> (<code class="type">boolean</code>)</span> <a href="#SQL-CREATEPUBLICATION-WITH-PUBLISH-VIA-PARTITION-ROOT" class="id_link">#</a></dt><dd><p>Этот параметр определяет, будут ли изменения в секции секционированной таблицы, включённой в публикацию, публиковаться как произошедшие в секционированной таблице (с её именем и схемой), а не в той секции, где они фактически имели место (это поведение по умолчанию). Включение этого параметра позволяет реплицировать изменения в несекционированную таблицу или в таблицу, состоящую из другого набора секций.</p><p>Иногда подписка связана с несколькими публикациями. Когда секционированная таблица публикуется в любой публикации, на которую оформлена подписка с <code class="literal">publish_via_partition_root = true</code>, изменения в этой секционированной таблице (или в её секциях) публикуются с указанием идентификатора или схемы этой секционированной таблицы, а не отдельной секции.</p><p>Этот параметр также определяет, какие фильтры строк и списки столбцов выбираются для секций; подробности описаны ниже.</p><p>Когда этот параметр включён, операции <code class="literal">TRUNCATE</code>, выполняемые непосредственно с секциями, не реплицируются.</p></dd></dl></div></dd></dl></div><p>Если для параметра типа <code class="type">boolean</code> опустить <code class="literal">=</code> <em class="replaceable"><code>значение</code></em>, это равнозначно указанию значения <code class="literal">TRUE</code>.</p></div><div class="refsect1" id="id-1.9.3.77.7"><h2>Замечания</h2><p>Если не задано ни <code class="literal">FOR TABLE</code>, ни <code class="literal">FOR ALL TABLES</code>, ни <code class="literal">FOR TABLES IN SCHEMA</code>, публикация создаётся с пустым набором таблиц. Это полезно, если таблицы или схемы будут добавляться позднее.</p><p>Создание публикации не влечёт немедленный запуск репликации. Эта операция только определяет логику группирования и фильтрации для будущих подписчиков.</p><p>Чтобы создать публикацию, пользователь должен иметь право <code class="literal">CREATE</code> в текущей базе данных. (Разумеется, на суперпользователей это условие не распространяется.)</p><p>Чтобы добавить таблицу в публикацию, пользователь должен иметь права владельца этой таблицы. Использовать предложения <code class="command">FOR ALL TABLES</code> и <code class="command">FOR TABLES IN SCHEMA</code> могут только суперпользователи.</p><p>Таблицы, добавляемые в публикацию, которая охватывает операции <code class="command">UPDATE</code> и/или <code class="command">DELETE</code>, должны иметь свойство <code class="literal">REPLICA IDENTITY</code>. В противном случае отслеживание этих операций для таблиц будет запрещено.</p><p>Для публикации операций <code class="command">UPDATE</code> или <code class="command">DELETE</code> необходимо, чтобы список столбцов включал столбцы идентификатора реплики (<code class="literal">REPLICA IDENTITY</code>). Если публикация создаётся только для операций <code class="command">INSERT</code>, ограничений на список столбцов нет.</p><p>Для публикации операций <code class="command">UPDATE</code> и <code class="command">DELETE</code> требуется, чтобы выражение фильтра строк (то есть предложение <code class="literal">WHERE</code>) содержало только столбцы, входящие в идентификатор реплики (<code class="literal">REPLICA IDENTITY</code>). Для публикации операции <code class="command">INSERT</code> в выражении <code class="literal">WHERE</code> может использоваться любой столбец. В фильтре строк допускаются простые выражения, не использующие пользовательские функции, пользовательские операторы, пользовательские типы, пользовательские правила сортировки, а также непостоянные встроенные функции и ссылки на системные столбцы.</p><p>Фильтр строк таблицы становится избыточным, когда добавляется указание <code class="literal">FOR TABLES IN SCHEMA</code> и таблица принадлежит указанной схеме.</p><p>Для опубликованных секционированных таблиц фильтр строк для каждой секции берётся из опубликованной секционированной таблицы, если параметр публикации <code class="literal">publish_via_partition_root</code> равен true, или из самой секции, если он равен false (по умолчанию). Подробнее фильтры строк описаны в <a class="xref" href="logical-replication-row-filter.html" title="31.3. Фильтры строк">Разделе 31.3</a>. Аналогично, для опубликованных секционированных таблиц список столбцов для каждой секции берётся из опубликованной секционированной таблицы, если параметр публикации <code class="literal">publish_via_partition_root</code> равен true, или из самой секции, если он равен false.</p><p>Для команды <code class="command">INSERT ... ON CONFLICT</code> публикация будет выдавать операцию, к которой сводится команда. В зависимости от исхода команды, она может быть опубликована либо как <code class="command">INSERT</code>, либо как <code class="command">UPDATE</code>, либо не будет опубликована вовсе.</p><p>Для команды <code class="command">MERGE</code> публикация будет выдавать <code class="command">INSERT</code>, <code class="command">UPDATE</code> или <code class="command">DELETE</code> для каждой вставляемой, изменяемой или удаляемой строки.</p><p>Присоединение (<code class="command">ATTACH</code>) таблицы к дереву секционирования, корень которого включён в публикацию со свойством параметра <code class="literal">publish_via_partition_root</code> равным <code class="literal">true</code>, не приводит к репликации существующего содержимого таблицы.</p><p>Команды <code class="command">COPY ... FROM</code> публикуются в виде операций <code class="command">INSERT</code>.</p><p>Операции <acronym class="acronym">DDL</acronym> не публикуются.</p><p>Выражение предложения <code class="literal">WHERE</code> вычисляется от имени роли, используемой для подключения репликации.</p></div><div class="refsect1" id="id-1.9.3.77.8"><h2>Примеры</h2><p>Создание публикации, охватывающей изменения в двух таблицах: </p><pre class="programlisting">CREATE PUBLICATION mypublication FOR TABLE users, departments;</pre><p>Создание публикации, охватывающей все изменения, которые относятся к действующим отделам: </p><pre class="programlisting">CREATE PUBLICATION active_departments FOR TABLE departments WHERE (active IS TRUE);</pre><p>Создание публикации, охватывающей все изменения во всех таблицах: </p><pre class="programlisting">CREATE PUBLICATION alltables FOR ALL TABLES;</pre><p>Создание публикации, охватывающей только операции <code class="command">INSERT</code> в одной таблице: </p><pre class="programlisting">CREATE PUBLICATION insert_only FOR TABLE mydata
    WITH (publish = 'insert');</pre><p>Создание публикации, охватывающей все изменения в таблицах <code class="structname">users</code>, <code class="structname">departments</code> и все изменения во всех таблицах, присутствующих в схеме <code class="structname">production</code>: </p><pre class="programlisting">CREATE PUBLICATION production_publication FOR TABLE users, departments, TABLES IN SCHEMA production;</pre><p>Создание публикации, охватывающей все изменения во всех таблицах, присутствующих в схемах <code class="structname">marketing</code> и <code class="structname">sales</code>: </p><pre class="programlisting">CREATE PUBLICATION sales_publication FOR TABLES IN SCHEMA marketing, sales;</pre><p>Создание публикации, которая охватывает все изменения для таблицы <code class="structname">users</code>, но реплицирует только столбцы <code class="structname">user_id</code> и <code class="structname">firstname</code>: </p><pre class="programlisting">CREATE PUBLICATION users_filtered FOR TABLE users (user_id, firstname);</pre></div><div class="refsect1" id="id-1.9.3.77.9"><h2>Совместимость</h2><p><code class="command">CREATE PUBLICATION</code> является расширением <span class="productname">PostgreSQL</span>.</p></div><div class="refsect1" id="id-1.9.3.77.10"><h2>См. также</h2><span class="simplelist"><a class="xref" href="sql-alterpublication.html" title="ALTER PUBLICATION"><span class="refentrytitle">ALTER PUBLICATION</span></a>, <a class="xref" href="sql-droppublication.html" title="DROP PUBLICATION"><span class="refentrytitle">DROP PUBLICATION</span></a>, <a class="xref" href="sql-createsubscription.html" title="CREATE SUBSCRIPTION"><span class="refentrytitle">CREATE SUBSCRIPTION</span></a>, <a class="xref" href="sql-altersubscription.html" title="ALTER SUBSCRIPTION"><span class="refentrytitle">ALTER SUBSCRIPTION</span></a></span></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="sql-createprocedure.html" title="CREATE PROCEDURE">Пред.</a> </td><td width="20%" align="center"><a accesskey="u" href="sql-commands.html" title="Команды SQL">Наверх</a></td><td width="40%" align="right"> <a accesskey="n" href="sql-createrole.html" title="CREATE ROLE">След.</a></td></tr><tr><td width="40%" align="left" valign="top">CREATE PROCEDURE </td><td width="20%" align="center"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="40%" align="right" valign="top"> CREATE ROLE</td></tr></table></div></body></html>