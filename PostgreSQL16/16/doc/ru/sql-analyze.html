<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>ANALYZE</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@lists.postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets Vsnapshot" /><link rel="prev" href="sql-alterview.html" title="ALTER VIEW" /><link rel="next" href="sql-begin.html" title="BEGIN" /></head><body id="docContent" class="container-fluid col-10"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="5" align="center">ANALYZE</th></tr><tr><td width="10%" align="left"><a accesskey="p" href="sql-alterview.html" title="ALTER VIEW">Пред.</a> </td><td width="10%" align="left"><a accesskey="u" href="sql-commands.html" title="Команды SQL">Наверх</a></td><th width="60%" align="center">Команды SQL</th><td width="10%" align="right"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="10%" align="right"> <a accesskey="n" href="sql-begin.html" title="BEGIN">След.</a></td></tr></table><hr /></div><div class="refentry" id="SQL-ANALYZE"><div class="titlepage"></div><a id="id-1.9.3.46.1" class="indexterm"></a><div class="refnamediv"><h2><span class="refentrytitle">ANALYZE</span></h2><p>ANALYZE — собрать статистику по базе данных</p></div><div class="refsynopsisdiv"><h2>Синтаксис</h2><pre class="synopsis">ANALYZE [ ( <em class="replaceable"><code>параметр</code></em> [, ...] ) ] [ <em class="replaceable"><code>таблица_и_столбцы</code></em> [, ...] ]
ANALYZE [ VERBOSE ] [ <em class="replaceable"><code>таблица_и_столбцы</code></em> [, ...] ]

<span class="phrase">Здесь допускается <em class="replaceable"><code>параметр</code></em>:</span>

    VERBOSE [ <em class="replaceable"><code>логическое_значение</code></em> ]
    SKIP_LOCKED [ <em class="replaceable"><code>логическое_значение</code></em> ]
    BUFFER_USAGE_LIMIT <em class="replaceable"><code>размер</code></em>

<span class="phrase">и <em class="replaceable"><code>таблица_и_столбцы</code></em>:</span>

    <em class="replaceable"><code>имя_таблицы</code></em> [ ( <em class="replaceable"><code>имя_столбца</code></em> [, ...] ) ]</pre></div><div class="refsect1" id="id-1.9.3.46.5"><h2>Описание</h2><p><code class="command">ANALYZE</code> собирает статистическую информацию о содержимом таблиц в базе данных и сохраняет результаты в системном каталоге <a class="link" href="catalog-pg-statistic.html" title="53.51. pg_statistic"><code class="structname">pg_statistic</code></a>. Впоследствии планировщик запросов будет использовать эту статистику для выбора наиболее эффективных планов выполнения запросов.</p><p>Без списка <em class="replaceable"><code>таблица_и_столбцы</code></em> команда <code class="command">ANALYZE</code> обрабатывает все таблицы и материализованные представления в текущей базе данных, на анализ которых текущий пользователь имеет право. Со списком <code class="command">ANALYZE</code> обрабатывает только указанные в нём таблицы. Дополнительно можно задать для таблицы список имён столбцов, в этом случае статистика будет собираться только по этим столбцам.</p><p>Когда список параметров заключается в скобки, параметры могут быть записаны в любом порядке. Синтаксис со скобками появился в <span class="productname">PostgreSQL</span> 11; вариант записи без скобок считается устаревшим.</p></div><div class="refsect1" id="id-1.9.3.46.6"><h2>Параметры</h2><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">VERBOSE</code></span></dt><dd><p>Включает вывод сообщений о процессе выполнения.</p></dd><dt><span class="term"><code class="literal">SKIP_LOCKED</code></span></dt><dd><p>Указывает, что команда <code class="command">ANALYZE</code> не должна ждать освобождения конфликтующих блокировок, начиная обработку отношения: если отношение не удаётся заблокировать сразу, без ожидания, оно пропускается. Заметьте, что даже с этим указанием <code class="command">ANALYZE</code> может заблокироваться, открывая индексы отношения или получая выборку строк из секций, потомков в иерархии наследования или некоторых видов сторонних таблиц. Учтите также, что при наличии конфликтующей блокировки в секционированной таблице команда <code class="command">ANALYZE</code> пропускает все её секции, тогда как обычно все они обрабатываются.</p></dd><dt><span class="term"><code class="literal">BUFFER_USAGE_LIMIT</code></span></dt><dd><p>Указывает размер кольцевого буфера <a class="glossterm" href="glossary.html#GLOSSARY-BUFFER-ACCESS-STRATEGY"><em class="glossterm"><a class="glossterm" href="glossary.html#GLOSSARY-BUFFER-ACCESS-STRATEGY" title="Стратегия доступа к буферу">стратегии доступа к буферам</a></em></a> (Buffer Access Strategy) для <code class="command">ANALYZE</code>. Этот размер используется для расчёта количества общих буферов, переиспользуемых в рамках этой стратегии. С значением <code class="literal">0</code> использование стратегии доступа к буферам отключается. Если не задать этот параметр, <code class="command">ANALYZE</code> использует значение из <a class="xref" href="runtime-config-resource.html#GUC-VACUUM-BUFFER-USAGE-LIMIT">vacuum_buffer_usage_limit</a>. С большим значением параметра <code class="command">ANALYZE</code> может выполняться быстрее, но при слишком большом значении многие полезные страницы могут вытесняться из общих буферов. Минимальное значение — <code class="literal">128 kB</code>, максимальное — <code class="literal">16 GB</code>.</p></dd><dt><span class="term"><em class="replaceable"><code>логическое_значение</code></em></span></dt><dd><p>Включает или отключает заданный параметр. Для включения параметра можно написать <code class="literal">TRUE</code>, <code class="literal">ON</code> или <code class="literal">1</code>, а для отключения — <code class="literal">FALSE</code>, <code class="literal">OFF</code> или <code class="literal">0</code>. Параметр <em class="replaceable"><code>логическое_значение</code></em> можно опустить, в этом случае подразумевается <code class="literal">TRUE</code>.</p></dd><dt><span class="term"><em class="replaceable"><code>размер</code></em></span></dt><dd><p>Задаёт объём памяти в килобайтах. Можно также указать в виде строки, содержащей числовой размер, за которым следует одна из следующих единиц информации: <code class="literal">B</code> (байты), <code class="literal">kB</code> (килобайты), <code class="literal">MB</code> (мегабайты), <code class="literal">GB</code> (гигабайты) или <code class="literal">TB</code> (терабайты).</p></dd><dt><span class="term"><em class="replaceable"><code>имя_таблицы</code></em></span></dt><dd><p>Имя (возможно, дополненное схемой) определённой таблицы, подлежащей анализу. Если опущено, анализироваться будут все обычные и секционированные таблицы, а также материализованные представления в текущей базе данных (но не сторонние таблицы). Если задано имя секционированной таблицы, обновлена будет как статистика наследования для этой таблицы, так и статистика отдельных её секций.</p></dd><dt><span class="term"><em class="replaceable"><code>имя_столбца</code></em></span></dt><dd><p>Имя столбца, подлежащего анализу. По умолчанию анализируются все столбцы.</p></dd></dl></div></div><div class="refsect1" id="id-1.9.3.46.7"><h2>Выводимая информация</h2><p>С указанием <code class="literal">VERBOSE</code> команда <code class="command">ANALYZE</code> выдаёт сообщения о процессе анализа, отмечая текущую обрабатываемую таблицу. Также она выводит различные статистические сведения о таблицах.</p></div><div class="refsect1" id="id-1.9.3.46.8"><h2>Замечания</h2><p>Чтобы осуществить анализ таблицы, обычно нужно быть владельцем этой таблицы или суперпользователем. Однако владельцам баз данных также разрешено выполнять анализ всех таблиц в своих базах, за исключением общих каталогов. (Ограничение в отношении общих каталогов означает, что действительно глобальную команду <code class="command">ANALYZE</code> может выполнить только суперпользователь.) <code class="command">ANALYZE</code> при обработке пропускает все таблицы, на очистку которых текущий пользователь не имеет прав.</p><p>Сторонние таблицы анализируются только при явном указании и только если соответствующая обёртка сторонних данных поддерживает команду <code class="command">ANALYZE</code>. Если эта команда не поддерживается, при выполнении <code class="command">ANALYZE</code> выводится предупреждение и больше ничего не происходит.</p><p>В стандартной конфигурации <span class="productname">PostgreSQL</span> работающий демон автоочистки (см. <a class="xref" href="routine-vacuuming.html#AUTOVACUUM" title="25.1.6. Демон автоочистки">Подраздел 25.1.6</a>) запускает анализ таблиц автоматически, когда они изначально заполняются данными, и периодически, по мере того, как они меняются. Если автоочистка отключена, рекомендуется запускать <code class="command">ANALYZE</code> время от времени, либо после кардинальных изменений в таблице. Точная статистика помогает планировщику выбрать наиболее эффективный план запроса и тем самым увеличивает скорость выполнения запроса. Обычно для баз, где данные в основном читаются, выполняют <a class="link" href="sql-vacuum.html" title="VACUUM"><code class="command">VACUUM</code></a> и <code class="command">ANALYZE</code> раз в день, во время наименьшей активности. (Этого будет недостаточно, если данные меняются очень активно.)</p><p><code class="command">ANALYZE</code> запрашивает для целевой таблицы блокировку только на чтение, так что эта команда может выполняться параллельно с другими операциями с таблицей.</p><p>Статистика, собираемая командой <code class="command">ANALYZE</code>, обычно включает список из нескольких самых частых значений в каждом столбце и гистограмму, отражающую примерное распределение данных во всех столбцах. Один или оба этих элемента статистики могут быть опущены, если <code class="command">ANALYZE</code> сочтёт их неинтересными (например, в столбце уникального ключа нет повторяющихся значений), либо если тип данных столбца не поддерживает соответствующие операторы. Более подробно статистика описывается в <a class="xref" href="maintenance.html" title="Глава 25. Регламентные задачи обслуживания базы данных">Главе 25</a>.</p><p>В больших таблицах <code class="command">ANALYZE</code> не просматривает все строки, а обрабатывает только небольшую случайную выборку. Это позволяет проанализировать за короткое время даже очень большие таблицы. Однако учтите, что такая статистика будет лишь приблизительной и может немного меняться при каждом выполнении <code class="command">ANALYZE</code>, даже если фактическое содержимое таблицы остаётся неизменным. Это может приводить к небольшим изменениям в оценках стоимости запросов, выводимых командой <a class="link" href="sql-explain.html" title="EXPLAIN"><code class="command">EXPLAIN</code></a>. В редких случаях вследствие этой недетерменированности планировщик меняет свой выбор после выполнения <code class="command">ANALYZE</code>. Чтобы избежать этого, увеличьте объём статистики, собираемой командой <code class="command">ANALYZE</code>, как описано ниже.</p><p>Количеством статистики можно управлять, настраивая конфигурационную переменную <a class="xref" href="runtime-config-query.html#GUC-DEFAULT-STATISTICS-TARGET">default_statistics_target</a> или устанавливая ориентир статистики на уровне столбцов командой <a class="link" href="sql-altertable.html" title="ALTER TABLE"><code class="command">ALTER TABLE ... ALTER COLUMN ... SET STATISTICS</code></a> (см. <a class="xref" href="sql-altertable.html" title="ALTER TABLE"><span class="refentrytitle">ALTER TABLE</span></a>). Ориентир задаёт максимальное число записей в списке наиболее распространённых значений и максимальное число интервалов в гистограмме. По умолчанию значение ориентира равно 100, но его можно увеличить или уменьшить в поисках баланса между точностью оценок планировщика и временем, требующимся для выполнения <code class="command">ANALYZE</code>, а также объёмом статистики в таблице <code class="literal">pg_statistic</code>. Если установить ориентир статистики равным нулю, статистика по таким столбцам собираться не будет. Это может быть полезно для столбцов, которые никогда не фигурируют в предложениях <code class="literal">WHERE</code>, <code class="literal">GROUP BY</code> и <code class="literal">ORDER BY</code>, так как планировщик никогда не будет использовать их статистику.</p><p>Число строк таблицы, выбираемых для подготовки статистики, определяется наибольшим ориентиром статистики по всем анализируемым столбцам этой таблицы. Увеличение ориентира приводит к пропорциональному увеличению времени и пространства, требуемого для выполнения <code class="command">ANALYZE</code>.</p><p>Одним из показателей, оцениваемых командой <code class="command">ANALYZE</code>, является число различных значений, встречающихся в каждом столбце. Так как рассматривается только подмножество всех строк, эта оценка иногда может быть весьма неточной, даже при самых больших ориентирах статистики. Если эта неточность приводит к плохому выбору плана запроса, более точное значение можно определить вручную и затем задать его командой <a class="link" href="sql-altertable.html" title="ALTER TABLE"><code class="command">ALTER TABLE ... ALTER COLUMN ... SET (n_distinct = ...)</code></a>.</p><p>Если у анализируемой таблицы есть потомки, <code class="command">ANALYZE</code> соберёт два набора статистик: один по строкам только родительской таблицы, а второй по строкам родительской и всех дочерних таблиц. Второй набор статистики необходим для планирования запросов, обращающихся к дереву наследования как одному целому. Сами дочерние таблицы в этом случае отдельно не анализируются. Демон автоочистки, однако, принимая решение об автоматическом запуске анализа, будет учитывать операции добавления или изменения данных только в самой родительской таблице. Если именно в этой таблице изменение и добавление происходят редко, наследуемая статистика может терять актуальность, если не запускать <code class="command">ANALYZE</code> вручную.</p><p>Для секционированных таблиц <code class="command">ANALYZE</code> собирает статистику, обрабатывая выборки строки из всех секций, а также рекурсивно обновляет статистику во всех секциях. Даже в многоуровневой иерархии секционирования каждая конечная секция анализируется только один раз. Отдельно для родительских таблиц (без рассмотрения данных их секций) статистика не собирается, так как секционирование гарантирует, что они пустые.</p><p>Процесс автоочистки не затрагивает секционированные таблицы и родительские таблицы в иерархии наследования, если изменения происходят только в дочерних таблицах. Поэтому, чтобы статистика всей иерархии наследования была актуальной, обычно необходимо периодически выполнять <code class="command">ANALYZE</code> вручную.</p><p>Если какие-либо из дочерних таблиц или секций являются сторонними таблицами и их обёртки сторонних данных не поддерживают <code class="command">ANALYZE</code>, эти дочерние таблицы игнорируются при сборе статистики наследования.</p><p>Если анализируемая таблица оказалась пустой, <code class="command">ANALYZE</code> не будет обновлять статистику по этой таблице; в базе сохранится статистика, собранная ранее.</p><p>Каждый процесс, выполняющий операцию <code class="command">ANALYZE</code>, будет выдавать информацию о ходе её выполнения, отображаемую в представлении <code class="structname">pg_stat_progress_analyze</code>. За подробностями обратитесь к <a class="xref" href="progress-reporting.html#ANALYZE-PROGRESS-REPORTING" title="28.4.1. Отслеживание выполнения ANALYZE">Подразделу 28.4.1</a>.</p></div><div class="refsect1" id="id-1.9.3.46.9"><h2>Совместимость</h2><p>Оператор <code class="command">ANALYZE</code> отсутствует в стандарте SQL.</p></div><div class="refsect1" id="id-1.9.3.46.10"><h2>См. также</h2><span class="simplelist"><a class="xref" href="sql-vacuum.html" title="VACUUM"><span class="refentrytitle">VACUUM</span></a>, <a class="xref" href="app-vacuumdb.html" title="vacuumdb"><span class="refentrytitle"><span class="application">vacuumdb</span></span></a>, <a class="xref" href="runtime-config-resource.html#RUNTIME-CONFIG-RESOURCE-VACUUM-COST" title="20.4.4. Задержка очистки по стоимости">Подраздел 20.4.4</a>, <a class="xref" href="routine-vacuuming.html#AUTOVACUUM" title="25.1.6. Демон автоочистки">Подраздел 25.1.6</a>, <a class="xref" href="progress-reporting.html#ANALYZE-PROGRESS-REPORTING" title="28.4.1. Отслеживание выполнения ANALYZE">Подраздел 28.4.1</a></span></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="sql-alterview.html" title="ALTER VIEW">Пред.</a> </td><td width="20%" align="center"><a accesskey="u" href="sql-commands.html" title="Команды SQL">Наверх</a></td><td width="40%" align="right"> <a accesskey="n" href="sql-begin.html" title="BEGIN">След.</a></td></tr><tr><td width="40%" align="left" valign="top">ALTER VIEW </td><td width="20%" align="center"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="40%" align="right" valign="top"> BEGIN</td></tr></table></div></body></html>