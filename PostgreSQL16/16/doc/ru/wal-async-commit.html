<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>30.4. Асинхронное подтверждение транзакций</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@lists.postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets Vsnapshot" /><link rel="prev" href="wal-intro.html" title="30.3. Журнал предзаписи (WAL)" /><link rel="next" href="wal-configuration.html" title="30.5. Настройка WAL" /></head><body id="docContent" class="container-fluid col-10"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="5" align="center">30.4. Асинхронное подтверждение транзакций</th></tr><tr><td width="10%" align="left"><a accesskey="p" href="wal-intro.html" title="30.3. Журнал предзаписи (WAL)">Пред.</a> </td><td width="10%" align="left"><a accesskey="u" href="wal.html" title="Глава 30. Надёжность и журнал предзаписи">Наверх</a></td><th width="60%" align="center">Глава 30. Надёжность и журнал предзаписи</th><td width="10%" align="right"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="10%" align="right"> <a accesskey="n" href="wal-configuration.html" title="30.5. Настройка WAL">След.</a></td></tr></table><hr /></div><div class="sect1" id="WAL-ASYNC-COMMIT"><div class="titlepage"><div><div><h2 class="title" style="clear: both">30.4. Асинхронное подтверждение транзакций <a href="#WAL-ASYNC-COMMIT" class="id_link">#</a></h2></div></div></div><a id="id-1.6.17.6.2" class="indexterm"></a><a id="id-1.6.17.6.3" class="indexterm"></a><p><em class="firstterm">Асинхронная фиксация</em> — это возможность завершать транзакции быстрее, ценой того, что в случае краха СУБД последние транзакции могут быть потеряны. Для многих приложений такой компромисс приемлем.</p><p>Как описано в предыдущей части, подтверждение транзакции обычно <em class="firstterm">синхронное</em>: сервер ждёт сохранения записей <acronym class="acronym">WAL</acronym> транзакции в постоянном хранилище, прежде чем сообщить клиенту об успешном завершении. Таким образом, клиенту гарантируется, что транзакция, которую подтвердил сервер, будет защищена, даже если сразу после этого произойдёт крах сервера. Однако для коротких транзакций данная задержка будет основной составляющей общего времени транзакции. В режиме асинхронного подтверждения сервер сообщает об успешном завершении сразу, как только транзакция будет завершена логически, прежде чем сгенерированные записи <acronym class="acronym">WAL</acronym> фактически будут записаны на диск. Это может значительно увеличить производительность при выполнении небольших транзакций.</p><p>Асинхронное подтверждение транзакций приводит к риску потери данных. Существует короткое окно между отчётом о завершении транзакции для клиента и временем, когда транзакция реально подтверждена (т. е. гарантируется, что она не будет потеряна в случае краха сервера). Таким образом, асинхронное подтверждение транзакций не должно использоваться, если клиент будет выполнять внешние действия, опираясь на предположение, что транзакция будет сохранена. Например, банк конечно не должен использовать асинхронное подтверждение для транзакций в банкоматах, выдающих наличные. Но во многих случаях, таких как журналирование событий, столь серьёзная гарантия сохранности данных не нужна.</p><p>Риск потери данных при использовании асинхронного подтверждения транзакций — это не риск повреждения данных. Если случился крах СУБД, она будет восстановлена путём воспроизведения <acronym class="acronym">WAL</acronym> до последней записи, которая была записана на диск. Таким образом, будет восстановлено целостное состояние СУБД, но любые транзакции, которые ещё не были сохранены на диск, в этом состоянии не будут отражены. Чистый эффект будет заключаться в потере нескольких последних транзакций. Поскольку транзакции воспроизводятся в том же порядке, в котором подтверждались, воспроизведение не нарушает целостность — например, если транзакция «B» выполнила изменения, которые влияют на предыдущую транзакцию «A», то не может быть такого, что изменения, выполненные «A» были потеряны, а изменения, внесённые «B» сохранены.</p><p>Пользователь может выбрать режим подтверждения для каждой транзакции, так что возможен конкурентный запуск транзакций в синхронном и асинхронном режиме. Это позволяет достичь гибкого компромисса между производительностью и конечно надёжностью транзакций. Режим подтверждения транзакций управляется параметром <a class="xref" href="runtime-config-wal.html#GUC-SYNCHRONOUS-COMMIT">synchronous_commit</a>, который может быть изменён любым из способов, пригодным для установки параметров конфигурации. Режим, используемый для какой-либо конкретной транзакции, зависит от значения <code class="varname">synchronous_commit</code>, которое действует на момент начала этой транзакции.</p><p>Некоторые команды, например <code class="command">DROP TABLE</code>, принудительно запускают синхронное подтверждение транзакции, независимо от значения <code class="varname">synchronous_commit</code>. Это сделано для того, чтобы иметь уверенность в целостности данных между файловой системой сервера и логическим состоянием базы данных. Команды, которые поддерживают двухфазное подтверждение транзакций, такие как <code class="command">PREPARE TRANSACTION</code>, также всегда синхронные.</p><p>Если во время окна риска между асинхронным подтверждением транзакции и сохранением на диск записей <acronym class="acronym">WAL</acronym>, происходит крах СУБД, то изменения, сделанные во время этой транзакции <span class="emphasis"><em>будут</em></span> потеряны. Продолжительность окна риска ограничена, потому что фоновый процесс (<span class="quote">«<span class="quote">WAL writer</span>»</span>), сохраняет не записанные записи <acronym class="acronym">WAL</acronym> на диск каждые <a class="xref" href="runtime-config-wal.html#GUC-WAL-WRITER-DELAY">wal_writer_delay</a> миллисекунд. Фактически, максимальная продолжительность окна риска составляет трёхкратное значение <code class="varname">wal_writer_delay</code>, потому что WAL writer разработан так, чтобы сразу сохранять целые страницы во время периодов занятости.</p><div class="caution"><h3 class="title">Внимание</h3><p>Режим немедленного завершения работы (immediate) эквивалентен краху сервера и приведёт, таким образом, к потере всех не сохранённых асинхронных транзакций.</p></div><p>Асинхронное подтверждение транзакций предоставляет поведение, которое отличается от того, что соответствует установке параметра <a class="xref" href="runtime-config-wal.html#GUC-FSYNC">fsync</a> = off. Настройка <code class="varname">fsync</code> касается всего сервера и может изменить поведение всех транзакций. Она выключает всю логику внутри <span class="productname">PostgreSQL</span>, которая пытается синхронизировать запись отдельных порций в базу данных и, таким образом, крах системы (обусловленный отказом аппаратного обеспечения или операционной системы, который не является сбоем самой СУБД <span class="productname">PostgreSQL</span> ) может в результате привести к повреждению состояния базы данных. Во многих случаях, асинхронное подтверждение транзакций предоставляет лучшую производительность, чем то, что можно получить выключением <code class="varname">fsync</code>, но без риска повреждения данных.</p><p><a class="xref" href="runtime-config-wal.html#GUC-COMMIT-DELAY">commit_delay</a> также выглядит очень похоже на асинхронное подтверждение транзакций, но по сути это является методом синхронного подтверждения транзакций (фактически, во время асинхронных транзакций <code class="varname">commit_delay</code> игнорируется). <code class="varname">commit_delay</code> приводит к задержке только перед тем, как синхронная транзакция пытается записать данные <acronym class="acronym">WAL</acronym> на диск, в надежде, что одиночная запись, выполняемая на одну такую транзакцию, сможет также обслужить другие транзакции, которые подтверждаются приблизительно в это же время. Установку этого параметра можно рассматривать как способ увеличения промежутка времени, в течение которого транзакции группируются для единовременной записи на диск. Это распределяет стоимость записи между несколькими транзакциями.</p></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="wal-intro.html" title="30.3. Журнал предзаписи (WAL)">Пред.</a> </td><td width="20%" align="center"><a accesskey="u" href="wal.html" title="Глава 30. Надёжность и журнал предзаписи">Наверх</a></td><td width="40%" align="right"> <a accesskey="n" href="wal-configuration.html" title="30.5. Настройка WAL">След.</a></td></tr><tr><td width="40%" align="left" valign="top">30.3. Журнал предзаписи (<acronym class="acronym">WAL</acronym>) </td><td width="20%" align="center"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="40%" align="right" valign="top"> 30.5. Настройка <acronym class="acronym">WAL</acronym></td></tr></table></div></body></html>