<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>34.8. Интерфейс быстрого пути</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@lists.postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets Vsnapshot" /><link rel="prev" href="libpq-cancel.html" title="34.7. Отмена запросов в процессе выполнения" /><link rel="next" href="libpq-notify.html" title="34.9. Асинхронное уведомление" /></head><body id="docContent" class="container-fluid col-10"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="5" align="center">34.8. Интерфейс быстрого пути</th></tr><tr><td width="10%" align="left"><a accesskey="p" href="libpq-cancel.html" title="34.7. Отмена запросов в процессе выполнения">Пред.</a> </td><td width="10%" align="left"><a accesskey="u" href="libpq.html" title="Глава 34. libpq — библиотека для языка C">Наверх</a></td><th width="60%" align="center">Глава 34. <span class="application">libpq</span> — библиотека для языка C</th><td width="10%" align="right"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="10%" align="right"> <a accesskey="n" href="libpq-notify.html" title="34.9. Асинхронное уведомление">След.</a></td></tr></table><hr /></div><div class="sect1" id="LIBPQ-FASTPATH"><div class="titlepage"><div><div><h2 class="title" style="clear: both">34.8. Интерфейс быстрого пути <a href="#LIBPQ-FASTPATH" class="id_link">#</a></h2></div></div></div><a id="id-1.7.3.15.2" class="indexterm"></a><p><span class="productname">PostgreSQL</span> предоставляет интерфейс для передачи серверу простых вызовов функций по быстрому пути.</p><div class="tip"><h3 class="title">Подсказка</h3><p>Этот интерфейс несколько устарел, поскольку можно достичь подобной производительности и большей функциональности путём создания подготовленного оператора, определяющего вызов функции. Последующее выполнение этого оператора с передачей параметров и результатов в двоичном виде можно считать заменой вызову по быстрому пути.</p></div><p>Функция <code class="function" id="LIBPQ-PQFN">PQfn</code><a id="id-1.7.3.15.5.2" class="indexterm"></a> запрашивает выполнение серверной функции посредством интерфейса быстрого доступа: </p><pre class="synopsis">
PGresult *PQfn(PGconn *conn,
               int fnid,
               int *result_buf,
               int *result_len,
               int result_is_int,
               const PQArgBlock *args,
               int nargs);

typedef struct
{
    int len;
    int isint;
    union
    {
        int *ptr;
        int integer;
    } u;
} PQArgBlock;
</pre><p>Аргумент <em class="parameter"><code>fnid</code></em> представляет собой OID функции, которая подлежит выполнению. <em class="parameter"><code>args</code></em> и <em class="parameter"><code>nargs</code></em> определяют параметры, которые должны быть переданы этой функции; они должны соответствовать списку аргументов объявленной функции. Когда поле <em class="parameter"><code>isint</code></em> структуры, передаваемой в качестве параметра, имеет значение true, тогда значение <em class="parameter"><code>u.integer</code></em> передаётся серверу в виде целого числа указанной длины (это должно быть 2 или 4 байта); при этом устанавливается нужный порядок байтов. Когда <em class="parameter"><code>isint</code></em> имеет значение false, тогда указанное число байт по адресу <em class="parameter"><code>*u.ptr</code></em> отправляется без какой-либо обработки; данные должны быть представлены в формате, которого ожидает сервер для передачи в двоичном виде данных того типа, что и аргументы функции. (Объявление поля <em class="parameter"><code>u.ptr</code></em>, как имеющего тип <code class="type">int *</code>, является историческим; было бы лучше рассматривать его как тип <code class="type">void *</code>.) <em class="parameter"><code>result_buf</code></em> указывает на буфер, в который должно быть помещено возвращаемое значение функции. Вызывающий код должен выделить достаточное место для сохранения возвращаемого значения. (Это никак не проверяется!) Фактическая длина результирующего значения в байтах будет возвращена в переменной целого типа, на которую указывает <em class="parameter"><code>result_len</code></em>. Если ожидается получение двух- или четырёхбайтового целочисленного результата, то присвойте параметру <em class="parameter"><code>result_is_int</code></em> значение 1, в противном случае назначьте ему 0. Когда параметр <em class="parameter"><code>result_is_int</code></em> равен 1, <span class="application">libpq</span> переставляет байты в передаваемом значении, если это необходимо, так, чтобы оно было доставлено на клиентскую машину в виде правильного значения типа <code class="type">int</code>; обратите внимание, что по адресу <em class="parameter"><code>*result_buf</code></em> доставляется четырёхбайтовое целое для любого допустимого размера результата. Когда <em class="parameter"><code>result_is_int</code></em> равен 0, тогда строка байтов в двоичном формате, отправленная сервером, будет возвращена немодифицированной. (В этом случае лучше рассматривать <em class="parameter"><code>result_buf</code></em> как имеющий тип <code class="type">void *</code>.)</p><p><code class="function">PQfn</code> всегда возвращает действительный указатель на объект <code class="structname">PGresult</code> со статусом <code class="literal">PGRES_COMMAND_OK</code> при успешном выполнении функции или <code class="literal">PGRES_FATAL_ERROR</code>, если произошла какая-то ошибка. Перед использованием результата нужно сначала проверить его статус. Вызывающая функция отвечает за освобождение памяти, занимаемой объектом <code class="structname">PGresult</code>, когда он больше не нужен, с помощью <a class="xref" href="libpq-exec.html#LIBPQ-PQCLEAR"><code class="function">PQclear</code></a>.</p><p>Чтобы передать функции аргумент NULL, запишите в поле <em class="parameter"><code>len</code></em> этой структуры значение <code class="literal">-1</code>; поля <em class="parameter"><code>isint</code></em> и <em class="parameter"><code>u</code></em> в этом случае не важны.</p><p>Если функция возвращает NULL, в <em class="parameter"><code>*result_len</code></em> записывается <code class="literal">-1</code>, а <em class="parameter"><code>*result_buf</code></em> не изменяется.</p><p>Обратите внимание, что при использовании этого интерфейса невозможно обработать множества значений в результате. Кроме того, функция должна быть обычной функцией, а не процедурой, агрегатной или оконной функцией.</p></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="libpq-cancel.html" title="34.7. Отмена запросов в процессе выполнения">Пред.</a> </td><td width="20%" align="center"><a accesskey="u" href="libpq.html" title="Глава 34. libpq — библиотека для языка C">Наверх</a></td><td width="40%" align="right"> <a accesskey="n" href="libpq-notify.html" title="34.9. Асинхронное уведомление">След.</a></td></tr><tr><td width="40%" align="left" valign="top">34.7. Отмена запросов в процессе выполнения </td><td width="20%" align="center"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="40%" align="right" valign="top"> 34.9. Асинхронное уведомление</td></tr></table></div></body></html>