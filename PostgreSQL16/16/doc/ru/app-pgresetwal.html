<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>pg_resetwal</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@lists.postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets Vsnapshot" /><link rel="prev" href="app-pg-ctl.html" title="pg_ctl" /><link rel="next" href="app-pgrewind.html" title="pg_rewind" /></head><body id="docContent" class="container-fluid col-10"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="5" align="center"><span class="application">pg_resetwal</span></th></tr><tr><td width="10%" align="left"><a accesskey="p" href="app-pg-ctl.html" title="pg_ctl">Пред.</a> </td><td width="10%" align="left"><a accesskey="u" href="reference-server.html" title="Серверные приложения PostgreSQL">Наверх</a></td><th width="60%" align="center">Серверные приложения PostgreSQL</th><td width="10%" align="right"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="10%" align="right"> <a accesskey="n" href="app-pgrewind.html" title="pg_rewind">След.</a></td></tr></table><hr /></div><div class="refentry" id="APP-PGRESETWAL"><div class="titlepage"></div><a id="id-1.9.5.8.1" class="indexterm"></a><div class="refnamediv"><h2><span class="refentrytitle"><span class="application">pg_resetwal</span></span></h2><p>pg_resetwal — очистить журнал предзаписи и другую управляющую информацию кластера <span class="productname">PostgreSQL</span></p></div><div class="refsynopsisdiv"><h2>Синтаксис</h2><div class="cmdsynopsis"><p id="id-1.9.5.8.4.1"><code class="command">pg_resetwal</code> [ <code class="option">-f</code>  |   <code class="option">--force</code> ] [ <code class="option">-n</code>  |   <code class="option">--dry-run</code> ] [<em class="replaceable"><code>параметр</code></em>...]  [ <code class="option">-D</code>  |   <code class="option">--pgdata</code> ]<em class="replaceable"><code>каталог_данных</code></em> </p></div></div><div class="refsect1" id="R1-APP-PGRESETWAL-1"><h2>Описание</h2><p><code class="command">pg_resetwal</code> очищает журнал предзаписи (WAL) и может сбросить некоторую другую управляющую информацию, хранящуюся в файле <code class="filename">pg_control</code>. Данная функция может быть востребована при повреждении этих файлов. Использовать её нужно только как крайнюю меру, когда запуск сервера оказывается невозможен из-за этого повреждения.</p><p>После выполнения этой команды запуск сервера, скорее всего, будет возможен, однако стоит учитывать, что база данных может содержать несогласованные данные из-за транзакций, зафиксированных частично. Вы должны немедленно выгрузить данные, выполнить <code class="command">initdb</code>, а затем восстановить данные. После этого проверьте целостность базы и внесите необходимые коррективы.</p><p>Эту утилиту может запускать только пользователь, установивший сервер, так как ей нужны права записи/чтения в каталоге хранения данных кластера. В целях безопасности каталог необходимо указывать в командной строке. <code class="command">pg_resetwal</code> не поддерживает переменную окружения <code class="envar">PGDATA</code>.</p><p>Если <code class="command">pg_resetwal</code> сообщает о невозможности определить данные из <code class="filename">pg_control</code>, команду можно запустить принудительно, указав <code class="option">-f</code>. В этом случае будут использованы наиболее вероятные значения. Они должны подходить для большинства полей, но для некоторых может потребоваться задать нужные значения явно: следующее значение OID, ID и эпоха следующей транзакции, ID мультитранзакции и смещение, начальная позиция WAL. Эти значения можно указать с помощью описанных далее параметров. Если их невозможно определить, то флаг <code class="option">f</code> позволяет это обойти. Однако достоверность данных восстановленной базы не гарантируется: крайне необходимо незамедлительно выгрузить и затем восстановить данные. <span class="emphasis"><em>Не</em></span> выполняйте никаких операций модификации до создания дампа данных, так как это может привести к ещё более печальным последствиям.</p></div><div class="refsect1" id="id-1.9.5.8.6"><h2>Параметры</h2><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="option">-f</code><br /></span><span class="term"><code class="option">--force</code></span></dt><dd><p>Принудительно выполнять <code class="command">pg_resetwal</code>, даже если не удаётся получить приемлемые данные из <code class="filename">pg_control</code>, как описано выше.</p></dd><dt><span class="term"><code class="option">-n</code><br /></span><span class="term"><code class="option">--dry-run</code></span></dt><dd><p>С ключом <code class="option">-n</code>/<code class="option">--dry-run</code> команда <code class="command">pg_resetwal</code> отображает значения, извлечённые из <code class="filename">pg_control</code>, а также значения, которые планируется изменить, и завершается, не внося никаких изменений. Это, прежде всего, средство отладки, хотя оно может быть полезно и для того, чтобы проверить корректность параметров, прежде чем <code class="command">pg_resetwal</code> начнёт что-либо делать.</p></dd><dt><span class="term"><code class="option">-V</code><br /></span><span class="term"><code class="option">--version</code></span></dt><dd><p>Показать версию, а затем завершиться.</p></dd><dt><span class="term"><code class="option">-?</code><br /></span><span class="term"><code class="option">--help</code></span></dt><dd><p>Показать справку, а затем завершиться.</p></dd></dl></div><p>Следующие параметры необходимы, только когда <code class="command">pg_resetwal</code> не может определить подходящие значения, прочитав <code class="filename">pg_control</code>. Безопасные значения можно определить, как описано ниже. Для значений, принимающих числовые аргументы, можно задать шестнадцатеричные значения, добавив префикс <code class="literal">0x</code>.</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="option">-c <em class="replaceable"><code>xid</code></em>,<em class="replaceable"><code>xid</code></em></code><br /></span><span class="term"><code class="option">--commit-timestamp-ids=<em class="replaceable"><code>xid</code></em>,<em class="replaceable"><code>xid</code></em></code></span></dt><dd><p>Вручную задать идентификаторы старейшей и новейшей транзакций, для которых можно получить время фиксации.</p><p>Безопасное значение идентификатора старейшей транзакции, для которой можно получить время фиксации (первый компонент), можно определить, найдя наименьшее в числовом виде имя файла в каталоге <code class="filename">pg_commit_ts</code> внутри каталога данных. Безопасное значение идентификатора новейшей транзакции, для которой можно получить время фиксации (второй компонент), можно определить, найдя, напротив, наибольшее в числовом виде имя файла в том же каталоге. Числа в именах этих файлов представлены в шестнадцатеричном формате.</p></dd><dt><span class="term"><code class="option">-e <em class="replaceable"><code>эпоха_xid</code></em></code><br /></span><span class="term"><code class="option">--epoch=<em class="replaceable"><code>эпоха_xid</code></em></code></span></dt><dd><p>Вручную задать эпоху в ID следующей транзакции.</p><p>Эпоха идентификаторов транзакции не хранится в базе данных нигде, кроме поля, устанавливаемого командой <code class="command">pg_resetwal</code>, поэтому если рассматривать собственно базу, допустимым будет любое значение. Это значение, возможно, понадобится скорректировать для обеспечения правильной работы системы репликации, например, <span class="application">Slony-I</span> и <span class="application">Skytools</span>. В этом случае подходящее значение следует получить из состояния нижележащей реплицированной базы данных.</p></dd><dt><span class="term"><code class="option">-l <em class="replaceable"><code>walfile</code></em></code><br /></span><span class="term"><code class="option">--next-wal-file=<em class="replaceable"><code>walfile</code></em></code></span></dt><dd><p>Вручную задать начальную позицию WAL, указав имя файла следующего сегмента WAL.</p><p>Имя файла следующего сегмента WAL должно превышать имена любых других файлов сегментов WAL, в настоящее время находящихся в подкаталоге <code class="filename">pg_wal</code> каталога данных. Эти имена тоже представлены в шестнадцатеричном виде и состоят из трёх частей. Первая из них — <span class="quote">«<span class="quote">ID линии времени</span>»</span> и её обычно не следует менять. Например, если <code class="filename">00000001000000320000004A</code> — наибольшее значение в <code class="filename">pg_wal</code>, нужно указать <code class="literal">-l 00000001000000320000004B</code> или большее число.</p><p>Заметьте, что при использовании нестандартных размеров сегментов WAL числа в именах файлов WAL отличаются от LSN, выдаваемых системными функциями и представлениями. Этот параметр принимает имя файла WAL, а не LSN.</p><div class="note"><h3 class="title">Примечание</h3><p><code class="command">pg_resetwal</code> ищет среди файлов каталога <code class="filename">pg_wal</code>, и по умолчанию выбирает значение для флага <code class="option">-l</code>, идущее следующим после найденного. Таким образом, вручную задавать параметр <code class="option">-l</code> нужно лишь если известно о существовании сегментов WAL, отсутствующих в настоящий момент в каталоге <code class="filename">pg_wal</code> (например, они могут находится в отдельном архиве); либо если содержимое <code class="filename">pg_wal</code> было полностью утеряно.</p></div></dd><dt><span class="term"><code class="option">-m <em class="replaceable"><code>mxid</code></em>,<em class="replaceable"><code>mxid</code></em></code><br /></span><span class="term"><code class="option">--multixact-ids=<em class="replaceable"><code>mxid</code></em>,<em class="replaceable"><code>mxid</code></em></code></span></dt><dd><p>Вручную задать ID следующей и старейшей мультитранзакции.</p><p>Безопасное значение следующего идентификатора мультитранзакции (первый компонент) можно вычислить, найдя наибольшее числовое значение среди имён файлов, расположенных в каталоге <code class="filename">pg_multixact/offsets</code>. К найденному значению необходимо прибавить один, затем умножить на 65536 (0x10000). Для вычисления безопасного значения ID старейшей мультитранзакции (второй компонент <code class="option">-m</code>) необходимо найти наименьшее числовое значение среди тех же файлов, и умножить его на 65536. Имена файлов представляются в шестнадцатеричном формате, так что значения проще указывать в нём же, добавив в конце четыре нуля.</p></dd><dt><span class="term"><code class="option">-o <em class="replaceable"><code>oid</code></em></code><br /></span><span class="term"><code class="option">--next-oid=<em class="replaceable"><code>oid</code></em></code></span></dt><dd><p>Вручную задать следующий OID.</p><p>Не существует относительно простого способа вычисления следующего за наибольшим из существующих значением OID, однако это некритично.</p></dd><dt><span class="term"><code class="option">-O <em class="replaceable"><code>mxoff</code></em></code><br /></span><span class="term"><code class="option">--multixact-offset=<em class="replaceable"><code>mxoff</code></em></code></span></dt><dd><p>Вручную задать смещение следующей мультитранзакции.</p><p>Безопасное значение можно определить, найдя наибольшее числовое значение в имени файла в каталоге <code class="filename">pg_multixact/members</code>, прибавив один и умножив результат на 52352 (0xCC80). Имена файлов представлены в шестнадцатеричном формате. Простого рецепта с прибавлением нулей в конце, как для других параметров, в данном случае нет.</p></dd><dt><span class="term"><code class="option">--wal-segsize=<em class="replaceable"><code>размер_сегмента_wal</code></em></code></span></dt><dd><p>Задать другой размер сегмента WAL, в мегабайтах. Значение параметра должно быть степенью 2 от 1 до 1024 (в мегабайтах). Подробнее о нём можно узнать в описании такого же параметра <a class="xref" href="app-initdb.html" title="initdb"><span class="refentrytitle"><span class="application">initdb</span></span></a>.</p><div class="note"><h3 class="title">Примечание</h3><p>Хотя <code class="command">pg_resetwal</code> выбирает стартовый адрес WAL, превышающий номер последнего существующего файла сегмента WAL, при некоторых изменениях размера предыдущие имена файлов WAL могут использоваться повторно. Если наложение имён файлов WAL приведёт к проблемам с вашей стратегией архивации, рекомендуется использовать <code class="option">-l</code> вместе с этим ключом, чтобы вручную задать начальный адрес WAL.</p></div></dd><dt><span class="term"><code class="option">-u <em class="replaceable"><code>xid</code></em></code><br /></span><span class="term"><code class="option">--oldest-transaction-id=<em class="replaceable"><code>xid</code></em></code></span></dt><dd><p>Вручную задать ID старейшей незамороженной транзакции.</p><p>Безопасное значение можно определить, найдя наименьшее числовое значение в имени файла в подкаталоге <code class="filename">pg_xact</code> каталога данных, а затем умножив результат на 1048576 (0x100000). Заметьте, что имена файлов представлены в шестнадцатеричном формате. Значение этого параметра обычно также проще задавать в шестнадцатеричном виде. Например, если <code class="filename">0007</code> — наименьшее значение в <code class="filename">pg_xact</code>, подходящим значением будет <code class="literal">-u 0x700000</code> (нужный множитель дают пять последних нулей).</p></dd><dt><span class="term"><code class="option">-x <em class="replaceable"><code>xid</code></em></code><br /></span><span class="term"><code class="option">--next-transaction-id=<em class="replaceable"><code>xid</code></em></code></span></dt><dd><p>Вручную задать ID следующей транзакции.</p><p>Безопасное значение можно определить, найдя наибольшее числовое значение в имени файла в подкаталоге <code class="filename">pg_xact</code> каталога данных, прибавив один и умножив результат на 1048576 (0x100000). Заметьте, что имена файлов представлены в шестнадцатеричном формате. Значение этого параметра обычно также проще задавать в шестнадцатеричном виде. Например, если <code class="filename">0011</code> — наибольшее значение в <code class="filename">pg_xact</code>, подходящим значением будет <code class="literal">-x 0x1200000</code> (нужный множитель дают пять последних нулей).</p></dd></dl></div></div><div class="refsect1" id="id-1.9.5.8.7"><h2>Переменные окружения</h2><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="envar">PG_COLOR</code></span></dt><dd><p>Выбирает вариант использования цвета в диагностических сообщениях. Возможные значения: <code class="literal">always</code> (всегда), <code class="literal">auto</code> (автоматически) и <code class="literal">never</code> (никогда).</p></dd></dl></div></div><div class="refsect1" id="id-1.9.5.8.8"><h2>Замечания</h2><p>Эту команду нельзя выполнять на работающем сервере. <code class="command">pg_resetwal</code> отклонит выполнение при обнаруженном блокирующем файле в каталоге хранения данных. Иногда при аварии сервера блокирующий файл может остаться в системе. В этом случае необходимо самостоятельно удалить его, чтобы дать возможность <code class="command">pg_resetwal</code> отработать. Перед выполнением операции дважды проверьте, что сервер остановлен.</p><p><code class="command">pg_resetwal</code> работает только с серверами той же основной версии.</p></div><div class="refsect1" id="id-1.9.5.8.9"><h2>См. также</h2><span class="simplelist"><a class="xref" href="app-pgcontroldata.html" title="pg_controldata"><span class="refentrytitle"><span class="application">pg_controldata</span></span></a></span></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="app-pg-ctl.html" title="pg_ctl">Пред.</a> </td><td width="20%" align="center"><a accesskey="u" href="reference-server.html" title="Серверные приложения PostgreSQL">Наверх</a></td><td width="40%" align="right"> <a accesskey="n" href="app-pgrewind.html" title="pg_rewind">След.</a></td></tr><tr><td width="40%" align="left" valign="top"><span class="application">pg_ctl</span> </td><td width="20%" align="center"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="40%" align="right" valign="top"> <span class="application">pg_rewind</span></td></tr></table></div></body></html>