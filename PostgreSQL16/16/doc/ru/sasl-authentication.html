<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>55.3. Аутентификация SASL</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@lists.postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets Vsnapshot" /><link rel="prev" href="protocol-flow.html" title="55.2. Поток сообщений" /><link rel="next" href="protocol-replication.html" title="55.4. Протокол потоковой репликации" /></head><body id="docContent" class="container-fluid col-10"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="5" align="center">55.3. Аутентификация SASL</th></tr><tr><td width="10%" align="left"><a accesskey="p" href="protocol-flow.html" title="55.2. Поток сообщений">Пред.</a> </td><td width="10%" align="left"><a accesskey="u" href="protocol.html" title="Глава 55. Клиент-серверный протокол">Наверх</a></td><th width="60%" align="center">Глава 55. Клиент-серверный протокол</th><td width="10%" align="right"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="10%" align="right"> <a accesskey="n" href="protocol-replication.html" title="55.4. Протокол потоковой репликации">След.</a></td></tr></table><hr /></div><div class="sect1" id="SASL-AUTHENTICATION"><div class="titlepage"><div><div><h2 class="title" style="clear: both">55.3. Аутентификация SASL <a href="#SASL-AUTHENTICATION" class="id_link">#</a></h2></div></div></div><div class="toc"><dl class="toc"><dt><span class="sect2"><a href="sasl-authentication.html#SASL-SCRAM-SHA-256">55.3.1. Аутентификация SCRAM-SHA-256</a></span></dt></dl></div><p><em class="firstterm">SASL</em> — это инфраструктура аутентификации для протоколов, ориентированных на соединения. На данный момент <span class="productname">PostgreSQL</span> реализует два механизма SASL: SCRAM-SHA-256 и SCRAM-SHA-256-PLUS, а в будущем могут появиться и другие. Далее описывается, как в принципе осуществляется аутентификация SASL, а в следующем подразделе более подробно рассматриваются SCRAM-SHA-256 и SCRAM-SHA-256-PLUS.</p><div class="procedure" id="id-1.10.6.8.3"><p class="title"><strong>Поток сообщений аутентификации SASL</strong></p><ol class="procedure" type="1"><li class="step" id="SASL-AUTH-BEGIN"><p>Чтобы начать обмен по схеме аутентификации SASL, сервер передаёт сообщение AuthenticationSASL. Оно содержит список механизмов аутентификации SASL, с которыми может работать сервер, в порядке предпочтений сервера.</p></li><li class="step" id="SASL-AUTH-INITIAL-RESPONSE"><p>Клиент выбирает один из поддерживаемых механизмов из списка и передаёт серверу сообщение SASLInitialResponse. Это сообщение содержит имя выбранного механизма и может содержать «Начальный ответ клиента», если это использует выбранный механизм.</p></li><li class="step" id="SASL-AUTH-CONTINUE"><p>За этим следует одно или нескольких сообщений вызова со стороны сервера и ответов со стороны клиента. Все вызовы сервер передаёт в сообщениях AuthenticationSASLContinue, а клиент отвечает на них сообщениями SASLResponse. Частные детали сообщений зависят от конкретного механизма.</p></li><li class="step" id="SASL-AUTH-END"><p>Наконец, когда обмен аутентификационной информацией заканчивается успешно, сервер передаёт сообщение AuthenticationSASLFinal и сразу за ним сообщение AuthenticationOk. В сообщении AuthenticationSASLFinal передаются дополнительные данные от сервера клиенту, содержимое которых определяется выбранным механизмом аутентификации. Если механизм аутентификации не требует передавать дополнительные данные в завершение обмена, сообщение AuthenticationSASLFinal опускается.</p></li></ol></div><p>В случае ошибки сервер может прервать процесс аутентификации на любом этапе и передать сообщение ErrorMessage.</p><div class="sect2" id="SASL-SCRAM-SHA-256"><div class="titlepage"><div><div><h3 class="title">55.3.1. Аутентификация SCRAM-SHA-256 <a href="#SASL-SCRAM-SHA-256" class="id_link">#</a></h3></div></div></div><p>На данный момент реализованы два механизма SASL: <code class="literal">SCRAM-SHA-256</code> и его вариация со связыванием каналов, <code class="literal">SCRAM-SHA-256-PLUS</code>. Они подробно описываются в <a class="ulink" href="https://datatracker.ietf.org/doc/html/rfc7677" target="_top">RFC 7677</a> и <a class="ulink" href="https://datatracker.ietf.org/doc/html/rfc5802" target="_top">RFC 5802</a>.</p><p>Когда в PostgreSQL задействуется SCRAM-SHA-256, сервер игнорирует имя пользователя, которое клиент передаёт в <code class="structname">client-first-message</code>. Вместо этого используется имя, переданное ранее в стартовом сообщении. Согласно спецификации SCRAM, имя пользователя должно быть в UTF-8, но <span class="productname">PostgreSQL</span> поддерживает разные кодировки символов, и значит, имя пользователя PostgreSQL не всегда будет представимо в UTF-8.</p><p>В спецификации SCRAM говорится, что пароль также должен передаваться в UTF-8 и обрабатываться алгоритмом <em class="firstterm">SASLprep</em>. Однако <span class="productname">PostgreSQL</span> не требует, чтобы пароль представлялся в UTF-8. Когда устанавливается пароль пользователя, он обрабатывается алгоритмом SASLprep как пароль в UTF-8, вне зависимости от фактической кодировки. Однако если он представлен недопустимой для UTF-8 последовательностью байтов либо содержит комбинации байтов UTF-8, которые не принимает алгоритм SASLprep, это не будет считаться ошибкой — при аутентификации будет использоваться исходный пароль, без обработки SASLprep. Это позволяет нормализовать пароли, представленные в UTF-8, и при этом использовать пароли не в UTF-8, а также не требует, чтобы система знала, в какой кодировке задан пароль.</p><p><em class="firstterm">Связывание каналов</em> поддерживается в PostgreSQL при сборке с использованием SSL. Для SCRAM со связыванием каналов в качестве имени механизма SASL выбрано <code class="literal">SCRAM-SHA-256-PLUS</code>. PostgreSQL использует тип связывания <code class="literal">tls-server-end-point</code>.</p><p>В <acronym class="acronym">SCRAM</acronym> без связывания каналов сервер выбирает случайное число, которое передаётся клиенту для смешивания с введённым пользователем паролем и получения передаваемого в ответ хеша. Хотя это препятствует повторному воспроизведению пароля в последующем сеансе, поддельный сервер между настоящим сервером и клиентом может прозрачно передать случайное число сервера и затем успешно пройти аутентификацию.</p><p><acronym class="acronym">SCRAM</acronym> со связыванием каналов позволяет предотвратить такие атаки посредника, подмешивая подпись сертификата сервера в передаваемый хеш пароля. Хотя поддельный сервер может повторить передачу сертификата настоящего сервера, у него не будет доступа к закрытому ключу, соответствующему этому сертификату, поэтому он не сможет подтвердить, что является его владельцем, и, как следствие, установить SSL-соединение.</p><div class="procedure" id="id-1.10.6.8.5.8"><p class="title"><strong>Пример</strong></p><ol class="procedure" type="1"><li class="step" id="SCRAM-BEGIN"><p>Сервер передаёт сообщение AuthenticationSASL. Оно содержит список механизмов аутентификации SASL, с которыми может работать сервер. Этот список будет включать <code class="literal">SCRAM-SHA-256-PLUS</code> и <code class="literal">SCRAM-SHA-256</code>, если сервер собран с поддержкой SSL, а иначе — только последнее значение.</p></li><li class="step" id="SCRAM-CLIENT-FIRST"><p>Клиент в ответ передаёт сообщение SASLInitialResponse, информирующее о выбранном механизме, <code class="literal">SCRAM-SHA-256</code> или <code class="literal">SCRAM-SHA-256-PLUS</code>. (Клиент волен выбрать любой механизм, но для большей безопасности следует выбирать вариацию со связыванием каналов, если он это поддерживает.) В поле «Начальный ответ клиента» это сообщение содержит данные SCRAM <code class="structname">client-first-message</code>. В <code class="structname">client-first-message</code> содержится тип связывания каналов, выбранный клиентом.</p></li><li class="step" id="SCRAM-SERVER-FIRST"><p>Сервер передаёт сообщение AuthenticationSASLContinue, содержащее данные SCRAM <code class="structname">server-first-message</code>.</p></li><li class="step" id="SCRAM-CLIENT-FINAL"><p>Клиент передаёт сообщение SASLResponse, содержащее данные SCRAM <code class="structname">client-final-message</code>.</p></li><li class="step" id="SCRAM-SERVER-FINAL"><p>Сервер передаёт сообщение AuthenticationSASLFinal, содержащее данные SCRAM <code class="structname">server-final-message</code>, и сразу за ним сообщение AuthenticationOk.</p></li></ol></div></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="protocol-flow.html" title="55.2. Поток сообщений">Пред.</a> </td><td width="20%" align="center"><a accesskey="u" href="protocol.html" title="Глава 55. Клиент-серверный протокол">Наверх</a></td><td width="40%" align="right"> <a accesskey="n" href="protocol-replication.html" title="55.4. Протокол потоковой репликации">След.</a></td></tr><tr><td width="40%" align="left" valign="top">55.2. Поток сообщений </td><td width="20%" align="center"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="40%" align="right" valign="top"> 55.4. Протокол потоковой репликации</td></tr></table></div></body></html>