<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>pg_verifybackup</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@lists.postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets Vsnapshot" /><link rel="prev" href="app-pgrestore.html" title="pg_restore" /><link rel="next" href="app-psql.html" title="psql" /></head><body id="docContent" class="container-fluid col-10"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="5" align="center"><span class="application">pg_verifybackup</span></th></tr><tr><td width="10%" align="left"><a accesskey="p" href="app-pgrestore.html" title="pg_restore">Пред.</a> </td><td width="10%" align="left"><a accesskey="u" href="reference-client.html" title="Клиентские приложения PostgreSQL">Наверх</a></td><th width="60%" align="center">Клиентские приложения PostgreSQL</th><td width="10%" align="right"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="10%" align="right"> <a accesskey="n" href="app-psql.html" title="psql">След.</a></td></tr></table><hr /></div><div class="refentry" id="APP-PGVERIFYBACKUP"><div class="titlepage"></div><a id="id-1.9.4.19.1" class="indexterm"></a><div class="refnamediv"><h2><span class="refentrytitle"><span class="application">pg_verifybackup</span></span></h2><p>pg_verifybackup — проверить целостность базовой копии кластера <span class="productname">PostgreSQL</span></p></div><div class="refsynopsisdiv"><h2>Синтаксис</h2><div class="cmdsynopsis"><p id="id-1.9.4.19.4.1"><code class="command">pg_verifybackup</code> [<em class="replaceable"><code>параметр</code></em>...]</p></div></div><div class="refsect1" id="id-1.9.4.19.5"><h2>Описание</h2><p><span class="application">pg_verifybackup</span> позволяет проверить целостность копии кластера БД, сделанной программой <code class="command">pg_basebackup</code>, по манифесту <code class="literal">backup_manifest</code>, созданному во время копирования. Копия должна быть представлена в формате «plain»; чтобы проверить копию в формате «tar», её нужно сначала разархивировать.</p><p>Важно отметить, что процедура контроля, выполняемая программой <span class="application">pg_verifybackup</span> не включает и не может включать в себя все проверки, которые будет выполнять сервер, если его запустить с этой копией. Даже если вы пользуетесь этим средством, вам всё же следует выполнять тестовое восстановление данных, чтобы убедиться в том, что восстановленные базы работают ожидаемым образом и содержат нужные данные. Тем не менее <span class="application">pg_verifybackup</span> может быстро выявить множество распространённых проблем, вызываемых неисправностью хранилища или ошибками пользователя.</p><p>Проверка копии выполняется в четыре этапа. На первом этапе <code class="literal">pg_verifybackup</code> читает файл <code class="literal">backup_manifest</code>. Если этот файл не существует, неправильно оформлен или не соответствует контрольной сумме, которая в нём содержится, <code class="literal">pg_verifybackup</code> завершает выполнение с критической ошибкой.</p><p>На втором этапе <code class="literal">pg_verifybackup</code> проверяет, что файлы данных, находящиеся на диске в настоящее время, в точностью совпадают с теми файлами, которые сервер должен был передать, за несколькими исключениями, описанными ниже. При этом выявляются все пропавшие или добавившиеся файлы, кроме некоторых игнорируемых. В частности, на этом этапе не принимается во внимание присутствие, отсутствие или какое-либо изменение файлов <code class="literal">postgresql.auto.conf</code>, <code class="literal">standby.signal</code> и <code class="literal">recovery.signal</code>, так как ожидается, что эти файлы могут создаваться или модифицироваться в процессе создания копии. Также из рассмотрения исключается файл <code class="literal">backup_manifest</code> в целевом каталоге и всё содержимое каталога <code class="literal">pg_wal</code>, несмотря на то, что эти файлы не будут описаны в манифесте копии. Проверяются только файлы; наличие или отсутствие каталогов контролируется только косвенно: если какой-либо каталог отсутствует, неизбежно будут отсутствовать и все файлы, которые должны в нём содержаться.</p><p>Затем <code class="literal">pg_verifybackup</code> проверяет контрольные суммы всех файлов, сравнивая их со значениями, указанными в манифесте, и выдаёт ошибки для файлов, у которых вычисленная контрольная сумма не совпадает с сохранённой в манифесте. Это действие не выполняется для файлов, вызвавших ошибки на предыдущем шаге, так как о проблемах с ними уже известно. Для файлов, которые игнорировались на втором этапе, контрольные суммы тоже не проверяются.</p><p>На последнем этапе <code class="literal">pg_verifybackup</code>, используя манифест, проверяет, имеются ли в журнале WAL все записи, необходимые для восстановления, и можно ли их успешно прочитать и разобрать. Файл <code class="literal">backup_manifest</code> содержит информацию о том, какие записи потребуются, благодаря чему <code class="literal">pg_verifybackup</code> может вызвать <code class="literal">pg_waldump</code>, чтобы разобрать и тем самым проверить эти записи журнала. При вызове программы <code class="literal">pg_waldump</code> передаётся флаг <code class="literal">--quiet</code>, так что она будет выдавать только ошибки, без каких-либо других сообщений. Хотя этот уровень проверки достаточен для выявления явных проблем, например, отсутствия файлов или несоответствия внутренних контрольных сумм, он всё же не даёт гарантию обнаружения всех проблем, которые могут возникнуть при попытке восстановления базы. Например, данный метод проверки бесполезен, если из-за внутренней ошибки сервера в WAL будут вноситься записи с правильными контрольными суммами, но бессмысленным содержимым.</p><p>Заметьте, что в случае наличия дополнительных файлов WAL, не требующихся для восстановления копии, они не будут проверяться этим средством, хотя проверить их можно, вызвать <code class="literal">pg_waldump</code> отдельно. Также учтите, что проверка WAL зависит от версии: для проверки целостности копии необходимо использовать ту версию <code class="literal">pg_verifybackup</code>, а значит и <code class="literal">pg_waldump</code>, с которой эта копия была получена. Проверки же целостности файлов должны работать с данными любой версии сервера, сформировавшего файл <code class="literal">backup_manifest</code>.</p></div><div class="refsect1" id="id-1.9.4.19.6"><h2>Параметры</h2><p>Утилита <span class="application">pg_verifybackup</span> принимает следующие аргументы командной строки: </p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="option">-e</code><br /></span><span class="term"><code class="option">--exit-on-error</code></span></dt><dd><p>Завершиться при первой же выявленной проблеме. В отсутствие этого указания <code class="literal">pg_verifybackup</code> продолжает проверку копии после обнаружения первой ошибки и сообщает обо всех ошибках.</p></dd><dt><span class="term"><code class="option">-i <em class="replaceable"><code>путь</code></em></code><br /></span><span class="term"><code class="option">--ignore=<em class="replaceable"><code>путь</code></em></code></span></dt><dd><p>Игнорировать указанный файл или каталог, который может быть задан относительным путём, при сравнении списка файлов данных, фактически присутствующих в копии, со списком в файле <code class="literal">backup_manifest</code>. Если указан путь к каталогу, из рассмотрения исключается всё дерево подкаталогов, начиная с указанного. В случае совпадения относительного пути файла с указанным никакие сообщения о дополнительных или пропавших файлах, а также об изменении размера или несовпадении контрольных сумм файлов, выдаваться не будут. Этот параметр можно задать несколько раз.</p></dd><dt><span class="term"><code class="option">-m <em class="replaceable"><code>путь</code></em></code><br /></span><span class="term"><code class="option">--manifest-path=<em class="replaceable"><code>путь</code></em></code></span></dt><dd><p>Использовать файл манифеста по заданному пути вместо файла, расположенного в корневом каталоге копии.</p></dd><dt><span class="term"><code class="option">-n</code><br /></span><span class="term"><code class="option">--no-parse-wal</code></span></dt><dd><p>Не пытаться разобрать данные журнала предзаписи, которые могут понадобиться для восстановления проверяемой копии.</p></dd><dt><span class="term"><code class="option">-P</code><br /></span><span class="term"><code class="option">--progress</code></span></dt><dd><p>Включает вывод сообщений о прогрессе. Эти сообщения будут выводиться при проверке контрольных сумм.</p><p>Этот параметр нельзя использовать с параметром <code class="option">--quiet</code>.</p></dd><dt><span class="term"><code class="option">-q</code><br /></span><span class="term"><code class="option">--quiet</code></span></dt><dd><p>Не выводить ничего, если копия проходит проверку успешно.</p></dd><dt><span class="term"><code class="option">-s</code><br /></span><span class="term"><code class="option">--skip-checksums</code></span></dt><dd><p>Не проверять контрольные суммы файлов данных. При этом тем не менее будет проверяться отсутствие или наличие файлов и их размеры. В таком режиме проверка выполняется гораздо быстрее, так как собственно содержимое файлов читать не требуется.</p></dd><dt><span class="term"><code class="option">-w <em class="replaceable"><code>путь</code></em></code><br /></span><span class="term"><code class="option">--wal-directory=<em class="replaceable"><code>путь</code></em></code></span></dt><dd><p>Проверять файлы WAL, находящиеся в указанном каталоге, а не в <code class="literal">pg_wal</code>. Это полезно, если архив WAL сохраняется отдельно от основного содержимого копии.</p></dd></dl></div><p>Другие флаги: </p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="option">-V</code><br /></span><span class="term"><code class="option">--version</code></span></dt><dd><p>Сообщить версию <span class="application">pg_verifybackup</span> и завершиться.</p></dd><dt><span class="term"><code class="option">-?</code><br /></span><span class="term"><code class="option">--help</code></span></dt><dd><p>Вывести справку об аргументах командной строки <span class="application">pg_verifybackup</span> и завершиться.</p></dd></dl></div></div><div class="refsect1" id="id-1.9.4.19.7"><h2>Примеры</h2><p>Создание базовой копии сервера <code class="literal">mydbserver</code> и проверка целостности копии: </p><pre class="screen">
<code class="prompt">$</code> <strong class="userinput"><code>pg_basebackup -h mydbserver -D /usr/local/pgsql/data</code></strong>
<code class="prompt">$</code> <strong class="userinput"><code>pg_verifybackup /usr/local/pgsql/data</code></strong>
</pre><p>Создание базовой копии сервера <code class="literal">mydbserver</code>, перемещение файла манифеста во внешний каталог и проверка копии: </p><pre class="screen">
<code class="prompt">$</code> <strong class="userinput"><code>pg_basebackup -h mydbserver -D /usr/local/pgsql/backup1234</code></strong>
<code class="prompt">$</code> <strong class="userinput"><code>mv /usr/local/pgsql/backup1234/backup_manifest /my/secure/location/backup_manifest.1234</code></strong>
<code class="prompt">$</code> <strong class="userinput"><code>pg_verifybackup -m /my/secure/location/backup_manifest.1234 /usr/local/pgsql/backup1234</code></strong>
</pre><p>Проверка копии с исключением файла, добавленного в каталог копии вручную, и без проверки контрольных сумм: </p><pre class="screen">
<code class="prompt">$</code> <strong class="userinput"><code>pg_basebackup -h mydbserver -D /usr/local/pgsql/data</code></strong>
<code class="prompt">$</code> <strong class="userinput"><code>edit /usr/local/pgsql/data/note.to.self</code></strong>
<code class="prompt">$</code> <strong class="userinput"><code>pg_verifybackup --ignore=note.to.self --skip-checksums /usr/local/pgsql/data</code></strong>
</pre></div><div class="refsect1" id="id-1.9.4.19.8"><h2>См. также</h2><span class="simplelist"><a class="xref" href="app-pgbasebackup.html" title="pg_basebackup"><span class="refentrytitle"><span class="application">pg_basebackup</span></span></a></span></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="app-pgrestore.html" title="pg_restore">Пред.</a> </td><td width="20%" align="center"><a accesskey="u" href="reference-client.html" title="Клиентские приложения PostgreSQL">Наверх</a></td><td width="40%" align="right"> <a accesskey="n" href="app-psql.html" title="psql">След.</a></td></tr><tr><td width="40%" align="left" valign="top"><span class="application">pg_restore</span> </td><td width="20%" align="center"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="40%" align="right" valign="top"> <span class="application">psql</span></td></tr></table></div></body></html>