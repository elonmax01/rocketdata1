<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>pg_rewind</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@lists.postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets Vsnapshot" /><link rel="prev" href="app-pgresetwal.html" title="pg_resetwal" /><link rel="next" href="pgtestfsync.html" title="pg_test_fsync" /></head><body id="docContent" class="container-fluid col-10"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="5" align="center"><span class="application">pg_rewind</span></th></tr><tr><td width="10%" align="left"><a accesskey="p" href="app-pgresetwal.html" title="pg_resetwal">Пред.</a> </td><td width="10%" align="left"><a accesskey="u" href="reference-server.html" title="Серверные приложения PostgreSQL">Наверх</a></td><th width="60%" align="center">Серверные приложения PostgreSQL</th><td width="10%" align="right"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="10%" align="right"> <a accesskey="n" href="pgtestfsync.html" title="pg_test_fsync">След.</a></td></tr></table><hr /></div><div class="refentry" id="APP-PGREWIND"><div class="titlepage"></div><a id="id-1.9.5.9.1" class="indexterm"></a><div class="refnamediv"><h2><span class="refentrytitle"><span class="application">pg_rewind</span></span></h2><p>pg_rewind — синхронизировать каталог данных <span class="productname">PostgreSQL</span> с другим каталогом, ответвлённым от него</p></div><div class="refsynopsisdiv"><h2>Синтаксис</h2><div class="cmdsynopsis"><p id="id-1.9.5.9.4.1"><code class="command">pg_rewind</code> [<em class="replaceable"><code>параметр</code></em>...]  { <code class="option">-D</code>  |   <code class="option">--target-pgdata</code> }<em class="replaceable"><code>каталог</code></em> { <code class="option">--source-pgdata=<em class="replaceable"><code>каталог</code></em></code>  |   <code class="option">--source-server=<em class="replaceable"><code>строка_подключения</code></em></code> } </p></div></div><div class="refsect1" id="id-1.9.5.9.5"><h2>Описание</h2><p>Утилита <span class="application">pg_rewind</span> представляет собой средство синхронизации кластера PostgreSQL с другой копией того же кластера после расхождения линий времени этих кластеров. Обычный сценарий её использования — вернуть в работу старый ведущий сервер после переключения на ведомый, в качестве ведомого для сервера, ставшего ведущим.</p><p>После успешной синхронизации состояние целевого каталога данных будет аналогично состоянию базовой копии исходного каталога. В отличие от создания новой копии или использования такого средства, как <span class="application">rsync</span>, синхронизация <span class="application">pg_rewind</span> не требует сравнения или копирования неизменённых блоков в кластере. Из существующих файлов отношений копируются только изменённые блоки, а все остальные файлы, включая новые файлы отношений, файлы конфигурации и сегменты WAL переносятся полностью. Благодаря этому такая синхронизация гораздо быстрее других методов, когда база данных большая, а различия между кластерами ограничиваются лишь небольшим количеством блоков.</p><p>Утилита <span class="application">pg_rewind</span> изучает истории линий времени исходного и целевого кластеров с целью найти точку, в которой они разошлись, и ожидает найти журналы WAL в каталоге <code class="filename">pg_wal</code> целевого кластера вплоть до точки расхождения. Точка расхождения может быть найдена на целевой или исходной линии времени либо в их общем предке. В типичном сценарии отработки отказа, когда целевой кластер отключается вскоре после расхождения, это не проблема, но если целевой кластер проработал долгое время после расхождения, старые файлы WAL могут быть уже удалены. В этом случае их можно вручную скопировать из архива WAL в каталог <code class="filename">pg_wal</code> или запустить <span class="application">pg_rewind</span> с ключом <code class="literal">-c</code>, чтобы они были автоматически получены из архива WAL. Варианты использования <span class="application">pg_rewind</span> не ограничиваются отработкой отказа; например, резервный сервер может быть повышен, выполнить несколько пишущих транзакций, а затем, после восстановления синхронизации, вновь стать резервным.</p><p>После выполнения <span class="application">pg_rewind</span> для приведения каталога данных в согласованное состояние должна завершиться процедура воспроизведения WAL. Когда целевой сервер запускается, он переходит в режим восстановления из архива и воспроизводит все изменения из WAL с исходного сервера, накопившиеся после последней контрольной точки с момента расхождения. Если какие-то сегменты WAL оказались недоступны на исходном сервере, когда выполнялась <span class="application">pg_rewind</span>, и поэтому не могли быть скопированы в ходе работы <span class="application">pg_rewind</span>, их необходимо предоставить, когда сервер будет запускаться. Это можно сделать, создав файл <code class="filename">recovery.signal</code> в целевом каталоге данных и определив подходящую команду <a class="xref" href="runtime-config-wal.html#GUC-RESTORE-COMMAND">restore_command</a> в <code class="filename">postgresql.conf</code>.</p><p>Утилита <span class="application">pg_rewind</span> требует, чтобы на целевом сервере был либо включён режим <a class="xref" href="runtime-config-wal.html#GUC-WAL-LOG-HINTS">wal_log_hints</a> в <code class="filename">postgresql.conf</code>, либо включены контрольные суммы, когда кластер был инициализирован командой <span class="application">initdb</span>. Оба эти режима по умолчанию отключены. Также должен быть включён режим <a class="xref" href="runtime-config-wal.html#GUC-FULL-PAGE-WRITES">full_page_writes</a>, но он по умолчанию включён.</p><div class="warning"><h3 class="title">Предупреждение: ошибки при синхронизации</h3><p>Если во время работы <span class="application">pg_rewind</span> происходит ошибка, вероятнее всего, целевой каталог данных будет в состоянии, не подходящем для восстановления. В этом случае рекомендуется сделать новую резервную копию.</p><p>Так как <span class="application">pg_rewind</span> копирует файлы конфигурации с исходного сервера без изменений, в полученную конфигурацию может потребоваться внести коррективы до перезапуска целевого сервера, особенно если целевой сервер становится ведомым для исходного. Если вы перезапустите сервер после окончания операции синхронизации, но не настроите команду восстановления WAL, целевой сервер может снова разойтись с ведущим.</p><p>Программа <span class="application">pg_rewind</span> немедленно прекращает работу, если обнаруживает файлы, непосредственная запись в которые невозможна. Это может иметь место, например, когда на исходном и целевом серверах совпадают пути файлов сертификатов и ключей SSL, доступных только для чтения. Если такие файлы существуют на целевом сервере, их рекомендуется удалить до запуска <span class="application">pg_rewind</span>. После выполнения синхронизации некоторые из таких файлов могут быть скопированы из источника и тогда может потребоваться удалить скопированные данные и восстановить ссылки/файлы, существовавшие до синхронизации.</p></div></div><div class="refsect1" id="id-1.9.5.9.6"><h2>Параметры</h2><p><span class="application">pg_rewind</span> принимает следующие аргументы командной строки: </p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="option">-D <em class="replaceable"><code>каталог</code></em></code><br /></span><span class="term"><code class="option">--target-pgdata=<em class="replaceable"><code>каталог</code></em></code></span></dt><dd><p>Этот параметр задаёт целевой каталог данных, который будет синхронизирован с источником. Целевой сервер должен быть отключён штатным образом до запуска <span class="application">pg_rewind</span></p></dd><dt><span class="term"><code class="option">--source-pgdata=<em class="replaceable"><code>каталог</code></em></code></span></dt><dd><p>Задаёт путь в файловой системе к каталогу данных исходного сервера, с которым будет синхронизироваться целевой. Для применения этого ключа исходный сервер должен быть остановлен штатным образом.</p></dd><dt><span class="term"><code class="option">--source-server=<em class="replaceable"><code>строка_подключения</code></em></code></span></dt><dd><p>Задаёт строку подключения libpq для подключения к исходному серверу <span class="productname">PostgreSQL</span>, с которым будет синхронизирован целевой. Подключение должно устанавливаться как обычное (не реплицирующее) от имени роли, имеющей необходимые права для выполнения функций <span class="application">pg_rewind</span> на исходном сервере (подробнее об этом говорится в Замечаниях), или от имени суперпользователя. Для применения этого параметра исходный сервер должен быть запущен и принимать подключения.</p></dd><dt><span class="term"><code class="option">-R</code><br /></span><span class="term"><code class="option">--write-recovery-conf</code></span></dt><dd><p>Создать <code class="filename">standby.signal</code> и добавить параметры подключения в <code class="filename">postgresql.auto.conf</code> в выходном каталоге. Этот ключ требует указания <code class="literal">--source-server</code>.</p></dd><dt><span class="term"><code class="option">-n</code><br /></span><span class="term"><code class="option">--dry-run</code></span></dt><dd><p>Делать всё, кроме внесения изменений в целевой каталог.</p></dd><dt><span class="term"><code class="option">-N</code><br /></span><span class="term"><code class="option">--no-sync</code></span></dt><dd><p>По умолчанию <code class="command">pg_rewind</code> ждёт, пока все файлы не будут надёжно записаны на диск. С данным параметром <code class="command">pg_rewind</code> завершается быстрее, без ожидания, но в случае неожиданного сбоя операционной системы целевой каталог данных может оказаться испорченным. Этот параметр может быть полезен при тестировании; в производственной среде применять его не следует.</p></dd><dt><span class="term"><code class="option">-P</code><br /></span><span class="term"><code class="option">--progress</code></span></dt><dd><p>Включает вывод сообщений о прогрессе. При этом в процессе копирования данных из исходного кластера будет выдаваться приблизительный процент выполнения.</p></dd><dt><span class="term"><code class="option">-c</code><br /></span><span class="term"><code class="option">--restore-target-wal</code></span></dt><dd><p>Использовать команду <code class="varname">restore_command</code>, определённую в конфигурации целевого кластера, для получения файлов WAL из архива в случае отсутствия их в каталоге <code class="filename">pg_wal</code>.</p></dd><dt><span class="term"><code class="option">--config-file=<em class="replaceable"><code>имя_файла</code></em></code></span></dt><dd><p>Использовать указанный основной файл конфигурации сервера для целевого кластера. Это влияет на поведение программы <span class="application">postgres</span>, которую вызывает <span class="application">pg_rewind</span> в процессе операции синхронизации в данном кластере (для получения <code class="varname">restore_command</code> при вызове с параметром <code class="option">-c/--restore-target-wal</code> и для выполнения процедуры восстановления после сбоя).</p></dd><dt><span class="term"><code class="option">--debug</code></span></dt><dd><p>Выводить подробные отладочные сообщения, полезные в основном для разработчиков, отлаживающих <span class="application">pg_rewind</span>.</p></dd><dt><span class="term"><code class="option">--no-ensure-shutdown</code></span></dt><dd><p>Для <span class="application">pg_rewind</span> необходимо, чтобы целевой сервер был остановлен штатным образом до синхронизации. По умолчанию, если целевой сервер не был остановлен штатно, <span class="application">pg_rewind</span> запускает его в однопользовательском режиме, чтобы он выполнил процедуру восстановления после сбоя, а затем останавливает его. Когда передаётся данный ключ, <span class="application">pg_rewind</span> не делает этого, а завершается с ошибкой немедленно, если сервер не был остановлен корректно. Ожидается, что в этом случае пользователи сами исправят сложившуюся ситуацию.</p></dd><dt><span class="term"><code class="option">-V</code><br /></span><span class="term"><code class="option">--version</code></span></dt><dd><p>Показать версию, а затем завершиться.</p></dd><dt><span class="term"><code class="option">-?</code><br /></span><span class="term"><code class="option">--help</code></span></dt><dd><p>Показать справку, а затем завершиться.</p></dd></dl></div></div><div class="refsect1" id="id-1.9.5.9.7"><h2>Переменные окружения</h2><p>Когда используется <code class="option">--source-server</code>, <span class="application">pg_rewind</span> также использует переменные среды, поддерживаемые <span class="application">libpq</span> (см. <a class="xref" href="libpq-envars.html" title="34.15. Переменные окружения">Раздел 34.15</a>).</p><p>Переменная окружения <code class="envar">PG_COLOR</code> выбирает вариант использования цвета в диагностических сообщениях. Возможные значения: <code class="literal">always</code> (всегда), <code class="literal">auto</code> (автоматически) и <code class="literal">never</code> (никогда).</p></div><div class="refsect1" id="id-1.9.5.9.8"><h2>Замечания</h2><p>Когда исходным кластером для <span class="application">pg_rewind</span> является работающий сервер, вместо суперпользователя может применяться роль, имеющая в этом кластере достаточные права для выполнения функций, которые использует <span class="application">pg_rewind</span>. Такую роль (<code class="literal">rewind_user</code>) можно создать так: </p><pre class="programlisting">CREATE USER rewind_user LOGIN;
GRANT EXECUTE ON function pg_catalog.pg_ls_dir(text, boolean, boolean) TO rewind_user;
GRANT EXECUTE ON function pg_catalog.pg_stat_file(text, boolean) TO rewind_user;
GRANT EXECUTE ON function pg_catalog.pg_read_binary_file(text) TO rewind_user;
GRANT EXECUTE ON function pg_catalog.pg_read_binary_file(text, bigint, bigint, boolean) TO rewind_user;</pre><div class="refsect2" id="id-1.9.5.9.8.3"><h3>Как это работает</h3><p>Основная идея состоит в том, чтобы перенести все изменения на уровне файловой системы из исходного кластера в целевой:</p><div class="procedure"><ol class="procedure" type="1"><li class="step"><p>Просканировать журнал WAL в целевом кластере, начиная с последней контрольной точки перед моментом, когда история линии времени исходного кластера разошлась с целевым кластером. Для каждой записи WAL отметить, какие блоки данных были затронуты. В результате будет получен список всех блоков данных, которые были изменены в целевом кластере после отделения исходного. Если какие-либо файлы WAL уже удалены, можно запустить <span class="application">pg_rewind</span> с ключом <code class="option">-c</code>, чтобы целевой сервер обратился за ними к архиву WAL.</p></li><li class="step"><p>Скопировать все эти изменённые блоки из исходного кластера в целевой либо на уровне файловой системы (<code class="option">--source-pgdata</code>), либо на уровне SQL (<code class="option">--source-server</code>). После этого файлы отношений оказываются в том же состоянии, в котором они были в момент последней контрольной точки, предшествующей моменту расхождения линий времени исходного и целевого кластера, с добавлением текущего состояния, полученного из исходного кластера, тех блоков, которые были изменены в целевом кластере после расхождения.</p></li><li class="step"><p>Скопировать все остальные файлы, включая новые файлы отношений, сегменты WAL, <code class="filename">pg_xact</code> и файлы конфигурации, из исходного кластера в целевой. Как и при базовом копировании, содержимое каталогов <code class="filename">pg_dynshmem/</code>, <code class="filename">pg_notify/</code>, <code class="filename">pg_replslot/</code>, <code class="filename">pg_serial/</code>, <code class="filename">pg_snapshots/</code>, <code class="filename">pg_stat_tmp/</code> и <code class="filename">pg_subtrans/</code> исключается из данных, копируемых из исходного кластера. Кроме того, исключаются файлы или каталоги с именами, начинающимися с <code class="filename">pgsql_tmp</code>, а также файлы <code class="filename">backup_label</code>, <code class="filename">tablespace_map</code>, <code class="filename">pg_internal.init</code>, <code class="filename">postmaster.opts</code>, <code class="filename">postmaster.pid</code> и <code class="filename">.DS_Store</code>.</p></li><li class="step"><p>Создать файл <code class="filename">backup_label</code> для перехода к воспроизведению WAL в контрольной точке, произведённой при переключении, и установить в файле <code class="filename">pg_control</code> минимальный LSN согласованного состояния, определённый в результате вызова <code class="literal">pg_current_wal_insert_lsn()</code> при синхронизации с работающим источником или равный LSN последней контрольной точке при синхронизации с остановленным.</p></li><li class="step"><p>При запуске целевого сервера <span class="productname">PostgreSQL</span> воспроизводятся все требуемые записи WAL, в результате чего каталог данных приводится в согласованное состояние.</p></li></ol></div></div></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="app-pgresetwal.html" title="pg_resetwal">Пред.</a> </td><td width="20%" align="center"><a accesskey="u" href="reference-server.html" title="Серверные приложения PostgreSQL">Наверх</a></td><td width="40%" align="right"> <a accesskey="n" href="pgtestfsync.html" title="pg_test_fsync">След.</a></td></tr><tr><td width="40%" align="left" valign="top"><span class="application">pg_resetwal</span> </td><td width="20%" align="center"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="40%" align="right" valign="top"> <span class="application">pg_test_fsync</span></td></tr></table></div></body></html>