<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>36.2. Управление подключениями к базе данных</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@lists.postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets Vsnapshot" /><link rel="prev" href="ecpg-concept.html" title="36.1. Концепция" /><link rel="next" href="ecpg-commands.html" title="36.3. Запуск команд SQL" /></head><body id="docContent" class="container-fluid col-10"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="5" align="center">36.2. Управление подключениями к базе данных</th></tr><tr><td width="10%" align="left"><a accesskey="p" href="ecpg-concept.html" title="36.1. Концепция">Пред.</a> </td><td width="10%" align="left"><a accesskey="u" href="ecpg.html" title="Глава 36. ECPG — Встраиваемый SQL в C">Наверх</a></td><th width="60%" align="center">Глава 36. <span class="application">ECPG</span> — Встраиваемый <acronym class="acronym">SQL</acronym> в C</th><td width="10%" align="right"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="10%" align="right"> <a accesskey="n" href="ecpg-commands.html" title="36.3. Запуск команд SQL">След.</a></td></tr></table><hr /></div><div class="sect1" id="ECPG-CONNECT"><div class="titlepage"><div><div><h2 class="title" style="clear: both">36.2. Управление подключениями к базе данных <a href="#ECPG-CONNECT" class="id_link">#</a></h2></div></div></div><div class="toc"><dl class="toc"><dt><span class="sect2"><a href="ecpg-connect.html#ECPG-CONNECTING">36.2.1. Подключение к серверу баз данных</a></span></dt><dt><span class="sect2"><a href="ecpg-connect.html#ECPG-SET-CONNECTION">36.2.2. Выбор подключения</a></span></dt><dt><span class="sect2"><a href="ecpg-connect.html#ECPG-DISCONNECT">36.2.3. Закрытие подключения</a></span></dt></dl></div><p>В этом разделе описывается, как открывать, закрывать и переключать подключения к базам данных.</p><div class="sect2" id="ECPG-CONNECTING"><div class="titlepage"><div><div><h3 class="title">36.2.1. Подключение к серверу баз данных <a href="#ECPG-CONNECTING" class="id_link">#</a></h3></div></div></div><p>Подключение к базе данных выполняется следующим оператором: </p><pre class="programlisting">EXEC SQL CONNECT TO <em class="replaceable"><code>цель-подключения</code></em> [<span class="optional">AS <em class="replaceable"><code>имя-подключения</code></em></span>] [<span class="optional">USER <em class="replaceable"><code>имя-пользователя</code></em></span>];</pre><p> <em class="replaceable"><code>Цель</code></em> может задаваться следующими способами: </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
      <code class="literal"><em class="replaceable"><code>имя_бд</code></em>[<span class="optional">@<em class="replaceable"><code>имя_сервера</code></em></span>][<span class="optional">:<em class="replaceable"><code>порт</code></em></span>]</code>
     </li><li class="listitem">
      <code class="literal">tcp:postgresql://<em class="replaceable"><code>имя_сервера</code></em>[<span class="optional">:<em class="replaceable"><code>порт</code></em></span>][<span class="optional">/<em class="replaceable"><code>имя_бд</code></em></span>][<span class="optional">?<em class="replaceable"><code>параметры</code></em></span>]</code>
     </li><li class="listitem">
      <code class="literal">unix:postgresql://localhost[<span class="optional">:<em class="replaceable"><code>порт</code></em></span>][<span class="optional">/<em class="replaceable"><code>имя_бд</code></em></span>][<span class="optional">?<em class="replaceable"><code>параметры</code></em></span>]</code>
     </li><li class="listitem">строковая константа SQL, содержащая одну из вышеприведённых записей</li><li class="listitem">ссылка на символьную переменную, содержащую одну из вышеприведённых записей (см. примеры)</li><li class="listitem">
      <code class="literal">DEFAULT</code>
     </li></ul></div><p> С целью подключения <code class="literal">DEFAULT</code> устанавливается подключение к базе данных по умолчанию с именем пользователя по умолчанию. Другое имя пользователя или имя подключения в этом случае указать нельзя.</p><p>Если цель подключения задаётся буквально (не в виде текстовой строки и не через переменную), её компоненты разбираются как обычные элементы SQL; это означает, например, что <em class="replaceable"><code>имя_сервера</code></em> должно выглядеть как один или несколько идентификаторов SQL, разделённых точками, и если они не заключены в кавычки, они будут приведены к нижнему регистру. Значения любых <em class="replaceable"><code>параметров</code></em> должны быть идентификаторами SQL, целыми числами или ссылками на переменные. Разумеется, практически любую строку можно сделать идентификатором SQL, заключив её в кавычки. На практике же, во избежание ошибок, предпочтительнее использовать текстовые строки (в апострофах) или ссылки на переменные.</p><p>Также разными способами можно указать имя пользователя: </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
      <code class="literal"><em class="replaceable"><code>имя_пользователя</code></em></code>
     </li><li class="listitem">
      <code class="literal"><em class="replaceable"><code>имя_пользователя</code></em>/<em class="replaceable"><code>пароль</code></em></code>
     </li><li class="listitem">
      <code class="literal"><em class="replaceable"><code>имя_пользователя</code></em> IDENTIFIED BY <em class="replaceable"><code>пароль</code></em></code>
     </li><li class="listitem">
      <code class="literal"><em class="replaceable"><code>имя_пользователя</code></em> USING <em class="replaceable"><code>пароль</code></em></code>
     </li></ul></div><p> В показанных выше строках <em class="replaceable"><code>имя_пользователя</code></em> и <em class="replaceable"><code>пароль</code></em> могут задаваться идентификатором или строковой константой SQL, либо ссылкой на символьную переменную.</p><p>Если указание цели подключения включает какие-либо <em class="replaceable"><code>параметры</code></em>, они должны записываться в виде <code class="literal"><em class="replaceable"><code>имя</code></em>=<em class="replaceable"><code>значение</code></em></code> и разделяться амперсандами (<code class="literal">&amp;</code>). В качестве имён параметров принимаются те же, что поддерживает <span class="application">libpq</span> (см. <a class="xref" href="libpq-connect.html#LIBPQ-PARAMKEYWORDS" title="34.1.2. Ключевые слова-параметры">Подраздел 34.1.2</a>). Перед элементами <em class="replaceable"><code>имя</code></em> или <em class="replaceable"><code>значение</code></em> пробелы игнорируются, но сохраняются внутри или после этих элементов. Заметьте, что записать <code class="literal">&amp;</code> внутри <em class="replaceable"><code>значения</code></em> нет никакой возможности.</p><p>Обратите внимание, что при указании соединения через сокет (с префиксом <code class="literal">unix:</code>) имя сервера обязательно должно быть <code class="literal">localhost</code>. Чтобы выбрать нестандартный каталог сокета, укажите путь к каталогу как значение параметра <code class="varname">host</code> в списке <em class="replaceable"><code>параметров</code></em> в строке цели.</p><p>Указание <em class="replaceable"><code>имя-подключения</code></em> применяется, когда в одной программе нужно использовать несколько подключений. Его можно опустить, если программа работает только с одним подключением. Соединение, открытое последним, становится текущим и будет использоваться по умолчанию при выполнении SQL-операторов (это описывается далее в этой главе).</p><p>Вот некоторые примеры оператора <code class="command">CONNECT</code>: </p><pre class="programlisting">EXEC SQL CONNECT TO mydb@sql.mydomain.com;

EXEC SQL CONNECT TO tcp:postgresql://sql.mydomain.com/mydb AS myconnection USER john;

EXEC SQL BEGIN DECLARE SECTION;
const char *target = "mydb@sql.mydomain.com";
const char *user = "john";
const char *passwd = "secret";
EXEC SQL END DECLARE SECTION;
 ...
EXEC SQL CONNECT TO :target USER :user USING :passwd;
/* or EXEC SQL CONNECT TO :target USER :user/:passwd; */</pre><p> В последней форме используется вариант, названный выше ссылкой на символьную переменную. В последующих разделах вы узнаете, как в SQL-операторах можно использовать переменные C, приставляя перед именем двоеточие.</p><p>Учтите, что формат цели подключения не описывается в стандарте SQL. Поэтому, если вы хотите разрабатывать переносимые приложения, имеет смысл применить подход, показанный в последнем примере, и сформировать строку подключения отдельно.</p><p>Если к базе данных, которая не приведена в соответствие <a class="link" href="ddl-schemas.html#DDL-SCHEMAS-PATTERNS" title="5.9.6. Шаблоны использования">шаблону безопасного использования схем</a>, имеют доступ недоверенные пользователи, начинайте сеанс с удаления схем, доступных всем для записи, из пути поиска (<code class="varname">search_path</code>). Например, добавьте <code class="literal">options=-c search_path=</code> в <code class="literal"><em class="replaceable"><code>options</code></em></code> или выполните <code class="literal">EXEC SQL SELECT pg_catalog.set_config('search_path', '', false);</code> после подключения. Это касается не только ECPG, но и любых других интерфейсов для выполнения произвольных SQL-команд.</p></div><div class="sect2" id="ECPG-SET-CONNECTION"><div class="titlepage"><div><div><h3 class="title">36.2.2. Выбор подключения <a href="#ECPG-SET-CONNECTION" class="id_link">#</a></h3></div></div></div><p>SQL-операторы в программах со встраиваемым SQL по умолчанию выполняются с текущим подключением, то есть с подключением, которое было открыто последним. Если приложению нужно управлять несколькими подключениями, это можно сделать тремя способами.</p><p>Первый вариант — явно выбирать подключение для каждого SQL-оператора, например, так: </p><pre class="programlisting">EXEC SQL AT <em class="replaceable"><code>имя-подключения</code></em> SELECT ...;</pre><p> Этот вариант хорошо подходит для случаев, когда приложению нужно использовать несколько подключений в смешанном порядке.</p><p>Если ваше приложение выполняется в нескольких потоках, они не могут использовать подключение одновременно. Поэтому вы должны либо явно управлять доступом (используя мьютексы), либо использовать отдельные подключения для каждого потока.</p><p>Второй вариант — выполнять оператор, переключающий текущее подключение. Этот оператор записывается так: </p><pre class="programlisting">EXEC SQL SET CONNECTION <em class="replaceable"><code>имя-подключения</code></em>;</pre><p> Этот вариант особенно удобен, когда с одним подключением нужно выполнить несколько операторов.</p><p>Следующий пример программы демонстрирует управление несколькими подключениями к базам данных: </p><pre class="programlisting">
#include &lt;stdio.h&gt;

EXEC SQL BEGIN DECLARE SECTION;
    char dbname[1024];
EXEC SQL END DECLARE SECTION;

int
main()
{
    EXEC SQL CONNECT TO testdb1 AS con1 USER testuser;
    EXEC SQL SELECT pg_catalog.set_config('search_path', '', false); EXEC SQL COMMIT;
    EXEC SQL CONNECT TO testdb2 AS con2 USER testuser;
    EXEC SQL SELECT pg_catalog.set_config('search_path', '', false); EXEC SQL COMMIT;
    EXEC SQL CONNECT TO testdb3 AS con3 USER testuser;
    EXEC SQL SELECT pg_catalog.set_config('search_path', '', false); EXEC SQL COMMIT;

    /* This query would be executed in the last opened database "testdb3". */
    EXEC SQL SELECT current_database() INTO :dbname;
    printf("current=%s (should be testdb3)\n", dbname);

    /* Using "AT" to run a query in "testdb2" */
    EXEC SQL AT con2 SELECT current_database() INTO :dbname;
    printf("current=%s (should be testdb2)\n", dbname);

    /* Switch the current connection to "testdb1". */
    EXEC SQL SET CONNECTION con1;

    EXEC SQL SELECT current_database() INTO :dbname;
    printf("current=%s (should be testdb1)\n", dbname);

    EXEC SQL DISCONNECT ALL;
    return 0;
}
</pre><p> Этот пример должен вывести следующее: </p><pre class="screen">
current=testdb3 (should be testdb3)
current=testdb2 (should be testdb2)
current=testdb1 (should be testdb1)
</pre><p>Третий вариант заключается в объявлении идентификатора SQL, связанного с подключением. Например: </p><pre class="programlisting">EXEC SQL AT <em class="replaceable"><code>имя-подключения</code></em> DECLARE <em class="replaceable"><code>имя-оператора</code></em> STATEMENT;
EXEC SQL PREPARE <em class="replaceable"><code>имя-оператора</code></em> FROM :<em class="replaceable"><code>динамическая-строка</code></em>;</pre><p> Связанный с подключением SQL-идентификатор затем нужно выполнять без предложения AT. Обратите внимание, что этот вариант действует как директивы препроцессора, поэтому это связывание будет работать только в рамках файла.</p><p>Следующий пример программы демонстрирует использование данного варианта: </p><pre class="programlisting">
#include &lt;stdio.h&gt;

EXEC SQL BEGIN DECLARE SECTION;
char dbname[128];
char *dyn_sql = "SELECT current_database()";
EXEC SQL END DECLARE SECTION;

int main(){
  EXEC SQL CONNECT TO postgres AS con1;
  EXEC SQL CONNECT TO testdb AS con2;
  EXEC SQL AT con1 DECLARE stmt STATEMENT;
  EXEC SQL PREPARE stmt FROM :dyn_sql;
  EXEC SQL EXECUTE stmt INTO :dbname;
  printf("%s\n", dbname);

  EXEC SQL DISCONNECT ALL;
  return 0;
}
</pre><p> Этот пример должен вывести следующее, даже если подключение по умолчанию установлено к базе testdb: </p><pre class="screen">
postgres
</pre></div><div class="sect2" id="ECPG-DISCONNECT"><div class="titlepage"><div><div><h3 class="title">36.2.3. Закрытие подключения <a href="#ECPG-DISCONNECT" class="id_link">#</a></h3></div></div></div><p>Чтобы закрыть подключение, примените следующий оператор: </p><pre class="programlisting">EXEC SQL DISCONNECT [<span class="optional"><em class="replaceable"><code>подключение</code></em></span>];</pre><p> <em class="replaceable"><code>Подключение</code></em> можно задать следующими способами: </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
      <code class="literal"><em class="replaceable"><code>имя-подключения</code></em></code>
     </li><li class="listitem">
      <code class="literal">CURRENT</code>
     </li><li class="listitem">
      <code class="literal">ALL</code>
     </li></ul></div><p> Если имя подключения не задано, закрывается текущее подключение.</p><p>Хорошим стилем считается, когда приложение явно закрывает каждое подключение, которое оно открыло.</p></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="ecpg-concept.html" title="36.1. Концепция">Пред.</a> </td><td width="20%" align="center"><a accesskey="u" href="ecpg.html" title="Глава 36. ECPG — Встраиваемый SQL в C">Наверх</a></td><td width="40%" align="right"> <a accesskey="n" href="ecpg-commands.html" title="36.3. Запуск команд SQL">След.</a></td></tr><tr><td width="40%" align="left" valign="top">36.1. Концепция </td><td width="20%" align="center"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="40%" align="right" valign="top"> 36.3. Запуск команд SQL</td></tr></table></div></body></html>