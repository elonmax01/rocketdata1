<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>33.2. Оценка результатов тестирования</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@lists.postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets Vsnapshot" /><link rel="prev" href="regress-run.html" title="33.1. Выполнение тестов" /><link rel="next" href="regress-variant.html" title="33.3. Вариативные сравнительные файлы" /></head><body id="docContent" class="container-fluid col-10"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="5" align="center">33.2. Оценка результатов тестирования</th></tr><tr><td width="10%" align="left"><a accesskey="p" href="regress-run.html" title="33.1. Выполнение тестов">Пред.</a> </td><td width="10%" align="left"><a accesskey="u" href="regress.html" title="Глава 33. Регрессионные тесты">Наверх</a></td><th width="60%" align="center">Глава 33. Регрессионные тесты</th><td width="10%" align="right"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="10%" align="right"> <a accesskey="n" href="regress-variant.html" title="33.3. Вариативные сравнительные файлы">След.</a></td></tr></table><hr /></div><div class="sect1" id="REGRESS-EVALUATION"><div class="titlepage"><div><div><h2 class="title" style="clear: both">33.2. Оценка результатов тестирования <a href="#REGRESS-EVALUATION" class="id_link">#</a></h2></div></div></div><div class="toc"><dl class="toc"><dt><span class="sect2"><a href="regress-evaluation.html#REGRESS-EVALUATION-MESSAGE-DIFFERENCES">33.2.1. Различия в сообщениях об ошибке</a></span></dt><dt><span class="sect2"><a href="regress-evaluation.html#REGRESS-EVALUATION-LOCALE-DIFFERENCES">33.2.2. Разница локалей</a></span></dt><dt><span class="sect2"><a href="regress-evaluation.html#REGRESS-EVALUATION-DATE-TIME-DIFFERENCES">33.2.3. Разница в дате и времени</a></span></dt><dt><span class="sect2"><a href="regress-evaluation.html#REGRESS-EVALUATION-FLOAT-DIFFERENCES">33.2.4. Разница в числах с плавающей точкой</a></span></dt><dt><span class="sect2"><a href="regress-evaluation.html#REGRESS-EVALUATION-ORDERING-DIFFERENCES">33.2.5. Разница в сортировке строк</a></span></dt><dt><span class="sect2"><a href="regress-evaluation.html#REGRESS-EVALUATION-STACK-DEPTH">33.2.6. Недостаточная глубина стека</a></span></dt><dt><span class="sect2"><a href="regress-evaluation.html#REGRESS-EVALUATION-RANDOM-TEST">33.2.7. Тест <span class="quote">«<span class="quote">случайных значений</span>»</span></a></span></dt><dt><span class="sect2"><a href="regress-evaluation.html#REGRESS-EVALUATION-CONFIG-PARAMS">33.2.8. Параметры конфигурации</a></span></dt></dl></div><p>Некоторые правильно установленные и полностью функциональные <span class="productname">PostgreSQL</span> инсталляции могут <span class="quote">«<span class="quote">давать сбой</span>»</span> при прохождении некоторых регрессионных тестов из-за особенностей, присущих той или иной платформе, таких как различное представление чисел с плавающей точкой и формулировкой сообщений. В настоящее время результаты тестов оцениваются простым <code class="command">diff</code> сравнением с выводом, сделанным в эталонной системе, поэтому результаты чувствительны к небольшим отличиям между системами. Когда тест завершается со <span class="quote">«<span class="quote">сбоем</span>»</span>, всегда исследуйте разницу между ожидаемым и полученным результатом; возможно, вы обнаружите, что разница не столь уж существенна. Тем не менее мы стремимся поддерживать эталонные файлы на всех поддерживаемых платформах, чтобы можно было ожидать прохождения всех тестов.</p><p>Актуальные итоговые результаты регрессионного тестирования хранятся в каталоге <code class="filename">src/test/regress/results</code>. Тестовый скрипт использует команду <code class="command">diff</code>, чтобы сравнить каждый итоговый файл с ожидаемыми результатами, которые хранятся в каталоге <code class="filename">src/test/regress/expected</code>. Все различия сохраняются в <code class="filename">src/test/regress/regression.diffs</code> для последующей проверки. (Если проводился тест не из основного пакета, то его результаты появятся в соответствующем подкаталоге, а не в <code class="filename">src/test/regress</code>.)</p><p>Если вам не нравятся используемые по умолчанию аргументы <code class="command">diff</code>, установите переменную среды <code class="envar">PG_REGRESS_DIFF_OPTS</code>, например <code class="literal">PG_REGRESS_DIFF_OPTS='-c'</code>. (Или, если хотите, запустите <code class="command">diff</code> самостоятельно.)</p><p>Если по какой-то причине какая-то конкретная платформа генерирует <span class="quote">«<span class="quote">сбой</span>»</span> для отдельного теста, но изучение его результата убеждает вас, что результат правильный, вы можете добавить новый файл сравнения, чтобы замаскировать отчёт об ошибке для последующего прохождения теста. За подробностями обратитесь к <a class="xref" href="regress-variant.html" title="33.3. Вариативные сравнительные файлы">Разделу 33.3</a>.</p><div class="sect2" id="REGRESS-EVALUATION-MESSAGE-DIFFERENCES"><div class="titlepage"><div><div><h3 class="title">33.2.1. Различия в сообщениях об ошибке <a href="#REGRESS-EVALUATION-MESSAGE-DIFFERENCES" class="id_link">#</a></h3></div></div></div><p>Некоторые регрессионные тесты подставляют заведомо неверные входные значения. Сообщения об ошибке могут выдаваться как <span class="productname">PostgreSQL</span>, так и самой операционной системой. В последнем случае форма сообщений может отличаться в зависимости от платформы, но отражают они одну и ту же информацию. Вот эта разница в сообщениях и приводит к <span class="quote">«<span class="quote">сбоям</span>»</span> регрессионного теста, которые можно устранить при проверке.</p></div><div class="sect2" id="REGRESS-EVALUATION-LOCALE-DIFFERENCES"><div class="titlepage"><div><div><h3 class="title">33.2.2. Разница локалей <a href="#REGRESS-EVALUATION-LOCALE-DIFFERENCES" class="id_link">#</a></h3></div></div></div><p>Если вы проводите тестирование на сервере, который был установлен с локалью, имеющей порядок сопоставления, отличный от С, вы можете столкнуться с различиями в порядке сортировки и, как следствие, с последующими сбоями. Пакет регрессионных тестов решает эту проблему путём наличия альтернативных файлов результата, которые способны справиться с большим количеством локалей.</p><p>Если вы используете метод тестирования на временной инсталляции, то чтобы запустить тестирование на другой локали, используйте подходящую переменную среды, относящуюся к локали, в командной строке <code class="command">make</code>, например: </p><pre class="programlisting">make check LANG=de_DE.utf8</pre><p> (Драйвер регрессионного теста обнуляет <code class="envar">LC_ALL</code>, поэтому выбор локали посредством данной переменной не работает.) Чтобы не использовать локаль, либо обнулите все переменные среды, относящиеся к локали, либо установите их в <code class="literal">C</code>) или используйте следующую специальную команду: </p><pre class="programlisting">make check NO_LOCALE=1</pre><p> Когда тест проходит на существующей инсталляции, установки локали определяются этой инсталляцией. Чтобы это изменить, инициализируйте кластер базы данных с иной локалью, передав соответствующие параметры <code class="command">initdb</code>.</p><p>В целом, рекомендуется по возможности проводить регрессионные тесты при таких установках локали, которые будут использованы в работе, тогда в результате тестирования будут проверены актуальные участки кода, относящиеся к локали и кодировке. В зависимости от окружения операционной системы, вы можете столкнуться со сбоями, но вы хотя бы будете знать, какого поведения локали можно ожидать при работе с реальными приложениями.</p></div><div class="sect2" id="REGRESS-EVALUATION-DATE-TIME-DIFFERENCES"><div class="titlepage"><div><div><h3 class="title">33.2.3. Разница в дате и времени <a href="#REGRESS-EVALUATION-DATE-TIME-DIFFERENCES" class="id_link">#</a></h3></div></div></div><p>Большая часть результатов проверки даты и времени зависит от часового пояса окружения. Эталонные файлы созданы для пояса <code class="literal">PST8PDT</code> (Беркли, Калифорния), поэтому если проводить тесты не с этим часовым поясом, проявятся мнимые ошибки. Драйвер регрессионного теста задаёт переменную среды <code class="envar">PGTZ</code> как <code class="literal">PST8PDT</code>, что позволяет получить корректный результат.</p></div><div class="sect2" id="REGRESS-EVALUATION-FLOAT-DIFFERENCES"><div class="titlepage"><div><div><h3 class="title">33.2.4. Разница в числах с плавающей точкой <a href="#REGRESS-EVALUATION-FLOAT-DIFFERENCES" class="id_link">#</a></h3></div></div></div><p>Некоторые тесты применяют 64-битное вычисление чисел с плавающей точкой (<code class="type">double precision</code>) из столбцов таблицы. Наблюдаются различия в результатах при использовании математических функций для столбцов <code class="type">double precision</code>. Тесты <code class="literal">float8</code> и <code class="literal">geometry</code> особенно чувствительны к небольшим различиям между платформами и даже режимами оптимизации компилятора. Чтобы понять реальную значимость этих различий, нужно сравнить их глазами, поскольку обычно они располагаются с десятого разряда справа от десятичной точки.</p><p>Некоторые системы показывают минус ноль как <code class="literal">-0</code>, тогда как другие показывают просто <code class="literal">0</code>.</p><p>Некоторые системы сигнализируют об ошибках в <code class="function">pow()</code> и <code class="function">exp()</code> не так, как ожидает текущий код <span class="productname">PostgreSQL</span>.</p></div><div class="sect2" id="REGRESS-EVALUATION-ORDERING-DIFFERENCES"><div class="titlepage"><div><div><h3 class="title">33.2.5. Разница в сортировке строк <a href="#REGRESS-EVALUATION-ORDERING-DIFFERENCES" class="id_link">#</a></h3></div></div></div><p>Иногда наблюдаются различия в том, что одни и те же строки выводятся в ином порядке, нежели в контрольном файле. В большинстве случаев это не является, строго говоря, ошибкой. Основная часть скриптов регрессионных тестов не столь педантична, чтобы использовать <code class="literal">ORDER BY</code> для каждого <code class="literal">SELECT</code>, и поэтому в результате порядок строк не гарантирован согласно спецификации SQL. На практике мы видим, как одинаковые запросы, выполняемые для одних и тех же данных на одном и том же программном обеспечении, выдают результаты в одинаковом порядке для всех платформ, в связи с чем отсутствие <code class="literal">ORDER BY</code> не является проблемой. Однако некоторые запросы выявляют межплатформенные различия в сортировке. Когда тестирование идет на уже установленном сервере, различия в сортировке могут быть следствием того, что локаль установлена в отличное от С значение, или некоторые параметры заданы не по умолчанию, такие как <code class="varname">work_mem</code> или стоимостные параметры планировщика.</p><p>Поэтому, если вы видите различия в сортировке строк, не стоит волноваться, если только запрос не использует <code class="literal">ORDER BY</code>. Тем не менее сообщайте нам о таких случаях, чтобы мы могли добавить <code class="literal">ORDER BY</code> в конкретный запрос, чтобы исключить возможность ошибки в будущих релизах.</p><p>Вы можете задать вопрос, почему мы явно не добавили <code class="literal">ORDER BY</code> во все запросы регрессионных тестов, чтобы избавиться от таких ошибок раз и навсегда. Причина в том, что это снизит полезность регрессионных тестов, поскольку они будут иметь тенденцию к проверке планов запросов использующих сортировку, за счёт исключения запросов без сортировки.</p></div><div class="sect2" id="REGRESS-EVALUATION-STACK-DEPTH"><div class="titlepage"><div><div><h3 class="title">33.2.6. Недостаточная глубина стека <a href="#REGRESS-EVALUATION-STACK-DEPTH" class="id_link">#</a></h3></div></div></div><p>Если <code class="literal">ошибки</code> теста приводят к поломке сервера при выполнении команды <code class="literal">select infinite_recurse()</code>, это означает, что предел платформы для размера стека меньше, чем показывает параметр <a class="xref" href="runtime-config-resource.html#GUC-MAX-STACK-DEPTH">max_stack_depth</a>. Проблема может быть решена запуском сервера с большим размером стека (рекомендованное значение <code class="varname">max_stack_depth</code> по умолчанию - 4 Мб). Если вы не можете этого сделать, в качестве альтернативы уменьшите значение <code class="varname">max_stack_depth</code>.</p><p>На платформах, поддерживающих функцию <code class="function">getrlimit()</code>, сервер должен автоматически выбирать значение переменной <code class="varname">max_stack_depth</code>; поэтому, если вы не переписывали это значение вручную, сбой такого типа — просто дефект, который нужно зарегистрировать.</p></div><div class="sect2" id="REGRESS-EVALUATION-RANDOM-TEST"><div class="titlepage"><div><div><h3 class="title">33.2.7. Тест <span class="quote">«<span class="quote">случайных значений</span>»</span> <a href="#REGRESS-EVALUATION-RANDOM-TEST" class="id_link">#</a></h3></div></div></div><p>Тестовый скрипт <code class="literal">random</code> подразумевает получение случайных значений. В очень редких случаях это приводит к сбоям в регрессионном тестировании. Выполнение </p><pre class="programlisting">diff results/random.out expected/random.out</pre><p> должно выводить одну или несколько строк различий. Нет причин для беспокойства, до тех пор пока сбои в этом тесте не повторяются постоянно.</p></div><div class="sect2" id="REGRESS-EVALUATION-CONFIG-PARAMS"><div class="titlepage"><div><div><h3 class="title">33.2.8. Параметры конфигурации <a href="#REGRESS-EVALUATION-CONFIG-PARAMS" class="id_link">#</a></h3></div></div></div><p>Когда тестирование проходит на существующей инсталляции, некоторые нестандартные значения параметров могут привести к сбоям в тесте. Например, изменение таких параметров конфигурации, как <code class="varname">enable_seqscan</code> или <code class="varname">enable_indexscan</code> могут привести к такому изменению системы, которое сможет воздействовать на результаты тестов, использующих <code class="command">EXPLAIN</code>.</p></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="regress-run.html" title="33.1. Выполнение тестов">Пред.</a> </td><td width="20%" align="center"><a accesskey="u" href="regress.html" title="Глава 33. Регрессионные тесты">Наверх</a></td><td width="40%" align="right"> <a accesskey="n" href="regress-variant.html" title="33.3. Вариативные сравнительные файлы">След.</a></td></tr><tr><td width="40%" align="left" valign="top">33.1. Выполнение тестов </td><td width="20%" align="center"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="40%" align="right" valign="top"> 33.3. Вариативные сравнительные файлы</td></tr></table></div></body></html>