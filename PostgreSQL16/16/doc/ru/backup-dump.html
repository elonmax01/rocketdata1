<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>26.1. Выгрузка в SQL</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@lists.postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets Vsnapshot" /><link rel="prev" href="backup.html" title="Глава 26. Резервное копирование и восстановление" /><link rel="next" href="backup-file.html" title="26.2. Резервное копирование на уровне файлов" /></head><body id="docContent" class="container-fluid col-10"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="5" align="center">26.1. Выгрузка в <acronym class="acronym">SQL</acronym></th></tr><tr><td width="10%" align="left"><a accesskey="p" href="backup.html" title="Глава 26. Резервное копирование и восстановление">Пред.</a> </td><td width="10%" align="left"><a accesskey="u" href="backup.html" title="Глава 26. Резервное копирование и восстановление">Наверх</a></td><th width="60%" align="center">Глава 26. Резервное копирование и восстановление</th><td width="10%" align="right"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="10%" align="right"> <a accesskey="n" href="backup-file.html" title="26.2. Резервное копирование на уровне файлов">След.</a></td></tr></table><hr /></div><div class="sect1" id="BACKUP-DUMP"><div class="titlepage"><div><div><h2 class="title" style="clear: both">26.1. Выгрузка в <acronym class="acronym">SQL</acronym> <a href="#BACKUP-DUMP" class="id_link">#</a></h2></div></div></div><div class="toc"><dl class="toc"><dt><span class="sect2"><a href="backup-dump.html#BACKUP-DUMP-RESTORE">26.1.1. Восстановление дампа</a></span></dt><dt><span class="sect2"><a href="backup-dump.html#BACKUP-DUMP-ALL">26.1.2. Использование <span class="application">pg_dumpall</span></a></span></dt><dt><span class="sect2"><a href="backup-dump.html#BACKUP-DUMP-LARGE">26.1.3. Управление большими базами данных</a></span></dt></dl></div><p>Идея, стоящая за этим методом, заключается в генерации текстового файла с командами SQL, которые при выполнении на сервере пересоздадут базу данных в том же самом состоянии, в котором она была на момент выгрузки. <span class="productname">PostgreSQL</span> предоставляет для этой цели вспомогательную программу <a class="xref" href="app-pgdump.html" title="pg_dump"><span class="refentrytitle"><span class="application">pg_dump</span></span></a>. Простейшее применение этой программы выглядит так: </p><pre class="synopsis">
pg_dump <em class="replaceable"><code>имя_базы</code></em> &gt; <em class="replaceable"><code>файл_дампа</code></em>
</pre><p> Как видите, <span class="application">pg_dump</span> записывает результаты своей работы в устройство стандартного вывода. Далее будет рассмотрено, чем это может быть полезно. В то время как вышеупомянутая команда создаёт текстовый файл, <span class="application">pg_dump</span> может создать файлы и в других форматах, которые допускают параллельную обработку и более гибкое управление восстановлением объектов.</p><p>Программа <span class="application">pg_dump</span> является для <span class="productname">PostgreSQL</span> обычным клиентским приложением (хотя и весьма умным). Это означает, что вы можете выполнять процедуру резервного копирования с любого удалённого компьютера, если имеете доступ к нужной базе данных. Но помните, что <span class="application">pg_dump</span> не использует для своей работы какие-то специальные привилегии. В частности, ей обычно требуется доступ на чтение всех таблиц, которые вы хотите выгрузить, так что для копирования всей базы данных практически всегда её нужно запускать с правами суперпользователя СУБД. (Если у вас нет достаточных прав для резервного копирования всей базы данных, вы тем не менее можете сделать резервную копию той части базы, доступ к которой у вас есть, используя такие параметры, как <code class="option">-n <em class="replaceable"><code>схема</code></em></code> или <code class="option">-t <em class="replaceable"><code>таблица</code></em></code>.)</p><p>Указать, к какому серверу должна подключаться программа <span class="application">pg_dump</span>, можно с помощью аргументов командной строки <code class="option">-h <em class="replaceable"><code>сервер</code></em></code> и <code class="option">-p <em class="replaceable"><code>порт</code></em></code>. По умолчанию в качестве сервера выбирается localhost или значение, указанное в переменной окружения <code class="envar">PGHOST</code>. Подобным образом, по умолчанию используется порт, заданный в переменной окружения <code class="envar">PGPORT</code>, а если она не задана, то порт, указанный по умолчанию при компиляции. (Для удобства при компиляции сервера обычно устанавливается то же значение по умолчанию.)</p><p>Как и любое другое клиентское приложение <span class="productname">PostgreSQL</span>, <span class="application">pg_dump</span> по умолчанию будет подключаться к базе данных с именем пользователя, совпадающим с именем текущего пользователя операционной системы. Чтобы переопределить имя, либо добавьте параметр <code class="option">-U</code>, либо установите переменную окружения <code class="envar">PGUSER</code>. Помните, что <span class="application">pg_dump</span> подключается к серверу через обычные механизмы проверки подлинности клиента (которые описываются в <a class="xref" href="client-authentication.html" title="Глава 21. Аутентификация клиентского приложения">Главе 21</a>).</p><p>Важное преимущество <span class="application">pg_dump</span> в сравнении с другими методами резервного копирования, описанными далее, состоит в том, что вывод <span class="application">pg_dump</span> обычно можно загрузить в более новые версии <span class="productname">PostgreSQL</span>, в то время как резервная копия на уровне файловой системы и непрерывное архивирование жёстко зависят от версии сервера. Также, только метод с применением <span class="application">pg_dump</span> будет работать при переносе базы данных на другую машинную архитектуру, например, при переносе с 32-битной на 64-битную версию сервера.</p><p>Дампы, создаваемые <span class="application">pg_dump</span>, являются внутренне согласованными, то есть, дамп представляет собой снимок базы данных на момент начала запуска <span class="application">pg_dump</span>. <span class="application">pg_dump</span> не блокирует другие операции с базой данных во время своей работы. (Исключение составляют операции, которым нужна исключительная блокировка, как например, большинство форм команды <code class="command">ALTER TABLE</code>.)</p><div class="sect2" id="BACKUP-DUMP-RESTORE"><div class="titlepage"><div><div><h3 class="title">26.1.1. Восстановление дампа <a href="#BACKUP-DUMP-RESTORE" class="id_link">#</a></h3></div></div></div><p>Текстовые файлы, созданные <span class="application">pg_dump</span>, предназначаются для последующего чтения программой <span class="application">psql</span>. Общий вид команды для восстановления дампа: </p><pre class="synopsis">
psql <em class="replaceable"><code>имя_базы</code></em> &lt; <em class="replaceable"><code>файл_дампа</code></em>
</pre><p> где <em class="replaceable"><code>файл_дампа</code></em> — это файл, содержащий вывод команды <span class="application">pg_dump</span>. База данных, заданная параметром <em class="replaceable"><code>имя_базы</code></em>, не будет создана данной командой, так что вы должны создать её сами из базы <code class="literal">template0</code> перед запуском <span class="application">psql</span> (например, с помощью команды <code class="literal">createdb -T template0 <em class="replaceable"><code>имя_базы</code></em></code>). Программа <span class="application">psql</span> принимает параметры, указывающие сервер, к которому осуществляется подключение, и имя пользователя, подобно <span class="application">pg_dump</span>. За дополнительными сведениями обратитесь к справке по <a class="xref" href="app-psql.html" title="psql"><span class="refentrytitle"><span class="application">psql</span></span></a>. Дампы, выгруженные не в текстовом формате, восстанавливаются утилитой <a class="xref" href="app-pgrestore.html" title="pg_restore"><span class="refentrytitle"><span class="application">pg_restore</span></span></a>.</p><p>Перед восстановлением SQL-дампа все пользователи, которые владели объектами или имели права на объекты в выгруженной базе данных, должны уже существовать. Если их нет, при восстановлении будут ошибки пересоздания объектов с изначальными владельцами и/или правами. (Иногда это желаемый результат, но обычно нет).</p><p>По умолчанию, если происходит ошибка SQL, программа <span class="application">psql</span> продолжает выполнение. Если же запустить <span class="application">psql</span> с установленной переменной <code class="literal">ON_ERROR_STOP</code>, это поведение поменяется и <span class="application">psql</span> завершится с кодом 3 в случае возникновения ошибки SQL: </p><pre class="programlisting">psql --set ON_ERROR_STOP=on <em class="replaceable"><code>имя_базы</code></em> &lt; <em class="replaceable"><code>файл_дампа</code></em></pre><p> В любом случае вы получите только частично восстановленную базу данных. В качестве альтернативы можно указать, что весь дамп должен быть восстановлен в одной транзакции, так что восстановление либо полностью выполнится, либо полностью отменится. Включить данный режим можно, передав <span class="application">psql</span> аргумент <code class="option">-1</code> или <code class="option">--single-transaction</code>. Выбирая этот режим, учтите, что даже незначительная ошибка может привести к откату восстановления, которое могло продолжаться несколько часов. Однако это всё же может быть предпочтительней, чем вручную вычищать сложную базу данных после частично восстановленного дампа.</p><p>Благодаря способности <span class="application">pg_dump</span> и <span class="application">psql</span> писать и читать каналы ввода/вывода, можно скопировать базу данных непосредственно с одного сервера на другой, например: </p><pre class="programlisting">pg_dump -h <em class="replaceable"><code>host1</code></em> <em class="replaceable"><code>имя_базы</code></em> | psql -h <em class="replaceable"><code>host2</code></em> <em class="replaceable"><code>имя_базы</code></em></pre><div class="important"><h3 class="title">Важно</h3><p>Дампы, которые выдаёт <span class="application">pg_dump</span>, содержат определения относительно <code class="literal">template0</code>. Это означает, что любые языки, процедуры и т. п., добавленные в базу через <code class="literal">template1</code>, <span class="application">pg_dump</span> также выгрузит в дамп. Как следствие, если при восстановлении вы используете модифицированный <code class="literal">template1</code>, вы должны создать пустую базу данных из <code class="literal">template0</code>, как показано в примере выше.</p></div><p>После восстановления резервной копии имеет смысл запустить <a class="link" href="sql-analyze.html" title="ANALYZE"><code class="command">ANALYZE</code></a> для каждой базы данных, чтобы оптимизатор запросов получил полезную статистику; за подробностями обратитесь к <a class="xref" href="routine-vacuuming.html#VACUUM-FOR-STATISTICS" title="25.1.3. Обновление статистики планировщика">Подразделу 25.1.3</a> и <a class="xref" href="routine-vacuuming.html#AUTOVACUUM" title="25.1.6. Демон автоочистки">Подразделу 25.1.6</a>. Другие советы по эффективной загрузке больших объёмов данных в <span class="productname">PostgreSQL</span> вы можете найти в <a class="xref" href="populate.html" title="14.4. Наполнение базы данных">Разделе 14.4</a>.</p></div><div class="sect2" id="BACKUP-DUMP-ALL"><div class="titlepage"><div><div><h3 class="title">26.1.2. Использование <span class="application">pg_dumpall</span> <a href="#BACKUP-DUMP-ALL" class="id_link">#</a></h3></div></div></div><p>Программа <span class="application">pg_dump</span> выгружает только одну базу данных в один момент времени и не включает в дамп информацию о ролях и табличных пространствах (так как это информация уровня кластера, а не самой базы данных). Для удобства создания дампа всего содержимого кластера баз данных предоставляется программа <a class="xref" href="app-pg-dumpall.html" title="pg_dumpall"><span class="refentrytitle"><span class="application">pg_dumpall</span></span></a>, которая делает резервную копию всех баз данных кластера, а также сохраняет данные уровня кластера, такие как роли и определения табличных пространств. Простое использование этой команды: </p><pre class="synopsis">
pg_dumpall &gt; <em class="replaceable"><code>файл_дампа</code></em>
</pre><p> Полученную копию можно восстановить с помощью <span class="application">psql</span>: </p><pre class="synopsis">
psql -f <em class="replaceable"><code>файл_дампа</code></em> postgres
</pre><p> (В принципе, здесь в качестве начальной базы данных можно указать имя любой существующей базы, но если вы загружаете дамп в пустой кластер, обычно нужно использовать <code class="literal">postgres</code>). Восстанавливать дамп, который выдала <span class="application">pg_dumpall</span>, всегда необходимо с правами суперпользователя, так как они требуются для восстановления информации о ролях и табличных пространствах. Если вы используете табличные пространства, убедитесь, что пути к табличным пространствам в дампе соответствуют новой среде.</p><p><span class="application">pg_dumpall</span> выдаёт команды, которые заново создают роли, табличные пространства и пустые базы данных, а затем вызывает для каждой базы <span class="application">pg_dump</span>. Таким образом, хотя каждая база данных будет внутренне согласованной, состояние разных баз не будет синхронным.</p><p>Только глобальные данные кластера можно выгрузить, передав <span class="application">pg_dumpall</span> ключ <code class="option">--globals-only</code>. Это необходимо, чтобы полностью скопировать кластер, когда <span class="application">pg_dump</span> выполняется для отдельных баз данных.</p></div><div class="sect2" id="BACKUP-DUMP-LARGE"><div class="titlepage"><div><div><h3 class="title">26.1.3. Управление большими базами данных <a href="#BACKUP-DUMP-LARGE" class="id_link">#</a></h3></div></div></div><p>Некоторые операционные системы накладывают ограничение на максимальный размер файла, что приводит к проблемам при создании больших файлов с помощью <span class="application">pg_dump</span>. К счастью, <span class="application">pg_dump</span> может писать в стандартный вывод, так что вы можете использовать стандартные инструменты Unix для того, чтобы избежать потенциальных проблем. Вот несколько возможных методов:</p><p><strong>Используйте сжатые дампы. </strong>Вы можете использовать предпочитаемую программу сжатия, например <span class="application">gzip</span>: </p><pre class="programlisting">pg_dump <em class="replaceable"><code>имя_базы</code></em> | gzip &gt; <em class="replaceable"><code>имя_файла</code></em>.gz</pre><p> Затем загрузить сжатый дамп можно командой: </p><pre class="programlisting">gunzip -c <em class="replaceable"><code>имя_файла</code></em>.gz | psql <em class="replaceable"><code>имя_базы</code></em></pre><p> или: </p><pre class="programlisting">cat <em class="replaceable"><code>имя_файла</code></em>.gz | gunzip | psql <em class="replaceable"><code>имя_базы</code></em></pre><p><strong>Используйте <code class="command">split</code>. </strong>Команда <code class="command">split</code> может разбивать выводимые данные на небольшие файлы, размер которых удовлетворяет ограничению нижележащей файловой системы. Например, чтобы получить части по 2 гигабайта: </p><pre class="programlisting">pg_dump <em class="replaceable"><code>имя_базы</code></em> | split -b 2G - <em class="replaceable"><code>имя_файла</code></em></pre><p> Восстановить их можно так: </p><pre class="programlisting">cat <em class="replaceable"><code>имя_файла</code></em>* | psql <em class="replaceable"><code>имя_базы</code></em></pre><p> Использовать GNU <span class="application">split</span> можно вместе с <span class="application">gzip</span>: </p><pre class="programlisting">pg_dump <em class="replaceable"><code>имя_базы</code></em> | split -b 2G --filter='gzip &gt; $FILE.gz'</pre><p> Восстановить данные после такого разбиения можно с помощью команды <code class="command">zcat</code>.</p><p><strong>Используйте специальный формат дампа <span class="application">pg_dump</span>. </strong>Если при сборке <span class="productname">PostgreSQL</span> была подключена библиотека <span class="application">zlib</span>, дамп в специальном формате будет записываться в файл в сжатом виде. В таком формате размер файла дампа будет близок к размеру, полученному с применением <code class="command">gzip</code>, но он лучше тем, что позволяет восстанавливать таблицы выборочно. Следующая команда выгружает базу данных в специальном формате: </p><pre class="programlisting">pg_dump -Fc <em class="replaceable"><code>имя_базы</code></em> &gt; <em class="replaceable"><code>имя_файла</code></em></pre><p> Дамп в специальном формате не является скриптом для <span class="application">psql</span> и должен восстанавливаться с помощью команды <span class="application">pg_restore</span>, например: </p><pre class="programlisting">pg_restore -d <em class="replaceable"><code>имя_базы</code></em> <em class="replaceable"><code>имя_файла</code></em></pre><p> За подробностями обратитесь к справке по командам <a class="xref" href="app-pgdump.html" title="pg_dump"><span class="refentrytitle"><span class="application">pg_dump</span></span></a> и <a class="xref" href="app-pgrestore.html" title="pg_restore"><span class="refentrytitle"><span class="application">pg_restore</span></span></a>.</p><p>Для очень больших баз данных может понадобиться сочетать <code class="command">split</code> с одним из двух других методов.</p><p><strong>Используйте возможность параллельной выгрузки в <span class="application">pg_dump</span>. </strong>Чтобы ускорить выгрузку большой БД, вы можете использовать режим параллельной выгрузки в <span class="application">pg_dump</span>. При этом одновременно будут выгружаться несколько таблиц. Управлять числом параллельных заданий позволяет параметр <code class="command">-j</code>. Параллельная выгрузка поддерживается только для формата архива в каталоге. </p><pre class="programlisting">pg_dump -j <em class="replaceable"><code>число</code></em> -F d -f <em class="replaceable"><code>выходной_каталог</code></em> <em class="replaceable"><code>имя_базы</code></em></pre><p> Вы также можете восстановить копию в параллельном режиме с помощью <code class="command">pg_restore -j</code>. Это поддерживается для любого архива в формате каталога или специальном формате, даже если архив создавался не командой <code class="command">pg_dump -j</code>.</p></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="backup.html" title="Глава 26. Резервное копирование и восстановление">Пред.</a> </td><td width="20%" align="center"><a accesskey="u" href="backup.html" title="Глава 26. Резервное копирование и восстановление">Наверх</a></td><td width="40%" align="right"> <a accesskey="n" href="backup-file.html" title="26.2. Резервное копирование на уровне файлов">След.</a></td></tr><tr><td width="40%" align="left" valign="top">Глава 26. Резервное копирование и восстановление </td><td width="20%" align="center"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="40%" align="right" valign="top"> 26.2. Резервное копирование на уровне файлов</td></tr></table></div></body></html>