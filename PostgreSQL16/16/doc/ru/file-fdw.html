<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>F.16. file_fdw — обращение к файлам данных в файловой системе сервера</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@lists.postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets Vsnapshot" /><link rel="prev" href="earthdistance.html" title="F.15. earthdistance — вычисление расстояний между точками на Земле" /><link rel="next" href="fuzzystrmatch.html" title="F.17. fuzzystrmatch — вычисление схожести и расстояния между строками" /></head><body id="docContent" class="container-fluid col-10"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="5" align="center">F.16. file_fdw — обращение к файлам данных в файловой системе сервера</th></tr><tr><td width="10%" align="left"><a accesskey="p" href="earthdistance.html" title="F.15. earthdistance — вычисление расстояний между точками на Земле">Пред.</a> </td><td width="10%" align="left"><a accesskey="u" href="contrib.html" title="Приложение F. Дополнительно поставляемые модули и расширения">Наверх</a></td><th width="60%" align="center">Приложение F. Дополнительно поставляемые модули и расширения</th><td width="10%" align="right"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="10%" align="right"> <a accesskey="n" href="fuzzystrmatch.html" title="F.17. fuzzystrmatch — вычисление схожести и расстояния между строками">След.</a></td></tr></table><hr /></div><div class="sect1" id="FILE-FDW"><div class="titlepage"><div><div><h2 class="title" style="clear: both">F.16. file_fdw — обращение к файлам данных в файловой системе сервера <a href="#FILE-FDW" class="id_link">#</a></h2></div></div></div><a id="id-1.11.7.26.2" class="indexterm"></a><p>Модуль <code class="filename">file_fdw</code> реализует обёртку сторонних данных <code class="function">file_fdw</code>, с помощью которой можно обращаться к файлам данных в файловой системе сервера или выполнять программы на сервере и читать их вывод. Файлы и вывод программ должны быть в формате, который понимает команда <code class="command">COPY FROM</code>; он рассматривается в описании <a class="xref" href="sql-copy.html" title="COPY"><span class="refentrytitle">COPY</span></a>. В настоящее время файлы доступны только для чтения.</p><p>Для сторонней таблицы, создаваемой через эту обёртку, можно задать следующие параметры:</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">filename</code></span></dt><dd><p>Определяет имя файла, который нужно прочитать. При указании относительного пути он рассматривается от каталога данных. Вы должны определить либо параметр <code class="literal">filename</code>, либо <code class="literal">program</code>, но не оба сразу.</p></dd><dt><span class="term"><code class="literal">program</code></span></dt><dd><p>Определяет команду, которая будет выполнена. Поток стандартного вывода этой команды будет прочитан так же, как и с <code class="command">COPY FROM PROGRAM</code>. Необходимо определить либо параметр <code class="literal">program</code>, либо <code class="literal">filename</code>, но не оба сразу.</p></dd><dt><span class="term"><code class="literal">format</code></span></dt><dd><p>Определяет формат файла (аналогично указанию <code class="literal">FORMAT</code> в команде <code class="command">COPY</code>).</p></dd><dt><span class="term"><code class="literal">header</code></span></dt><dd><p>Указывает, что данные содержат строку заголовка с именами столбцов (аналогично указанию <code class="literal">HEADER</code> в команде <code class="command">COPY</code>).</p></dd><dt><span class="term"><code class="literal">delimiter</code></span></dt><dd><p>Задаёт символ, разделяющий столбцы в данных (аналогично указанию <code class="literal">DELIMITER</code> в команде <code class="command">COPY</code>).</p></dd><dt><span class="term"><code class="literal">quote</code></span></dt><dd><p>Задаёт символ, используемый для заключения данных в кавычки (аналогично указанию <code class="literal">QUOTE</code> в команде <code class="command">COPY</code>).</p></dd><dt><span class="term"><code class="literal">escape</code></span></dt><dd><p>Задаёт символ, используемый для экранирования данных (аналогично указанию <code class="literal">ESCAPE</code> в команде <code class="command">COPY</code>).</p></dd><dt><span class="term"><code class="literal">null</code></span></dt><dd><p>Определяет строку, задающую значение <code class="literal">NULL</code> в данных (аналогично указанию <code class="literal">NULL</code> в команде <code class="command">COPY</code>).</p></dd><dt><span class="term"><code class="literal">encoding</code></span></dt><dd><p>Задаёт кодировку данных (аналогично указанию <code class="literal">ENCODING</code> в команде <code class="command">COPY</code>).</p></dd></dl></div><p>Заметьте, что хотя <code class="command">COPY</code> принимает указания, такие как <code class="literal">HEADER</code>, без соответствующего значения, синтаксис обёртки сторонних данных требует, чтобы значение присутствовало во всех случаях. Чтобы активировать указания <code class="command">COPY</code>, которым значение обычно не передаётся, им можно просто передать значение TRUE, так как все они являются логическими.</p><p>Для столбцов сторонней таблицы, создаваемой через эту обёртку, можно задать следующие параметры:</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">force_not_null</code></span></dt><dd><p>Логическое значение. Если true, то значение столбца не должно сверяться со значением NULL (заданным в параметре <code class="literal">null</code> на уровне таблицы). Аналогично включению столбца в список указания <code class="literal">FORCE_NOT_NULL</code> команды <code class="command">COPY</code>.</p></dd><dt><span class="term"><code class="literal">force_null</code></span></dt><dd><p>Логическое значение. Если true, значения столбцов нужно сверять со значением NULL (заданным в параметре <code class="literal">NULL</code>), даже если они заключены в кавычки. Без этого параметра только значения без кавычек, соответствующие значению <code class="literal">null</code>, будут возвращаться как NULL. Аналогично включению столбца в список указания <code class="literal">FORCE_NULL</code> команды <code class="command">COPY</code>.</p></dd></dl></div><p>В настоящее время <code class="literal">file_fdw</code> не поддерживает указание <code class="literal">FORCE_QUOTE</code> команды <code class="command">COPY</code>.</p><p>Перечисленные параметры применимы только для сторонних таблиц или их столбцов. Их нельзя указать для обёртки сторонних данных <code class="literal">file_fdw</code>, серверов или сопоставлений пользователей, использующих эту обёртку.</p><p>Для изменения параметров, определяемых для таблицы, требуется быть суперпользователем или иметь права роли <code class="literal">pg_read_server_files</code> (для указания имени файла) или роли <code class="literal">pg_execute_server_program</code> (для указания программы). Это сделано в целях безопасности: только избранные пользователи должны выбирать, какой файл читать или какую программу запускать. В принципе право изменения остальных параметров можно предоставить и обычным пользователям, но в настоящий момент это не реализовано.</p><p>Задавая параметр <code class="literal">program</code>, помните, что эта строка выполняется оболочкой ОС. Если вы хотите передавать заданной команде параметры из недоверенного источника, позаботьтесь об исключении или экранировании всех символов, которые могут иметь особое назначение в оболочке. По соображениям безопасности лучше, чтобы эта командная строка была фиксированной или как минимум в ней не передавались данные, поступающие от пользователя.</p><p>Для сторонних таблиц, работающих через <code class="literal">file_fdw</code>, команда <code class="command">EXPLAIN</code> показывает имя используемого файла или запускаемой программы. Если не указывать <code class="literal">COSTS OFF</code>, то выводится и размер файла (в байтах).</p><div class="example" id="id-1.11.7.26.14"><p class="title"><strong>Пример F.1. Создание сторонней таблицы для журнала сервера PostgreSQL</strong></p><div class="example-contents"><p>Одно из очевидных применений <code class="literal">file_fdw</code> — это предоставление доступа к журналу сообщений PostgreSQL как к таблице. Для этого необходимо предварительно настроить <a class="link" href="runtime-config-logging.html#RUNTIME-CONFIG-LOGGING-CSVLOG" title="20.8.4. Использование вывода журнала в формате CSV">вывод сообщений в файл CSV</a> (дальше мы будем считать, что это файл <code class="literal">pglog.csv</code>). Сначала установите расширение <code class="literal">file_fdw</code>:</p><pre class="programlisting">CREATE EXTENSION file_fdw;</pre><p>Затем создайте сторонний сервер: </p><pre class="programlisting">CREATE SERVER pglog FOREIGN DATA WRAPPER file_fdw;</pre><p>Всё готово для создания сторонней таблицы. В команде <code class="command">CREATE FOREIGN TABLE</code> нужно перечислить столбцы таблицы, указать файл CSV и его формат:</p><pre class="programlisting">CREATE FOREIGN TABLE pglog (
  log_time timestamp(3) with time zone,
  user_name text,
  database_name text,
  process_id integer,
  connection_from text,
  session_id text,
  session_line_num bigint,
  command_tag text,
  session_start_time timestamp with time zone,
  virtual_transaction_id text,
  transaction_id bigint,
  error_severity text,
  sql_state_code text,
  message text,
  detail text,
  hint text,
  internal_query text,
  internal_query_pos integer,
  context text,
  query text,
  query_pos integer,
  location text,
  application_name text,
  backend_type text,
  leader_pid integer,
  query_id bigint
) SERVER pglog
OPTIONS ( filename 'log/pglog.csv', format 'csv' );</pre><p>Вот и всё. Теперь для просмотра журнала сервера можно просто выполнять запросы к таблице. В производственной среде, разумеется, ещё потребуется как-то учесть ротацию файлов журнала.</p></div></div><br class="example-break" /></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="earthdistance.html" title="F.15. earthdistance — вычисление расстояний между точками на Земле">Пред.</a> </td><td width="20%" align="center"><a accesskey="u" href="contrib.html" title="Приложение F. Дополнительно поставляемые модули и расширения">Наверх</a></td><td width="40%" align="right"> <a accesskey="n" href="fuzzystrmatch.html" title="F.17. fuzzystrmatch — вычисление схожести и расстояния между строками">След.</a></td></tr><tr><td width="40%" align="left" valign="top">F.15. earthdistance — вычисление расстояний между точками на Земле </td><td width="20%" align="center"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="40%" align="right" valign="top"> F.17. fuzzystrmatch — вычисление схожести и расстояния между строками</td></tr></table></div></body></html>