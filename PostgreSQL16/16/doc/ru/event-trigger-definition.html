<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>40.1. Обзор механизма работы триггеров событий</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@lists.postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets Vsnapshot" /><link rel="prev" href="event-triggers.html" title="Глава 40. Триггеры событий" /><link rel="next" href="event-trigger-matrix.html" title="40.2. Матрица срабатывания триггеров событий" /></head><body id="docContent" class="container-fluid col-10"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="5" align="center">40.1. Обзор механизма работы триггеров событий</th></tr><tr><td width="10%" align="left"><a accesskey="p" href="event-triggers.html" title="Глава 40. Триггеры событий">Пред.</a> </td><td width="10%" align="left"><a accesskey="u" href="event-triggers.html" title="Глава 40. Триггеры событий">Наверх</a></td><th width="60%" align="center">Глава 40. Триггеры событий</th><td width="10%" align="right"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="10%" align="right"> <a accesskey="n" href="event-trigger-matrix.html" title="40.2. Матрица срабатывания триггеров событий">След.</a></td></tr></table><hr /></div><div class="sect1" id="EVENT-TRIGGER-DEFINITION"><div class="titlepage"><div><div><h2 class="title" style="clear: both">40.1. Обзор механизма работы триггеров событий <a href="#EVENT-TRIGGER-DEFINITION" class="id_link">#</a></h2></div></div></div><p>Триггер события срабатывает всякий раз, когда в базе данных, в которой он определён, происходит связанное с ним событие. В настоящий момент поддерживаются следующие события: <code class="literal">ddl_command_start</code>, <code class="literal">ddl_command_end</code>, <code class="literal">table_rewrite</code> и <code class="literal">sql_drop</code>. Поддержка дополнительных событий может быть добавлена в будущих выпусках.</p><p>Событие <code class="literal">ddl_command_start</code> происходит непосредственно перед выполнением команд <code class="literal">CREATE</code>, <code class="literal">ALTER</code>, <code class="literal">DROP</code>, <code class="literal">SECURITY LABEL</code>, <code class="literal">COMMENT</code>, <code class="literal">GRANT</code> и <code class="literal">REVOKE</code>. Проверка на существование объекта перед срабатыванием триггера не производится. В качестве исключения, однако, это событие не происходит для команд DDL, обращающихся к общим объектам кластера базы данных — базам данных, табличным пространствам, ролям, а также к самим триггерам событий. Событие <code class="literal">ddl_command_start</code> также происходит непосредственно перед выполнением команды <code class="literal">SELECT INTO</code>, так как она равнозначна команде <code class="literal">CREATE TABLE AS</code>.</p><p>Событие <code class="literal">ddl_command_end</code> происходит непосредственно после выполнения команд из того же набора. Чтобы получить дополнительную информацию об операциях <acronym class="acronym">DDL</acronym>, повлёкших произошедшее событие, вызовите функцию <code class="literal">pg_event_trigger_ddl_commands()</code>, возвращающую множество, из кода обработчика события <code class="literal">ddl_command_end</code> (см. <a class="xref" href="functions-event-triggers.html" title="9.29. Функции событийных триггеров">Раздел 9.29</a>). Заметьте, что этот триггер срабатывает после того, как эти действия имели место (но до фиксации транзакции), так что в системных каталогах можно увидеть уже изменённое состояние.</p><p>Событие <code class="literal">sql_drop</code> происходит непосредственно перед событием <code class="literal">ddl_command_end</code> для команд, которые удаляют объекты базы данных. Для получения списка удалённых объектов используйте возвращающую набор строк функцию <code class="literal">pg_event_trigger_dropped_objects()</code> в триггере события <code class="literal">sql_drop</code> (см. <a class="xref" href="functions-event-triggers.html" title="9.29. Функции событийных триггеров">Раздел 9.29</a>). Обратите внимание, что триггер выполняется после удаления объектов из таблиц системного каталога, поэтому их невозможно больше увидеть.</p><p>Событие <code class="literal">table_rewrite</code> происходит непосредственно перед тем, как таблица будет перезаписана в результате определённых действий команд <code class="literal">ALTER TABLE</code> и <code class="literal">ALTER TYPE</code>. Хотя перезапись таблицы может быть вызвана и другими управляющими операторами, в частности <code class="literal">CLUSTER</code> и <code class="literal">VACUUM</code>, событие <code class="literal">table_rewrite</code> для них не вызывается.</p><p>Триггеры событий (как и прочие функции) не могут выполняться в прерванной транзакции. Поэтому, если команда DDL завершается ошибкой, соответствующие триггеры <code class="literal">ddl_command_end</code> не сработают. И наоборот, если триггер <code class="literal">ddl_command_end</code> завершился с ошибкой, последующие триггеры событий не сработают, так же как и сама команда не будет выполняться. Похожим образом, если триггер <code class="literal">ddl_command_end</code> завершится ошибкой, действие команды DDL будет отменено, как это происходит при возникновении ошибки внутри транзакции.</p><p>Полный список команд, которые поддерживаются триггерами событий, можно найти в <a class="xref" href="event-trigger-matrix.html" title="40.2. Матрица срабатывания триггеров событий">Разделе 40.2</a>.</p><p>Для создания триггера события используется команда <a class="xref" href="sql-createeventtrigger.html" title="CREATE EVENT TRIGGER"><span class="refentrytitle">CREATE EVENT TRIGGER</span></a>. Предварительно нужно создать функцию, со специальным возвращаемым типом <code class="literal">event_trigger</code>. Данная функция не обязана возвращать значение (и может не возвращать). Возвращаемый тип служит лишь указанием на то, что функция будет вызываться из триггера события.</p><p>Если есть несколько триггеров на одно и то же событие, то они будут вызываться в алфавитном порядке по имени триггера.</p><p>В определении триггера можно использовать условие <code class="literal">WHEN</code>, чтобы, например, триггер <code class="literal">ddl_command_start</code> срабатывал только для отдельных команд, которые нужно перехватить. Триггеры событий часто используются для ограничения диапазона DDL-команд, доступных пользователям.</p></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="event-triggers.html" title="Глава 40. Триггеры событий">Пред.</a> </td><td width="20%" align="center"><a accesskey="u" href="event-triggers.html" title="Глава 40. Триггеры событий">Наверх</a></td><td width="40%" align="right"> <a accesskey="n" href="event-trigger-matrix.html" title="40.2. Матрица срабатывания триггеров событий">След.</a></td></tr><tr><td width="40%" align="left" valign="top">Глава 40. Триггеры событий </td><td width="20%" align="center"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="40%" align="right" valign="top"> 40.2. Матрица срабатывания триггеров событий</td></tr></table></div></body></html>