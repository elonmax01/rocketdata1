<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>73.1. Размещение файлов базы данных</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@lists.postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets Vsnapshot" /><link rel="prev" href="storage.html" title="Глава 73. Физическое хранение базы данных" /><link rel="next" href="storage-toast.html" title="73.2. TOAST" /></head><body id="docContent" class="container-fluid col-10"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="5" align="center">73.1. Размещение файлов базы данных</th></tr><tr><td width="10%" align="left"><a accesskey="p" href="storage.html" title="Глава 73. Физическое хранение базы данных">Пред.</a> </td><td width="10%" align="left"><a accesskey="u" href="storage.html" title="Глава 73. Физическое хранение базы данных">Наверх</a></td><th width="60%" align="center">Глава 73. Физическое хранение базы данных</th><td width="10%" align="right"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="10%" align="right"> <a accesskey="n" href="storage-toast.html" title="73.2. TOAST">След.</a></td></tr></table><hr /></div><div class="sect1" id="STORAGE-FILE-LAYOUT"><div class="titlepage"><div><div><h2 class="title" style="clear: both">73.1. Размещение файлов базы данных <a href="#STORAGE-FILE-LAYOUT" class="id_link">#</a></h2></div></div></div><p>В данном разделе описывается формат хранения на уровне файлов и каталогов.</p><p>Файлы конфигурации и файлы данных, используемые кластером базы данных, традиционно хранятся вместе в каталоге данных кластера, который обычно называют <code class="varname">PGDATA</code> (по имени переменной среды, которую можно использовать для его определения). Обычно <code class="varname">PGDATA</code> находится в <code class="filename">/var/lib/pgsql/data</code>. На одной и той же машине может находиться множество кластеров, управляемых различными экземплярами сервера.</p><p>В каталоге <code class="varname">PGDATA</code> содержится несколько подкаталогов и управляющих файлов, как показано в <a class="xref" href="storage-file-layout.html#PGDATA-CONTENTS-TABLE" title="Таблица 73.1. Содержание PGDATA">Таблице 73.1</a>. В дополнение к этим обязательным элементам конфигурационные файлы кластера <code class="filename">postgresql.conf</code>, <code class="filename">pg_hba.conf</code> и <code class="filename">pg_ident.conf</code> традиционно хранятся в <code class="varname">PGDATA</code>, хотя их можно разместить и в другом месте.</p><div class="table" id="PGDATA-CONTENTS-TABLE"><p class="title"><strong>Таблица 73.1. Содержание <code class="varname">PGDATA</code></strong></p><div class="table-contents"><table class="table" summary="Содержание PGDATA" border="1"><colgroup><col /><col /></colgroup><thead><tr><th>Элемент</th><th>Описание</th></tr></thead><tbody><tr><td><code class="filename">PG_VERSION</code></td><td>Файл, содержащий номер основной версии <span class="productname">PostgreSQL</span></td></tr><tr><td><code class="filename">base</code></td><td>Подкаталог, содержащий подкаталоги для каждой базы данных</td></tr><tr><td><code class="filename">current_logfiles</code></td><td>Файл, в котором отмечается, в какие файлы журналов производит запись сборщик сообщений</td></tr><tr><td><code class="filename">global</code></td><td>Подкаталог, содержащий общие таблицы кластера, такие как <code class="structname">pg_database</code></td></tr><tr><td><code class="filename">pg_commit_ts</code></td><td>Подкаталог, содержащий данные о времени фиксации транзакций</td></tr><tr><td><code class="filename">pg_dynshmem</code></td><td>Подкаталог, содержащий файлы, используемые подсистемой динамически разделяемой памяти</td></tr><tr><td><code class="filename">pg_logical</code></td><td>Подкаталог, содержащий данные о состоянии для логического декодирования</td></tr><tr><td><code class="filename">pg_multixact</code></td><td>Подкаталог, содержащий данные о состоянии мультитранзакций (используемые для разделяемой блокировки строк)</td></tr><tr><td><code class="filename">pg_notify</code></td><td>Подкаталог, содержащий данные состояния прослушивания и уведомлений (LISTEN/NOTIFY)</td></tr><tr><td><code class="filename">pg_replslot</code></td><td>Подкаталог, содержащий данные слота репликации</td></tr><tr><td><code class="filename">pg_serial</code></td><td>Подкаталог, содержащий информацию о выполненных сериализуемых транзакциях.</td></tr><tr><td><code class="filename">pg_snapshots</code></td><td>Подкаталог, содержащий экспортированные снимки (snapshots)</td></tr><tr><td><code class="filename">pg_stat</code></td><td>Подкаталог, содержащий постоянные файлы для подсистемы статистики.</td></tr><tr><td><code class="filename">pg_stat_tmp</code></td><td>Подкаталог, содержащий временные файлы для подсистемы статистики</td></tr><tr><td><code class="filename">pg_subtrans</code></td><td>Подкаталог, содержащий данные о состоянии подтранзакций</td></tr><tr><td><code class="filename">pg_tblspc</code></td><td>Подкаталог, содержащий символические ссылки на табличные пространства</td></tr><tr><td><code class="filename">pg_twophase</code></td><td>Подкаталог, содержащий файлы состояний для подготовленных транзакций</td></tr><tr><td><code class="filename">pg_wal</code></td><td>Подкаталог, содержащий файлы WAL (журнал предзаписи)</td></tr><tr><td><code class="filename">pg_xact</code></td><td>Подкаталог, содержащий данные о состоянии транзакции</td></tr><tr><td><code class="filename">postgresql.auto.conf</code></td><td>Файл, используемый для хранения параметров конфигурации, которые устанавливаются при помощи <code class="command">ALTER SYSTEM</code></td></tr><tr><td><code class="filename">postmaster.opts</code></td><td>Файл, содержащий параметры командной строки, с которыми сервер был запущен в последний раз</td></tr><tr><td><code class="filename">postmaster.pid</code></td><td>Файл блокировки, содержащий идентификатор (ID) текущего управляющего процесса (PID), путь к каталогу данных кластера, время запуска управляющего процесса, номер порта, путь к каталогу Unix-сокета (может быть пустым), первый корректный адрес прослушивания (listen_address) (IP-адрес или <code class="literal">*</code>, либо пустое значение в случае отсутствия прослушивания по TCP), и ID сегмента разделяемой памяти (этот файл отсутствует после остановки сервера).</td></tr></tbody></table></div></div><br class="table-break" /><p>Для каждой базы данных в кластере существует подкаталог внутри <code class="varname">PGDATA</code><code class="filename">/base</code>, названный по OID базы данных в <code class="structname">pg_database</code>. Этот подкаталог по умолчанию является местом хранения файлов базы данных; в частности, там хранятся её системные каталоги.</p><p>Обратите внимание, в следующих разделах описывается поведение встроенного <a class="link" href="tableam.html" title="Глава 63. Определение интерфейса для табличных методов доступа">табличного метода доступа</a> <code class="literal">heap</code> и встроенных <a class="link" href="indexam.html" title="Глава 64. Определение интерфейса для индексных методов доступа">индексных методов доступа</a>. Однако <span class="productname">PostgreSQL</span> по своей природе является расширяемым, и поэтому другие методы доступа могут работать иначе.</p><p>Каждая таблица и индекс хранятся в отдельном файле. Для обычных отношений, эти файлы получают имя по номеру <em class="firstterm">файлового узла</em> таблицы или индекса, который содержится в <code class="structname">pg_class</code>.<code class="structfield">relfilenode</code>. Но для временных отношений, имя файла имеет форму <code class="literal">t<em class="replaceable"><code>BBB</code></em>_<em class="replaceable"><code>FFF</code></em></code>, где <em class="replaceable"><code>BBB</code></em> - идентификатор серверного процесса сервера, который создал данный файл, а <em class="replaceable"><code>FFF</code></em> — номер файлового узла. В обоих случаях, помимо главного файла (также называемого основным слоем), у каждой таблицы и индекса есть <em class="firstterm">карта свободного пространства</em> (см. <a class="xref" href="storage-fsm.html" title="73.3. Карта свободного пространства">Раздел 73.3</a>), в которой хранится информация о свободном пространстве в данном отношении. Имя файла карты свободного пространства образуется из номера файлового узла с суффиксом <code class="literal">_fsm</code>. Также таблицы имеют <em class="firstterm">карту видимости</em>, хранящуюся в слое с суффиксом <code class="literal">_vm</code>, для отслеживания страниц, не содержащих мёртвых записей. Карта видимости подробнее описана в <a class="xref" href="storage-vm.html" title="73.4. Карта видимости">Разделе 73.4</a>. Нежурналируемые таблицы и индексы имеют третий слой, так называемый слой инициализации, имя которого содержит суффикс <code class="literal">_init</code> (см. <a class="xref" href="storage-init.html" title="73.5. Слой инициализации">Раздел 73.5</a>).</p><div class="caution"><h3 class="title">Внимание</h3><p>Заметьте, что хотя номер файла таблицы часто совпадает с её OID, так бывает <span class="emphasis"><em>не</em></span> всегда; некоторые операции, например, <code class="command">TRUNCATE</code>, <code class="command">REINDEX</code>, <code class="command">CLUSTER</code> и некоторые формы команды <code class="command">ALTER TABLE</code> могут изменить номер файла, но при этом сохранят OID. Не следует рассчитывать, что номер файлового узла и OID таблицы совпадают. Кроме того, для некоторых системных каталогов, включая и <code class="structname">pg_class</code>, в <code class="structname">pg_class</code>.<code class="structfield">relfilenode</code> содержится ноль. Фактический номер файлового узла для них хранится в низкоуровневой структуре данных, и его можно получить при помощи функции <code class="function">pg_relation_filenode()</code>.</p></div><p>Когда объём таблицы или индекса превышает 1 GB, они делятся на <em class="firstterm">сегменты</em> размером в один гигабайт. Файл первого сегмента называется по номеру файлового узла (filenode); последующие сегменты получают имена filenode.1, filenode.2 и т. д. При такой организации хранения не возникает проблем на платформах, имеющих ограничения по размеру файлов. (На самом деле, 1 ГБ — лишь размер по умолчанию. Размер сегмента можно изменить при сборке <span class="productname">PostgreSQL</span>, используя параметр конфигурации <code class="option">--with-segsize</code>.) В принципе, карты свободного пространства и карты видимости также могут занимать нескольких сегментов, хотя на практике это маловероятно.</p><p>У таблицы, столбцы которой могут содержать данные большого объёма, будет иметься собственная таблица <em class="firstterm">TOAST</em>, предназначенная для отдельного хранения значений, которые слишком велики для хранения в строках самой таблицы. Основная таблица связывается с её таблицей <acronym class="acronym">TOAST</acronym> (если таковая имеется) через <code class="structname">pg_class</code>.<code class="structfield">reltoastrelid</code>. За подробной информацией обратитесь к <a class="xref" href="storage-toast.html" title="73.2. TOAST">Разделу 73.2</a>.</p><p>Содержание таблиц и индексов рассматривается ниже (см. <a class="xref" href="storage-page-layout.html" title="73.6. Компоновка страницы базы данных">Раздел 73.6</a>).</p><p>Табличное пространство делает сценарий более сложным. Каждое пользовательское табличное пространство имеет символическую ссылку внутри каталога <code class="varname">PGDATA</code><code class="filename">/pg_tblspc</code>, указывающую на физический каталог табличного пространства (т. е., положение, указанное в команде табличного пространства <code class="command">CREATE TABLESPACE</code>). Эта символическая ссылка получает имя по OID табличного пространства. Внутри физического каталога табличного пространства имеется подкаталог, имя которого зависит от версии сервера <span class="productname">PostgreSQL</span>, как например <code class="literal">PG_9.0_201008051</code>. (Этот подкаталог используется для того, чтобы последующие версии базы данных могли свободно использовать одно и то же местоположение, заданное в <code class="command">CREATE TABLESPACE</code>.) Внутри каталога конкретной версии находится подкаталог для каждой базы данных, которая имеет элементы в табличном пространстве, названный по OID базы данных. Таблицы и индексы хранятся внутри этого каталога, используя схему именования файловых узлов. Табличное пространство <code class="literal">pg_default</code> недоступно через <code class="filename">pg_tblspc</code>, но соответствует <code class="varname">PGDATA</code><code class="filename">/base</code>. Подобным же образом, табличное пространство <code class="literal">pg_global</code> недоступно через <code class="filename">pg_tblspc</code>, но соответствует <code class="varname">PGDATA</code><code class="filename">/global</code>.</p><p>Функция <code class="function">pg_relation_filepath()</code> показывает полный путь (относительно <code class="varname">PGDATA</code>) для любого отношения. Часто это избавляет от необходимости запоминать многие из приведённых выше правил. Но следует помнить, что эта функция выдаёт лишь имя первого сегмента основного слоя отношения, т. е. возможно, понадобится добавить номер сегмента и/или <code class="literal">_fsm</code>, <code class="literal">_vm</code> или <code class="literal">_init</code>, чтобы найти все файлы, связанные с отношением.</p><p>Временные файлы (для таких операций, как сортировка объёма данных большего, чем может уместиться в памяти) создаются внутри <code class="varname">PGDATA</code><code class="filename">/base/pgsql_tmp</code> или внутри подкаталога <code class="filename">pgsql_tmp</code> каталога табличного пространства, если для них определено табличное пространство, отличное от <code class="literal">pg_default</code>. Имя временного файла имеет форму <code class="filename">pgsql_tmp<em class="replaceable"><code>PPP</code></em>.<em class="replaceable"><code>NNN</code></em></code>, где <em class="replaceable"><code>PPP</code></em> — PID серверного процесса, а <em class="replaceable"><code>NNN</code></em> служит для разделения различных временных файлов этого серверного процесса.</p></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="storage.html" title="Глава 73. Физическое хранение базы данных">Пред.</a> </td><td width="20%" align="center"><a accesskey="u" href="storage.html" title="Глава 73. Физическое хранение базы данных">Наверх</a></td><td width="40%" align="right"> <a accesskey="n" href="storage-toast.html" title="73.2. TOAST">След.</a></td></tr><tr><td width="40%" align="left" valign="top">Глава 73. Физическое хранение базы данных </td><td width="20%" align="center"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="40%" align="right" valign="top"> 73.2. TOAST</td></tr></table></div></body></html>