<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>46.7. Явные подтранзакции</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@lists.postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets Vsnapshot" /><link rel="prev" href="plpython-database.html" title="46.6. Обращение к базе данных" /><link rel="next" href="plpython-transactions.html" title="46.8. Управление транзакциями" /></head><body id="docContent" class="container-fluid col-10"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="5" align="center">46.7. Явные подтранзакции</th></tr><tr><td width="10%" align="left"><a accesskey="p" href="plpython-database.html" title="46.6. Обращение к базе данных">Пред.</a> </td><td width="10%" align="left"><a accesskey="u" href="plpython.html" title="Глава 46. PL/Python — процедурный язык Python">Наверх</a></td><th width="60%" align="center">Глава 46. PL/Python — процедурный язык Python</th><td width="10%" align="right"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="10%" align="right"> <a accesskey="n" href="plpython-transactions.html" title="46.8. Управление транзакциями">След.</a></td></tr></table><hr /></div><div class="sect1" id="PLPYTHON-SUBTRANSACTION"><div class="titlepage"><div><div><h2 class="title" style="clear: both">46.7. Явные подтранзакции <a href="#PLPYTHON-SUBTRANSACTION" class="id_link">#</a></h2></div></div></div><div class="toc"><dl class="toc"><dt><span class="sect2"><a href="plpython-subtransaction.html#PLPYTHON-SUBTRANSACTION-CONTEXT-MANAGERS">46.7.1. Менеджеры контекста подтранзакций</a></span></dt></dl></div><p>Перехват ошибок, произошедших при обращении к базе данных, как описано в <a class="xref" href="plpython-database.html#PLPYTHON-TRAPPING" title="46.6.2. Обработка ошибок">Подразделе 46.6.2</a>, может привести к нежелательной ситуации, когда часть операций будет успешно выполнена, прежде чем произойдёт сбой. Данные останутся в несогласованном состоянии после обработки такой ошибки. PL/Python предлагает решение этой проблемы в форме явных подтранзакций.</p><div class="sect2" id="PLPYTHON-SUBTRANSACTION-CONTEXT-MANAGERS"><div class="titlepage"><div><div><h3 class="title">46.7.1. Менеджеры контекста подтранзакций <a href="#PLPYTHON-SUBTRANSACTION-CONTEXT-MANAGERS" class="id_link">#</a></h3></div></div></div><p>Рассмотрим функцию, осуществляющую перевод средств между двумя счетами: </p><pre class="programlisting">CREATE FUNCTION transfer_funds() RETURNS void AS $$
try:
    plpy.execute("UPDATE accounts SET balance = balance - 100 WHERE account_name = 'joe'")
    plpy.execute("UPDATE accounts SET balance = balance + 100 WHERE account_name = 'mary'")
except plpy.SPIError as e:
    result = "error transferring funds: %s" % e.args
else:
    result = "funds transferred correctly"
plan = plpy.prepare("INSERT INTO operations (result) VALUES ($1)", ["text"])
plpy.execute(plan, [result])
$$ LANGUAGE plpython3u;</pre><p> Если при выполнении второго оператора <code class="literal">UPDATE</code> произойдёт исключение, эта функция сообщит об ошибке, но результат первого <code class="literal">UPDATE</code> будет тем не менее зафиксирован. Другими словами, средства будут списаны со счёта Джо, но не зачислятся на счёт Мэри.</p><p>Во избежание таких проблем можно завернуть вызовы <code class="literal">plpy.execute</code> в явную подтранзакцию. Модуль <code class="literal">plpy</code> предоставляет вспомогательный объект для управления явными подтранзакциями, создаваемый функцией <code class="literal">plpy.subtransaction()</code>. Объекты, созданные этой функцией, реализуют <a class="ulink" href="https://docs.python.org/library/stdtypes.html#context-manager-types" target="_top">интерфейс менеджера контекста</a>. Используя явные подтранзакции, мы можем переписать нашу функцию так: </p><pre class="programlisting">CREATE FUNCTION transfer_funds2() RETURNS void AS $$
try:
    with plpy.subtransaction():
        plpy.execute("UPDATE accounts SET balance = balance - 100 WHERE account_name = 'joe'")
        plpy.execute("UPDATE accounts SET balance = balance + 100 WHERE account_name = 'mary'")
except plpy.SPIError as e:
    result = "error transferring funds: %s" % e.args
else:
    result = "funds transferred correctly"
plan = plpy.prepare("INSERT INTO operations (result) VALUES ($1)", ["text"])
plpy.execute(plan, [result])
$$ LANGUAGE plpython3u;</pre><p> Заметьте, что конструкция <code class="literal">try</code>/<code class="literal">except</code> по-прежнему нужна. Без неё исключение распространится вверх по стеку Python и приведёт к прерыванию всей функции с ошибкой <span class="productname">PostgreSQL</span>, так что в таблицу <code class="literal">operations</code> запись не добавится. Менеджер контекста подтранзакции не перехватывает ошибки, он только гарантирует, что все операции с базой данных в его области действия будут атомарно зафиксированы или отменены. Откат блока подтранзакции происходит при исключении любого вида, а не только исключения, вызванного ошибками при обращении к базе данных. Обычное исключение Python, вызванное внутри блока явной подтранзакции, также приведёт к откату этой подтранзакции.</p></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="plpython-database.html" title="46.6. Обращение к базе данных">Пред.</a> </td><td width="20%" align="center"><a accesskey="u" href="plpython.html" title="Глава 46. PL/Python — процедурный язык Python">Наверх</a></td><td width="40%" align="right"> <a accesskey="n" href="plpython-transactions.html" title="46.8. Управление транзакциями">След.</a></td></tr><tr><td width="40%" align="left" valign="top">46.6. Обращение к базе данных </td><td width="20%" align="center"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="40%" align="right" valign="top"> 46.8. Управление транзакциями</td></tr></table></div></body></html>