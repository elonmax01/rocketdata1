<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>F.33. pgstattuple — получение статистики на уровне кортежей</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@lists.postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets Vsnapshot" /><link rel="prev" href="pgstatstatements.html" title="F.32. pg_stat_statements — отслеживание статистики планирования и выполнения SQL-операторов" /><link rel="next" href="pgsurgery.html" title="F.34. pg_surgery — проведение операций низкого уровня с данными отношений" /></head><body id="docContent" class="container-fluid col-10"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="5" align="center">F.33. pgstattuple — получение статистики на уровне кортежей</th></tr><tr><td width="10%" align="left"><a accesskey="p" href="pgstatstatements.html" title="F.32. pg_stat_statements — отслеживание статистики планирования и выполнения SQL-операторов">Пред.</a> </td><td width="10%" align="left"><a accesskey="u" href="contrib.html" title="Приложение F. Дополнительно поставляемые модули и расширения">Наверх</a></td><th width="60%" align="center">Приложение F. Дополнительно поставляемые модули и расширения</th><td width="10%" align="right"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="10%" align="right"> <a accesskey="n" href="pgsurgery.html" title="F.34. pg_surgery — проведение операций низкого уровня с данными отношений">След.</a></td></tr></table><hr /></div><div class="sect1" id="PGSTATTUPLE"><div class="titlepage"><div><div><h2 class="title" style="clear: both">F.33. pgstattuple — получение статистики на уровне кортежей <a href="#PGSTATTUPLE" class="id_link">#</a></h2></div></div></div><div class="toc"><dl class="toc"><dt><span class="sect2"><a href="pgstattuple.html#PGSTATTUPLE-FUNCS">F.33.1. Функции</a></span></dt><dt><span class="sect2"><a href="pgstattuple.html#PGSTATTUPLE-AUTHORS">F.33.2. Авторы</a></span></dt></dl></div><a id="id-1.11.7.43.2" class="indexterm"></a><p>Модуль <code class="filename">pgstattuple</code> предоставляет различные функции для получения статистики на уровне кортежей.</p><p>Так как эти функции возвращают подробную информацию, относящуюся к уровню страницы, доступ к ним по умолчанию ограничен. Право <code class="literal">EXECUTE</code> для них имеет только роль <code class="literal">pg_stat_scan_tables</code>. Разумеется, суперпользователи могут обойти это ограничение. После того как это расширение установлено, можно поменять права доступа к этим функциям командами <code class="command">GRANT</code> и разрешить их выполнение другим пользователям. Однако предпочтительнее будет добавить этих пользователей в роль <code class="literal">pg_stat_scan_tables</code>.</p><div class="sect2" id="PGSTATTUPLE-FUNCS"><div class="titlepage"><div><div><h3 class="title">F.33.1. Функции <a href="#PGSTATTUPLE-FUNCS" class="id_link">#</a></h3></div></div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term">
     <a id="id-1.11.7.43.5.2.1.1.1" class="indexterm"></a>
     <code class="function">pgstattuple(regclass) returns record</code>
    </span></dt><dd><p>Функция <code class="function">pgstattuple</code> возвращает физическую длину отношения, процент <span class="quote">«<span class="quote">мёртвых</span>»</span> кортежей и другую информацию. Она может быть полезна для принятия решения о необходимости очистки. В аргументе передаётся имя (возможно, дополненное схемой) или OID целевого отношения. Например: </p><pre class="programlisting">test=&gt; SELECT * FROM pgstattuple('pg_catalog.pg_proc');
-[ RECORD 1 ]------+-------
table_len          | 458752
tuple_count        | 1470
tuple_len          | 438896
tuple_percent      | 95.67
dead_tuple_count   | 11
dead_tuple_len     | 3157
dead_tuple_percent | 0.69
free_space         | 8932
free_percent       | 1.95</pre><p> Столбцы результата описаны в <a class="xref" href="pgstattuple.html#PGSTATTUPLE-COLUMNS" title="Таблица F.24. Столбцы результата pgstattuple">Таблице F.24</a>.</p><div class="table" id="PGSTATTUPLE-COLUMNS"><p class="title"><strong>Таблица F.24. Столбцы результата <code class="function">pgstattuple</code></strong></p><div class="table-contents"><table class="table" summary="Столбцы результата pgstattuple" border="1"><colgroup><col /><col /><col /></colgroup><thead><tr><th>Столбец</th><th>Тип</th><th>Описание</th></tr></thead><tbody><tr><td><code class="structfield">table_len</code></td><td><code class="type">bigint</code></td><td>Физическая длина отношения в байтах</td></tr><tr><td><code class="structfield">tuple_count</code></td><td><code class="type">bigint</code></td><td>Количество «живых» кортежей</td></tr><tr><td><code class="structfield">tuple_len</code></td><td><code class="type">bigint</code></td><td>Общая длина «живых» кортежей в байтах</td></tr><tr><td><code class="structfield">tuple_percent</code></td><td><code class="type">float8</code></td><td>Процент «живых» кортежей</td></tr><tr><td><code class="structfield">dead_tuple_count</code></td><td><code class="type">bigint</code></td><td>Количество «мёртвых» кортежей</td></tr><tr><td><code class="structfield">dead_tuple_len</code></td><td><code class="type">bigint</code></td><td>Общая длина «мёртвых» кортежей в байтах</td></tr><tr><td><code class="structfield">dead_tuple_percent</code></td><td><code class="type">float8</code></td><td>Процент «мёртвых» кортежей</td></tr><tr><td><code class="structfield">free_space</code></td><td><code class="type">bigint</code></td><td>Общий объём свободного пространства в байтах</td></tr><tr><td><code class="structfield">free_percent</code></td><td><code class="type">float8</code></td><td>Процент свободного пространства</td></tr></tbody></table></div></div><br class="table-break" /><div class="note"><h3 class="title">Примечание</h3><p>Значение <code class="literal">table_len</code> всегда будет больше суммы <code class="literal">tuple_len</code>, <code class="literal">dead_tuple_len</code> и <code class="literal">free_space</code>. Разница объясняется фиксированными издержками, внутристраничной таблицей указателей на кортежи и пропусками, добавляемыми для выравнивания кортежей.</p></div><p>Функция <code class="function">pgstattuple</code> получает блокировку отношения только для чтения. Таким образом, её результаты отражают не мгновенный снимок; на них будут влиять параллельные изменения.</p><p><code class="function">pgstattuple</code> считает кортеж <span class="quote">«<span class="quote">мёртвым</span>»</span>, если <code class="function">HeapTupleSatisfiesDirty</code> возвращает false.</p></dd><dt><span class="term">
     <code class="function">pgstattuple(text) returns record</code>
    </span></dt><dd><p>Эта функция равнозначна функции <code class="function">pgstattuple(regclass)</code> за исключением того, что для неё целевое отношение задаётся в текстовом виде. Данная функция оставлена для обратной совместимости, в будущем она может перейти в разряд устаревших.</p></dd><dt><span class="term">
    <a id="id-1.11.7.43.5.2.3.1.1" class="indexterm"></a>
     <code class="function">pgstatindex(regclass) returns record</code>
    </span></dt><dd><p>Функция <code class="function">pgstatindex</code> возвращает запись с информацией об индексе типа B-дерево. Например: </p><pre class="programlisting">test=&gt; SELECT * FROM pgstatindex('pg_cast_oid_index');
-[ RECORD 1 ]------+------
version            | 2
tree_level         | 0
index_size         | 16384
root_block_no      | 1
internal_pages     | 0
leaf_pages         | 1
empty_pages        | 0
deleted_pages      | 0
avg_leaf_density   | 54.27
leaf_fragmentation | 0</pre><p>Столбцы результата: </p><div class="informaltable"><table class="informaltable" border="1"><colgroup><col /><col /><col /></colgroup><thead><tr><th>Столбец</th><th>Тип</th><th>Описание</th></tr></thead><tbody><tr><td><code class="structfield">version</code></td><td><code class="type">integer</code></td><td>Номер версии B-дерева</td></tr><tr><td><code class="structfield">tree_level</code></td><td><code class="type">integer</code></td><td>Уровень корневой страницы в дереве</td></tr><tr><td><code class="structfield">index_size</code></td><td><code class="type">bigint</code></td><td>Общий объём индекса в байтах</td></tr><tr><td><code class="structfield">root_block_no</code></td><td><code class="type">bigint</code></td><td>Расположение страницы корня (0, если её нет)</td></tr><tr><td><code class="structfield">internal_pages</code></td><td><code class="type">bigint</code></td><td>Количество <span class="quote">«<span class="quote">внутренних</span>»</span> страниц (верхнего уровня)</td></tr><tr><td><code class="structfield">leaf_pages</code></td><td><code class="type">bigint</code></td><td>Количество страниц на уровне листьев</td></tr><tr><td><code class="structfield">empty_pages</code></td><td><code class="type">bigint</code></td><td>Количество пустых страниц</td></tr><tr><td><code class="structfield">deleted_pages</code></td><td><code class="type">bigint</code></td><td>Количество удалённых страниц</td></tr><tr><td><code class="structfield">avg_leaf_density</code></td><td><code class="type">float8</code></td><td>Средняя плотность страниц на уровне листьев</td></tr><tr><td><code class="structfield">leaf_fragmentation</code></td><td><code class="type">float8</code></td><td>Фрагментация на уровне листьев</td></tr></tbody></table></div><p>Выдаваемый размер индекса (<code class="literal">index_size</code>) обычно вычисляется по формуле <code class="literal">internal_pages + leaf_pages + empty_pages + deleted_pages</code> плюс одна страница, так как в нём учитывается и метастраница индекса.</p><p>Как и <code class="function">pgstattuple</code>, эта функция собирает данные страница за страницей и не следует ожидать, что её результат представляет мгновенный снимок всего индекса.</p></dd><dt><span class="term">
     <code class="function">pgstatindex(text) returns record</code>
    </span></dt><dd><p>Эта функция равнозначна функции <code class="function">pgstatindex(regclass)</code> за исключением того, что для неё целевое отношение задаётся в текстовом виде. Данная функция оставлена для обратной совместимости, в будущем она может перейти в разряд устаревших.</p></dd><dt><span class="term">
     <a id="id-1.11.7.43.5.2.5.1.1" class="indexterm"></a>
     <code class="function">pgstatginindex(regclass) returns record</code>
    </span></dt><dd><p>Функция <code class="function">pgstatginindex</code> возвращает запись с информацией об индексе типа GIN. Например: </p><pre class="programlisting">test=&gt; SELECT * FROM pgstatginindex('test_gin_index');
-[ RECORD 1 ]--+--
version        | 1
pending_pages  | 0
pending_tuples | 0</pre><p>Столбцы результата: </p><div class="informaltable"><table class="informaltable" border="1"><colgroup><col /><col /><col /></colgroup><thead><tr><th>Столбец</th><th>Тип</th><th>Описание</th></tr></thead><tbody><tr><td><code class="structfield">version</code></td><td><code class="type">integer</code></td><td>Номер версии GIN</td></tr><tr><td><code class="structfield">pending_pages</code></td><td><code class="type">integer</code></td><td>Количество страниц в списке ожидающих обработки</td></tr><tr><td><code class="structfield">pending_tuples</code></td><td><code class="type">bigint</code></td><td>Количество кортежей в списке ожидающих обработки</td></tr></tbody></table></div></dd><dt><span class="term">
     <a id="id-1.11.7.43.5.2.6.1.1" class="indexterm"></a>
     <code class="function">pgstathashindex(regclass) returns record</code>
    </span></dt><dd><p>Функция <code class="function">pgstathashindex</code> возвращает запись с информацией о хеш-индексе. Например: </p><pre class="programlisting">test=&gt; select * from pgstathashindex('con_hash_index');
-[ RECORD 1 ]--+-----------------
version        | 4
bucket_pages   | 33081
overflow_pages | 0
bitmap_pages   | 1
unused_pages   | 32455
live_items     | 10204006
dead_items     | 0
free_percent   | 61.8005949100872</pre><p>Столбцы результата: </p><div class="informaltable"><table class="informaltable" border="1"><colgroup><col /><col /><col /></colgroup><thead><tr><th>Столбец</th><th>Тип</th><th>Описание</th></tr></thead><tbody><tr><td><code class="structfield">version</code></td><td><code class="type">integer</code></td><td>Номер версии HASH</td></tr><tr><td><code class="structfield">bucket_pages</code></td><td><code class="type">bigint</code></td><td>Количество страниц групп</td></tr><tr><td><code class="structfield">overflow_pages</code></td><td><code class="type">bigint</code></td><td>Количество страниц переполнения</td></tr><tr><td><code class="structfield">bitmap_pages</code></td><td><code class="type">bigint</code></td><td>Количество страниц битовой карты</td></tr><tr><td><code class="structfield">unused_pages</code></td><td><code class="type">bigint</code></td><td>Количество неиспользованных страниц</td></tr><tr><td><code class="structfield">live_items</code></td><td><code class="type">bigint</code></td><td>Количество «живых» кортежей</td></tr><tr><td><code class="structfield">dead_tuples</code></td><td><code class="type">bigint</code></td><td>Количество «мёртвых» кортежей</td></tr><tr><td><code class="structfield">free_percent</code></td><td><code class="type">float</code></td><td>Процент свободного пространства</td></tr></tbody></table></div></dd><dt><span class="term">
     <a id="id-1.11.7.43.5.2.7.1.1" class="indexterm"></a>
     <code class="function">pg_relpages(regclass) returns bigint</code>
    </span></dt><dd><p>Функция <code class="function">pg_relpages</code> возвращает число страниц в отношении.</p></dd><dt><span class="term">
     <code class="function">pg_relpages(text) returns bigint</code>
    </span></dt><dd><p>Эта функция равнозначна функции <code class="function">pg_relpages(regclass)</code> за исключением того, что для неё целевое отношение задаётся в текстовом виде. Данная функция оставлена для обратной совместимости, в будущем она может перейти в разряд устаревших.</p></dd><dt><span class="term">
     <a id="id-1.11.7.43.5.2.9.1.1" class="indexterm"></a>
     <code class="function">pgstattuple_approx(regclass) returns record</code>
    </span></dt><dd><p>Функция <code class="function">pgstattuple_approx</code> является более быстрой альтернативой <code class="function">pgstattuple</code>, возвращающей приблизительные результаты. В качестве аргумента ей передаётся имя или OID целевого отношения. Например: </p><pre class="programlisting">test=&gt; SELECT * FROM pgstattuple_approx('pg_catalog.pg_proc'::regclass);
-[ RECORD 1 ]--------+-------
table_len            | 573440
scanned_percent      | 2
approx_tuple_count   | 2740
approx_tuple_len     | 561210
approx_tuple_percent | 97.87
dead_tuple_count     | 0
dead_tuple_len       | 0
dead_tuple_percent   | 0
approx_free_space    | 11996
approx_free_percent  | 2.09</pre><p> Выходные столбцы описаны в <a class="xref" href="pgstattuple.html#PGSTATAPPROX-COLUMNS" title="Таблица F.25. Столбцы результата pgstattuple_approx">Таблице F.25</a>.</p><p>Тогда как <code class="function">pgstattuple</code> всегда производит полное сканирование таблицы и возвращает точное число живых и мёртвых кортежей (и их размер), а также точный объём свободного пространства, функция <code class="function">pgstattuple_approx</code> пытается избежать полного сканирования и возвращает точную статистику только по мёртвым кортежам, а количество и объём живых кортежей, как и объём свободного пространства определяет приблизительно.</p><p>Она делает это, пропуская страницы, в которых, согласно карте видимости, есть только видимые кортежи (если для страницы установлен соответствующий бит, предполагается, что она не содержит мёртвых кортежей). Для таких страниц эта функция узнаёт объём свободного пространства из карты свободного пространства и предполагает, что остальное пространство на странице занято живыми кортежами.</p><p>На страницах, которые нельзя пропустить, она сканирует каждый кортеж, отражает его наличие и размер в соответствующих счётчиках и суммирует свободное пространство на странице. В конце она оценивает приблизительно общее число живых кортежей, исходя из числа просканированных страниц и кортежей (так же, как VACUUM рассчитывает значение pg_class.reltuples).</p><div class="table" id="PGSTATAPPROX-COLUMNS"><p class="title"><strong>Таблица F.25. Столбцы результата <code class="function">pgstattuple_approx</code></strong></p><div class="table-contents"><table class="table" summary="Столбцы результата pgstattuple_approx" border="1"><colgroup><col /><col /><col /></colgroup><thead><tr><th>Столбец</th><th>Тип</th><th>Описание</th></tr></thead><tbody><tr><td><code class="structfield">table_len</code></td><td><code class="type">bigint</code></td><td>Физическая длина отношения в байтах (точная)</td></tr><tr><td><code class="structfield">scanned_percent</code></td><td><code class="type">float8</code></td><td>Просканированный процент таблицы</td></tr><tr><td><code class="structfield">approx_tuple_count</code></td><td><code class="type">bigint</code></td><td>Количество «живых» кортежей (приблизительное)</td></tr><tr><td><code class="structfield">approx_tuple_len</code></td><td><code class="type">bigint</code></td><td>Общая длина «живых» кортежей в байтах (приблизительная)</td></tr><tr><td><code class="structfield">approx_tuple_percent</code></td><td><code class="type">float8</code></td><td>Процент «живых» кортежей</td></tr><tr><td><code class="structfield">dead_tuple_count</code></td><td><code class="type">bigint</code></td><td>Количество «мёртвых» кортежей (точное)</td></tr><tr><td><code class="structfield">dead_tuple_len</code></td><td><code class="type">bigint</code></td><td>Общая длина «мёртвых» кортежей в байтах (точная)</td></tr><tr><td><code class="structfield">dead_tuple_percent</code></td><td><code class="type">float8</code></td><td>Процент «мёртвых» кортежей</td></tr><tr><td><code class="structfield">approx_free_space</code></td><td><code class="type">bigint</code></td><td>Общий объём свободного пространства в байтах (приблизительный)</td></tr><tr><td><code class="structfield">approx_free_percent</code></td><td><code class="type">float8</code></td><td>Процент свободного пространства</td></tr></tbody></table></div></div><br class="table-break" /><p>В показанном выше выводе показатели свободного пространства могут не соответствовать выводу <code class="function">pgstattuple</code> в точности, потому что карта свободного пространства показывает верное значение, но не гарантируется, что оно будет точным до байта.</p></dd></dl></div></div><div class="sect2" id="PGSTATTUPLE-AUTHORS"><div class="titlepage"><div><div><h3 class="title">F.33.2. Авторы <a href="#PGSTATTUPLE-AUTHORS" class="id_link">#</a></h3></div></div></div><p>Тацуо Исии, Сатоши Нагаясу и Абхиджит Менон-Сен</p></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="pgstatstatements.html" title="F.32. pg_stat_statements — отслеживание статистики планирования и выполнения SQL-операторов">Пред.</a> </td><td width="20%" align="center"><a accesskey="u" href="contrib.html" title="Приложение F. Дополнительно поставляемые модули и расширения">Наверх</a></td><td width="40%" align="right"> <a accesskey="n" href="pgsurgery.html" title="F.34. pg_surgery — проведение операций низкого уровня с данными отношений">След.</a></td></tr><tr><td width="40%" align="left" valign="top">F.32. pg_stat_statements — отслеживание статистики планирования и выполнения SQL-операторов </td><td width="20%" align="center"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="40%" align="right" valign="top"> F.34. pg_surgery — проведение операций низкого уровня с данными отношений</td></tr></table></div></body></html>