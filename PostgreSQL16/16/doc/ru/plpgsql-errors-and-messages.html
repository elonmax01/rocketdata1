<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>43.9. Сообщения и ошибки</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@lists.postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets Vsnapshot" /><link rel="prev" href="plpgsql-transactions.html" title="43.8. Управление транзакциями" /><link rel="next" href="plpgsql-trigger.html" title="43.10. Триггерные функции" /></head><body id="docContent" class="container-fluid col-10"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="5" align="center">43.9. Сообщения и ошибки</th></tr><tr><td width="10%" align="left"><a accesskey="p" href="plpgsql-transactions.html" title="43.8. Управление транзакциями">Пред.</a> </td><td width="10%" align="left"><a accesskey="u" href="plpgsql.html" title="Глава 43. PL/pgSQL — процедурный язык SQL">Наверх</a></td><th width="60%" align="center">Глава 43. <span class="application">PL/pgSQL</span> — процедурный язык <acronym class="acronym">SQL</acronym></th><td width="10%" align="right"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="10%" align="right"> <a accesskey="n" href="plpgsql-trigger.html" title="43.10. Триггерные функции">След.</a></td></tr></table><hr /></div><div class="sect1" id="PLPGSQL-ERRORS-AND-MESSAGES"><div class="titlepage"><div><div><h2 class="title" style="clear: both">43.9. Сообщения и ошибки <a href="#PLPGSQL-ERRORS-AND-MESSAGES" class="id_link">#</a></h2></div></div></div><div class="toc"><dl class="toc"><dt><span class="sect2"><a href="plpgsql-errors-and-messages.html#PLPGSQL-STATEMENTS-RAISE">43.9.1. Вывод сообщений и ошибок</a></span></dt><dt><span class="sect2"><a href="plpgsql-errors-and-messages.html#PLPGSQL-STATEMENTS-ASSERT">43.9.2. Проверка утверждений</a></span></dt></dl></div><div class="sect2" id="PLPGSQL-STATEMENTS-RAISE"><div class="titlepage"><div><div><h3 class="title">43.9.1. Вывод сообщений и ошибок <a href="#PLPGSQL-STATEMENTS-RAISE" class="id_link">#</a></h3></div></div></div><a id="id-1.8.8.11.2.2" class="indexterm"></a><a id="id-1.8.8.11.2.3" class="indexterm"></a><p>Команда <code class="command">RAISE</code> предназначена для вывода сообщений и вызова ошибок. </p><pre class="synopsis">
RAISE [<span class="optional"> <em class="replaceable"><code>уровень</code></em> </span>] '<em class="replaceable"><code>формат</code></em>' [<span class="optional">, <em class="replaceable"><code>выражение</code></em> [<span class="optional">, ... </span>]</span>] [<span class="optional"> USING <em class="replaceable"><code>параметр</code></em> = <em class="replaceable"><code>значение</code></em> [<span class="optional">, ... </span>] </span>];
RAISE [<span class="optional"> <em class="replaceable"><code>уровень</code></em> </span>] <em class="replaceable"><code>имя_условия</code></em> [<span class="optional"> USING <em class="replaceable"><code>параметр</code></em> = <em class="replaceable"><code>выражение</code></em> [<span class="optional">, ... </span>] </span>];
RAISE [<span class="optional"> <em class="replaceable"><code>уровень</code></em> </span>] SQLSTATE '<em class="replaceable"><code>sqlstate</code></em>' [<span class="optional"> USING <em class="replaceable"><code>параметр</code></em> = <em class="replaceable"><code>выражение</code></em> [<span class="optional">, ... </span>] </span>];
RAISE [<span class="optional"> <em class="replaceable"><code>уровень</code></em> </span>] USING <em class="replaceable"><code>параметр</code></em> = <em class="replaceable"><code>выражение</code></em> [<span class="optional">, ... </span>];
RAISE ;
</pre><p> <em class="replaceable"><code>уровень</code></em> задаёт уровень важности ошибки. Возможные значения: <code class="literal">DEBUG</code>, <code class="literal">LOG</code>, <code class="literal">INFO</code>, <code class="literal">NOTICE</code>, <code class="literal">WARNING</code> и <code class="literal">EXCEPTION</code>. По умолчанию используется <code class="literal">EXCEPTION</code>. <code class="literal">EXCEPTION</code> вызывает ошибку (что обычно прерывает текущую транзакцию), остальные значения <em class="replaceable"><code>уровня</code></em> только генерируют сообщения с различными уровнями приоритета. Будут ли сообщения конкретного приоритета переданы клиенту или записаны в журнал сервера, или и то, и другое, зависит от конфигурационных переменных <a class="xref" href="runtime-config-logging.html#GUC-LOG-MIN-MESSAGES">log_min_messages</a> и <a class="xref" href="runtime-config-client.html#GUC-CLIENT-MIN-MESSAGES">client_min_messages</a>. За дополнительными сведениями обратитесь к <a class="xref" href="runtime-config.html" title="Глава 20. Настройка сервера">Главе 20</a>.</p><p>После указания <em class="replaceable"><code>уровня</code></em>, если оно есть, можно задать строку <em class="replaceable"><code>формата</code></em> (это должна быть простая строковая константа, не выражение). Строка формата определяет вид текста об ошибке, который будет выдан. За строкой формата могут следовать необязательные выражения аргументов, которые будут вставлены в сообщение. Внутри строки формата знак <code class="literal">%</code> заменяется строковым представлением значения очередного аргумента. Чтобы выдать символ <code class="literal">%</code> буквально, продублируйте его (как <code class="literal">%%</code>). Число аргументов должно совпадать с числом местозаполнителей <code class="literal">%</code> в строке формата, иначе при компиляции функции возникнет ошибка.</p><p>В следующем примере символ <code class="literal">%</code> будет заменён на значение <code class="literal">v_job_id</code>: </p><pre class="programlisting">RAISE NOTICE 'Вызов функции cs_create_job(%)', v_job_id;</pre><p>При помощи <code class="literal">USING</code> и последующих элементов <em class="replaceable"><code>параметр</code></em> = <em class="replaceable"><code>выражение</code></em> можно добавить дополнительную информацию к отчёту об ошибке. Все <em class="replaceable"><code>выражения</code></em> представляют собой строковые выражения. Возможные ключевые слова для <em class="replaceable"><code>параметра</code></em> следующие: </p><div class="variablelist" id="RAISE-USING-OPTIONS"><dl class="variablelist"><dt id="RAISE-USING-OPTION-MESSAGE"><span class="term"><code class="literal">MESSAGE</code></span> <a href="#RAISE-USING-OPTION-MESSAGE" class="id_link">#</a></dt><dd><p>Устанавливает текст сообщения об ошибке. Этот параметр не может использоваться, если в команде <code class="command">RAISE</code> присутствует <em class="replaceable"><code>формат</code></em> перед <code class="literal">USING</code>.</p></dd><dt id="RAISE-USING-OPTION-DETAIL"><span class="term"><code class="literal">DETAIL</code></span> <a href="#RAISE-USING-OPTION-DETAIL" class="id_link">#</a></dt><dd><p>Предоставляет детальное сообщение об ошибке.</p></dd><dt id="RAISE-USING-OPTION-HINT"><span class="term"><code class="literal">HINT</code></span> <a href="#RAISE-USING-OPTION-HINT" class="id_link">#</a></dt><dd><p>Предоставляет подсказку по вызванной ошибке.</p></dd><dt id="RAISE-USING-OPTION-ERRCODE"><span class="term"><code class="literal">ERRCODE</code></span> <a href="#RAISE-USING-OPTION-ERRCODE" class="id_link">#</a></dt><dd><p>Устанавливает код ошибки (<code class="literal">SQLSTATE</code>). Код ошибки задаётся либо по имени, как показано в <a class="xref" href="errcodes-appendix.html" title="Приложение A. Коды ошибок PostgreSQL">Приложении A</a>, или напрямую, пятисимвольный код <code class="literal">SQLSTATE</code>.</p></dd><dt id="RAISE-USING-OPTION-COLUMN"><span class="term"><code class="literal">COLUMN</code><br /></span><span class="term"><code class="literal">CONSTRAINT</code><br /></span><span class="term"><code class="literal">DATATYPE</code><br /></span><span class="term"><code class="literal">TABLE</code><br /></span><span class="term"><code class="literal">SCHEMA</code></span> <a href="#RAISE-USING-OPTION-COLUMN" class="id_link">#</a></dt><dd><p>Предоставляет имя соответствующего объекта, связанного с ошибкой.</p></dd></dl></div><p>Этот пример прерывает транзакцию и устанавливает сообщение об ошибке с подсказкой: </p><pre class="programlisting">RAISE EXCEPTION 'Несуществующий ID --&gt; %', user_id
      USING HINT = 'Проверьте ваш пользовательский ID';</pre><p>Следующие два примера демонстрируют эквивалентные способы задания <code class="literal">SQLSTATE</code>: </p><pre class="programlisting">RAISE 'Duplicate user ID: %', user_id USING ERRCODE = 'unique_violation';
RAISE 'Duplicate user ID: %', user_id USING ERRCODE = '23505';</pre><p>У команды <code class="command">RAISE</code> есть и другой синтаксис, в котором в качестве главного аргумента используется имя или код <code class="literal">SQLSTATE</code> ошибки. Например: </p><pre class="programlisting">RAISE division_by_zero;
RAISE SQLSTATE '22012';</pre><p> Предложение <code class="literal">USING</code> в этом синтаксисе можно использовать для того, чтобы переопределить стандартное сообщение об ошибке, детальное сообщение, подсказку. Ещё один вариант предыдущего примера: </p><pre class="programlisting">RAISE unique_violation USING MESSAGE = 'ID пользователя уже существует: ' || user_id;</pre><p>Ещё один вариант — использовать <code class="literal">RAISE USING</code> или <code class="literal">RAISE <em class="replaceable"><code>уровень</code></em> USING</code>, а всё остальное записать в списке <code class="literal">USING</code>.</p><p>И заключительный вариант, в котором <code class="command">RAISE</code> не имеет параметров вообще. Эта форма может использоваться только в секции <code class="literal">EXCEPTION</code> блока и предназначена для того, чтобы повторно вызвать ошибку, которая сейчас перехвачена и обрабатывается.</p><div class="note"><h3 class="title">Примечание</h3><p>До версии <span class="productname">PostgreSQL</span> 9.1 команда <code class="command">RAISE</code> без параметров всегда вызывала ошибку с выходом из блока, содержащего активную секцию <code class="literal">EXCEPTION</code>. Эту ошибку нельзя было перехватить, даже если <code class="command">RAISE</code> в секции <code class="literal">EXCEPTION</code> поместить во вложенный блок со своей секцией <code class="literal">EXCEPTION</code>. Это было сочтено удивительным и не совместимым с Oracle PL/SQL.</p></div><p>Если в команде <code class="command">RAISE EXCEPTION</code> не задано ни имя, ни код <code class="literal">SQLSTATE</code>, по умолчанию выдаётся <code class="literal">raise_exception</code> (<code class="literal">P0001</code>). Если не задан текст сообщения, по умолчанию в качестве этого текста передаётся имя условия или код SQLSTATE.</p><div class="note"><h3 class="title">Примечание</h3><p>При задании <code class="literal">SQLSTATE</code> кода необязательно использовать только список предопределённых кодов ошибок. В качестве кода ошибки может быть любое пятисимвольное значение, состоящее из цифр и/или ASCII символов в верхнем регистре, кроме <code class="literal">00000</code>. Не рекомендуется использовать коды ошибок, которые заканчиваются на <code class="literal">000</code>, потому что так обозначаются коды категорий. И чтобы их перехватить, нужно перехватывать целую категорию.</p></div></div><div class="sect2" id="PLPGSQL-STATEMENTS-ASSERT"><div class="titlepage"><div><div><h3 class="title">43.9.2. Проверка утверждений <a href="#PLPGSQL-STATEMENTS-ASSERT" class="id_link">#</a></h3></div></div></div><a id="id-1.8.8.11.3.2" class="indexterm"></a><a id="id-1.8.8.11.3.3" class="indexterm"></a><a id="id-1.8.8.11.3.4" class="indexterm"></a><p>Оператор <code class="command">ASSERT</code> представляет удобное средство вставлять отладочные проверки в функции <span class="application">PL/pgSQL</span>. </p><pre class="synopsis">
ASSERT <em class="replaceable"><code>условие</code></em> [<span class="optional"> , <em class="replaceable"><code>сообщение</code></em> </span>];
</pre><p> Здесь <em class="replaceable"><code>условие</code></em> — это логическое выражение, которое, как ожидается, должно быть всегда истинным; если это так, оператор <code class="command">ASSERT</code> больше ничего не делает. Если же оно возвращает ложь или NULL, этот оператор выдаёт исключение <code class="literal">ASSERT_FAILURE</code>. (Если ошибка происходит при вычислении <em class="replaceable"><code>условия</code></em>, она выдаётся как обычная ошибка.)</p><p>Если в нём задаётся необязательное <em class="replaceable"><code>сообщение</code></em>, результат этого выражения (если он не NULL) заменяет сообщение об ошибке по умолчанию <span class="quote">«<span class="quote">assertion failed</span>»</span> (нарушение истинности), в случае, если <em class="replaceable"><code>условие</code></em> не выполняется. В обычном случае, когда условие утверждения выполняется, выражение <em class="replaceable"><code>сообщения</code></em> не вычисляется.</p><p>Проверку утверждений можно включить или отключить с помощью конфигурационного параметра <code class="literal">plpgsql.check_asserts</code>, принимающего логическое значение; по умолчанию она включена (<code class="literal">on</code>). Если этот параметр отключён (<code class="literal">off</code>), операторы <code class="command">ASSERT</code> ничего не делают.</p><p>Учтите, что оператор <code class="command">ASSERT</code> предназначен для выявления программных дефектов, а не для вывода обычных ошибок (для этого используется оператор <code class="command">RAISE</code>, описанный выше).</p></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="plpgsql-transactions.html" title="43.8. Управление транзакциями">Пред.</a> </td><td width="20%" align="center"><a accesskey="u" href="plpgsql.html" title="Глава 43. PL/pgSQL — процедурный язык SQL">Наверх</a></td><td width="40%" align="right"> <a accesskey="n" href="plpgsql-trigger.html" title="43.10. Триггерные функции">След.</a></td></tr><tr><td width="40%" align="left" valign="top">43.8. Управление транзакциями </td><td width="20%" align="center"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="40%" align="right" valign="top"> 43.10. Триггерные функции</td></tr></table></div></body></html>