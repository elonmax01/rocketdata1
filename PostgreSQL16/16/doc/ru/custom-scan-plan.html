<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>61.2. Создание нестандартных планов сканирования</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@lists.postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets Vsnapshot" /><link rel="prev" href="custom-scan-path.html" title="61.1. Создание нестандартных путей сканирования" /><link rel="next" href="custom-scan-execution.html" title="61.3. Выполнение нестандартного сканирования" /></head><body id="docContent" class="container-fluid col-10"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="5" align="center">61.2. Создание нестандартных планов сканирования</th></tr><tr><td width="10%" align="left"><a accesskey="p" href="custom-scan-path.html" title="61.1. Создание нестандартных путей сканирования">Пред.</a> </td><td width="10%" align="left"><a accesskey="u" href="custom-scan.html" title="Глава 61. Написание провайдера нестандартного сканирования">Наверх</a></td><th width="60%" align="center">Глава 61. Написание провайдера нестандартного сканирования</th><td width="10%" align="right"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="10%" align="right"> <a accesskey="n" href="custom-scan-execution.html" title="61.3. Выполнение нестандартного сканирования">След.</a></td></tr></table><hr /></div><div class="sect1" id="CUSTOM-SCAN-PLAN"><div class="titlepage"><div><div><h2 class="title" style="clear: both">61.2. Создание нестандартных планов сканирования <a href="#CUSTOM-SCAN-PLAN" class="id_link">#</a></h2></div></div></div><div class="toc"><dl class="toc"><dt><span class="sect2"><a href="custom-scan-plan.html#CUSTOM-SCAN-PLAN-CALLBACKS">61.2.1. Обработчики плана нестандартного сканирования</a></span></dt></dl></div><p>Нестандартное сканирование представляется в окончательном дереве плана в виде следующей структуры: </p><pre class="programlisting">typedef struct CustomScan
{
    Scan      scan;
    uint32    flags;
    List     *custom_plans;
    List     *custom_exprs;
    List     *custom_private;
    List     *custom_scan_tlist;
    Bitmapset *custom_relids;
    const CustomScanMethods *methods;
} CustomScan;</pre><p>Объект в поле <code class="structfield">scan</code> должен быть инициализирован, как и для любого другого сканирования, и включать оценки стоимости, целевые списки, условия и т. д. Поле <code class="structfield">flags</code> содержит битовую маску с тем же значением, что и в <code class="structname">CustomPath</code>. В поле <code class="structfield">custom_plans</code> могут быть сохранены дочерние узлы <code class="structname">Plan</code>. В <code class="structfield">custom_exprs</code> могут быть сохранены деревья выражений, которые будут исправляться кодом в <code class="filename">setrefs.c</code> и <code class="filename">subselect.c</code>, а в <code class="structfield">custom_private</code> следует сохранить другие внутренние данные, которые будут использоваться только самим провайдером нестандартного сканирования. Поле <code class="structfield">custom_scan_tlist</code> может содержать NIL при сканировании базового отношения, что будет показывать, что нестандартное сканирование возвращает кортежи, соответствующие типу строк базового отношения. В противном случае оно должно указывать на целевой список, описывающий фактические кортежи. Список <code class="structfield">custom_scan_tlist</code> должен устанавливаться при соединениях и может задаваться при сканировании, если провайдер сканирования может вычислять какие-либо выражения без переменных. Поле <code class="structfield">custom_relids</code> заполняется ядром и задаёт набор отношений (индексов в списке отношений), которые обрабатывает данный узел сканирования; когда имеет место сканирование, а не соединение, в этом списке будет всего один элемент. Поле <code class="structfield">methods</code> должно указывать на объект (обычно статически размещённый), реализующий требуемые методы нестандартного сканирования, которые подробнее описываются ниже.</p><p>Когда <code class="structname">CustomScan</code> сканирует одно отношение, в <code class="structfield">scan.scanrelid</code> должен задаваться индекс сканируемой таблицы в списке отношений. Когда он заменяет соединение, поле <code class="structfield">scan.scanrelid</code> должно быть нулевым.</p><p>Деревья планов должны поддерживать возможность копирования функцией <code class="function">copyObject</code>, так что все данные, сохранённые в <span class="quote">«<span class="quote">дополнительных</span>»</span> полях, должны быть узлами, которые может обработать эта функция. Более того, провайдеры нестандартного сканирования не могут заменять структуру <code class="structname">CustomScan</code> расширенной структурой, её содержащей, что возможно с <code class="structname">CustomPath</code> или <code class="structname">CustomScanState</code>.</p><div class="sect2" id="CUSTOM-SCAN-PLAN-CALLBACKS"><div class="titlepage"><div><div><h3 class="title">61.2.1. Обработчики плана нестандартного сканирования <a href="#CUSTOM-SCAN-PLAN-CALLBACKS" class="id_link">#</a></h3></div></div></div><pre class="programlisting">Node *(*CreateCustomScanState) (CustomScan *cscan);</pre><p> Выделяет структуру <code class="structname">CustomScanState</code> для заданного объекта <code class="structname">CustomScan</code>. Фактически выделенная область будет обычно больше, чем требуется для самой структуры <code class="structname">CustomScanState</code>, так как многие провайдеры могут включать её в расширенную структуру в качестве первого поля. В возвращаемом значении должны быть подходящим образом заполнены тег узла и поле <code class="structfield">methods</code>, но другие поля на данном этапе должны быть обнулены; после того как <code class="function">ExecInitCustomScan</code> произведёт базовую инициализацию, будет вызван обработчик <code class="function">BeginCustomScan</code>, в котором провайдер нестандартного сканирования может выполнить все остальные требуемые действия.</p></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="custom-scan-path.html" title="61.1. Создание нестандартных путей сканирования">Пред.</a> </td><td width="20%" align="center"><a accesskey="u" href="custom-scan.html" title="Глава 61. Написание провайдера нестандартного сканирования">Наверх</a></td><td width="40%" align="right"> <a accesskey="n" href="custom-scan-execution.html" title="61.3. Выполнение нестандартного сканирования">След.</a></td></tr><tr><td width="40%" align="left" valign="top">61.1. Создание нестандартных путей сканирования </td><td width="20%" align="center"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="40%" align="right" valign="top"> 61.3. Выполнение нестандартного сканирования</td></tr></table></div></body></html>