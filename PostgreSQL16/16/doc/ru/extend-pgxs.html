<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>38.18. Инфраструктура сборки расширений</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@lists.postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets Vsnapshot" /><link rel="prev" href="extend-extensions.html" title="38.17. Упаковывание связанных объектов в расширение" /><link rel="next" href="triggers.html" title="Глава 39. Триггеры" /></head><body id="docContent" class="container-fluid col-10"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="5" align="center">38.18. Инфраструктура сборки расширений</th></tr><tr><td width="10%" align="left"><a accesskey="p" href="extend-extensions.html" title="38.17. Упаковывание связанных объектов в расширение">Пред.</a> </td><td width="10%" align="left"><a accesskey="u" href="extend.html" title="Глава 38. Расширение SQL">Наверх</a></td><th width="60%" align="center">Глава 38. Расширение <acronym class="acronym">SQL</acronym></th><td width="10%" align="right"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="10%" align="right"> <a accesskey="n" href="triggers.html" title="Глава 39. Триггеры">След.</a></td></tr></table><hr /></div><div class="sect1" id="EXTEND-PGXS"><div class="titlepage"><div><div><h2 class="title" style="clear: both">38.18. Инфраструктура сборки расширений <a href="#EXTEND-PGXS" class="id_link">#</a></h2></div></div></div><a id="id-1.8.3.21.2" class="indexterm"></a><p>Если вы задумываетесь о распространении ваших модулей расширения <span class="productname">PostgreSQL</span>, знайте, что организовать для них портируемую систему сборки может быть довольно сложно. Поэтому инсталляция <span class="productname">PostgreSQL</span> включает инфраструктуру сборки расширений, названную <acronym class="acronym">PGXS</acronym>, так что несложные модули расширений можно собрать просто в среде установленного сервера. <acronym class="acronym">PGXS</acronym> предназначена в первую очередь для расширений, написанных на C, хотя её можно применять и для расширения на чистом SQL. Заметьте, что <acronym class="acronym">PGXS</acronym> не претендует на роль универсальной инфраструктуры сборки, способной собрать любой программный объект, взаимодействующий с <span class="productname">PostgreSQL</span>; она просто автоматизирует общие правила для сборки простых модулей расширения сервера. Для более сложных пакетов вам придётся разработать собственную систему сборки.</p><p>Чтобы использовать инфраструктуру <acronym class="acronym">PGXS</acronym> для вашего расширения, вы должны написать простой сборочный файл. В нём вы должны установить нужные переменные и подключить глобальный сборочный файл <acronym class="acronym">PGXS</acronym>. Следующий пример собирает модуль расширения с именем <code class="literal">isbn_issn</code>, который включает разделяемую библиотеку, написанную на C, управляющий файл расширения, SQL-скрипт, текстовый файл документации и заголовочный файл (он нужен, только если другие модули будут вызывать функции данного расширения напрямую, без использования SQL): </p><pre class="programlisting">MODULES = isbn_issn
EXTENSION = isbn_issn
DATA = isbn_issn--1.0.sql
DOCS = README.isbn_issn
HEADERS_isbn_issn = isbn_issn.h

PG_CONFIG = pg_config
PGXS := $(shell $(PG_CONFIG) --pgxs)
include $(PGXS)</pre><p> Последние три строки всегда должны быть такими. Выше в файле вы определяете переменные или добавляете собственные правила для <span class="application">make</span>.</p><p>Установите одну из этих трёх переменных, чтобы указать, что будет собрано: </p><div class="variablelist"><dl class="variablelist"><dt id="EXTEND-PGXS-MODULES"><span class="term"><code class="varname">MODULES</code></span> <a href="#EXTEND-PGXS-MODULES" class="id_link">#</a></dt><dd><p>список объектов разделяемых библиотек, которые должны быть собраны из исходных файлов с одной основой (суффиксы библиотек в этом списке не указываются)</p></dd><dt id="EXTEND-PGXS-MODULE-BIG"><span class="term"><code class="varname">MODULE_big</code></span> <a href="#EXTEND-PGXS-MODULE-BIG" class="id_link">#</a></dt><dd><p>разделяемая библиотека, которая должна быть собрана из нескольких исходных файлов (объектные файлы перечисляются в <code class="varname">OBJS</code>)</p></dd><dt id="EXTEND-PGXS-PROGRAM"><span class="term"><code class="varname">PROGRAM</code></span> <a href="#EXTEND-PGXS-PROGRAM" class="id_link">#</a></dt><dd><p>исполняемая программа, которая должна быть собрана (объектные файлы перечисляются в <code class="varname">OBJS</code>)</p></dd></dl></div><p> Также можно установить следующие переменные: </p><div class="variablelist"><dl class="variablelist"><dt id="EXTEND-PGXS-EXTENSION"><span class="term"><code class="varname">EXTENSION</code></span> <a href="#EXTEND-PGXS-EXTENSION" class="id_link">#</a></dt><dd><p>имена расширений(я); для каждого имени вы должны предоставить файл <code class="literal"><em class="replaceable"><code>расширение</code></em>.control</code>, который будет установлен в <code class="literal"><em class="replaceable"><code>префикс</code></em>/share/extension</code></p></dd><dt id="EXTEND-PGXS-MODULEDIR"><span class="term"><code class="varname">MODULEDIR</code></span> <a href="#EXTEND-PGXS-MODULEDIR" class="id_link">#</a></dt><dd><p>подкаталог в каталоге <code class="literal"><em class="replaceable"><code>префикс</code></em>/share</code>, в который должны устанавливаться файлы DATA и DOCS (если не задан, подразумевается <code class="literal">extension</code>, если установлена переменная <code class="varname">EXTENSION</code>, или <code class="literal">contrib</code> в противном случае)</p></dd><dt id="EXTEND-PGXS-DATA"><span class="term"><code class="varname">DATA</code></span> <a href="#EXTEND-PGXS-DATA" class="id_link">#</a></dt><dd><p>произвольные файлы, которые должны быть установлены в <code class="literal"><em class="replaceable"><code>префикс</code></em>/share/$MODULEDIR</code></p></dd><dt id="EXTEND-PGXS-DATA-BUILT"><span class="term"><code class="varname">DATA_built</code></span> <a href="#EXTEND-PGXS-DATA-BUILT" class="id_link">#</a></dt><dd><p>произвольные файлы, которые должны быть сначала собраны, а затем установлены в <code class="literal"><em class="replaceable"><code>префикс</code></em>/share/$MODULEDIR</code></p></dd><dt id="EXTEND-PGXS-DATA-TSEARCH"><span class="term"><code class="varname">DATA_TSEARCH</code></span> <a href="#EXTEND-PGXS-DATA-TSEARCH" class="id_link">#</a></dt><dd><p>произвольные файлы, которые должны быть установлены в <code class="literal"><em class="replaceable"><code>префикс</code></em>/share/tsearch_data</code></p></dd><dt id="EXTEND-PGXS-DOCS"><span class="term"><code class="varname">DOCS</code></span> <a href="#EXTEND-PGXS-DOCS" class="id_link">#</a></dt><dd><p>произвольные файлы, которые должны быть установлены в <code class="literal"><em class="replaceable"><code>префикс</code></em>/doc/$MODULEDIR</code></p></dd><dt id="EXTEND-PGXS-HEADERS"><span class="term"><code class="varname">HEADERS</code><br /></span><span class="term"><code class="varname">HEADERS_built</code></span> <a href="#EXTEND-PGXS-HEADERS" class="id_link">#</a></dt><dd><p>Файлы, которые будут устанавливаться (и, возможно, собираться) в <code class="literal"><em class="replaceable"><code>префикс</code></em>/include/server/$MODULEDIR/$MODULE_big</code>.</p><p>В отличие от файлов <code class="literal">DATA_built</code>, файлы в <code class="literal">HEADERS_built</code> не удаляются при выполнении цели <code class="literal">clean</code>; если вы хотите удалять их, добавьте их в <code class="literal">EXTRA_CLEAN</code> или напишите собственные правила для этого.</p></dd><dt id="EXTEND-PGXS-HEADERS-MODULE"><span class="term"><code class="varname">HEADERS_$MODULE</code><br /></span><span class="term"><code class="varname">HEADERS_built_$MODULE</code></span> <a href="#EXTEND-PGXS-HEADERS-MODULE" class="id_link">#</a></dt><dd><p>Файлы, которые будут устанавливаться (если требуется, после сборки) в <code class="literal"><em class="replaceable"><code>префикс</code></em>/include/server/$MODULEDIR/$MODULE</code>, где в качестве <code class="literal">$MODULE</code> должно задаваться имя модуля, фигурирующее в <code class="literal">MODULES</code> или <code class="literal">MODULE_big</code>.</p><p>В отличие от файлов <code class="literal">DATA_built</code>, файлы в <code class="literal">HEADERS_built_$MODULE</code> не удаляются при выполнении цели <code class="literal">clean</code>; если вы хотите удалять их, добавьте их в <code class="literal">EXTRA_CLEAN</code> или напишите собственные правила для этого.</p><p>Для одного модуля вполне можно использовать обе переменные в любом сочетании, если только в вашем списке <code class="literal">MODULES</code> не присутствуют два имени, отличающиеся только префиксом <code class="literal">built_</code>, что приводит к неоднозначности. В этом (очень маловероятном) случае следует использовать только переменные <code class="literal">HEADERS_built_$MODULE</code>.</p></dd><dt id="EXTEND-PGXS-SCRIPTS"><span class="term"><code class="varname">SCRIPTS</code></span> <a href="#EXTEND-PGXS-SCRIPTS" class="id_link">#</a></dt><dd><p>скрипты (не двоичные файлы), которые должны быть установлены в <code class="literal"><em class="replaceable"><code>префикс</code></em>/bin</code></p></dd><dt id="EXTEND-PGXS-SCRIPTS-BUILT"><span class="term"><code class="varname">SCRIPTS_built</code></span> <a href="#EXTEND-PGXS-SCRIPTS-BUILT" class="id_link">#</a></dt><dd><p>скрипты (не двоичные файлы), которые должны быть сначала собраны, а затем установлены в <code class="literal"><em class="replaceable"><code>префикс</code></em>/bin</code></p></dd><dt id="EXTEND-PGXS-REGRESS"><span class="term"><code class="varname">REGRESS</code></span> <a href="#EXTEND-PGXS-REGRESS" class="id_link">#</a></dt><dd><p>список тестов регрессий (без суффикса), см. ниже</p></dd><dt id="EXTEND-PGXS-REGRESS-OPTS"><span class="term"><code class="varname">REGRESS_OPTS</code></span> <a href="#EXTEND-PGXS-REGRESS-OPTS" class="id_link">#</a></dt><dd><p>дополнительные параметры, передаваемые <span class="application">pg_regress</span></p></dd><dt id="EXTEND-PGXS-ISOLATION"><span class="term"><code class="varname">ISOLATION</code></span> <a href="#EXTEND-PGXS-ISOLATION" class="id_link">#</a></dt><dd><p>список изоляционных тестов, см. ниже</p></dd><dt id="EXTEND-PGXS-ISOLATION-OPTS"><span class="term"><code class="varname">ISOLATION_OPTS</code></span> <a href="#EXTEND-PGXS-ISOLATION-OPTS" class="id_link">#</a></dt><dd><p>дополнительные параметры, передаваемые <span class="application">pg_isolation_regress</span></p></dd><dt id="EXTEND-PGXS-TAP-TESTS"><span class="term"><code class="varname">TAP_TESTS</code></span> <a href="#EXTEND-PGXS-TAP-TESTS" class="id_link">#</a></dt><dd><p>переключатель, определяющий, нужно ли запускать TAP-тесты; см. ниже</p></dd><dt id="EXTEND-PGXS-NO-INSTALL"><span class="term"><code class="varname">NO_INSTALL</code></span> <a href="#EXTEND-PGXS-NO-INSTALL" class="id_link">#</a></dt><dd><p>не определять цель <code class="literal">install</code>; это полезно для модулей тестирования, результаты сборки которых не нужно устанавливать</p></dd><dt id="EXTEND-PGXS-NO-INSTALLCHECK"><span class="term"><code class="varname">NO_INSTALLCHECK</code></span> <a href="#EXTEND-PGXS-NO-INSTALLCHECK" class="id_link">#</a></dt><dd><p>не определять цель <code class="literal">installcheck</code>; это полезно, если тестам требуется особая конфигурация или <span class="application">pg_regress</span> не используется</p></dd><dt id="EXTEND-PGXS-EXTRA-CLEAN"><span class="term"><code class="varname">EXTRA_CLEAN</code></span> <a href="#EXTEND-PGXS-EXTRA-CLEAN" class="id_link">#</a></dt><dd><p>дополнительные файлы, которые должны быть удалены при <code class="literal">make clean</code></p></dd><dt id="EXTEND-PGXS-PG-CPPFLAGS"><span class="term"><code class="varname">PG_CPPFLAGS</code></span> <a href="#EXTEND-PGXS-PG-CPPFLAGS" class="id_link">#</a></dt><dd><p>флаги, добавляемые перед другими в <code class="varname">CPPFLAGS</code></p></dd><dt id="EXTEND-PGXS-PG-CFLAGS"><span class="term"><code class="varname">PG_CFLAGS</code></span> <a href="#EXTEND-PGXS-PG-CFLAGS" class="id_link">#</a></dt><dd><p>флаги, добавляемые в <code class="varname">CFLAGS</code></p></dd><dt id="EXTEND-PGXS-PG-CXXFLAGS"><span class="term"><code class="varname">PG_CXXFLAGS</code></span> <a href="#EXTEND-PGXS-PG-CXXFLAGS" class="id_link">#</a></dt><dd><p>флаги, добавляемые в <code class="varname">CXXFLAGS</code></p></dd><dt id="EXTEND-PGXS-PG-LDFLAGS"><span class="term"><code class="varname">PG_LDFLAGS</code></span> <a href="#EXTEND-PGXS-PG-LDFLAGS" class="id_link">#</a></dt><dd><p>флаги, добавляемые перед другими в <code class="varname">LDFLAGS</code></p></dd><dt id="EXTEND-PGXS-PG-LIBS"><span class="term"><code class="varname">PG_LIBS</code></span> <a href="#EXTEND-PGXS-PG-LIBS" class="id_link">#</a></dt><dd><p>будет добавлено в строку компоновки <code class="varname">PROGRAM</code></p></dd><dt id="EXTEND-PGXS-SHLIB-LINK"><span class="term"><code class="varname">SHLIB_LINK</code></span> <a href="#EXTEND-PGXS-SHLIB-LINK" class="id_link">#</a></dt><dd><p>будет добавлено в строку компоновки <code class="varname">MODULE_big</code></p></dd><dt id="EXTEND-PGXS-PG-CONFIG"><span class="term"><code class="varname">PG_CONFIG</code></span> <a href="#EXTEND-PGXS-PG-CONFIG" class="id_link">#</a></dt><dd><p>путь к программе <span class="application">pg_config</span> в инсталляции <span class="productname">PostgreSQL</span>, с которой будет выполняться сборка (обычно указывается просто <code class="literal">pg_config</code>, и используется первый экземпляр, найденный по пути в <code class="varname">PATH</code>)</p></dd></dl></div><p>Поместите этот сборочный файл под именем <code class="literal">Makefile</code> в каталог, где находится ваше расширение. После этого выполните <code class="literal">make</code>, чтобы скомпилировать, а затем <code class="literal">make install</code>, чтобы установить ваш модуль. По умолчанию расширение компилируется и устанавливается для той инсталляции <span class="productname">PostgreSQL</span>, которая соответствует экземпляру <code class="command">pg_config</code>, найденному первым при поиске по пути в <code class="varname">PATH</code>. Чтобы использовать другую инсталляцию, вы можете задать в <code class="varname">PG_CONFIG</code> путь к её экземпляру <code class="command">pg_config</code> либо внутри сборочного файла, либо в командном файле <code class="literal">make</code>.</p><p>Вы также можете запустить <code class="literal">make</code> в каталоге вне каталога исходного дерева вашего расширения, если хотите отделить каталог сборки. Эта процедура называется сборкой с <a id="id-1.8.3.21.7.2" class="indexterm"></a><em class="firstterm">VPATH</em> и выполняется так: </p><pre class="programlisting">mkdir build_dir
cd build_dir
make -f /path/to/extension/source/tree/Makefile
make -f /path/to/extension/source/tree/Makefile install</pre><p>Также вы можете подготовить каталог для сборки с VPATH таким же образом, как это делается в коде ядра сервера. Как один из вариантов, для этого можно воспользоваться скриптом ядра <code class="filename">config/prep_buildtree</code>. Затем вы сможете выполнить сборку, установив переменную <code class="varname">VPATH</code> для <code class="literal">make</code> таким образом: </p><pre class="programlisting">make VPATH=/path/to/extension/source/tree
make VPATH=/path/to/extension/source/tree install</pre><p> Эта процедура поддерживает самые разные расположения каталогов.</p><p>Скрипты, перечисленные в переменной <code class="varname">REGRESS</code>, используются для регрессионного тестирования модуля, и вызвать их можно командой <code class="literal">make installcheck</code> после <code class="literal">make install</code>. Для проведения тестирования необходим работающий сервер <span class="productname">PostgreSQL</span>. Файлы скриптов, перечисленные в <code class="varname">REGRESS</code>, должны размещаться в подкаталоге <code class="literal">sql/</code> каталога расширения. Эти файлы должны иметь расширение <code class="literal">.sql</code>, но указывать его в списке <code class="varname">REGRESS</code> в сборочном файле не нужно. Для каждого теста также должен создаваться файл с ожидаемым выводом в подкаталоге <code class="literal">expected/</code>, с тем же базовым именем и расширением <code class="literal">.out</code>. Команда <code class="literal">make installcheck</code> выполнит каждый тест в <span class="application">psql</span> и сравнит полученный вывод с ожидаемым. Все выявленные различия будут записаны в файл <code class="literal">regression.diffs</code> в формате команды <code class="command">diff -c</code>. Заметьте, что при попытке запустить тест без файла ожидаемого вывода этот тест будет отмечен как <span class="quote">«<span class="quote">проблемный</span>»</span>, поэтому убедитесь, что все такие файлы присутствуют.</p><p>Скрипты, перечисленные в переменной <code class="varname">ISOLATION</code>, используются для тестирования работы модуля при параллельной нагрузке, и вызвать их можно командой <code class="literal">make installcheck</code> после <code class="literal">make install</code>. Для проведения тестирования необходим работающий сервер <span class="productname">PostgreSQL</span>. Файлы скриптов, перечисленные в <code class="varname">ISOLATION</code>, должны размещаться в подкаталоге <code class="literal">specs/</code> каталога вашего расширения. Эти файлы должны иметь расширение <code class="literal">.spec</code>, которое не должно включаться в список <code class="varname">ISOLATION</code> в Makefile. Для каждого теста также должен создаваться файл с ожидаемым выводом в подкаталоге <code class="literal">expected/</code>, с тем же базовым именем и расширением <code class="literal">.out</code>. Команда <code class="literal">make installcheck</code> выполнит каждый тест и сравнит полученный вывод с ожидаемым. Все выявленные различия будут записаны в файл <code class="literal">output_iso/regression.diffs</code> в формате команды <code class="command">diff -c</code>. Заметьте, что при попытке запустить тест без файла ожидаемого вывода этот тест будет отмечен как <span class="quote">«<span class="quote">проблемный</span>»</span>, поэтому убедитесь, что все такие файлы присутствуют.</p><p>Переменная <code class="literal">TAP_TESTS</code> включает использование TAP-тестов. Данные, получаемые на каждом прогоне теста, помещаются в подкаталог <code class="literal">tmp_check/</code>. За дополнительными подробностями обратитесь к <a class="xref" href="regress-tap.html" title="33.4. TAP-тесты">Разделу 33.4</a>.</p><div class="tip"><h3 class="title">Подсказка</h3><p>Проще всего для этого создать пустые файлы ожидаемого вывода, а затем выполнить тест (при этом, конечно, будут выявлены несоответствия). Изучите полученные файлы результатов, сохранённые в каталоге <code class="literal">results/</code> (для тестов <code class="literal">REGRESS</code>) или каталоге <code class="literal">output_iso/results/</code> (для тестов в <code class="literal">ISOLATION</code>), и, если они соответствуют вашим ожиданиям от теста, скопируйте их в <code class="literal">expected/</code>.</p></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="extend-extensions.html" title="38.17. Упаковывание связанных объектов в расширение">Пред.</a> </td><td width="20%" align="center"><a accesskey="u" href="extend.html" title="Глава 38. Расширение SQL">Наверх</a></td><td width="40%" align="right"> <a accesskey="n" href="triggers.html" title="Глава 39. Триггеры">След.</a></td></tr><tr><td width="40%" align="left" valign="top">38.17. Упаковывание связанных объектов в расширение </td><td width="20%" align="center"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="40%" align="right" valign="top"> Глава 39. Триггеры</td></tr></table></div></body></html>