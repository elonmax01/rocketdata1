<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>70.3. Расширяемость</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@lists.postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets Vsnapshot" /><link rel="prev" href="gin-builtin-opclasses.html" title="70.2. Встроенные классы операторов" /><link rel="next" href="gin-implementation.html" title="70.4. Реализация" /></head><body id="docContent" class="container-fluid col-10"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="5" align="center">70.3. Расширяемость</th></tr><tr><td width="10%" align="left"><a accesskey="p" href="gin-builtin-opclasses.html" title="70.2. Встроенные классы операторов">Пред.</a> </td><td width="10%" align="left"><a accesskey="u" href="gin.html" title="Глава 70. Индексы GIN">Наверх</a></td><th width="60%" align="center">Глава 70. Индексы GIN</th><td width="10%" align="right"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="10%" align="right"> <a accesskey="n" href="gin-implementation.html" title="70.4. Реализация">След.</a></td></tr></table><hr /></div><div class="sect1" id="GIN-EXTENSIBILITY"><div class="titlepage"><div><div><h2 class="title" style="clear: both">70.3. Расширяемость <a href="#GIN-EXTENSIBILITY" class="id_link">#</a></h2></div></div></div><p>Интерфейс <acronym class="acronym">GIN</acronym> характеризуется высоким уровнем абстракции и таким образом требует от разработчика метода доступа реализовать только смысловое наполнение обрабатываемого типа данных. Уровень <acronym class="acronym">GIN</acronym> берёт на себя заботу о параллельном доступе, поддержке журнала и поиске в структуре дерева.</p><p>Всё, что нужно, чтобы получить работающий метод доступа <acronym class="acronym">GIN</acronym> — это реализовать несколько пользовательских методов, определяющих поведение ключей в дереве и отношения между ключами, индексируемыми объектами и поддерживаемыми запросами. Словом, <acronym class="acronym">GIN</acronym> сочетает расширяемость с универсальностью, повторным использованием кода и аккуратным интерфейсом.</p><p>Класс операторов должен предоставить <acronym class="acronym">GIN</acronym> следующие три метода: </p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="function">Datum *extractValue(Datum itemValue, int32 *nkeys, bool **nullFlags)</code></span></dt><dd><p>Возвращает массив ключей (выделенный через palloc) для индексируемого объекта. Число возвращаемых ключей должно записываться в <code class="literal">*nkeys</code>. Если какой-либо из ключей может быть NULL, нужно так же выделить через palloc массив из <code class="literal">*nkeys</code> полей <code class="type">bool</code>, записать его адрес в <code class="literal">*nullFlags</code> и установить эти флаги NULL как требуется. В <code class="literal">*nullFlags</code> можно оставить значение <code class="symbol">NULL</code> (это начальное значение), если все ключи отличны от NULL. Эта функция может возвратить <code class="symbol">NULL</code>, если объект не содержит ключей.</p></dd><dt><span class="term"><code class="function">Datum *extractQuery(Datum query, int32 *nkeys, StrategyNumber n, bool **pmatch, Pointer **extra_data, bool **nullFlags, int32 *searchMode)</code></span></dt><dd><p>Возвращает массив ключей (выделенный через palloc) для запрашиваемого значения; то есть, в <code class="literal">query</code> поступает значение, находящееся по правую сторону индексируемого оператора, по левую сторону которого указан индексируемый столбец. Аргумент <code class="literal">n</code> задаёт номер стратегии оператора в классе операторов (см. <a class="xref" href="xindex.html#XINDEX-STRATEGIES" title="38.16.2. Стратегии методов индексов">Подраздел 38.16.2</a>). Часто функция <code class="function">extractQuery</code> должна проанализировать <code class="literal">n</code>, чтобы определить тип данных аргумента <code class="literal">query</code> и выбрать метод для извлечения значений ключей. Число возвращаемых ключей должно быть записано в <code class="literal">*nkeys</code>. Если какие-либо ключи могут быть NULL, нужно так же выделить через palloc массив из <code class="literal">*nkeys</code> полей <code class="type">bool</code>, сохранить его адрес в <code class="literal">*nullFlags</code>, и установить эти флаги NULL как требуется. В <code class="literal">*nullFlags</code> можно оставить значение <code class="symbol">NULL</code> (это начальное значение), если все ключи отличны от NULL. Эта функция может возвратить <code class="symbol">NULL</code>, если <code class="literal">query</code> не содержит ключей.</p><p>Выходной аргумент <code class="literal">searchMode</code> позволяет функции <code class="function">extractQuery</code> выбрать режим, в котором должен выполняться поиск. Если <code class="literal">*searchMode</code> имеет значение <code class="literal">GIN_SEARCH_MODE_DEFAULT</code> (это значение устанавливается перед вызовом), подходящими кандидатами считаются только те объекты, которые соответствуют минимум одному из возвращённых ключей. Если в <code class="literal">*searchMode</code> установлено значение <code class="literal">GIN_SEARCH_MODE_INCLUDE_EMPTY</code>, то в дополнение к объектам с минимум одним совпадением ключа, подходящими кандидатами будут считаться и объекты, вообще не содержащие ключей. (Этот режим полезен для реализации, например, операторов A-является-подмножеством-B.) Если в <code class="literal">*searchMode</code> установлено значение <code class="literal">GIN_SEARCH_MODE_ALL</code>, подходящими кандидатами считаются все отличные от NULL объекты в индексе, независимо от того, встречаются ли в них возвращаемые ключи. (Этот режим намного медленнее двух других, так как он по сути требует сканирования всего индекса, но он может быть необходим для корректной обработки крайних случаев. Оператор, который выбирает этот режим в большинстве ситуаций, скорее всего не подходит для реализации в классе операторов GIN.) Символы для этих значений режима определены в <code class="filename">access/gin.h</code>.</p><p>Выходной аргумент <code class="literal">pmatch</code> используется, когда поддерживается частичное соответствие. Чтобы использовать его, <code class="function">extractQuery</code> должна выделить массив из <code class="literal">*nkeys</code> логических элементов и сохранить его адрес в <code class="literal">*pmatch</code>. Элемент этого массива должен содержать true, если соответствующий ключ требует частичного соответствия, и false в противном случае. Если переменная <code class="literal">*pmatch</code> содержит <code class="symbol">NULL</code>, GIN полагает, что частичное соответствие не требуется. В эту переменную записывается <code class="symbol">NULL</code> перед вызовом, так что этот аргумент можно просто игнорировать в классах операторов, не поддерживающих частичное соответствие.</p><p>Выходной аргумент <code class="literal">extra_data</code> позволяет функции <code class="function">extractQuery</code> передать дополнительные данные методам <code class="function">consistent</code> и <code class="function">comparePartial</code>. Чтобы использовать его, <code class="function">extractQuery</code> должна выделить массив из <code class="literal">*nkeys</code> указателей и сохранить его адрес в <code class="literal">*extra_data</code>, а затем сохранить всё, что ей требуется, в отдельных указателях. В эту переменную записывается <code class="symbol">NULL</code> перед вызовом, поэтому данный аргумент может просто игнорироваться классами операторов, которым не нужны дополнительные данные. Если массив <code class="literal">*extra_data</code> задан, он целиком передаётся в метод <code class="function">consistent</code>, а в <code class="function">comparePartial</code> передаётся соответствующий его элемент.</p></dd></dl></div><p> Класс операторов должен также предоставить функцию для проверки, соответствует ли индексированный объект запросу. Поддерживаются две её вариации: булева <code class="function">consistent</code> и троичная <code class="function">triConsistent</code>. Функция <code class="function">triConsistent</code> покрывает функциональность обоих, так что достаточно реализовать только её. Однако если вычисление булевой вариации оказывается значительно дешевле, может иметь смысл реализовать их обе. Если представлена только булева вариация, некоторые оптимизации, построенные на отбраковывании объектов до выборки всех ключей, отключаются. </p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="function">bool consistent(bool check[], StrategyNumber n, Datum query, int32 nkeys, Pointer extra_data[], bool *recheck, Datum queryKeys[], bool nullFlags[])</code></span></dt><dd><p>Возвращает true, если индексированный объект удовлетворяет оператору запроса с номером стратегии <code class="literal">n</code> (или потенциально удовлетворяет, когда возвращается указание перепроверки). Эта функция не имеет прямого доступа к значению индексированного объекта, так как <acronym class="acronym">GIN</acronym> не хранит сами объекты. Вместо этого, она знает о значениях ключей, извлечённых из запроса и встречающихся в данном индексированном объекте. Массив <code class="literal">check</code> имеет длину <code class="literal">nkeys</code>, что равняется числу ключей, ранее возвращённых функцией <code class="function">extractQuery</code> для данного значения <code class="literal">query</code>. Элемент массива <code class="literal">check</code> равняется true, если индексированный объект содержит соответствующий ключ запроса; то есть, если (check[i] == true), то i-ый ключ в массиве результата <code class="function">extractQuery</code> присутствует в индексированном объекте. Исходное значение <code class="literal">query</code> передаётся на случай, если оно потребуется методу <code class="function">consistent</code>; с той же целью ему передаются массивы <code class="literal">queryKeys[]</code> и <code class="literal">nullFlags[]</code>, ранее возвращённые функцией <code class="function">extractQuery</code>. В аргументе <code class="literal">extra_data</code> передаётся массив дополнительных данных, возвращённый функцией <code class="function">extractQuery</code>, или <code class="symbol">NULL</code>, если дополнительных данных нет.</p><p>Когда <code class="function">extractQuery</code> возвращает ключ NULL в <code class="literal">queryKeys[]</code>, соответствующий элемент <code class="literal">check[]</code> содержит true, если индексированный объект содержит ключ NULL; то есть можно считать, что элементы <code class="literal">check[]</code> отражают условие <code class="literal">IS NOT DISTINCT FROM</code>. Функция <code class="function">consistent</code> может проверить соответствующий элемент <code class="literal">nullFlags[]</code>, если ей нужно различать соответствие с обычным значением и соответствие с NULL.</p><p>В случае успеха в <code class="literal">*recheck</code> нужно записать true, если кортеж данных нужно перепроверить с оператором запроса, либо false, если проверка по индексу была точной. То есть результат false гарантирует, что кортеж данных не соответствует запросу; результат true со значением <code class="literal">*recheck</code>, равным false, гарантирует, что кортеж данных соответствует запросу; а результат true со значением <code class="literal">*recheck</code>, равным true, означает, что кортеж данных может соответствовать запросу, поэтому его нужно выбрать и перепроверить, применив оператор запроса непосредственно к исходному индексированному элементу.</p></dd><dt><span class="term"><code class="function">GinTernaryValue triConsistent(GinTernaryValue check[], StrategyNumber n, Datum query, int32 nkeys, Pointer extra_data[], Datum queryKeys[], bool nullFlags[])</code></span></dt><dd><p>Функция <code class="function">triConsistent</code> подобна <code class="function">consistent</code>, но вместо булевых значений в векторе <code class="literal">check</code> ей передаются три варианта сравнений для каждого ключа: <code class="literal">GIN_TRUE</code>, <code class="literal">GIN_FALSE</code> и <code class="literal">GIN_MAYBE</code>. <code class="literal">GIN_FALSE</code> и <code class="literal">GIN_TRUE</code> имеют обычное логическое значение, тогда как <code class="literal">GIN_MAYBE</code> означает, что присутствие ключа неизвестно. Когда присутствуют значения <code class="literal">GIN_MAYBE</code>, функция должна возвращать <code class="literal">GIN_TRUE</code>, только если объект удовлетворяет запросу независимо от того, содержит ли индекс соответствующие ключи запроса. Подобным образом, функция должна возвращать <code class="literal">GIN_FALSE</code>, только если объект не удовлетворяет запросу независимо от того, содержит ли он ключи <code class="literal">GIN_MAYBE</code>. Если результат зависит от элементов <code class="literal">GIN_MAYBE</code>, то есть соответствие нельзя утверждать или отрицать в зависимости от известных ключей запроса, функция должна вернуть <code class="literal">GIN_MAYBE</code>.</p><p>Когда в векторе <code class="literal">check</code> нет элементов <code class="literal">GIN_MAYBE</code>, возвращаемое значение <code class="literal">GIN_MAYBE</code> равнозначно установленному флагу <code class="literal">recheck</code> в булевой функции <code class="function">consistent</code>.</p></dd></dl></div><p>Кроме того, GIN нужно каким-то образом сортировать значения ключа, хранящиеся в индексе. Класс операторов может определить порядок сортировки, указав метод сравнения: </p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="function">int compare(Datum a, Datum b)</code></span></dt><dd><p>Сравнивает два ключа (не индексированные объекты!) и возвращает целое меньше нуля, ноль или целое больше нуля, показывающее, что первый ключ меньше, равен или больше второго. Ключи NULL никогда не передаются этой функции.</p></dd></dl></div><p> Если же класс операторов не определяет метод <code class="function">compare</code>, GIN попытается найти класс операторов B-дерева по умолчанию для типа данных ключа индекса и воспользоваться его функцией сравнения. Если класс операторов GIN предназначен только для одного типа данных, рекомендуется задавать функцию сравнения в этом классе операторов, так как поиск класса операторов B-дерева занимает несколько циклов. Однако для полиморфных классов операторов GIN (например, <code class="literal">array_ops</code>) задать одну функцию сравнения обычно не представляется возможным.</p><p>Дополнительно класс операторов для <acronym class="acronym">GIN</acronym> может предоставить следующие методы: </p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="function">int comparePartial(Datum partial_key, Datum key, StrategyNumber n, Pointer extra_data)</code></span></dt><dd><p>Сравнивает ключ запроса с частичным соответствием с ключом индекса. Возвращает целое число, знак которого отражает результат сравнения: отрицательное число означает, что ключ индекса не соответствует запросу, но нужно продолжать сканирование индекса; ноль означает, что ключ индекса соответствует запросу; положительное число означает, что сканирование индекса нужно прекратить, так как других соответствий не будет. Функции передаётся номер стратегии <code class="literal">n</code> оператора, сформировавшего запрос частичного соответствия, на случай, если нужно знать его смысл, чтобы определить, когда прекращать сканирование. Кроме того, ей передаётся <code class="literal">extra_data</code> — соответствующий элемент массива дополнительных данных, сформированного функцией <code class="function">extractQuery</code>, либо <code class="symbol">NULL</code>, если дополнительных данных нет. Значения NULL этой функции никогда не передаются.</p></dd><dt><span class="term"><code class="function">void options(local_relopts *relopts)</code></span></dt><dd><p>Определяет набор видимых пользователю параметров, управляющих поведением класса операторов.</p><p>Функции <code class="function">options</code> передаётся указатель на структуру <code class="structname">local_relopts</code>, в которую нужно внести набор параметров, относящихся к классу операторов. Обращаться к этим параметрам из других опорных функций можно с помощью макросов <code class="literal">PG_HAS_OPCLASS_OPTIONS()</code> и <code class="literal">PG_GET_OPCLASS_OPTIONS()</code>.</p><p>Так как в <acronym class="acronym">GIN</acronym> и извлечение ключа из индексируемых значений, и его представление допускают гибкость, могут быть полезны параметры для настройки этого индекса.</p></dd></dl></div><p>Для поддержки проверок на <span class="quote">«<span class="quote">частичное соответствие</span>»</span> класс операторов должен предоставить метод <code class="function">comparePartial</code>, а метод <code class="function">extractQuery</code> должен устанавливать параметр <code class="literal">pmatch</code>, когда встречается запрос на частичное соответствие. За подробностями обратитесь к <a class="xref" href="gin-implementation.html#GIN-PARTIAL-MATCH" title="70.4.2. Алгоритм частичного соответствия">Подразделу 70.4.2</a>.</p><p>Фактические типы данных различных значений <code class="literal">Datum</code>, упоминаемых выше, зависят от класса операторов. Значения объектов, передаваемые в <code class="function">extractValue</code>, всегда имеют входной тип класса операторов, а все значения ключей должны быть типа, заданного параметром <code class="literal">STORAGE</code> для класса. Типом аргумента <code class="literal">query</code>, передаваемого функциям <code class="function">extractQuery</code>, <code class="function">consistent</code> и <code class="function">triConsistent</code>, будет тот тип, что указан в качестве типа правого операнда оператора-члена класса, определяемого по номеру стратегии. Это не обязательно должен быть индексируемый тип, достаточно лишь, чтобы из него можно было извлечь значения ключей, имеющие нужный тип. Однако рекомендуется, чтобы в SQL-объявлениях этих трёх опорных функций для аргумента <code class="literal">query</code> назначался индексируемый тип класса операторов, даже несмотря на то, что фактический тип может быть другим, в зависимости от оператора.</p></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="gin-builtin-opclasses.html" title="70.2. Встроенные классы операторов">Пред.</a> </td><td width="20%" align="center"><a accesskey="u" href="gin.html" title="Глава 70. Индексы GIN">Наверх</a></td><td width="40%" align="right"> <a accesskey="n" href="gin-implementation.html" title="70.4. Реализация">След.</a></td></tr><tr><td width="40%" align="left" valign="top">70.2. Встроенные классы операторов </td><td width="20%" align="center"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="40%" align="right" valign="top"> 70.4. Реализация</td></tr></table></div></body></html>