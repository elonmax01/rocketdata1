<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>44.5. Обращение к базе данных из PL/Tcl</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@lists.postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets Vsnapshot" /><link rel="prev" href="pltcl-global.html" title="44.4. Глобальные данные в PL/Tcl" /><link rel="next" href="pltcl-trigger.html" title="44.6. Триггерные функции на PL/Tcl" /></head><body id="docContent" class="container-fluid col-10"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="5" align="center">44.5. Обращение к базе данных из PL/Tcl</th></tr><tr><td width="10%" align="left"><a accesskey="p" href="pltcl-global.html" title="44.4. Глобальные данные в PL/Tcl">Пред.</a> </td><td width="10%" align="left"><a accesskey="u" href="pltcl.html" title="Глава 44. PL/Tcl — процедурный язык Tcl">Наверх</a></td><th width="60%" align="center">Глава 44. PL/Tcl — процедурный язык Tcl</th><td width="10%" align="right"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="10%" align="right"> <a accesskey="n" href="pltcl-trigger.html" title="44.6. Триггерные функции на PL/Tcl">След.</a></td></tr></table><hr /></div><div class="sect1" id="PLTCL-DBACCESS"><div class="titlepage"><div><div><h2 class="title" style="clear: both">44.5. Обращение к базе данных из PL/Tcl <a href="#PLTCL-DBACCESS" class="id_link">#</a></h2></div></div></div><p>В этом разделе для обозначения необязательных элементов в описании синтаксиса используются знаки вопроса (а не квадратные скобки), как это принято в Tcl. Имеются следующие команды для доступа к базе данных из тела функции PL/Tcl: </p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal"><code class="function">spi_exec</code> ?<span class="optional">-count <em class="replaceable"><code>n</code></em></span>? ?<span class="optional">-array <em class="replaceable"><code>имя</code></em></span>? <em class="replaceable"><code>команда</code></em> ?<span class="optional"><em class="replaceable"><code>тело-цикла</code></em></span>?</code></span></dt><dd><p>Выполняет команду SQL, заданную в виде строки. В случае ошибки в этой команде выдаётся ошибка в Tcl. В противном случае <code class="function">spi_exec</code> возвращает число обработанных командой строк (выбранных, добавленных, изменённых или удалённых), либо ноль, если эта команда — служебный оператор. Кроме того, если команда — оператор <code class="command">SELECT</code>, значения выбранных столбцов помещаются в переменные Tcl, как описано ниже.</p><p>Необязательный аргумент <code class="literal">-count</code> указывает функции <code class="function">spi_exec</code> остановиться после получения <em class="replaceable"><code>n</code></em> строк, как если бы запрос включал предложение <code class="literal">LIMIT</code>. Если <em class="replaceable"><code>n</code></em> равно нулю, запрос выполняется до конца, так же, как без указания <code class="literal">-count</code>.</p><p>Если в качестве команды выполняется оператор <code class="command">SELECT</code>, значения результирующих столбцов помещаются в переменные Tcl, названные по именам столбцов. Если передаётся <code class="literal">-array</code>, значения столбцов вместо этого становятся элементами названного ассоциативного массива, индексами в котором становятся имена столбцов. Кроме того, в элементе с именем <span class="quote">«<span class="quote"><code class="literal">.tupno</code></span>»</span> сохраняется номер текущей строки в результирующем наборе (отсчитывая от нуля), если только это имя не занято одним из столбцов результата.</p><p>Если в качестве команды выполняется <code class="command">SELECT</code> без указания скрипта <em class="replaceable"><code>тело-цикла</code></em>, в переменных Tcl или элементах массива сохраняется только первая строка результатов; оставшиеся строки (если они есть), игнорируются. Если запрос не возвращает строки, не сохраняется ничего. (Этот случай можно отследить, проверив результат <code class="function">spi_exec</code>.) Например, команда: </p><pre class="programlisting">spi_exec "SELECT count(*) AS cnt FROM pg_proc"</pre><p> присвоит переменной <code class="literal">$cnt</code> в Tcl число строк, содержащихся в системном каталоге <code class="structname">pg_proc</code>.</p><p>Если передаётся необязательный аргумент <em class="replaceable"><code>тело-цикла</code></em>, заданный в нём блок скрипта Tcl будет выполняться для каждой строки результата запроса. (Аргумент <em class="replaceable"><code>тело-цикла</code></em> игнорируется, если целевая команда — не <code class="command">SELECT</code>.) При этом значения столбцов текущей строки сохраняются в переменных Tcl или элементах массива перед каждой итерацией этого цикла. Например, код: </p><pre class="programlisting">spi_exec -array C "SELECT * FROM pg_class" {
    elog DEBUG "have table $C(relname)"
}</pre><p> будет выводить в журнал сообщение для каждой строки <code class="literal">pg_class</code>. Это работает подобно другим конструкциям циклов в Tcl; в частности, команды <code class="literal">continue</code> и <code class="literal">break</code> в теле цикла будут действовать обычным образом.</p><p>Если в столбце результата запроса выдаётся NULL, целевая переменная для неё не устанавливается, и оказывается <span class="quote">«<span class="quote">неустановленной</span>»</span>.</p></dd><dt><span class="term"><code class="function">spi_prepare</code> <em class="replaceable"><code>запрос</code></em> <em class="replaceable"><code>список-типов</code></em></span></dt><dd><p>Подготавливает и сохраняет план запроса для последующего выполнения. Сохранённый план будет продолжать существование до завершения текущего сеанса.<a id="id-1.8.9.9.2.1.2.2.1.1" class="indexterm"></a></p><p>Запрос может принимать параметры, то есть местозаполнители для значений, которые будут передаваться, когда план будет собственно выполняться. В строке запроса эти параметры обозначаются как <code class="literal">$1</code> ... <code class="literal">$<em class="replaceable"><code>n</code></em></code>. Если в запросе используются параметры, нужно задать имена типов этих параметров в виде списка Tcl. (Если параметры отсутствуют, задайте пустой <em class="replaceable"><code>список_типов</code></em>.)</p><p>Функция <code class="function">spi_prepare</code> возвращает идентификатор запроса, который может использоваться в последующих вызовах <code class="function">spi_execp</code>. Пример приведён в описании <code class="function">spi_execp</code>.</p></dd><dt><span class="term"><code class="literal"><code class="function">spi_execp</code> ?<span class="optional">-count <em class="replaceable"><code>n</code></em></span>? ?<span class="optional">-array <em class="replaceable"><code>имя</code></em></span>? ?<span class="optional">-nulls <em class="replaceable"><code>строка</code></em></span>? <em class="replaceable"><code>ид-запроса</code></em> ?<span class="optional"><em class="replaceable"><code>список-значений</code></em></span>? ?<span class="optional"><em class="replaceable"><code>тело-цикла</code></em></span>?</code></span></dt><dd><p>Выполняет запрос, ранее подготовленный функцией <code class="function">spi_prepare</code>. В качестве <em class="replaceable"><code>ид_запроса</code></em> передаётся идентификатор, возвращённый функцией <code class="function">spi_prepare</code>. Если в запросе задействуются параметры, необходимо указать <em class="replaceable"><code>список-значений</code></em>. Это должен быть принятый в Tcl список параметров. Он должен иметь ту же длину, что и список типов параметров, ранее переданный <code class="function">spi_prepare</code>. Опустите <em class="replaceable"><code>список-значений</code></em>, если у запроса нет параметров.</p><p>Необязательный аргумент <code class="literal">-nulls</code> принимает строку из пробелов и символов <code class="literal">'n'</code>, которые отмечают, в каких параметрах <code class="function">spi_execp</code> передаются значения NULL. Если присутствует, эта строка должна иметь ту же длину, что и <em class="replaceable"><code>список-значений</code></em>. В случае её отсутствия значения всех параметров считаются отличными от NULL.</p><p>Не считая отличий в способе передачи запроса и параметров, <code class="function">spi_execp</code> работает так же, как <code class="function">spi_exec</code>. Параметры <code class="literal">-count</code>, <code class="literal">-array</code> и <em class="replaceable"><code>тело-цикла</code></em> задаются так же, и так же передаётся возвращаемое значение.</p><p>Взгляните на пример функции на PL/Tcl, использующей подготовленный план: </p><pre class="programlisting">CREATE FUNCTION t1_count(integer, integer) RETURNS integer AS $$
    if {![ info exists GD(plan) ]} {
        # подготовить сохранённый план при первом вызове
        set GD(plan) [ spi_prepare \
                "SELECT count(*) AS cnt FROM t1 WHERE num &gt;= \$1 AND num &lt;= \$2" \
                [ list int4 int4 ] ]
    }
    spi_execp -count 1 $GD(plan) [ list $1 $2 ]
    return $cnt
$$ LANGUAGE pltcl;</pre><p> Обратные косые черты внутри строки запроса, передаваемой функции <code class="function">spi_prepare</code>, нужны для того, чтобы маркеры <code class="literal">$<em class="replaceable"><code>n</code></em></code> передавались функции <code class="function">spi_prepare</code> как есть, а не заменялись при подстановке переменных Tcl.</p></dd><dt><span class="term"><code class="function">subtransaction</code> <em class="replaceable"><code>команда</code></em></span></dt><dd><p>Скрипт Tcl, который содержит <em class="replaceable"><code>команда</code></em>, выполняется в подтранзакции SQL. Если этот скрипт возвращает ошибку, вся подтранзакция откатывается назад, а затем в окружающий код Tcl возвращается ошибка. За дополнительными подробностями и примером обратитесь к <a class="xref" href="pltcl-subtransactions.html" title="44.9. Явные подтранзакции в PL/Tcl">Разделу 44.9</a>.</p></dd><dt><span class="term"><code class="function">quote</code> <em class="replaceable"><code>строка</code></em></span></dt><dd><p>Дублирует все вхождения апострофа и обратной косой черты в заданной строке. Это можно использовать для защиты строк, которые будут вставляться в команды SQL, передаваемые в <code class="function">spi_exec</code> или <code class="function">spi_prepare</code>. Например, представьте, что при выполнении такой команды SQL: </p><pre class="programlisting">"SELECT '$val' AS ret"</pre><p> переменная языка Tcl <code class="literal">val</code> содержит <code class="literal">doesn't</code>. Это приведёт к формированию такой окончательной строки команды: </p><pre class="programlisting">SELECT 'doesn't' AS ret</pre><p> при разборе которой в процессе <code class="function">spi_exec</code> или <code class="function">spi_prepare</code> возникнет ошибка. Чтобы этот запрос работал правильно, итоговая команда должна выглядеть так: </p><pre class="programlisting">SELECT 'doesn''t' AS ret</pre><p> Получить её в PL/Tcl можно так: </p><pre class="programlisting">"SELECT '[ quote $val ]' AS ret"</pre><p> Преимуществом <code class="function">spi_execp</code> является то, что для неё заключать значения параметров в кавычки подобным образом не нужно, так как параметры никогда не разбираются в составе строки команды SQL.</p></dd><dt><span class="term">
       <code class="function">elog</code> <em class="replaceable"><code>уровень</code></em> <em class="replaceable"><code>сообщение</code></em>
       <a id="id-1.8.9.9.2.1.6.1.4" class="indexterm"></a>
      </span></dt><dd><p>Выдаёт служебное сообщение или сообщение об ошибке. Возможные уровни сообщений: <code class="literal">DEBUG</code> (ОТЛАДКА), <code class="literal">LOG</code> (СООБЩЕНИЕ), <code class="literal">INFO</code> (ИНФОРМАЦИЯ), <code class="literal">NOTICE</code> (ЗАМЕЧАНИЕ), <code class="literal">WARNING</code> (ПРЕДУПРЕЖДЕНИЕ), <code class="literal">ERROR</code> (ОШИБКА) и <code class="literal">FATAL</code> (ВАЖНО). С уровнем <code class="literal">ERROR</code> выдаётся ошибка; если она не перехватывается окружающим кодом Tcl, она распространяется в вызывающий запрос, что приводит к прерыванию текущей транзакции или подтранзакции. По сути то же самое делает команда <code class="literal">error</code> языка Tcl. Сообщение уровня <code class="literal">FATAL</code> прерывает транзакцию и приводит к завершению текущего сеанса. (Вероятно, нет обоснованной причины использовать этот уровень ошибок в функциях PL/Tcl, но он поддерживается для полноты.) При использовании других уровней происходит просто вывод сообщения с заданным уровнем важности. Будут ли сообщения определённого уровня передаваться клиенту и/или записываться в журнал, определяется конфигурационными переменными <a class="xref" href="runtime-config-logging.html#GUC-LOG-MIN-MESSAGES">log_min_messages</a> и <a class="xref" href="runtime-config-client.html#GUC-CLIENT-MIN-MESSAGES">client_min_messages</a>. За дополнительными сведениями обратитесь к <a class="xref" href="runtime-config.html" title="Глава 20. Настройка сервера">Главе 20</a> и <a class="xref" href="pltcl-error-handling.html" title="44.8. Обработка ошибок в PL/Tcl">Разделу 44.8</a>.</p></dd></dl></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="pltcl-global.html" title="44.4. Глобальные данные в PL/Tcl">Пред.</a> </td><td width="20%" align="center"><a accesskey="u" href="pltcl.html" title="Глава 44. PL/Tcl — процедурный язык Tcl">Наверх</a></td><td width="40%" align="right"> <a accesskey="n" href="pltcl-trigger.html" title="44.6. Триггерные функции на PL/Tcl">След.</a></td></tr><tr><td width="40%" align="left" valign="top">44.4. Глобальные данные в PL/Tcl </td><td width="20%" align="center"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="40%" align="right" valign="top"> 44.6. Триггерные функции на PL/Tcl</td></tr></table></div></body></html>