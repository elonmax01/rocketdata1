<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>33.1. Выполнение тестов</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@lists.postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets Vsnapshot" /><link rel="prev" href="regress.html" title="Глава 33. Регрессионные тесты" /><link rel="next" href="regress-evaluation.html" title="33.2. Оценка результатов тестирования" /></head><body id="docContent" class="container-fluid col-10"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="5" align="center">33.1. Выполнение тестов</th></tr><tr><td width="10%" align="left"><a accesskey="p" href="regress.html" title="Глава 33. Регрессионные тесты">Пред.</a> </td><td width="10%" align="left"><a accesskey="u" href="regress.html" title="Глава 33. Регрессионные тесты">Наверх</a></td><th width="60%" align="center">Глава 33. Регрессионные тесты</th><td width="10%" align="right"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="10%" align="right"> <a accesskey="n" href="regress-evaluation.html" title="33.2. Оценка результатов тестирования">След.</a></td></tr></table><hr /></div><div class="sect1" id="REGRESS-RUN"><div class="titlepage"><div><div><h2 class="title" style="clear: both">33.1. Выполнение тестов <a href="#REGRESS-RUN" class="id_link">#</a></h2></div></div></div><div class="toc"><dl class="toc"><dt><span class="sect2"><a href="regress-run.html#REGRESS-RUN-TEMP-INST">33.1.1. Запуск тестов на временной инсталляции</a></span></dt><dt><span class="sect2"><a href="regress-run.html#REGRESS-RUN-EXISTING-INST">33.1.2. Запуск тестов для существующей инсталляции</a></span></dt><dt><span class="sect2"><a href="regress-run.html#REGRESS-ADDITIONAL">33.1.3. Дополнительные пакеты тестов</a></span></dt><dt><span class="sect2"><a href="regress-run.html#REGRESS-RUN-LOCALE">33.1.4. Локаль и кодировка</a></span></dt><dt><span class="sect2"><a href="regress-run.html#REGRESS-RUN-CUSTOM-SETTINGS">33.1.5. Пользовательские параметры сервера</a></span></dt><dt><span class="sect2"><a href="regress-run.html#REGRESS-RUN-EXTRA-TESTS">33.1.6. Специальные тесты</a></span></dt></dl></div><p>Регрессионное тестирование можно выполнять как на уже установленном и работающем сервере, так и используя временную инсталляцию внутри дерева сборки. Более того, существуют <span class="quote">«<span class="quote">параллельный</span>»</span> и <span class="quote">«<span class="quote">последовательный</span>»</span> режимы тестирования. Последовательный метод выполняет каждый сценарий теста отдельно, тогда как параллельный метод запускает несколько процессов на сервере, чтобы выполнить определённый набор тестов параллельно. Параллельное тестирование позволяет с уверенностью утверждать, что межпроцессное взаимодействие и блокировки работают корректно. Некоторые тесты могут выполняться последовательно даже в <span class="quote">«<span class="quote">параллельном</span>»</span> режиме, если это требуется для выполнения тестирования.</p><div class="sect2" id="REGRESS-RUN-TEMP-INST"><div class="titlepage"><div><div><h3 class="title">33.1.1. Запуск тестов на временной инсталляции <a href="#REGRESS-RUN-TEMP-INST" class="id_link">#</a></h3></div></div></div><p>Чтобы запустить параллельное регрессионное тестирование после сборки, но до инсталляции, наберите: </p><pre class="screen">
make check
</pre><p> в каталоге верхнего уровня. (Или перейдите в <code class="filename">src/test/regress</code> и выполните команду там.) Для тестов, выполняющихся в параллельном режиме, добавляется префикс <span class="quote">«<span class="quote">+</span>»</span>, для тестов в последовательном режиме используется префикс <span class="quote">«<span class="quote">-</span>»</span>. По завершении процесса вы должны увидеть нечто вроде: </p><pre class="screen">
<code class="computeroutput">
# All 213 tests passed.
</code>
</pre><p> или список тестов, не пройденных успешно. Прочитайте <a class="xref" href="regress-evaluation.html" title="33.2. Оценка результатов тестирования">Раздел 33.2</a>, прежде чем делать вывод о серьёзности выявленных <span class="quote">«<span class="quote">проблем</span>»</span>.</p><p>Поскольку данный метод тестирования выполняется на временном сервере, он не будет работать, если вы выполняете сборку под пользователем root, сервер просто не запустится из под root. Рекомендуется не делать сборку под пользователем root, если только вы не собираетесь проводить тестирование после завершения инсталляции.</p><p>Если вы сконфигурировали <span class="productname">PostgreSQL</span> для инсталляции в месте, где уже установлена предыдущая версия <span class="productname">PostgreSQL</span>, и вы выполняете <code class="literal">make check</code> до инсталляции новой версии, вы можете столкнуться с тем, что тестирование завершится со сбоем, поскольку новая программа будет пытаться использовать уже установленные общие библиотеки. (Типичные симптомы - жалобы на неопределённые символы.) Если вы хотите провести тестирование до перезаписи старой инсталляции, вам необходимо проводить построение с <code class="literal">configure --disable-rpath</code>. Однако этот вариант не рекомендуется для окончательной инсталляции.</p><p>Параллельное регрессионное тестирование запускает довольно много процессов под вашим именем пользователя. В настоящее время возможный максимум параллельной обработки составляет двадцать параллельных тестовых сценариев, а это означает сорок процессов: это и серверный процесс, и <span class="application">psql</span> процесс для каждого тестового сценария. Поэтому если ваша система устанавливает ограничения на количество процессов для каждого пользователя, имеет смысл уточнить, что ваш лимит составляет не меньше пятидесяти процессов или около того. В противном случае вы столкнетесь с кажущимися случайными сбоями в параллельном тестировании. Если же вы не имеете права увеличить свой лимит процессов, вы можете снизить степень распараллеливания установкой параметра <code class="literal">MAX_CONNECTIONS</code>. Например: </p><pre class="screen">
make MAX_CONNECTIONS=10 check
</pre><p> выполняет не больше десяти тестов параллельно.</p></div><div class="sect2" id="REGRESS-RUN-EXISTING-INST"><div class="titlepage"><div><div><h3 class="title">33.1.2. Запуск тестов для существующей инсталляции <a href="#REGRESS-RUN-EXISTING-INST" class="id_link">#</a></h3></div></div></div><p>Чтобы запустить тестирование после инсталляции (см. <a class="xref" href="installation.html" title="Глава 17. Установка из исходного кода">Главу 17</a>), инициализируйте каталог данных и запустите сервер, как показано в <a class="xref" href="runtime.html" title="Глава 19. Подготовка к работе и сопровождение сервера">Главе 19</a>, потом введите: </p><pre class="screen">
make installcheck
</pre><p> или для параллельного тестирования: </p><pre class="screen">
make installcheck-parallel
</pre><p> Тестовые сценарии будут соединяться с сервером на локальном компьютере с номером порта по умолчанию, если иное не задано переменными среды <code class="envar">PGHOST</code> и <code class="envar">PGPORT</code>. Тестирование будет проведено в базе данных <code class="literal">regression</code>; любая существующая база с таким именем будет удалена.</p><p>Также тесты будут создавать для временного пользования объекты, общие для кластера, такие как роли, табличные пространства и подписки. Имена этих объектов будут начинаться с <code class="literal">regress_</code>. Остерегайтесь использования режима <code class="literal">installcheck</code> там, где такие имена могут иметь существующие глобальные объекты.</p></div><div class="sect2" id="REGRESS-ADDITIONAL"><div class="titlepage"><div><div><h3 class="title">33.1.3. Дополнительные пакеты тестов <a href="#REGRESS-ADDITIONAL" class="id_link">#</a></h3></div></div></div><p>Команды <code class="literal">make check</code> и <code class="literal">make installcheck</code> запускают только <span class="quote">«<span class="quote">основные</span>»</span> регрессионные тесты, которые проверяют встроенную функциональность сервера <span class="productname">PostgreSQL</span>. Исходный дистрибутив содержит множество других комплектов тестов, большая часть которых имеет дело с дополнительной функциональностью, такой, как, например, дополнительные процедурные языки.</p><p>Чтобы запустить пакет тестов (включая основные) применительно к модулям, выбранным для построения, наберите одну из этих команд в каталоге верхнего уровня дерева сборки: </p><pre class="screen">
make check-world
make installcheck-world
</pre><p> Эти команды запускают тестирование, используя временный или уже установленный сервер, в соответствии с данным выше описанием для команд <code class="literal">make check</code> и <code class="literal">make installcheck</code>. Остальные детали соответствуют ранее изложенным объяснениям для каждого метода. Необходимо иметь в виду, что команда <code class="literal">make check-world</code> создаёт экземпляр кластера (временный каталог данных) для каждого тестировочного модуля, а это требует гораздо больше времени и дискового пространства, нежели команда <code class="literal">make installcheck-world</code>.</p><p>На современном компьютере с множеством процессорных ядер и операционной системой без жёстких ограничений тестирование можно многократно ускорить за счёт распараллеливания. Рецепт, которым на практике пользуются большинство разработчиков для ускоренного выполнения всех тестов, выглядит примерно так: </p><pre class="screen">
make check-world -j8 &gt;/dev/null
</pre><p> Значение для <code class="option">-j</code> обычно ограничивается количеством ядер или может быть немного больше. Подавление вывода в <span class="systemitem">stdout</span> избавляет от большого объёма сообщений, не представляющих интереса, когда нужно просто убедиться в успешности проверки. (В случае ошибки выводимые в <span class="systemitem">stderr</span> сообщения обычно дают достаточно информации для диагностики проблемы.)</p><p>В качестве альтернативного пути можно запустить индивидуальный набор тестов, набрав <code class="literal">make check</code> или <code class="literal">make installcheck</code> в подходящем подкаталоге дерева сборки. Имейте в виду, что <code class="literal">make installcheck</code> предполагает, что вы уже установили соответствующие модули, а не только основной сервер.</p><p>Дополнительные тесты, которые можно активизировать таким способом:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Регрессионные тесты для дополнительных процедурных языков. Эти тесты расположены в каталоге <code class="filename">src/pl</code>.</p></li><li class="listitem"><p>Регрессионные тесты для модулей <code class="filename">contrib</code>, расположенные в каталоге <code class="filename">contrib</code>. Не для всех модулей из <code class="filename"> contrib</code> существуют тесты.</p></li><li class="listitem"><p>Регрессионные тесты для интерфейсных библиотек, расположенные в <code class="filename">src/interfaces/libpq/test</code> и <code class="filename">src/interfaces/ecpg/test</code>.</p></li><li class="listitem"><p>Тесты для проверки встроенных в ядро методов проверки подлинности, расположенные в <code class="filename">src/test/authentication</code>. (Ниже описываются дополнительные тесты, связанные с проверкой подлинности.)</p></li><li class="listitem"><p>Тесты для нагрузочного тестирования параллельных сеансов, расположенные в <code class="filename">src/test/isolation</code>.</p></li><li class="listitem"><p>Тесты для проверки физической репликации и восстановления после сбоев, расположенные в <code class="filename">src/test/recovery</code>.</p></li><li class="listitem"><p>Тесты для проверки логической репликации, расположенные в <code class="filename">src/test/subscription</code>.</p></li><li class="listitem"><p>Тесты клиентских программ, расположенные в <code class="filename">src/bin</code>.</p></li></ul></div><p>При использовании режима <code class="literal">installcheck</code> эти тесты будут создавать и удалять базы данных с именами, включающими слово <code class="literal">regression</code>, например <code class="literal">pl_regression</code> или <code class="literal">contrib_regression</code>. Остерегайтесь использования этого режима там, где имеются базы с такими именами, не предназначенные для тестирования.</p><p>Некоторые из этих дополнительных комплектов тестов используют инфраструктуру TAP, описанную в <a class="xref" href="regress-tap.html" title="33.4. TAP-тесты">Разделе 33.4</a>. TAP-тесты выполняются, только когда PostgreSQL конфигурируется с ключом <code class="option">--enable-tap-tests</code>. Этот ключ рекомендуется для разработки, но если подходящей инсталляции Perl нет, его можно опустить.</p><p>Некоторые комплекты не запускаются по умолчанию — одни потому, что выполнять их в многопользовательской системе небезопасно, другие потому, что им требуется специальное программное обеспечение, а некоторые из-за своей ресурсоёмкости. Эти комплекты тестов можно включить дополнительно, присвоив переменной <code class="varname">PG_TEST_EXTRA</code> (это может быть переменная окружения или скрипта <code class="command">make</code>) строку с их списком через пробел, например: </p><pre class="programlisting">make check-world PG_TEST_EXTRA='kerberos ldap ssl load_balance'</pre><p> В настоящее время поддерживаются следующие значения: </p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">kerberos</code></span></dt><dd><p>Запускает комплект тестов в подкаталоге <code class="filename">src/test/kerberos</code>. Эти тесты требуют наличия инсталляции MIT Kerberos и открывают сокеты TCP/IP для приёма соединений.</p></dd><dt><span class="term"><code class="literal">ldap</code></span></dt><dd><p>Запускает комплект тестов в подкаталоге <code class="filename">src/test/ldap</code>. Эти тесты требуют наличия инсталляции <span class="productname">OpenLDAP</span> и открывают сокеты TCP/IP для приёма соединений.</p></dd><dt><span class="term"><code class="literal">ssl</code></span></dt><dd><p>Запускает комплект тестов в подкаталоге <code class="filename">src/test/ssl</code>. Эти тесты открывают сокеты TCP/IP для приёма соединений.</p></dd><dt><span class="term"><code class="literal">load_balance</code></span></dt><dd><p>Запускает тест <code class="filename">src/interfaces/libpq/t/004_load_balance_dns.pl</code>. Этот тест требует наличия соответствующих записей в системном файле <code class="filename">hosts</code> и открывает сокеты TCP/IP для приёма соединений.</p></dd><dt><span class="term"><code class="literal">wal_consistency_checking</code></span></dt><dd><p>Включает проверку <code class="literal">wal_consistency_checking=all</code> при выполнении определённых тестов в подкаталоге <code class="filename">src/test/recovery</code>. По умолчанию эта проверка не производится, так как она создаёт значительную нагрузку.</p></dd></dl></div><p> Тесты функциональности, которая не поддерживается в текущей конфигурации сборки, не запускаются, даже если они указаны в <code class="varname">PG_TEST_EXTRA</code>.</p><p>Кроме того, в каталоге <code class="filename">src/test/modules</code> есть тесты, которые будут запускаться в режиме <code class="literal">make check-world</code>, но не в <code class="literal">make installcheck-world</code>. Это объясняется тем, что они имеют побочные эффекты или устанавливают расширения, неподходящие для производственной среды. По желанию вы можете выполнить <code class="literal">make install</code> или <code class="literal">make installcheck</code> в одном из его подкаталогов, но делать это с сервером, не предназначенным для тестирования, не рекомендуется.</p></div><div class="sect2" id="REGRESS-RUN-LOCALE"><div class="titlepage"><div><div><h3 class="title">33.1.4. Локаль и кодировка <a href="#REGRESS-RUN-LOCALE" class="id_link">#</a></h3></div></div></div><p>По умолчанию, тесты, работающие на временной инсталляции, используют локаль, определённую в текущей среде и кодировку базы данных, заданную при выполнении <code class="command">initdb</code>. Для тестирования различных локалей может оказаться полезным установить подходящие переменные среды, например: </p><pre class="screen">
make check LANG=C
make check LC_COLLATE=en_US.utf8 LC_CTYPE=ru_RU.utf8
</pre><p> Поддержка переменной <code class="envar">LC_ALL</code> в этом случае не реализована; все остальные переменные среды, относящиеся к локали, работают.</p><p>При тестировании на существующей инсталляции, локаль определяется имеющимся кластером базы данных и не может быть изменена для выполнения теста.</p><p>Вы можете задать кодировку базы данных в переменной <code class="envar">ENCODING</code>, например: </p><pre class="screen">
make check LANG=C ENCODING=EUC_JP
</pre><p> Установка кодировки базы данных таким образом имеет смысл только для локали C; в противном случае кодировка определяется автоматически из локали, и установка кодировки, не соответствующей локали, приведёт к ошибке.</p><p>Кодировка базы данных может быть установлена как для тестирования на временной, так и на существующей инсталляции, хотя в последнем случае она должна быть совместимой с локалью этой инсталляции.</p></div><div class="sect2" id="REGRESS-RUN-CUSTOM-SETTINGS"><div class="titlepage"><div><div><h3 class="title">33.1.5. Пользовательские параметры сервера <a href="#REGRESS-RUN-CUSTOM-SETTINGS" class="id_link">#</a></h3></div></div></div><p>При запуске пакета регрессионных тестов можно использовать пользовательские параметры сервера, задаваемые переменной окружения <code class="varname">PGOPTIONS</code> (если это возможно): </p><pre class="screen">
make check PGOPTIONS="-c debug_parallel_query=regress -c work_mem=50MB"
</pre><p> Когда тесты проводятся с временной инсталляцией, пользовательские параметры также можно задать в предварительно написанном <code class="filename">postgresql.conf</code>: </p><pre class="screen">
echo 'log_checkpoints = on' &gt; test_postgresql.conf
echo 'work_mem = 50MB' &gt;&gt; test_postgresql.conf
make check EXTRA_REGRESS_OPTS="--temp-config=test_postgresql.conf"
</pre><p>Такие параметры полезно задать для изменения детализации сообщений в журнале, изменения ограничений ресурсов или включения дополнительных проверок во время выполнения, например <a class="xref" href="runtime-config-developer.html#GUC-DEBUG-DISCARD-CACHES">debug_discard_caches</a>.</p></div><div class="sect2" id="REGRESS-RUN-EXTRA-TESTS"><div class="titlepage"><div><div><h3 class="title">33.1.6. Специальные тесты <a href="#REGRESS-RUN-EXTRA-TESTS" class="id_link">#</a></h3></div></div></div><p>Пакет основных регрессионных тестов содержит несколько тестовых файлов, которые не запускаются по умолчанию, поскольку они могут зависеть от платформы или выполняться слишком долго. Вы можете запустить те или иные дополнительные тесты, задав переменную <code class="envar">EXTRA_TESTS</code>. Например, запустить тест <code class="literal">numeric_big</code>: </p><pre class="screen">
make check EXTRA_TESTS=numeric_big
</pre></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="regress.html" title="Глава 33. Регрессионные тесты">Пред.</a> </td><td width="20%" align="center"><a accesskey="u" href="regress.html" title="Глава 33. Регрессионные тесты">Наверх</a></td><td width="40%" align="right"> <a accesskey="n" href="regress-evaluation.html" title="33.2. Оценка результатов тестирования">След.</a></td></tr><tr><td width="40%" align="left" valign="top">Глава 33. Регрессионные тесты </td><td width="20%" align="center"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="40%" align="right" valign="top"> 33.2. Оценка результатов тестирования</td></tr></table></div></body></html>