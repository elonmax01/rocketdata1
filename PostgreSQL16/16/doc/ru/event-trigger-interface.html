<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>40.3. Триггерные функции событий на языке C</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@lists.postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets Vsnapshot" /><link rel="prev" href="event-trigger-matrix.html" title="40.2. Матрица срабатывания триггеров событий" /><link rel="next" href="event-trigger-example.html" title="40.4. Полный пример триггера события" /></head><body id="docContent" class="container-fluid col-10"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="5" align="center">40.3. Триггерные функции событий на языке C</th></tr><tr><td width="10%" align="left"><a accesskey="p" href="event-trigger-matrix.html" title="40.2. Матрица срабатывания триггеров событий">Пред.</a> </td><td width="10%" align="left"><a accesskey="u" href="event-triggers.html" title="Глава 40. Триггеры событий">Наверх</a></td><th width="60%" align="center">Глава 40. Триггеры событий</th><td width="10%" align="right"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="10%" align="right"> <a accesskey="n" href="event-trigger-example.html" title="40.4. Полный пример триггера события">След.</a></td></tr></table><hr /></div><div class="sect1" id="EVENT-TRIGGER-INTERFACE"><div class="titlepage"><div><div><h2 class="title" style="clear: both">40.3. Триггерные функции событий на языке C <a href="#EVENT-TRIGGER-INTERFACE" class="id_link">#</a></h2></div></div></div><a id="id-1.8.5.7.2" class="indexterm"></a><p>В этом разделе описываются низкоуровневые детали интерфейса для событийных триггерных функций. Эта информация необходима только при разработке событийных триггерных функций событий на языке C. При использовании языка более высокого уровня эти детали не видны. В большинстве случаев стоит рассмотреть возможность использования процедурного языка, прежде чем начать разрабатывать событийные триггеры на C. В документации по каждому процедурному языку объясняется, как создавать событийные триггеры на этом языке.</p><p>Триггерные функции событий должны использовать <span class="quote">«<span class="quote">version 1</span>»</span> интерфейса диспетчера функций.</p><p>Когда функция вызывается диспетчером триггеров событий, ей не передаются обычные аргументы, но передаётся указатель <span class="quote">«<span class="quote">context</span>»</span>, ссылающийся на структуру <code class="structname">EventTriggerData</code>. Функции на C могут проверить вызваны ли они диспетчером триггеров событий или нет выполнив макрос: </p><pre class="programlisting">CALLED_AS_EVENT_TRIGGER(fcinfo)</pre><p> который разворачивается в: </p><pre class="programlisting"><code class="structname">EventTriggerData</code></pre><p> Если возвращается истина, то <code class="literal">fcinfo-&gt;context</code> можно безопасно привести к типу <code class="literal">EventTriggerData *</code> и использовать указатель на структуру <code class="structname">EventTriggerData</code>. Функция <span class="emphasis"><em>не</em></span> должна изменять структуру <code class="structname">EventTriggerData</code> или любые данные, которые на неё указывают.</p><p><code class="structname">struct EventTriggerData</code> определена в <code class="filename">commands/event_trigger.h</code>: </p><pre class="programlisting">typedef struct EventTriggerData
{
    NodeTag     type;
    const char *event;      /* имя события */
    Node       *parsetree;  /* дерево разбора */
    CommandTag  tag;        /* тег команды */
} EventTriggerData;</pre><p> со следующими членами структуры: </p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="structfield">type</code></span></dt><dd><p>Всегда <code class="literal">T_EventTriggerData</code>.</p></dd><dt><span class="term"><code class="structfield">event</code></span></dt><dd><p>Описывает событие, для которого вызывается функция. Возможные значения: <code class="literal">"ddl_command_start"</code>, <code class="literal">"ddl_command_end"</code>, <code class="literal">"sql_drop"</code>, <code class="literal">"table_rewrite"</code>. Суть этих событий описывается в <a class="xref" href="event-trigger-definition.html" title="40.1. Обзор механизма работы триггеров событий">Разделе 40.1</a>.</p></dd><dt><span class="term"><code class="structfield">parsetree</code></span></dt><dd><p>Указатель на дерево разбора команды. Детали можно посмотреть в исходном коде PostgreSQL. Структура дерева разбора может быть изменена без предупреждений.</p></dd><dt><span class="term"><code class="structfield">tag</code></span></dt><dd><p>Тег команды, для которой сработал триггер события. Например <code class="literal">"CREATE FUNCTION"</code>.</p></dd></dl></div><p>Функция триггера события должна возвращать указатель <code class="symbol">NULL</code> (но <span class="emphasis"><em>не</em></span> SQL значение null, то есть не нужно устанавливать <em class="parameter"><code>isNull</code></em> в истину).</p></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="event-trigger-matrix.html" title="40.2. Матрица срабатывания триггеров событий">Пред.</a> </td><td width="20%" align="center"><a accesskey="u" href="event-triggers.html" title="Глава 40. Триггеры событий">Наверх</a></td><td width="40%" align="right"> <a accesskey="n" href="event-trigger-example.html" title="40.4. Полный пример триггера события">След.</a></td></tr><tr><td width="40%" align="left" valign="top">40.2. Матрица срабатывания триггеров событий </td><td width="20%" align="center"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="40%" align="right" valign="top"> 40.4. Полный пример триггера события</td></tr></table></div></body></html>