<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>DECLARE</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@lists.postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets Vsnapshot" /><link rel="prev" href="sql-deallocate.html" title="DEALLOCATE" /><link rel="next" href="sql-delete.html" title="DELETE" /></head><body id="docContent" class="container-fluid col-10"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="5" align="center">DECLARE</th></tr><tr><td width="10%" align="left"><a accesskey="p" href="sql-deallocate.html" title="DEALLOCATE">Пред.</a> </td><td width="10%" align="left"><a accesskey="u" href="sql-commands.html" title="Команды SQL">Наверх</a></td><th width="60%" align="center">Команды SQL</th><td width="10%" align="right"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="10%" align="right"> <a accesskey="n" href="sql-delete.html" title="DELETE">След.</a></td></tr></table><hr /></div><div class="refentry" id="SQL-DECLARE"><div class="titlepage"></div><a id="id-1.9.3.99.1" class="indexterm"></a><a id="id-1.9.3.99.2" class="indexterm"></a><a id="id-1.9.3.99.3" class="indexterm"></a><div class="refnamediv"><h2><span class="refentrytitle">DECLARE</span></h2><p>DECLARE — определить курсор</p></div><div class="refsynopsisdiv"><h2>Синтаксис</h2><pre class="synopsis">DECLARE <em class="replaceable"><code>имя</code></em> [ BINARY ] [ ASENSITIVE | INSENSITIVE ] [ [ NO ] SCROLL ]
    CURSOR [ { WITH | WITHOUT } HOLD ] FOR <em class="replaceable"><code>запрос</code></em></pre></div><div class="refsect1" id="id-1.9.3.99.7"><h2>Описание</h2><p>Оператор <code class="command">DECLARE</code> позволяет пользователю создавать курсоры, с помощью которых можно выбирать по очереди некоторое количество строк из результата большого запроса. Когда курсор создан, через него можно получать строки, применяя команду <a class="link" href="sql-fetch.html" title="FETCH"><code class="command">FETCH</code></a>.</p><div class="note"><h3 class="title">Примечание</h3><p>На этой странице описывается применение курсоров на уровне команд SQL. Если вы попытаетесь использовать курсоры внутри функции <span class="application">PL/pgSQL</span>, правила будут другими — см. <a class="xref" href="plpgsql-cursors.html" title="43.7. Курсоры">Раздел 43.7</a>.</p></div></div><div class="refsect1" id="id-1.9.3.99.8"><h2>Параметры</h2><div class="variablelist"><dl class="variablelist"><dt><span class="term"><em class="replaceable"><code>имя</code></em></span></dt><dd><p>Имя создаваемого курсора. Оно должно отличаться от имён других активных курсоров в сеансе.</p></dd><dt><span class="term"><code class="literal">BINARY</code></span></dt><dd><p>Курсор с таким свойством возвращает данные в двоичном, а не текстовом формате.</p></dd><dt><span class="term"><code class="literal">ASENSITIVE</code><br /></span><span class="term"><code class="literal">INSENSITIVE</code></span></dt><dd><p>Свойство «чувствительности» курсора определяет, будут ли изменения нижележащих данных курсора, выполненные в той же транзакции после объявления курсора, видны в нём. <code class="literal">INSENSITIVE</code> означает, что они не будут видны, а <code class="literal">ASENSITIVE</code> выбирает поведение, определяемое реализацией. Третий вариант, <code class="literal">SENSITIVE</code>, при выборе которого такие изменения должны быть видны в курсоре, в <span class="productname">PostgreSQL</span> не поддерживается. В <span class="productname">PostgreSQL</span> все курсоры являются «нечувствительными», поэтому данные ключевые слова не действуют и принимаются только для совместимости со стандартом SQL.</p><p>Указание <code class="literal">INSENSITIVE</code> вместе с <code class="literal">FOR UPDATE</code> или <code class="literal">FOR SHARE</code> считается ошибочным.</p></dd><dt><span class="term"><code class="literal">SCROLL</code><br /></span><span class="term"><code class="literal">NO SCROLL</code></span></dt><dd><p>Указание <code class="literal">SCROLL</code> определяет, что курсор может прокручивать набор данных и получать строки непоследовательно (например, в обратном порядке). В зависимости от сложности плана запроса указание <code class="literal">SCROLL</code> может отрицательно отразиться на скорости выполнения запроса. Указание <code class="literal">NO SCROLL</code>, напротив, определяет, что через курсор нельзя будет получать строки в произвольном порядке. По умолчанию прокрутка в некоторых случаях разрешается; но это не равнозначно эффекту указания <code class="literal">SCROLL</code>. За подробностями обратитесь к разделу <a class="xref" href="sql-declare.html#SQL-DECLARE-NOTES" title="Замечания">Замечания</a>.</p></dd><dt><span class="term"><code class="literal">WITH HOLD</code><br /></span><span class="term"><code class="literal">WITHOUT HOLD</code></span></dt><dd><p>Указание <code class="literal">WITH HOLD</code> определяет, что курсор можно продолжать использовать после успешной фиксации создавшей его транзакции. <code class="literal">WITHOUT HOLD</code> определяет, что курсор нельзя будет использовать за рамками транзакции, создавшей его. Если не указано ни <code class="literal">WITHOUT HOLD</code>, ни <code class="literal">WITH HOLD</code>, по умолчанию подразумевается <code class="literal">WITHOUT HOLD</code>.</p></dd><dt><span class="term"><em class="replaceable"><code>запрос</code></em></span></dt><dd><p>Команда <a class="link" href="sql-select.html" title="SELECT"><code class="command">SELECT</code></a> или <a class="link" href="sql-values.html" title="VALUES"><code class="command">VALUES</code></a>, выдающая строки, которые будут получены через курсор.</p></dd></dl></div><p>Ключевые слова <code class="literal">ASENSITIVE</code>, <code class="literal">BINARY</code>, <code class="literal">INSENSITIVE</code> и <code class="literal">SCROLL</code> могут указываться в любом порядке.</p></div><div class="refsect1" id="SQL-DECLARE-NOTES"><h2>Замечания</h2><p>Обычный курсор выдаёт данные в текстовом виде, в каком их выдаёт <code class="command">SELECT</code>. Однако с указанием <code class="literal">BINARY</code> курсор может выдавать их и в двоичном формате. Это упрощает операции преобразования данных для сервера и клиента, за счёт дополнительных усилий, требующихся от программиста для работы с платформозависимыми двоичными форматами. Например, если запрос получает значение 1 из целочисленного столбца, обычный курсор выдаст строку, содержащую <code class="literal">1</code>, тогда как через двоичный курсор будет получено четырёхбайтовое поле, содержащее внутреннее представление значения (с сетевым порядком байтов).</p><p>Двоичные курсоры должны применяться с осмотрительностью. Многие приложения, в том числе <span class="application">psql</span>, не приспособлены к работе с двоичными курсорами и ожидают, что данные будут поступать в текстовом формате.</p><div class="note"><h3 class="title">Примечание</h3><p>Когда клиентское приложение выполняет команду <code class="command">FETCH</code>, используя <span class="quote">«<span class="quote">расширенный</span>»</span> протокол запросов, в сообщении Bind этого протокола указывается, в каком формате, текстовом или двоичном, должны быть получены данные. Это указание переопределяет свойство курсора, заданное в его объявлении. Таким образом, концепция курсора, объявляемого двоичным, становится устаревшей при использовании расширенного протокола запросов — любой курсор может быть прочитан как текстовый или двоичный.</p></div><p>Если в команде объявления курсора не указано <code class="literal">WITH HOLD</code>, созданный ей курсор может использоваться только в текущей транзакции. Таким образом, оператор <code class="command">DECLARE</code> без <code class="literal">WITH HOLD</code> бесполезен вне блока транзакции: курсор будет существовать только до завершения этого оператора. Поэтому <span class="productname">PostgreSQL</span> сообщает об ошибке, если такая команда выполняется вне блока транзакции. Чтобы определить блок транзакции, примените команды <a class="link" href="sql-begin.html" title="BEGIN"><code class="command">BEGIN</code></a> и <a class="link" href="sql-commit.html" title="COMMIT"><code class="command">COMMIT</code></a> (или <a class="link" href="sql-rollback.html" title="ROLLBACK"><code class="command">ROLLBACK</code></a>).</p><p>Если в объявлении курсора указано <code class="literal">WITH HOLD</code> и транзакция, создавшая курсор, успешно фиксируется, к этому курсору могут продолжать обращаться последующие транзакции в этом сеансе. (Но если создавшая курсор транзакция прерывается, курсор уничтожается.) Курсор со свойством <code class="literal">WITH HOLD</code> (удерживаемый) может быть закрыт явно, командой <code class="command">CLOSE</code>, либо неявно, по завершении сеанса. В текущей реализации строки, представляемые удерживаемым курсором, копируются во временный файл или в область памяти, так что они остаются доступными для следующих транзакций.</p><p>Объявить курсор со свойством <code class="literal">WITH HOLD</code> можно, только если запрос не содержит указаний <code class="literal">FOR UPDATE</code> и <code class="literal">FOR SHARE</code>.</p><p>Указание <code class="literal">SCROLL</code> добавляется при определении курсора, который будет выбирать данные в обратном порядке. Это поведение требуется стандартом SQL. Однако для совместимости с предыдущими версиями, <span class="productname">PostgreSQL</span> допускает выборку в обратном направлении и без указания <code class="literal">SCROLL</code>, если план запроса курсора достаточно прост, чтобы реализовать прокрутку назад без дополнительных операций. Тем не менее разработчикам приложений не следует рассчитывать на то, что курсор, созданный без указания <code class="literal">SCROLL</code>, можно будет прокручивать назад. С указанием <code class="literal">NO SCROLL</code> прокрутка назад запрещается в любом случае.</p><p>Выборка в обратном направлении также запрещается, если запрос содержит указания <code class="literal">FOR UPDATE</code> и <code class="literal">FOR SHARE</code>; в этом случае указание <code class="literal">SCROLL</code> не принимается.</p><div class="caution"><h3 class="title">Внимание</h3><p>Прокручиваемые курсоры могут выдавать неожиданные результаты, если они вызывают изменчивые функции (см. <a class="xref" href="xfunc-volatility.html" title="38.7. Категории изменчивости функций">Раздел 38.7</a>). Когда повторно выбирается ранее прочитанная строка, функции могут вызываться снова и выдавать результаты, отличные от полученных в первый раз. Для запроса, вызывающего изменчивые функции, лучше всего указать <code class="literal">NO SCROLL</code>. Если такой способ не подходит, другая возможность обойти эту проблему — объявить курсор с указанием <code class="literal">WITH HOLD</code> и зафиксировать транзакцию, прежде чем читать из него какие-либо строки. В этом случае весь набор данных курсора будет материализован во временном хранилище, так что изменчивые функции будут выполнены для каждой строки лишь единожды.</p></div><p>Если запрос в определении курсора включает указания <code class="literal">FOR UPDATE</code> или <code class="literal">FOR SHARE</code>, возвращаемые курсором строки блокируются в момент первой выборки, так же, как это происходит при выполнении <a class="link" href="sql-select.html" title="SELECT"><code class="command">SELECT</code></a> с этими указаниями. Кроме того, при чтении строк будут возвращаться их наиболее актуальные версии.</p><div class="caution"><h3 class="title">Внимание</h3><p>Обычно рекомендуется использовать <code class="literal">FOR UPDATE</code>, если курсор предназначается для применения в командах <code class="command">UPDATE ... WHERE CURRENT OF</code> и <code class="command">DELETE ... WHERE CURRENT OF</code>. Указание <code class="literal">FOR UPDATE</code> предотвращает изменение строк другими сеансами после того, как они были считаны, и до того, как выполнится команда. Без <code class="literal">FOR UPDATE</code> последующая команда с <code class="literal">WHERE CURRENT OF</code> не сработает, если строка будет изменена после создания курсора.</p><p>Ещё одна причина использовать указание <code class="literal">FOR UPDATE</code> в том, что без него последующие команды с <code class="literal">WHERE CURRENT OF</code> могут выдать ошибку, если запрос курсора не удовлетворяет оговоренному в стандарте SQL критерию <span class="quote">«<span class="quote">простой изменяемости</span>»</span> (в частности, курсор должен ссылаться только на одну таблицу и не должен использовать группировку и сортировку (<code class="literal">ORDER BY</code>)). Курсоры, не удовлетворяющие этому критерию, могут работать либо не работать, в зависимости от конкретного выбранного плана; так что в худшем случае приложение может работать в тестовой, но сломается в производственной среде. С указанием <code class="literal">FOR UPDATE</code> курсор гарантированно будет изменяемым.</p><p>Не использовать же <code class="literal">FOR UPDATE</code> для команд с <code class="literal">WHERE CURRENT OF</code> в основном имеет смысл, только если требуется получить прокручиваемый курсор или курсор, изолированный от одновременно производимых изменений (то есть, продолжающий показывать прежние данные). Если это действительно необходимо, обязательно учтите при реализации приведённые выше замечания.</p></div><p>В стандарте SQL механизм курсоров предусмотрен только для встраиваемого <acronym class="acronym">SQL</acronym>. Сервер <span class="productname">PostgreSQL</span> не реализует для курсоров оператор <code class="command">OPEN</code>; курсор считается открытым при объявлении. Однако <span class="application">ECPG</span>, встраиваемый препроцессор SQL для <span class="productname">PostgreSQL</span>, следует соглашениям стандарта, в том числе поддерживая для курсоров операторы <code class="command">DECLARE</code> и <code class="command">OPEN</code>.</p><p>Структура данных сервера, определяющая открытый курсор, называется <em class="firstterm">порталом</em>. Имена порталов раскрываются в клиентском протоколе, то есть если имя портала известно, клиент может выбирать строки напрямую через открытый портал. Если курсор создаётся командой <code class="command">DECLARE</code>, имя портала совпадает с именем курсора.</p><p>Получить список всех доступных курсоров можно, обратившись к системному представлению <a class="link" href="view-pg-cursors.html" title="54.6. pg_cursors"><code class="structname">pg_cursors</code></a>.</p></div><div class="refsect1" id="id-1.9.3.99.10"><h2>Примеры</h2><p>Объявление курсора: </p><pre class="programlisting">DECLARE liahona CURSOR FOR SELECT * FROM films;</pre><p> Другие примеры использования курсора можно найти в <a class="xref" href="sql-fetch.html" title="FETCH"><span class="refentrytitle">FETCH</span></a>.</p></div><div class="refsect1" id="id-1.9.3.99.11"><h2>Совместимость</h2><p>Стандарт SQL допускает курсоры только во встраиваемом <acronym class="acronym">SQL</acronym> и в модулях. <span class="productname">PostgreSQL</span> позволяет использовать курсоры интерактивно.</p><p>Согласно стандарту SQL, изменения, которые вносит нечувствительный курсор, выполняющий оператор <code class="literal">UPDATE ... WHERE CURRENT OF</code> и <code class="literal">DELETE ... WHERE CURRENT OF</code>, должны быть видны в этом же курсоре. <span class="productname">PostgreSQL</span> обрабатывает эти операторы как и любые другие операторы, изменяющие данные, так что нечувствительные курсоры не видят результатов их действия.</p><p>Двоичные курсоры являются расширением <span class="productname">PostgreSQL</span>.</p></div><div class="refsect1" id="id-1.9.3.99.12"><h2>См. также</h2><span class="simplelist"><a class="xref" href="sql-close.html" title="CLOSE"><span class="refentrytitle">CLOSE</span></a>, <a class="xref" href="sql-fetch.html" title="FETCH"><span class="refentrytitle">FETCH</span></a>, <a class="xref" href="sql-move.html" title="MOVE"><span class="refentrytitle">MOVE</span></a></span></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="sql-deallocate.html" title="DEALLOCATE">Пред.</a> </td><td width="20%" align="center"><a accesskey="u" href="sql-commands.html" title="Команды SQL">Наверх</a></td><td width="40%" align="right"> <a accesskey="n" href="sql-delete.html" title="DELETE">След.</a></td></tr><tr><td width="40%" align="left" valign="top">DEALLOCATE </td><td width="20%" align="center"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="40%" align="right" valign="top"> DELETE</td></tr></table></div></body></html>