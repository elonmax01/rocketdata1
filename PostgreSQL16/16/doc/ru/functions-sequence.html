<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>9.17. Функции для работы с последовательностями</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@lists.postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets Vsnapshot" /><link rel="prev" href="functions-json.html" title="9.16. Функции и операторы JSON" /><link rel="next" href="functions-conditional.html" title="9.18. Условные выражения" /></head><body id="docContent" class="container-fluid col-10"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="5" align="center">9.17. Функции для работы с последовательностями</th></tr><tr><td width="10%" align="left"><a accesskey="p" href="functions-json.html" title="9.16. Функции и операторы JSON">Пред.</a> </td><td width="10%" align="left"><a accesskey="u" href="functions.html" title="Глава 9. Функции и операторы">Наверх</a></td><th width="60%" align="center">Глава 9. Функции и операторы</th><td width="10%" align="right"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="10%" align="right"> <a accesskey="n" href="functions-conditional.html" title="9.18. Условные выражения">След.</a></td></tr></table><hr /></div><div class="sect1" id="FUNCTIONS-SEQUENCE"><div class="titlepage"><div><div><h2 class="title" style="clear: both">9.17. Функции для работы с последовательностями <a href="#FUNCTIONS-SEQUENCE" class="id_link">#</a></h2></div></div></div><a id="id-1.5.8.23.2" class="indexterm"></a><p>В этом разделе описаны функции для работы с объектами, представляющими <em class="firstterm">последовательности</em>. Такие объекты (также называемыми генераторами последовательностей или просто последовательностями) являются специальными таблицами из одной строки и создаются командой <a class="xref" href="sql-createsequence.html" title="CREATE SEQUENCE"><span class="refentrytitle">CREATE SEQUENCE</span></a>. Используются они обычно для получения уникальных идентификаторов строк таблицы. Функции, перечисленные в <a class="xref" href="functions-sequence.html#FUNCTIONS-SEQUENCE-TABLE" title="Таблица 9.52. Функции для работы с последовательностями">Таблице 9.52</a>, предоставляют простые и безопасные для параллельного использования методы получения очередных значений таких последовательностей.</p><div class="table" id="FUNCTIONS-SEQUENCE-TABLE"><p class="title"><strong>Таблица 9.52. Функции для работы с последовательностями</strong></p><div class="table-contents"><table class="table" summary="Функции для работы с последовательностями" border="1"><colgroup><col /></colgroup><thead><tr><th class="func_table_entry"><p class="func_signature">Функция</p>
       <p>Описание</p></th></tr></thead><tbody><tr><td class="func_table_entry"><p class="func_signature"><a id="id-1.5.8.23.4.2.2.1.1.1.1" class="indexterm"></a> <code class="function">nextval</code> ( <code class="type">regclass</code> ) → <code class="returnvalue">bigint</code></p>
       <p>Продвигает объект последовательности к следующему значению и возвращает это значение. Это действие атомарно: даже если вызвать <code class="function">nextval</code> параллельно в нескольких сеансах, в каждом вызове будет гарантированно получено неповторяющееся значение последовательности. Если объект последовательности создаётся с параметрами по умолчанию, при каждом очередном вызове <code class="function">nextval</code> будет выдаваться следующее по порядку значение, начиная с 1. Изменить это поведение можно, установив соответствующие параметры команды <a class="xref" href="sql-createsequence.html" title="CREATE SEQUENCE"><span class="refentrytitle">CREATE SEQUENCE</span></a>.</p>
       <p>Этой функции требуется право <code class="literal">USAGE</code> или <code class="literal">UPDATE</code> для последовательности.</p></td></tr><tr><td class="func_table_entry"><p class="func_signature"><a id="id-1.5.8.23.4.2.2.2.1.1.1" class="indexterm"></a> <code class="function">setval</code> ( <code class="type">regclass</code>, <code class="type">bigint</code> [<span class="optional">, <code class="type">boolean</code></span>] ) → <code class="returnvalue">bigint</code></p>
       <p>Устанавливает для объекта последовательности текущее значение и может также установить флаг <code class="literal">is_called</code>. В форме с двумя параметрами устанавливает для последовательности заданное значение поля <code class="literal">last_value</code> и значение <code class="literal">true</code> для флага <code class="literal">is_called</code>, показывающего, что при следующем вызове <code class="function">nextval</code> последовательность должна сначала продвинуться к очередному значению, которое будет возвращено. При этом <code class="function">currval</code> также возвратит заданное значение. В форме с тремя параметрами флагу <code class="literal">is_called</code> тоже можно присвоить <code class="literal">true</code> или <code class="literal">false</code>. Со значением <code class="literal">true</code> она действует так же, как и форма с двумя параметрами. Если же присвоить этому флагу значение <code class="literal">false</code>, первый вызов <code class="function">nextval</code> после этого вернёт именно заданное значение, а продвижение последовательности произойдёт при последующем вызове <code class="function">nextval</code>. Кроме того, значение, возвращаемое <code class="function">currval</code> в этом случае, не меняется. Например: </p><pre class="programlisting">SELECT setval('myseq', 42);           <em class="lineannotation"><span class="lineannotation">При следующем вызове <code class="function">nextval</code> выдаст 43</span></em>
SELECT setval('myseq', 42, true);     <em class="lineannotation"><span class="lineannotation">То же самое</span></em>
SELECT setval('myseq', 42, false);    <em class="lineannotation"><span class="lineannotation">При следующем вызове <code class="function">nextval</code> выдаст 42</span></em></pre><p> Результатом <code class="function">setval</code> будет просто значение её второго аргумента.</p>
       <p>Этой функции требуется право <code class="literal">UPDATE</code> для последовательности.</p></td></tr><tr><td class="func_table_entry"><p class="func_signature"><a id="id-1.5.8.23.4.2.2.3.1.1.1" class="indexterm"></a> <code class="function">currval</code> ( <code class="type">regclass</code> ) → <code class="returnvalue">bigint</code></p>
       <p>Возвращает значение, выданное при последнем вызове <code class="function">nextval</code> для этой последовательности в текущем сеансе. (Если в данном сеансе <code class="function">nextval</code> ни разу не вызывалась для данной последовательности, возвращается ошибка.) Так как это значение ограничено рамками сеанса, эта функция выдаёт предсказуемый результат вне зависимости от того, вызвалась ли впоследствии <code class="function">nextval</code> в других сеансах или нет.</p>
       <p>Этой функции требуется право <code class="literal">USAGE</code> или <code class="literal">SELECT</code> для последовательности.</p></td></tr><tr><td class="func_table_entry"><p class="func_signature"><a id="id-1.5.8.23.4.2.2.4.1.1.1" class="indexterm"></a> <code class="function">lastval</code> () → <code class="returnvalue">bigint</code></p>
       <p>Возвращает значение, выданное при последнем вызове <code class="function">nextval</code> в текущем сеансе. Эта функция подобна <code class="function">currval</code>, но она не принимает в параметрах имя последовательности, а обращается к той последовательности, для которой вызывалась <code class="function">nextval</code> в последний раз в текущем сеансе. Если в текущем сеансе функция <code class="function">nextval</code> ещё не вызывалась, при вызове <code class="function">lastval</code> произойдёт ошибка.</p>
       <p>Этой функции требуется право <code class="literal">USAGE</code> или <code class="literal">SELECT</code> для последней использованной последовательности.</p></td></tr></tbody></table></div></div><br class="table-break" /><div class="caution"><h3 class="title">Внимание</h3><p>Во избежание блокирования параллельных транзакций, пытающихся получить значения одной последовательности, значение, выданное функцией <code class="function">nextval</code>, не высвобождается для повторного использования, если вызывающая транзакция впоследствии прерывается. Это означает, что в случае сбоев базы данных или прерывания транзакций в последовательности задействованных значений могут появляться пропуски. Пропуски могут появиться и без прерывания транзакции. Например, команда <code class="command">INSERT</code> с предложением <code class="literal">ON CONFLICT</code> вычислит кортеж, претендующий на добавление, произведя все требуемые вызовы <code class="function">nextval</code>, прежде чем выявит конфликты, которые могут привести к отработке правил <code class="literal">ON CONFLICT</code> вместо добавления. Таким образом, объекты последовательностей <span class="productname">PostgreSQL</span> <span class="emphasis"><em>не годятся для получения непрерывных последовательностей</em></span>.</p><p>В том же ключе изменения состояния последовательности, произведённые функцией <code class="function">setval</code>, сразу же становятся видимыми для других транзакций и не отменяются при откате транзакции, вызвавшей эту функцию.</p><p>Если кластер базы прерывает работу до фиксации транзакции, содержащей вызов функции <code class="function">nextval</code> или <code class="function">setval</code>, изменение состояния последовательности может не попасть в постоянное хранилище, поэтому неизвестно, какое состояние будет иметь последовательность после перезапуска кластера: исходное или изменённое. Это не создаёт проблем при использовании последовательности внутри базы данных, так как другие изменения незафиксированных транзакций также не будут видны. Однако если значение последовательности будет сохраняться и использоваться вне базы данных, следует предварительно убедиться в том, что вызов функции <code class="function">nextval</code> успешно зафиксирован.</p></div><p>Последовательность, с которой будет работать любая из вышеописанных функций, определяется аргументом типа <code class="type">regclass</code>, который представляет собой просто OID последовательности в системном каталоге <code class="structname">pg_class</code>. Однако вам не нужно вручную вычислять OID, так как процедура ввода значения <code class="type">regclass</code> может сделать это за вас. За подробностями обратитесь к <a class="xref" href="datatype-oid.html" title="8.19. Идентификаторы объектов">Разделу 8.19</a>.</p></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="functions-json.html" title="9.16. Функции и операторы JSON">Пред.</a> </td><td width="20%" align="center"><a accesskey="u" href="functions.html" title="Глава 9. Функции и операторы">Наверх</a></td><td width="40%" align="right"> <a accesskey="n" href="functions-conditional.html" title="9.18. Условные выражения">След.</a></td></tr><tr><td width="40%" align="left" valign="top">9.16. Функции и операторы JSON </td><td width="20%" align="center"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="40%" align="right" valign="top"> 9.18. Условные выражения</td></tr></table></div></body></html>