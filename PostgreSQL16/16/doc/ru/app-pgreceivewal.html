<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>pg_receivewal</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@lists.postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets Vsnapshot" /><link rel="prev" href="app-pg-isready.html" title="pg_isready" /><link rel="next" href="app-pgrecvlogical.html" title="pg_recvlogical" /></head><body id="docContent" class="container-fluid col-10"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="5" align="center"><span class="application">pg_receivewal</span></th></tr><tr><td width="10%" align="left"><a accesskey="p" href="app-pg-isready.html" title="pg_isready">Пред.</a> </td><td width="10%" align="left"><a accesskey="u" href="reference-client.html" title="Клиентские приложения PostgreSQL">Наверх</a></td><th width="60%" align="center">Клиентские приложения PostgreSQL</th><td width="10%" align="right"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="10%" align="right"> <a accesskey="n" href="app-pgrecvlogical.html" title="pg_recvlogical">След.</a></td></tr></table><hr /></div><div class="refentry" id="APP-PGRECEIVEWAL"><div class="titlepage"></div><a id="id-1.9.4.16.1" class="indexterm"></a><div class="refnamediv"><h2><span class="refentrytitle"><span class="application">pg_receivewal</span></span></h2><p>pg_receivewal — принимать журналы предзаписи с сервера <span class="productname">PostgreSQL</span></p></div><div class="refsynopsisdiv"><h2>Синтаксис</h2><div class="cmdsynopsis"><p id="id-1.9.4.16.4.1"><code class="command">pg_receivewal</code> [<em class="replaceable"><code>параметр</code></em>...]</p></div></div><div class="refsect1" id="id-1.9.4.16.5"><h2>Описание</h2><p>Утилита <span class="application">pg_receivewal</span> предназначена для приёма журнала предзаписи от работающего кластера <span class="productname">PostgreSQL</span>. Журнал предзаписи передаётся по протоколу потоковой репликации и записывается в локальный каталог. Затем этот каталог можно использовать в качестве архива для восстановления состояния на момент времени (см. <a class="xref" href="continuous-archiving.html" title="26.3. Непрерывное архивирование и восстановление на момент времени (Point-in-Time Recovery, PITR)">Раздел 26.3</a>).</p><p><span class="application">pg_receivewal</span> принимает журнал предзаписи в реальном времени по мере того, как он генерируется на сервере, и не ждёт завершения сегментов, как это делает <a class="xref" href="runtime-config-wal.html#GUC-ARCHIVE-COMMAND">archive_command</a> и <a class="xref" href="runtime-config-wal.html#GUC-ARCHIVE-LIBRARY">archive_library</a>. Поэтому <span class="application">pg_receivewal</span> можно использовать, не устанавливая <a class="xref" href="runtime-config-wal.html#GUC-ARCHIVE-TIMEOUT">archive_timeout</a>.</p><p>В отличие от приёмника WAL, работающего на ведомом сервере PostgreSQL, <span class="application">pg_receivewal</span> по умолчанию сохраняет на диск данные WAL, только когда файл WAL закрывается. Для сохранения данных WAL в реальном времени необходимо использовать ключ <code class="option">--synchronous</code>. Так как приёмник <span class="application">pg_receivewal</span> не применяет WAL, важно не допустить, чтобы он стал синхронным ведомым сервером, когда параметр <a class="xref" href="runtime-config-wal.html#GUC-SYNCHRONOUS-COMMIT">synchronous_commit</a> равен <code class="literal">remote_apply</code>. Если это произойдёт, он будет выглядеть как ведомый, который никогда не может нагнать ведущего, что приведёт к блокированию фиксации транзакций. Чтобы это предотвратить, нужно либо установить подходящее значение параметра <a class="xref" href="runtime-config-replication.html#GUC-SYNCHRONOUS-STANDBY-NAMES">synchronous_standby_names</a>, либо задать для <span class="application">pg_receivewal</span> такое имя приложения (<code class="varname">application_name</code>), которое не соответствует установленному имени, либо выбрать для <code class="varname">synchronous_commit</code> значение, отличное от <code class="literal">remote_apply</code>.</p><p>Журнал предзаписи передаётся через обычное подключение к <span class="productname">PostgreSQL</span>, с использованием протокола репликации. Подключение должен устанавливать пользователь с правом <code class="literal">REPLICATION</code> (см. <a class="xref" href="role-attributes.html" title="22.2. Атрибуты ролей">Раздел 22.2</a>) или суперпользователь, а в <code class="filename">pg_hba.conf</code> должно разрешаться подключение для репликации. Кроме того, параметр <a class="xref" href="runtime-config-replication.html#GUC-MAX-WAL-SENDERS">max_wal_senders</a> на сервере должен быть достаточно большим, чтобы можно было создать ещё один сеанс для передачи потока.</p><p>Начальная точка передачи журнала предзаписи вычисляется при запуске <span class="application">pg_receivewal</span> так: </p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Сначала сканируется каталог, в который помещаются файлы сегментов WAL, в нём выбирается последний завершённый файл сегмента, и начальной точкой считается начало следующего файла сегмента WAL.</p></li><li class="listitem"><p>Если вычислить начальную точку предыдущим способом не удаётся и при этом используется слот репликации, выдаётся дополнительная команда <code class="command">READ_REPLICATION_SLOT</code> для получения значения <code class="literal">restart_lsn</code>, которое будет использоваться в качестве начальной точки. Этот вариант поддерживается только при потоковой передаче журналов предзаписи из <span class="productname">PostgreSQL</span> 15 и выше.</p></li><li class="listitem"><p>Если вычислить начальную точку предыдущим способом не удаётся, используется последняя позиция сохранённых данных в WAL, которую выдаёт команда <code class="literal">IDENTIFY_SYSTEM</code>.</p></li></ol></div><p>Если подключение разорвалось или его c самого начала не удаётся установить из-за некритической ошибки, <span class="application">pg_receivewal</span> будет бесконечно повторять попытки подключения и восстановит передачу, как только сможет. Чтобы отменить это поведение, воспользуйтесь параметром <code class="literal">-n</code>.</p><p>В отсутствие критических ошибок <span class="application">pg_receivewal</span> будет выполняться до прерывания сигналом <span class="systemitem">SIGINT</span> (<span class="keycap"><strong>Control</strong></span>+<span class="keycap"><strong>C</strong></span>) или <span class="systemitem">SIGTERM</span>.</p></div><div class="refsect1" id="id-1.9.4.16.6"><h2>Параметры</h2><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="option">-D <em class="replaceable"><code>каталог</code></em></code><br /></span><span class="term"><code class="option">--directory=<em class="replaceable"><code>каталог</code></em></code></span></dt><dd><p>Каталог, в который будут записываться данные.</p><p>Этот параметр является обязательным.</p></dd><dt><span class="term"><code class="option">-E <em class="replaceable"><code>lsn</code></em></code><br /></span><span class="term"><code class="option">--endpos=<em class="replaceable"><code>lsn</code></em></code></span></dt><dd><p>Автоматически прекратить репликацию и завершить работу с кодом выхода 0 (без ошибки) при достижении заданного LSN.</p><p>Если будет получена запись с LSN, равным заданному <em class="replaceable"><code>lsn</code></em>, она будет обработана.</p></dd><dt><span class="term"><code class="option">--if-not-exists</code></span></dt><dd><p>Не выдавать ошибку, когда указан параметр <code class="option">--create-slot</code> и слот с заданным именем уже существует.</p></dd><dt><span class="term"><code class="option">-n</code><br /></span><span class="term"><code class="option">--no-loop</code></span></dt><dd><p>Не повторять цикл при ошибках подключения, а сразу завершать работу, возвращая ошибку.</p></dd><dt><span class="term"><code class="option">--no-sync</code></span></dt><dd><p>С этим ключом <code class="command">pg_receivewal</code> не будет принудительно сбрасывать данные WAL на диск. Этот вариант быстрее, но при последующем сбое операционной системы сегменты WAL могут оказаться испорченными. Обычно этот ключ полезен при тестировании, но при создании архива WAL в производственной среде использовать его не следует.</p><p>Этот ключ несовместим с <code class="literal">--synchronous</code>.</p></dd><dt><span class="term"><code class="option">-s <em class="replaceable"><code>интервал</code></em></code><br /></span><span class="term"><code class="option">--status-interval=<em class="replaceable"><code>интервал</code></em></code></span></dt><dd><p>Указывает интервал в секундах между отправками серверу пакетов состояния. Это позволяет упростить мониторинг прогресса. Чтобы выключить периодическое обновление состояния, необходимо установить значение в ноль. При этом обновление будет отправляться по запросу сервера для избежания отсоединения по истечению времени. Значение по умолчанию составляет 10 секунд.</p></dd><dt><span class="term"><code class="option">-S <em class="replaceable"><code>имя_слота</code></em></code><br /></span><span class="term"><code class="option">--slot=<em class="replaceable"><code>имя_слота</code></em></code></span></dt><dd><p>Указывает <span class="application">pg_receivewal</span> использовать существующий слот репликации (см. <a class="xref" href="warm-standby.html#STREAMING-REPLICATION-SLOTS" title="27.2.6. Слоты репликации">Подраздел 27.2.6</a>). Когда задан этот параметр, <span class="application">pg_receivewal</span> будет сообщать серверу текущую позицию сохранения, отмечая, какой сегмент был сохранён на диске, чтобы сервер мог удалить этот сегмент, если он больше не нужен.</p><p>Когда клиент репликации <span class="application">pg_receivewal</span> настроен на сервере как синхронный ведомый сервер, для используемого слота репликации серверу будет передаваться позиция сохранённых данных, но только когда файл WAL закрывается. Таким образом, в такой конфигурации транзакции на ведущем сервере будут ожидать завершения продолжительное время и по сути будут работать неудовлетворительно. Чтобы эта конфигурация работала корректно, нужно дополнительно указать параметр <code class="literal">--synchronous</code> (см. ниже).</p></dd><dt><span class="term"><code class="option">--synchronous</code></span></dt><dd><p>Сохранять данные WAL на диск сразу после того, как они были получены. Также передавать пакет состояния сразу после сохранения, вне зависимости от <code class="literal">--status-interval</code>.</p><p>Этот параметр следует указывать, если клиент репликации <span class="application">pg_receivewal</span> настроен на сервере как синхронный ведомый, чтобы обеспечить своевременную передачу ответа серверу.</p></dd><dt><span class="term"><code class="option">-v</code><br /></span><span class="term"><code class="option">--verbose</code></span></dt><dd><p>Включает режим подробных сообщений.</p></dd><dt><span class="term"><code class="option">-Z <em class="replaceable"><code>уровень</code></em></code><br /></span><span class="term"><code class="option">-Z <em class="replaceable"><code>метод</code></em>[:<em class="replaceable"><code>дополнительная_информация</code></em>]</code><br /></span><span class="term"><code class="option">--compress=<em class="replaceable"><code>уровень</code></em></code><br /></span><span class="term"><code class="option">--compress=<em class="replaceable"><code>метод</code></em>[:<em class="replaceable"><code>дополнительная_информация</code></em>]</code></span></dt><dd><p>Включает сжатие журналов предзаписи.</p><p>В качестве метода сжатия можно выбрать <code class="literal">gzip</code>, <code class="literal">lz4</code> (если <span class="productname">PostgreSQL</span> скомпилирован с параметром <code class="option">--with-lz4</code>) или <code class="literal">none</code> (без сжатия). В качестве дополнительной информации можно передать параметры сжатия. Если в строке информации передаётся целое число, оно задаёт уровень сжатия. В противном случае она должна содержать список элементов, разделённых запятыми, в форме <em class="replaceable"><code>ключевое_слово</code></em> или <em class="replaceable"><code>ключевое_слово=значение</code></em>. На данный момент поддерживаются только ключевое слово <code class="literal">level</code>.</p><p>Если уровень сжатия не указан, будет выбран уровень сжатия по умолчанию. Если указан только уровень сжатия, но не указан метод, будет применяться метод сжатия <code class="literal">gzip</code>, когда уровень больше 0, а когда уровень равен 0, сжатие не будет выполняться.</p><p>Когда используется метод <code class="literal">gzip</code>, ко всем именам файлов автоматически добавляется суффикс <code class="filename">.gz</code>, а когда <code class="literal">lz4</code> — суффикс <code class="filename">.lz4</code>.</p></dd></dl></div><p>Далее описаны параметры управления подключением. </p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="option">-d <em class="replaceable"><code>строка_подключения</code></em></code><br /></span><span class="term"><code class="option">--dbname=<em class="replaceable"><code>строка_подключения</code></em></code></span></dt><dd><p>Указывает параметры подключения к серверу в формате <a class="link" href="libpq-connect.html#LIBPQ-CONNSTRING" title="34.1.1. Строки параметров подключения">строки подключения</a>; они будут переопределять любые одноимённые параметры, заданные в командной строке.</p><p>Параметр называется <code class="literal">--dbname</code> для согласованности с другими клиентскими приложениями, но так как <span class="application">pg_receivewal</span> не подключается к какой-либо конкретной базе, это имя в строке подключения игнорируется.</p></dd><dt><span class="term"><code class="option">-h <em class="replaceable"><code>сервер</code></em></code><br /></span><span class="term"><code class="option">--host=<em class="replaceable"><code>сервер</code></em></code></span></dt><dd><p>Указывает имя компьютера, на котором работает сервер. Если значение начинается с косой черты, оно определяет каталог Unix-сокета. Значение по умолчанию берётся из переменной окружения <code class="envar">PGHOST</code>, если она установлена. В противном случае выполняется подключение к Unix-сокету.</p></dd><dt><span class="term"><code class="option">-p <em class="replaceable"><code>порт</code></em></code><br /></span><span class="term"><code class="option">--port=<em class="replaceable"><code>порт</code></em></code></span></dt><dd><p>Указывает TCP-порт или расширение файла локального Unix-сокета, через который сервер принимает подключения. Значение по умолчанию определяется переменной окружения <code class="envar">PGPORT</code>, если она установлена, либо числом, заданным при компиляции.</p></dd><dt><span class="term"><code class="option">-U <em class="replaceable"><code>имя_пользователя</code></em></code><br /></span><span class="term"><code class="option">--username=<em class="replaceable"><code>имя_пользователя</code></em></code></span></dt><dd><p>Имя пользователя для подключения.</p></dd><dt><span class="term"><code class="option">-w</code><br /></span><span class="term"><code class="option">--no-password</code></span></dt><dd><p>Не выдавать запрос на ввод пароля. Если сервер требует аутентификацию по паролю и пароль не доступен с помощью других средств, таких как файл <code class="filename">.pgpass</code>, попытка соединения не удастся. Этот параметр может быть полезен в пакетных заданиях и скриптах, где нет пользователя, который вводит пароль.</p></dd><dt><span class="term"><code class="option">-W</code><br /></span><span class="term"><code class="option">--password</code></span></dt><dd><p>Принудительно запрашивать пароль перед подключением к базе данных.</p><p>Это несущественный параметр, так как <span class="application">pg_receivewal</span> запрашивает пароль автоматически, если сервер проверяет подлинность по паролю. Однако чтобы понять это, <span class="application">pg_receivewal</span> лишний раз подключается к серверу. Поэтому иногда имеет смысл ввести <code class="option">-W</code>, чтобы исключить эту ненужную попытку подключения.</p></dd></dl></div><p><span class="application">pg_receivewal</span> может выполнить одно из двух действий в отношении слотов физической репликации: </p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="option">--create-slot</code></span></dt><dd><p>Создать слот физической репликации с именем, заданным аргументом <code class="option">--slot</code>, и завершиться.</p></dd><dt><span class="term"><code class="option">--drop-slot</code></span></dt><dd><p>Удалить слот репликации с именем, заданным аргументом <code class="option">--slot</code>, и завершиться.</p></dd></dl></div><p>Другие флаги: </p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="option">-V</code><br /></span><span class="term"><code class="option">--version</code></span></dt><dd><p>Сообщить версию <span class="application">pg_receivewal</span> и завершиться.</p></dd><dt><span class="term"><code class="option">-?</code><br /></span><span class="term"><code class="option">--help</code></span></dt><dd><p>Вывести справку по аргументам командной строки <span class="application">pg_receivewal</span> и завершиться.</p></dd></dl></div></div><div class="refsect1" id="id-1.9.4.16.7"><h2>Код завершения</h2><p><span class="application">pg_receivewal</span> завершится с кодом 0 при прерывании сигналом <span class="systemitem">SIGINT</span> или <span class="systemitem">SIGTERM</span>. (Это штатный способ его завершения, поэтому получение этого сигнала не считается ошибкой.) При критических ошибках или получении других сигналов код завершения будет ненулевым.</p></div><div class="refsect1" id="id-1.9.4.16.8"><h2>Переменные окружения</h2><p>Эта утилита, как и большинство других утилит <span class="productname">PostgreSQL</span>, использует переменные среды, поддерживаемые <span class="application">libpq</span> (см. <a class="xref" href="libpq-envars.html" title="34.15. Переменные окружения">Раздел 34.15</a>).</p><p>Переменная окружения <code class="envar">PG_COLOR</code> выбирает вариант использования цвета в диагностических сообщениях. Возможные значения: <code class="literal">always</code> (всегда), <code class="literal">auto</code> (автоматически) и <code class="literal">never</code> (никогда).</p></div><div class="refsect1" id="id-1.9.4.16.9"><h2>Замечания</h2><p>Применяя <span class="application">pg_receivewal</span> вместо <a class="xref" href="runtime-config-wal.html#GUC-ARCHIVE-COMMAND">archive_command</a> или <a class="xref" href="runtime-config-wal.html#GUC-ARCHIVE-LIBRARY">archive_library</a> в качестве основного способа резервного копирования WAL, настоятельно рекомендуется использовать слоты репликации. В противном случае сервер вполне может переписать или удалить файлы журнала предзаписи, прежде чем они будут скопированы, так как он не получает никакой информации, через <a class="xref" href="runtime-config-wal.html#GUC-ARCHIVE-COMMAND">archive_command</a>/<a class="xref" href="runtime-config-wal.html#GUC-ARCHIVE-LIBRARY">archive_library</a> или слоты репликации, о том, как проходит архивация потока WAL. Учтите, однако, что при использовании слота репликации может заполниться всё место на диске, если принимающая сторона не будет успевать принимать данные WAL.</p><p><span class="application">pg_receivewal</span> сохранит разрешения для группы в полученных файлах WAL, если такие разрешения установлены в исходном кластере.</p></div><div class="refsect1" id="id-1.9.4.16.10"><h2>Примеры</h2><p>Следующая команда принимает журнал предзаписи с сервера <code class="literal">mydbserver</code> и сохраняет его в локальном каталоге <code class="filename">/usr/local/pgsql/archive</code>: </p><pre class="screen">
<code class="prompt">$</code> <strong class="userinput"><code>pg_receivewal -h mydbserver -D /usr/local/pgsql/archive</code></strong>
</pre></div><div class="refsect1" id="id-1.9.4.16.11"><h2>См. также</h2><span class="simplelist"><a class="xref" href="app-pgbasebackup.html" title="pg_basebackup"><span class="refentrytitle"><span class="application">pg_basebackup</span></span></a></span></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="app-pg-isready.html" title="pg_isready">Пред.</a> </td><td width="20%" align="center"><a accesskey="u" href="reference-client.html" title="Клиентские приложения PostgreSQL">Наверх</a></td><td width="40%" align="right"> <a accesskey="n" href="app-pgrecvlogical.html" title="pg_recvlogical">След.</a></td></tr><tr><td width="40%" align="left" valign="top"><span class="application">pg_isready</span> </td><td width="20%" align="center"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="40%" align="right" valign="top"> <span class="application">pg_recvlogical</span></td></tr></table></div></body></html>