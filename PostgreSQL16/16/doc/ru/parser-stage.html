<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>52.3. Этап разбора</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@lists.postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets Vsnapshot" /><link rel="prev" href="connect-estab.html" title="52.2. Как устанавливаются соединения" /><link rel="next" href="rule-system.html" title="52.4. Система правил PostgreSQL" /></head><body id="docContent" class="container-fluid col-10"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="5" align="center">52.3. Этап разбора</th></tr><tr><td width="10%" align="left"><a accesskey="p" href="connect-estab.html" title="52.2. Как устанавливаются соединения">Пред.</a> </td><td width="10%" align="left"><a accesskey="u" href="overview.html" title="Глава 52. Обзор внутреннего устройства PostgreSQL">Наверх</a></td><th width="60%" align="center">Глава 52. Обзор внутреннего устройства PostgreSQL</th><td width="10%" align="right"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="10%" align="right"> <a accesskey="n" href="rule-system.html" title="52.4. Система правил PostgreSQL">След.</a></td></tr></table><hr /></div><div class="sect1" id="PARSER-STAGE"><div class="titlepage"><div><div><h2 class="title" style="clear: both">52.3. Этап разбора <a href="#PARSER-STAGE" class="id_link">#</a></h2></div></div></div><div class="toc"><dl class="toc"><dt><span class="sect2"><a href="parser-stage.html#PARSER-STAGE-PARSER">52.3.1. Разбор</a></span></dt><dt><span class="sect2"><a href="parser-stage.html#PARSER-STAGE-TRANSFORMATION-PROCESS">52.3.2. Преобразование</a></span></dt></dl></div><p><em class="firstterm">Этап разбора</em> разделяется на две части: </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><em class="firstterm">Разбор</em>, алгоритм которого описан в <code class="filename">gram.y</code> и <code class="filename">scan.l</code>, а программный код генерируется инструментами Unix <span class="application">bison</span> и <span class="application">flex</span>.</p></li><li class="listitem"><p><em class="firstterm">Преобразование</em>, в процессе которого модифицируются и дополняются структуры данных, полученные после разбора запроса.</p></li></ul></div><div class="sect2" id="PARSER-STAGE-PARSER"><div class="titlepage"><div><div><h3 class="title">52.3.1. Разбор <a href="#PARSER-STAGE-PARSER" class="id_link">#</a></h3></div></div></div><p>При разборе проверяется сначала синтаксис строки запроса (поступающей в виде неструктурированного текста). Если он правильный, строится <em class="firstterm">дерево запроса</em> и передаётся дальше, в противном случае возвращается ошибка. Лексический и синтаксический анализ реализован с применением хорошо известных средств Unix <span class="application">bison</span> и <span class="application">flex</span>.</p><p><em class="firstterm">Лексическая структура</em> определяется в файле <code class="filename">scan.l</code> и описывает <em class="firstterm">идентификаторы</em>, <em class="firstterm">ключевые слова SQL</em> и т. д. Для каждого найденного ключевого слова или идентификатора генерируется <em class="firstterm">символ языка</em>, который затем передаётся синтаксическому анализатору.</p><p>Синтаксис языка определён в файле <code class="filename">gram.y</code> в виде набора <em class="firstterm">грамматических правил</em> и <em class="firstterm">действий</em>, которые должны выполняться при срабатывании правил. Для построения дерева разбора используется код действий (это действительно код на C).</p><p>Файл <code class="filename">scan.l</code> преобразуется в программу на C <code class="filename">scan.c</code> с помощью <span class="application">flex</span>, а <code class="filename">gram.y</code> — в <code class="filename">gram.c</code> с помощью <span class="application">bison</span>. После этих преобразований исполняемый код анализатора создаётся обычным компилятором C. Никогда не вносите коррективы в сгенерированные файлы C, так как они будут перезаписаны при следующем вызове <span class="application">flex</span> или <span class="application">bison</span>. </p><div class="note"><h3 class="title">Примечание</h3><p>Упомянутые преобразования и компиляция обычно производятся автоматически сборочными файлами <em class="firstterm">Makefile</em>, поставляемыми в составе дистрибутива <span class="productname">PostgreSQL</span>.</p></div><p>Подробное описание <span class="application">bison</span> и грамматических правил в <code class="filename">gram.y</code> выходит за рамки данной главы. Узнать больше о <span class="application">flex</span> и <span class="application">bison</span> можно из книг и документации. Изучение грамматики, описанной в <code class="filename">gram.y</code>, следует начать со знакомства с <span class="application">bison</span>, иначе будет трудно понять, что там происходит.</p></div><div class="sect2" id="PARSER-STAGE-TRANSFORMATION-PROCESS"><div class="titlepage"><div><div><h3 class="title">52.3.2. Преобразование <a href="#PARSER-STAGE-TRANSFORMATION-PROCESS" class="id_link">#</a></h3></div></div></div><p>На этой стадии дерево разбора создаётся только с фиксированными знаниями о синтаксической структуре SQL. При его создании не просматриваются системные каталоги, что не даёт возможность понять конкретную семантику запрошенной операции. После этого выполняется <em class="firstterm">процедура преобразования</em>, которая принимает дерево разбора от анализатора и выполняет семантический анализ, необходимый для понимания, к каким именно таблицам, функциям и операторам обращается запрос. Структура данных, которая создаётся для представления этой информации, называется <em class="firstterm">деревом запроса</em>.</p><p>Синтаксический разбор отделён от семантического анализа, потому что обращаться к системным каталогам можно только внутри транзакции, а начинать транзакцию сразу после получения строки с запросом нежелательно. Синтаксического разбора достаточно, чтобы распознать команды управления транзакциями (<code class="command">BEGIN</code>, <code class="command">ROLLBACK</code> и т. д.), поэтому их можно выполнить без дальнейшего анализа. Убедившись, что мы имеем дело с собственно запросом (например, <code class="command">SELECT</code> или <code class="command">UPDATE</code>), можно начинать транзакцию, если она ещё не начата. Только после этого можно переходить к процедуре преобразования.</p><p>Дерево запроса, создаваемое процедурой преобразования, по структуре во многом похоже на дерево разбора, но отличается во многих деталях. Например, узел <code class="structname">FuncCall</code> в дереве разбора представляет то, что по синтаксису похоже на вызов функции. Этот узел может быть преобразован в узел <code class="structname">FuncExpr</code> или <code class="structname">Aggref</code> в зависимости от того, какой (обычной или агрегатной) окажется функция с заданным именем. Кроме того, в дерево запроса добавляется информация о фактических типах данных столбцов и результатов выражений.</p></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="connect-estab.html" title="52.2. Как устанавливаются соединения">Пред.</a> </td><td width="20%" align="center"><a accesskey="u" href="overview.html" title="Глава 52. Обзор внутреннего устройства PostgreSQL">Наверх</a></td><td width="40%" align="right"> <a accesskey="n" href="rule-system.html" title="52.4. Система правил PostgreSQL">След.</a></td></tr><tr><td width="40%" align="left" valign="top">52.2. Как устанавливаются соединения </td><td width="20%" align="center"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="40%" align="right" valign="top"> 52.4. Система правил <span class="productname">PostgreSQL</span></td></tr></table></div></body></html>