<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>pg_amcheck</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@lists.postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets Vsnapshot" /><link rel="prev" href="app-ecpg.html" title="ecpg" /><link rel="next" href="app-pgbasebackup.html" title="pg_basebackup" /></head><body id="docContent" class="container-fluid col-10"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="5" align="center"><span class="application">pg_amcheck</span></th></tr><tr><td width="10%" align="left"><a accesskey="p" href="app-ecpg.html" title="ecpg">Пред.</a> </td><td width="10%" align="left"><a accesskey="u" href="reference-client.html" title="Клиентские приложения PostgreSQL">Наверх</a></td><th width="60%" align="center">Клиентские приложения PostgreSQL</th><td width="10%" align="right"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="10%" align="right"> <a accesskey="n" href="app-pgbasebackup.html" title="pg_basebackup">След.</a></td></tr></table><hr /></div><div class="refentry" id="APP-PGAMCHECK"><div class="titlepage"></div><a id="id-1.9.4.9.1" class="indexterm"></a><div class="refnamediv"><h2><span class="refentrytitle"><span class="application">pg_amcheck</span></span></h2><p>pg_amcheck — проверить одну или несколько БД <span class="productname">PostgreSQL</span> на предмет повреждения</p></div><div class="refsynopsisdiv"><h2>Синтаксис</h2><div class="cmdsynopsis"><p id="id-1.9.4.9.4.1"><code class="command">pg_amcheck</code> [<em class="replaceable"><code>параметр</code></em>...] [<em class="replaceable"><code>имя_бд</code></em>]</p></div></div><div class="refsect1" id="id-1.9.4.9.5"><h2>Описание</h2><p>Программа <span class="application">pg_amcheck</span> поддерживает запуск реализованных в расширении <a class="xref" href="amcheck.html" title="F.2. amcheck — модуль с инструментами, проверяющими целостность таблиц и индексов">amcheck</a> функций, выявляющих повреждения, в одной или нескольких базах данных, с возможностью выбора проверяемых индексов, таблиц и схем. Она также позволяет выбрать, какие проверки будут выполняться, и запустить их в параллельном режиме (для которого задаётся число параллельных подключений).</p><p>В настоящее время поддерживаются только обычные табличные отношения, таблицы TOAST, материализованные представления, последовательности и индексы btree. Другие типы отношений просто пропускаются.</p><p>Если задаётся <code class="literal">имя_бд</code>, это должно быть имя одной проверяемой базы данных, а никакие другие параметры выбора базы данных задаваться не должны. Если же, напротив, присутствуют параметры выбора баз данных, будут проверяться все соответствующие базы. В отсутствие этих параметров проверяться будет только база по умолчанию. Параметрами, выбирающими базы, являются <code class="option">--all</code>, <code class="option">--database</code> и <code class="option">--exclude-database</code>. Также в их число можно включить <code class="option">--relation</code>, <code class="option">--exclude-relation</code>, <code class="option">--table</code>, <code class="option">--exclude-table</code>, <code class="option">--index</code> и <code class="option">--exclude-index</code>, но только если их значения задаются тремя компонентами (например, <code class="option">mydb*.myschema*.myrel*</code>). И наконец, к таким параметрам можно отнести <code class="option">--schema</code> и <code class="option">--exclude-schema</code>, если их значения задаются двумя компонентами (например, <code class="option">mydb*.myschema*</code>).</p><p>В качестве параметра <em class="replaceable"><code>имя_бд</code></em> может также передаваться <a class="link" href="libpq-connect.html#LIBPQ-CONNSTRING" title="34.1.1. Строки параметров подключения">строка подключения</a>.</p></div><div class="refsect1" id="id-1.9.4.9.6"><h2>Параметры</h2><p>Следующие параметры командной строки определяют, что будет проверяться: </p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="option">-a</code><br /></span><span class="term"><code class="option">--all</code></span></dt><dd><p>Проверить все базы данных (кроме исключённых аргументом <code class="option">--exclude-database</code>).</p></dd><dt><span class="term"><code class="option">-d <em class="replaceable"><code>шаблон</code></em></code><br /></span><span class="term"><code class="option">--database=<em class="replaceable"><code>шаблон</code></em></code></span></dt><dd><p>Проверить базы данных, соответствующие заданному <a class="link" href="app-psql.html#APP-PSQL-PATTERNS" title="Шаблоны поиска"><em class="replaceable"><code>шаблону</code></em></a>, кроме исключённых аргументом <code class="option">--exclude-database</code>. Этот параметр можно добавлять неоднократно.</p></dd><dt><span class="term"><code class="option">-D <em class="replaceable"><code>шаблон</code></em></code><br /></span><span class="term"><code class="option">--exclude-database=<em class="replaceable"><code>шаблон</code></em></code></span></dt><dd><p>Исключить базы данных, соответствующие заданному <a class="link" href="app-psql.html#APP-PSQL-PATTERNS" title="Шаблоны поиска"><em class="replaceable"><code>шаблону</code></em></a>. Этот параметр можно добавлять неоднократно.</p></dd><dt><span class="term"><code class="option">-i <em class="replaceable"><code>шаблон</code></em></code><br /></span><span class="term"><code class="option">--index=<em class="replaceable"><code>шаблон</code></em></code></span></dt><dd><p>Проверить индексы, соответствующие заданному <a class="link" href="app-psql.html#APP-PSQL-PATTERNS" title="Шаблоны поиска"><em class="replaceable"><code>шаблону</code></em></a>, если они не исключены каким-либо образом. Этот параметр можно добавлять неоднократно.</p><p>Этот параметр подобен параметру <code class="option">--relation</code>, но применяется только к индексам, а не к другим типам отношений.</p></dd><dt><span class="term"><code class="option">-I <em class="replaceable"><code>шаблон</code></em></code><br /></span><span class="term"><code class="option">--exclude-index=<em class="replaceable"><code>шаблон</code></em></code></span></dt><dd><p>Исключить индексы, соответствующие заданному <a class="link" href="app-psql.html#APP-PSQL-PATTERNS" title="Шаблоны поиска"><em class="replaceable"><code>шаблону</code></em></a>. Этот параметр можно добавлять неоднократно.</p><p>Этот параметр подобен параметру <code class="option">--exclude-relation</code>, но применяется только к индексам, а не к другим типам отношений.</p></dd><dt><span class="term"><code class="option">-r <em class="replaceable"><code>шаблон</code></em></code><br /></span><span class="term"><code class="option">--relation=<em class="replaceable"><code>шаблон</code></em></code></span></dt><dd><p>Проверить отношения, соответствующие заданному <a class="link" href="app-psql.html#APP-PSQL-PATTERNS" title="Шаблоны поиска"><em class="replaceable"><code>шаблону</code></em></a>, если они не исключены каким-либо образом. Этот параметр можно добавлять неоднократно.</p><p>Шаблоны могут быть неполными, например <code class="literal">myrel*</code>, либо они могут задаваться с указанием схемы, например <code class="literal">myschema*.myrel*</code>, а также с указанием базы и схемы, например <code class="literal">mydb*.myschema*.myrel*</code>. В случае указания шаблона с базой данных, все соответствующие базы будут добавлены в список баз, подлежащих проверке.</p></dd><dt><span class="term"><code class="option">-R <em class="replaceable"><code>шаблон</code></em></code><br /></span><span class="term"><code class="option">--exclude-relation=<em class="replaceable"><code>шаблон</code></em></code></span></dt><dd><p>Исключить отношения, соответствующие заданному <a class="link" href="app-psql.html#APP-PSQL-PATTERNS" title="Шаблоны поиска"><em class="replaceable"><code>шаблону</code></em></a>. Этот параметр можно добавлять неоднократно.</p><p>Как и с <code class="option">--relation</code>, <a class="link" href="app-psql.html#APP-PSQL-PATTERNS" title="Шаблоны поиска"><em class="replaceable"><code>шаблон</code></em></a> может быть неполным или дополненным указанием схемы, а также указанием базы и схемы.</p></dd><dt><span class="term"><code class="option">-s <em class="replaceable"><code>шаблон</code></em></code><br /></span><span class="term"><code class="option">--schema=<em class="replaceable"><code>шаблон</code></em></code></span></dt><dd><p>Проверить таблицы и индексы в схемах, соответствующих заданному <a class="link" href="app-psql.html#APP-PSQL-PATTERNS" title="Шаблоны поиска"><em class="replaceable"><code>шаблону</code></em></a>, если соответствующие объекты не исключены каким-либо образом. Этот параметр можно добавлять неоднократно.</p><p>Чтобы проверить только таблицы в схемах, соответствующих определённому шаблону, можно указать в параметрах <code class="literal">--table=ШАБЛОН_СХЕМЫ.* --no-dependent-indexes</code>. Чтобы выбрать только индексы, можно воспользоваться указанием <code class="literal">--index=ШАБЛОН_СХЕМЫ.*</code>.</p><p>Шаблон схемы может содержать указание базы. Например, вы можете написать <code class="literal">--schema=mydb*.myschema*</code>, чтобы выбрать схемы <code class="literal">myschema*</code> в базах данных, соответствующих шаблону <code class="literal">mydb*</code>.</p></dd><dt><span class="term"><code class="option">-S <em class="replaceable"><code>шаблон</code></em></code><br /></span><span class="term"><code class="option">--exclude-schema=<em class="replaceable"><code>шаблон</code></em></code></span></dt><dd><p>Исключить таблицы и индексы в схемах, соответствующих заданному <a class="link" href="app-psql.html#APP-PSQL-PATTERNS" title="Шаблоны поиска"><em class="replaceable"><code>шаблону</code></em></a>. Этот параметр можно добавлять неоднократно.</p><p>Как и в параметре <code class="option">--schema</code>, к шаблону можно добавить имя базы данных.</p></dd><dt><span class="term"><code class="option">-t <em class="replaceable"><code>шаблон</code></em></code><br /></span><span class="term"><code class="option">--table=<em class="replaceable"><code>шаблон</code></em></code></span></dt><dd><p>Проверить таблицы в схемах, соответствующих заданному <a class="link" href="app-psql.html#APP-PSQL-PATTERNS" title="Шаблоны поиска"><em class="replaceable"><code>шаблону</code></em></a>, если соответствующие объекты не исключены каким-либо образом. Этот параметр можно добавлять неоднократно.</p><p>Этот параметр подобен параметру <code class="option">--relation</code>, но применяется только к таблицам, материализованным представлениям и последовательностям, а не к индексам.</p></dd><dt><span class="term"><code class="option">-T <em class="replaceable"><code>шаблон</code></em></code><br /></span><span class="term"><code class="option">--exclude-table=<em class="replaceable"><code>шаблон</code></em></code></span></dt><dd><p>Исключить таблицы, соответствующие заданному <a class="link" href="app-psql.html#APP-PSQL-PATTERNS" title="Шаблоны поиска"><em class="replaceable"><code>шаблону</code></em></a>. Этот параметр можно добавлять неоднократно.</p><p>Этот параметр подобен параметру <code class="option">--exclude-relation</code>, но применяется только к таблицам, материализованным представлениям и последовательностям, а не к индексам.</p></dd><dt><span class="term"><code class="option">--no-dependent-indexes</code></span></dt><dd><p>По умолчанию, если проверяется таблица, также будут проверяться все индексы btree этой таблицы, даже если они не были явно выбраны ключами типа <code class="literal">--index</code> или <code class="literal">--relation</code>. Данный параметр отключает это поведение.</p></dd><dt><span class="term"><code class="option">--no-dependent-toast</code></span></dt><dd><p>По умолчанию, если проверяется таблица, также будет проверяться её TOAST-таблица (если таковая имеется), даже если она не была явно выбрана ключами типа <code class="literal">--table</code> или <code class="literal">--relation</code>. Данный параметр отключает это поведение.</p></dd><dt><span class="term"><code class="option">--no-strict-names</code></span></dt><dd><p>По умолчанию, если аргументу <code class="literal">--database</code>, <code class="literal">--table</code>, <code class="literal">--index</code> или <code class="literal">--relation</code> не соответствуют никакие объекты, это считается критической ошибкой. С данным параметром уровень ошибки понижается до предупреждения.</p></dd></dl></div><p>Следующие параметры командной строки управляют методами проверки таблиц: </p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="option">--exclude-toast-pointers</code></span></dt><dd><p>По умолчанию, когда в таблице встречается указатель на TOAST, осуществляется поиск записи в TOAST-таблице для проверки корректности указателя. Эти проверки могут быть довольно медленными, и данный параметр позволяет пропустить их.</p></dd><dt><span class="term"><code class="option">--on-error-stop</code></span></dt><dd><p>Прекращать обработку табличного отношения сразу после сообщения обо всех повреждениях на первой повреждённой странице и переходить к следующей таблице или индексу.</p><p>Заметьте, что проверка индекса всегда прекращается после обнаружения первой повреждённой страницы. Данный параметр имеет смысл только для табличных отношений.</p></dd><dt><span class="term"><code class="option">--skip=<em class="replaceable"><code>параметр</code></em></code></span></dt><dd><p>С указанием <code class="literal">all-frozen</code> проверки повреждений таблиц будут пропускать страницы, помеченные как полностью замороженные, во всех таблицах.</p><p>С указанием <code class="literal">all-visible</code> проверки повреждений таблиц будут пропускать страницы, помеченные как полностью видимые, во всех таблицах.</p><p>По умолчанию никакие страницы не пропускаются. Такое поведение задаётся значением <code class="literal">none</code>, но так как это значение подразумевается, явно задавать его не требуется.</p></dd><dt><span class="term"><code class="option">--startblock=<em class="replaceable"><code>блок</code></em></code></span></dt><dd><p>Начать проверку с блока с заданным номером. Если проверяемое табличное отношение содержит меньше заданного числа блоков, будет выдана ошибка. Данный параметр представляется полезным только для проверки одной конкретной таблицы, и он не действует на индексы. Дополнительные замечания приведены в описании <code class="literal">--endblock</code>.</p></dd><dt><span class="term"><code class="option">--endblock=<em class="replaceable"><code>блок</code></em></code></span></dt><dd><p>Завершить проверку на блоке с указанным номером. Если проверяемое табличное отношение содержит меньше заданного числа блоков, будет выдана ошибка. Данный параметр представляется полезным только для проверки одной конкретной таблицы, и он не действует на индексы. Если проверяется и обычная, и TOAST-таблица, этот параметр действует на обе, но при проверке TOAST-указателей тем не менее возможны обращения к блокам за этим пределом, если только эта проверка не была выключена параметром <code class="option">--exclude-toast-pointers</code>.</p></dd></dl></div><p>Следующие параметры командной строки управляют методами проверки индексов-B-деревьев: </p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="option">--heapallindexed</code></span></dt><dd><p>Проверять для каждого обрабатываемого индекса наличие всех кортежей кучи в виде индексных кортежей с использованием режима <code class="option">heapallindexed</code> проверки <a class="xref" href="amcheck.html" title="F.2. amcheck — модуль с инструментами, проверяющими целостность таблиц и индексов">amcheck</a>.</p></dd><dt><span class="term"><code class="option">--parent-check</code></span></dt><dd><p>Выполнять для каждого проверяемого индекса btree функцию <a class="xref" href="amcheck.html" title="F.2. amcheck — модуль с инструментами, проверяющими целостность таблиц и индексов">amcheck</a> <code class="function">bt_index_parent_check</code>, проводящую дополнительные проверки связей родитель-потомок.</p><p>По умолчанию выполняется функция <span class="application">amcheck</span> <code class="function">bt_index_check</code>, но заметьте, что в случае использования параметра <code class="option">--rootdescend</code> неявно выбирается функция <code class="function">bt_index_parent_check</code>.</p></dd><dt><span class="term"><code class="option">--rootdescend</code></span></dt><dd><p>При проверке каждого индекса для каждого кортежа заново находить индексные кортежи на уровне листьев, производя поиск с корневой страницы, то есть задействовать режим <a class="xref" href="amcheck.html" title="F.2. amcheck — модуль с инструментами, проверяющими целостность таблиц и индексов">amcheck</a> <code class="option">rootdescend</code>.</p><p>При использовании данного параметра также неявно включается параметр <code class="option">--parent-check</code>.</p><p>Этот режим проверки изначально реализовывался как средство, полезное при разработке функциональности индексов-B-деревьев. Он может обнаруживать не все или вовсе не обнаруживать те типы повреждений, которые встречаются на практике. Также в этом режиме проверка выполняется значительно дольше и для неё требуется больше серверных ресурсов.</p></dd></dl></div><div class="warning"><h3 class="title">Предупреждение</h3><p>Дополнительные проверки, выполняемые для индексов-B-деревьев, когда указан параметр <code class="option">--parent-check</code> или параметр <code class="option">--rootdescend</code>, требуют относительно сильных блокировок на уровне отношений. Только эти проверки блокируют одновременное изменение данных командами <code class="command">INSERT</code>, <code class="command">UPDATE</code> и <code class="command">DELETE</code>.</p></div><p>Следующие параметры командной строки управляют подключением к серверу: </p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="option">-h <em class="replaceable"><code>компьютер</code></em></code><br /></span><span class="term"><code class="option">--host=<em class="replaceable"><code>компьютер</code></em></code></span></dt><dd><p>Указывает имя компьютера, на котором работает сервер. Если значение начинается с косой черты, оно определяет каталог Unix-сокета.</p></dd><dt><span class="term"><code class="option">-p <em class="replaceable"><code>порт</code></em></code><br /></span><span class="term"><code class="option">--port=<em class="replaceable"><code>порт</code></em></code></span></dt><dd><p>Указывает TCP-порт или расширение файла локального Unix-сокета, через который сервер принимает подключения.</p></dd><dt><span class="term"><code class="option">-U</code><br /></span><span class="term"><code class="option">--username=<em class="replaceable"><code>имя_пользователя</code></em></code></span></dt><dd><p>Имя пользователя для подключения.</p></dd><dt><span class="term"><code class="option">-w</code><br /></span><span class="term"><code class="option">--no-password</code></span></dt><dd><p>Не выдавать запрос на ввод пароля. Если сервер требует аутентификацию по паролю и пароль не доступен с помощью других средств, таких как файл <code class="filename">.pgpass</code>, попытка соединения не удастся. Этот параметр может быть полезен в пакетных заданиях и скриптах, где нет пользователя, который вводит пароль.</p></dd><dt><span class="term"><code class="option">-W</code><br /></span><span class="term"><code class="option">--password</code></span></dt><dd><p>Принудительно запрашивать пароль перед подключением к базе данных.</p><p>Это несущественный параметр, так как <span class="application">pg_amcheck</span> запрашивает пароль автоматически, если сервер проверяет подлинность по паролю. Однако чтобы понять это, <span class="application">pg_amcheck</span> лишний раз подключается к серверу. Поэтому иногда имеет смысл ввести <code class="option">-W</code>, чтобы исключить эту ненужную попытку подключения.</p></dd><dt><span class="term"><code class="option">--maintenance-db=<em class="replaceable"><code>имя_бд</code></em></code></span></dt><dd><p>Задаёт базу данных или <a class="link" href="libpq-connect.html#LIBPQ-CONNSTRING" title="34.1.1. Строки параметров подключения">строку подключения</a> для установления подключения, через которое будет определяться список баз данных для проверки. Если не используются ни ключ <code class="option">--all</code>, ни параметры, задающие шаблон имён проверяемых баз данных, такое подключение не требуется и данный параметр игнорируется. Иначе все параметры из переданной строки, за исключением имени базы данных, будут также использоваться при подключении к проверяемым базам. Если этот параметр опущен, выполняется подключение к базе <code class="literal">postgres</code>, а если к ней подключиться не удаётся — к базе <code class="literal">template1</code>.</p></dd></dl></div><p>Другие параметры: </p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="option">-e</code><br /></span><span class="term"><code class="option">--echo</code></span></dt><dd><p>Выводить в stdout все SQL-запросы, передаваемые серверу.</p></dd><dt><span class="term"><code class="option">-j <em class="replaceable"><code>число</code></em></code><br /></span><span class="term"><code class="option">--jobs=<em class="replaceable"><code>число</code></em></code></span></dt><dd><p>Использовать заданное <em class="replaceable"><code>число</code></em> одновременных подключений к серверу, а если оно превышает количество объектов, число подключений ограничивается этим количеством.</p><p>По умолчанию используется одно подключение.</p></dd><dt><span class="term"><code class="option">-P</code><br /></span><span class="term"><code class="option">--progress</code></span></dt><dd><p>Выводить информацию о прогрессе операции. Выводимая информация включает количество отношений, для которых была проведена проверка, и общий размер этих отношений. В неё также включается общее количество отношений, которые должны быть проверены, и примерный размер этих отношений.</p></dd><dt><span class="term"><code class="option">-v</code><br /></span><span class="term"><code class="option">--verbose</code></span></dt><dd><p>Выводить больше сообщений. В частности, будут выводиться сообщения о проверке каждого отношения, а также увеличится уровень детализации ошибок сервера.</p></dd><dt><span class="term"><code class="option">-V</code><br /></span><span class="term"><code class="option">--version</code></span></dt><dd><p>Вывести версию <span class="application">pg_amcheck</span> и завершиться.</p></dd><dt><span class="term"><code class="option">--install-missing</code><br /></span><span class="term"><code class="option">--install-missing=<em class="replaceable"><code>схема</code></em></code></span></dt><dd><p>Установить все отсутствующие расширения, которые требуются для проверки баз(ы) данных. Если это расширение не было установлено, его объекты будут помещены в заданную <em class="replaceable"><code>схему</code></em> или, если она не задана, в схему <code class="literal">pg_catalog</code>.</p><p>В настоящее время для работы <span class="application">pg_amcheck</span> требуется только расширение <a class="xref" href="amcheck.html" title="F.2. amcheck — модуль с инструментами, проверяющими целостность таблиц и индексов">amcheck</a>.</p></dd><dt><span class="term"><code class="option">-?</code><br /></span><span class="term"><code class="option">--help</code></span></dt><dd><p>Вывести справку об аргументах командной строки <span class="application">pg_amcheck</span> и завершиться.</p></dd></dl></div></div><div class="refsect1" id="id-1.9.4.9.7"><h2>Замечания</h2><p>Программа <span class="application">pg_amcheck</span> предназначена для работы с <span class="productname">PostgreSQL</span> 14.0 и выше.</p></div><div class="refsect1" id="id-1.9.4.9.8"><h2>См. также</h2><span class="simplelist"><a class="xref" href="amcheck.html" title="F.2. amcheck — модуль с инструментами, проверяющими целостность таблиц и индексов">amcheck</a></span></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="app-ecpg.html" title="ecpg">Пред.</a> </td><td width="20%" align="center"><a accesskey="u" href="reference-client.html" title="Клиентские приложения PostgreSQL">Наверх</a></td><td width="40%" align="right"> <a accesskey="n" href="app-pgbasebackup.html" title="pg_basebackup">След.</a></td></tr><tr><td width="40%" align="left" valign="top"><span class="application">ecpg</span> </td><td width="20%" align="center"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="40%" align="right" valign="top"> <span class="application">pg_basebackup</span></td></tr></table></div></body></html>