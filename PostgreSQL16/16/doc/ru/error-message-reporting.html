<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>56.2. Вывод сообщений об ошибках в коде сервера</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@lists.postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets Vsnapshot" /><link rel="prev" href="source-format.html" title="56.1. Форматирование" /><link rel="next" href="error-style-guide.html" title="56.3. Руководство по стилю сообщений об ошибках" /></head><body id="docContent" class="container-fluid col-10"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="5" align="center">56.2. Вывод сообщений об ошибках в коде сервера</th></tr><tr><td width="10%" align="left"><a accesskey="p" href="source-format.html" title="56.1. Форматирование">Пред.</a> </td><td width="10%" align="left"><a accesskey="u" href="source.html" title="Глава 56. Соглашения по оформлению кода PostgreSQL">Наверх</a></td><th width="60%" align="center">Глава 56. Соглашения по оформлению кода PostgreSQL</th><td width="10%" align="right"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="10%" align="right"> <a accesskey="n" href="error-style-guide.html" title="56.3. Руководство по стилю сообщений об ошибках">След.</a></td></tr></table><hr /></div><div class="sect1" id="ERROR-MESSAGE-REPORTING"><div class="titlepage"><div><div><h2 class="title" style="clear: both">56.2. Вывод сообщений об ошибках в коде сервера <a href="#ERROR-MESSAGE-REPORTING" class="id_link">#</a></h2></div></div></div><a id="id-1.10.7.3.2" class="indexterm"></a><a id="id-1.10.7.3.3" class="indexterm"></a><p>Сообщения об ошибках, предупреждения и обычные сообщения, выдаваемые в коде сервера должны создаваться функцией <code class="function">ereport</code> или родственной её предшественницей <code class="function">elog</code>. Использование этой функции достаточно сложно и требует дополнительного объяснения.</p><p>У каждого сообщения есть два обязательных элемента: уровень важности (от <code class="literal">DEBUG</code> до <code class="literal">PANIC</code>) и основной текст сообщения. В дополнение к ним есть необязательные элементы, из которых часто используется код идентификатора ошибки, соответствующий определению SQLSTATE в спецификации SQL. Макрос <code class="function">ereport</code> сам по себе является просто оболочкой, которая существует в основном для синтаксического удобства, чтобы выдача сообщения выглядела как вызов одной функции в коде C. Единственный параметр, который принимает непосредственно <code class="function">ereport</code>, — это уровень важности. Основной текст и любые дополнительные элементы сообщения генерируются в вызове <code class="function">ereport</code> в результате использования вспомогательных функций, таких как <code class="function">errmsg</code>.</p><p>Типичный вызов <code class="function">ereport</code> выглядит примерно так: </p><pre class="programlisting">ereport(ERROR,
        errcode(ERRCODE_DIVISION_BY_ZERO),
        errmsg("division by zero"));</pre><p> В нём задаётся уровень важности <code class="literal">ERROR</code> (заурядная ошибка). В вызове <code class="function">errcode</code> указывается код ошибки SQLSTATE по макросу, определённому в <code class="filename">src/include/utils/errcodes.h</code>. Вызов <code class="function">errmsg</code> даёт текст основного сообщения.</p><p>Вы часто также будете встречать вызовы в старом стиле, с дополнительными скобками, обрамляющими вызовы вспомогательных функций: </p><pre class="programlisting">ereport(ERROR,
        (errcode(ERRCODE_DIVISION_BY_ZERO),
         errmsg("division by zero")));</pre><p> Эти дополнительные скобки были обязательными до <span class="productname">PostgreSQL</span> версии 12, но сейчас они не требуются.</p><p>Более сложный пример: </p><pre class="programlisting">ereport(ERROR,
        errcode(ERRCODE_AMBIGUOUS_FUNCTION),
        errmsg("function %s is not unique",
               func_signature_string(funcname, nargs,
                                     NIL, actual_arg_types)),
        errhint("Unable to choose a best candidate function. "
                "You might need to add explicit typecasts."));</pre><p> В нём демонстрируется использование кодов форматирования для включения значений времени выполнения в текст сообщения. Также в нём добавляется дополнительное сообщение <span class="quote">«<span class="quote">подсказки</span>»</span>. Вызовы вспомогательных функций можно записывать в любом порядке, но обычно сначала вызываются <code class="function">errcode</code> и <code class="function">errmsg</code>.</p><p>При уровне важности <code class="literal">ERROR</code> или более высоком, <code class="function">ereport</code> прерывает выполнение текущего запроса и не возвращает управление в вызывающий код. Если уровень важности ниже <code class="literal">ERROR</code>, <code class="function">ereport</code> завершается обычным образом.</p><p>Для <code class="function">ereport</code> предлагаются следующие вспомогательные функции: </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><code class="function">errcode(sqlerrcode)</code> задаёт код идентификатора ошибки SQLSTATE для данной ошибки. Если эта функция не вызывается, подразумевается идентификатор ошибки <code class="literal">ERRCODE_INTERNAL_ERROR</code> при уровне важности <code class="literal">ERROR</code> или выше, либо <code class="literal">ERRCODE_WARNING</code> при уровне важности <code class="literal">WARNING</code>, иначе (при уровне <code class="literal">NOTICE</code> или ниже) — <code class="literal">ERRCODE_SUCCESSFUL_COMPLETION</code>. Хотя эти значения по умолчанию довольно разумны, всегда стоит подумать, насколько они уместны, прежде чем опустить вызов <code class="function">errcode()</code>.</p></li><li class="listitem"><p><code class="function">errmsg(const char *msg, ...)</code> задаёт основной текст сообщения об ошибке и, возможно, значения времени выполнения, которые будут в него включаться. Эти включения записываются кодами формата в стиле <code class="function">sprintf</code>. В дополнение к стандартным кодам формата, принимаемым функцией <code class="function">sprintf</code>, можно использовать код формата <code class="literal">%m</code>, который вставит сообщение об ошибке, возвращённое строкой <code class="function">strerror</code> для текущего значения <code class="literal">errno</code>. <a href="#ftn.id-1.10.7.3.10.2.2.1.7" class="footnote"><sup class="footnote" id="id-1.10.7.3.10.2.2.1.7">[16]</sup></a> Для <code class="literal">%m</code> не требуется соответствующая запись в списке параметров <code class="function">errmsg</code>. Заметьте, что эта строка будет пропущена через <code class="function">gettext</code>, то есть может быть локализована, до обработки кодов формата.</p></li><li class="listitem"><p><code class="function">errmsg_internal(const char *msg, ...)</code> действует как <code class="function">errmsg</code>, но её строка сообщения не будет переводиться и включаться в словарь сообщений для интернационализации. Это следует использовать для случаев, которые <span class="quote">«<span class="quote">не происходят никогда</span>»</span>, так что тратить силы на их перевод не стоит.</p></li><li class="listitem"><p><code class="function">errmsg_plural(const char *fmt_singular, const char *fmt_plural, unsigned long n, ...)</code> действует подобно <code class="function">errmsg</code>, но поддерживает различные формы сообщения с множественными числами. Параметр <em class="replaceable"><code>fmt_singular</code></em> задаёт строку формата на английском для единственного числа, <em class="replaceable"><code>fmt_plural</code></em> — формат для множественного числа, <em class="replaceable"><code>n</code></em> задаёт целое число, определяющее, какая именно форма множественного числа требуется, а остальные аргументы форматируются согласно выбранной строке формата. За дополнительными сведениями обратитесь к <a class="xref" href="nls-programmer.html#NLS-GUIDELINES" title="57.2.2. Рекомендации по написанию сообщений">Подразделу 57.2.2</a>.</p></li><li class="listitem"><p><code class="function">errdetail(const char *msg, ...)</code> задаёт дополнительное <span class="quote">«<span class="quote">подробное</span>»</span> сообщение; оно должно использоваться, когда есть дополнительная информация, которую неуместно включать в основное сообщение. Строка сообщения обрабатывается так же, как и для <code class="function">errmsg</code>.</p></li><li class="listitem"><p><code class="function">errdetail_internal(const char *msg, ...)</code> действует как <code class="function">errdetail</code>, но её строка сообщения не будет переводиться и включаться в словарь сообщений для интернационализации. Это следует использовать для подробных сообщений, на перевод которых не стоит тратить силы, например, когда это техническая информация, непонятная большинству пользователей.</p></li><li class="listitem"><p><code class="function">errdetail_plural(const char *fmt_singular, const char *fmt_plural, unsigned long n, ...)</code> действует подобно <code class="function">errdetail</code>, но поддерживает различные формы сообщения с множественными числами. За дополнительными сведениями обратитесь к <a class="xref" href="nls-programmer.html#NLS-GUIDELINES" title="57.2.2. Рекомендации по написанию сообщений">Подразделу 57.2.2</a>.</p></li><li class="listitem"><p><code class="function">errdetail_log(const char *msg, ...)</code> подобна <code class="function">errdetail</code>, но выводимая строка попадает только в журнал сервера, и никогда не передаётся клиенту. Если используется и <code class="function">errdetail</code> (или один из её эквивалентов), и <code class="function">errdetail_log</code>, тогда одна строка передаётся клиенту, а другая отправляется в журнал. Это полезно для вывода подробных сообщений, имеющих конфиденциальный характер или большой размер, так что передавать их клиенту нежелательно.</p></li><li class="listitem"><p><code class="function">errdetail_log_plural(const char *fmt_singular, const char *fmt_plural, unsigned long n, ...)</code> действует подобно <code class="function">errdetail_log</code>, но поддерживает различные формы сообщения с множественными числами. За дополнительными сведениями обратитесь к <a class="xref" href="nls-programmer.html#NLS-GUIDELINES" title="57.2.2. Рекомендации по написанию сообщений">Подразделу 57.2.2</a>.</p></li><li class="listitem"><p><code class="function">errhint(const char *msg, ...)</code> передаёт дополнительное сообщение <span class="quote">«<span class="quote">подсказки</span>»</span>; это позволяет предложить решение проблемы, а не просто сообщить факты, связанные с ней. Строка сообщения обрабатывается так же, как и для <code class="function">errmsg</code>.</p></li><li class="listitem"><p><code class="function">errhint_plural(const char *fmt_singular, const char *fmt_plural, unsigned long n, ...)</code> действует подобно <code class="function">errhint</code>, но поддерживает различные формы сообщения с множественными числами. За дополнительными сведениями обратитесь к <a class="xref" href="nls-programmer.html#NLS-GUIDELINES" title="57.2.2. Рекомендации по написанию сообщений">Подразделу 57.2.2</a>.</p></li><li class="listitem"><p><code class="function">errcontext(const char *msg, ...)</code> обычно не вызывается непосредственно с места вызова <code class="function">ereport</code>, а используется в функциях обратного вызова <code class="literal">error_context_stack</code> и выдаёт информацию о контексте, в котором произошла ошибка, например, о текущем положении в функции PL. Строка сообщения обрабатывается так же, как и для <code class="function">errmsg</code>. В отличие от других вспомогательных функций, внутри вызова <code class="function">ereport</code> её можно вызывать неоднократно; добавляемые таким образом последовательные сообщения складываются через символы перевода строк.</p></li><li class="listitem"><p><code class="function">errposition(int cursorpos)</code> задаёт положение ошибки в тексте запроса. В настоящее время это полезно только для ошибок, выявляемых на этапах лексического и синтаксического анализа запроса.</p></li><li class="listitem"><p><code class="function">errtable(Relation rel)</code> определяет отношение, имя и схема которого должны быть включены во вспомогательные поля сообщения об ошибке.</p></li><li class="listitem"><p><code class="function">errtablecol(Relation rel, int attnum)</code> определяет столбец, имя которого, вместе с именем таблицы и схемы, должно быть включено во вспомогательные поля сообщения об ошибке.</p></li><li class="listitem"><p><code class="function">errtableconstraint(Relation rel, const char *conname)</code> задаёт имя ограничения таблицы, которое вместе с именем таблицы и схемы должно быть включено во вспомогательные поля сообщения об ошибке. В данном контексте индекс считается ограничением, независимо от того, имеется ли для него запись в <code class="structname">pg_constraint</code>. Заметьте, что при этом в качестве <code class="literal">rel</code> нужно передавать нижележащее отношение, а не сам индекс.</p></li><li class="listitem"><p><code class="function">errdatatype(Oid datatypeOid)</code> задаёт тип данных, имя которого, вместе с именем схемы, должно включаться во вспомогательные поля сообщения об ошибке.</p></li><li class="listitem"><p><code class="function">errdomainconstraint(Oid datatypeOid, const char *conname)</code> задаёт имя ограничения домена, которое вместе с именем домена и схемы должно включаться во вспомогательные поля сообщения об ошибке.</p></li><li class="listitem"><p><code class="function">errcode_for_file_access()</code> — вспомогательная функция, выбирающая подходящий идентификатор SQLSTATE при сбое в системном вызове, в котором происходит обращение к файловой системе. Какой код ошибки генерировать, она определяет по сохранённому значению <code class="literal">errno</code>. Обычно это используется в сочетании с <code class="literal">%m</code> в основном сообщении об ошибке.</p></li><li class="listitem"><p><code class="function">errcode_for_socket_access()</code> — вспомогательная функция, выбирающая подходящий идентификатор SQLSTATE при сбое в системном вызове, в котором происходит обращение к сокетам.</p></li><li class="listitem"><p><code class="function">errhidestmt(bool hide_stmt)</code> может быть вызвана для подавления вывода поля <code class="literal">ОПЕРАТОР:</code> (<code class="literal">STATEMENT:</code>) в журнал сервера. Обычно это уместно, когда само сообщение включает текст текущего оператора.</p></li><li class="listitem"><p><code class="function">errhidecontext(bool hide_ctx)</code> может быть вызвана для подавления вывода поля <code class="literal">КОНТЕКСТ:</code> (<code class="literal">CONTEXT:</code>) в журнал сервера. Это следует использовать только для подробных отладочных сообщений, в которых одна и та же информация о контексте, выводимая в журнал, будет только чрезмерно замусоривать его.</p></li></ul></div><div class="note"><h3 class="title">Примечание</h3><p>В вызове <code class="function">ereport</code> следует использовать максимум одну из функций <code class="function">errtable</code>, <code class="function">errtablecol</code>, <code class="function">errtableconstraint</code>, <code class="function">errdatatype</code> или <code class="function">errdomainconstraint</code>. Данные функции существуют для того, чтобы приложения могли извлечь имя объекта базы данных, связанного с условием ошибки, так, чтобы для этого им не требовалось разбирать текст ошибки, возможно локализованный. Эти функции должны использоваться в случае ошибок, для которых может быть желательной автоматическая обработка. Для версии <span class="productname">PostgreSQL</span> 9.3 этот подход распространяется полностью только на ошибки класса SQLSTATE 23 (нарушение целостности ограничения), но в будущем область его применения может быть расширена.</p></div><p>Существует также более старая, но тем не менее активно используемая функция <code class="function">elog</code>. Вызов <code class="function">elog</code>: </p><pre class="programlisting">elog(level, "format string", ...);</pre><p> полностью равнозначен вызову: </p><pre class="programlisting">ereport(level, errmsg_internal("format string", ...));</pre><p> Заметьте, что код ошибки SQLSTATE всегда определяется неявно, а строка сообщения не подлежит переводу. Таким образом, <code class="function">elog</code> следует использовать только для внутренних ошибок и отладки на низком уровне. Любое сообщение, которое может представлять интерес для обычных пользователей, должно проходить через <code class="function">ereport</code>. Тем не менее в системе есть достаточно много внутренних проверок для случаев, <span class="quote">«<span class="quote">которые не должны происходить</span>»</span>, и в них по-прежнему широко используется <code class="function">elog</code>; для таких сообщений эта функция предпочитается из-за простоты записи.</p><p>Советы по написанию хороших сообщений об ошибках можно найти в <a class="xref" href="error-style-guide.html" title="56.3. Руководство по стилю сообщений об ошибках">Разделе 56.3</a>.</p><div class="footnotes"><br /><hr style="width:100; text-align:left;margin-left: 0" /><div id="ftn.id-1.10.7.3.10.2.2.1.7" class="footnote"><p><a href="#id-1.10.7.3.10.2.2.1.7" class="para"><sup class="para">[16] </sup></a>То есть значение, которое было текущим, когда была вызвана <code class="function">ereport</code>; изменения <code class="literal">errno</code> во вспомогательных функциях выдачи сообщений на него не повлияют. Это будет не так, если вы запишете <code class="literal">strerror(errno)</code> явно в списке параметров <code class="function">errmsg</code>; поэтому делать так не нужно.</p></div></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="source-format.html" title="56.1. Форматирование">Пред.</a> </td><td width="20%" align="center"><a accesskey="u" href="source.html" title="Глава 56. Соглашения по оформлению кода PostgreSQL">Наверх</a></td><td width="40%" align="right"> <a accesskey="n" href="error-style-guide.html" title="56.3. Руководство по стилю сообщений об ошибках">След.</a></td></tr><tr><td width="40%" align="left" valign="top">56.1. Форматирование </td><td width="20%" align="center"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="40%" align="right" valign="top"> 56.3. Руководство по стилю сообщений об ошибках</td></tr></table></div></body></html>