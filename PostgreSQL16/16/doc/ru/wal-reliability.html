<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>30.1. Надёжность</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@lists.postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets Vsnapshot" /><link rel="prev" href="wal.html" title="Глава 30. Надёжность и журнал предзаписи" /><link rel="next" href="checksums.html" title="30.2. Контрольные суммы данных" /></head><body id="docContent" class="container-fluid col-10"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="5" align="center">30.1. Надёжность</th></tr><tr><td width="10%" align="left"><a accesskey="p" href="wal.html" title="Глава 30. Надёжность и журнал предзаписи">Пред.</a> </td><td width="10%" align="left"><a accesskey="u" href="wal.html" title="Глава 30. Надёжность и журнал предзаписи">Наверх</a></td><th width="60%" align="center">Глава 30. Надёжность и журнал предзаписи</th><td width="10%" align="right"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="10%" align="right"> <a accesskey="n" href="checksums.html" title="30.2. Контрольные суммы данных">След.</a></td></tr></table><hr /></div><div class="sect1" id="WAL-RELIABILITY"><div class="titlepage"><div><div><h2 class="title" style="clear: both">30.1. Надёжность <a href="#WAL-RELIABILITY" class="id_link">#</a></h2></div></div></div><p>Надёжность — это важное свойство любой серьёзной СУБД и <span class="productname">PostgreSQL</span> делает всё возможное, чтобы гарантировать надёжность своего функционирования. Один из аспектов надёжности состоит в том, что все данные записываются с помощью подтверждённых транзакций, которые сохраняются в энергонезависимой области, которая защищена от потери питания, сбоев операционной системы и аппаратных отказов (разумеется, за исключением отказа самой энергонезависимой области). Успешная запись данных в постоянное место хранения (диск или эквивалентный носитель) обычно всё, что требуется. Фактически, даже если компьютер полностью вышел из строя, если диски выжили, то они могут быть переставлены в другой похожий компьютер и все подтверждённые транзакции останутся неповреждёнными.</p><p>Хотя периодическая запись данных на пластины диска может выглядеть как простая операция, это не так, потому что диски значительно медленнее, чем оперативная память и процессор, а также потому что между оперативной памятью и пластинами диска есть некоторые механизмы кеширования. Во-первых, есть буферный кеш операционной системы, который кеширует частые запросы к блокам диска и комбинирует запись на диск. К счастью, все операционные системы предоставляют приложениям способ принудительной записи из буферного кеша на диск и <span class="productname">PostgreSQL</span> использует эту возможность. (Смотрите параметр <a class="xref" href="runtime-config-wal.html#GUC-WAL-SYNC-METHOD">wal_sync_method</a> который отвечает за то как это делается.)</p><p>Далее, кеширование также может осуществляться контроллером диска; в особенности это касается <acronym class="acronym">RAID</acronym>-контроллеров. В некоторых случаях это кеширование работает в режиме <em class="firstterm">сквозной записи</em>, что означает, что запись осуществляется на диск как только приходят данные. В других случаях, возможна работа в режиме <em class="firstterm">отложенной записи</em>, что означает, что запись осуществляется некоторое время спустя. Такой режим кеширования может создавать риск для надёжности, потому что память контроллера диска непостоянна и будет потеряна в случае потери питания. Лучшие контроллеры имеют так называемую <em class="firstterm">батарею резервного питания</em> (Battery-Backup Unit, <acronym class="acronym">BBU</acronym>), которая сохраняет кеш контроллера на батарее, если пропадёт системное питание. После возобновления питания, данные, оставшиеся в кеше контроллера, будут записаны на диски.</p><p>И наконец, многие диски имеют внутренний кеш. На каких-то дисках он работает в режиме сквозной записи, на других — в режиме отложенной записи. В последнем случае с кешем диска связаны те же риски потери данных, что и с кешем контроллера дисков. В частности, кеш отложенной записи, сбрасывающийся при потере питания, часто имеют диски IDE и SATA потребительского класса. Также зависимый от питания кеш отложенной записи имеют многие SSD-накопители.</p><p>Обычно, такое кеширование можно выключить; однако то, как это делается, различается для операционной системы и для типа диска:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>В <span class="productname">Linux</span> параметры дисков IDE и SATA могут быть получены с помощью команды <code class="command">hdparm -I</code>; кеширование записи включено, если за строкой <code class="literal">Write cache</code> следует <code class="literal">*</code>. Для выключения кеширования записи может быть использована команда <code class="command">hdparm -W 0</code>. Параметры SCSI-дисков могут быть получены с помощью утилиты <a class="ulink" href="http://sg.danny.cz/sg/sdparm.html" target="_top"><span class="application">sdparm</span></a>. Используйте <code class="command">sdparm --get=WCE</code>, чтобы проверить, включено ли кеширование записи, и <code class="command">sdparm --clear=WCE</code>, чтобы выключить его.</p></li><li class="listitem"><p>Во <span class="productname">FreeBSD</span> параметры IDE-дисков могут быть получены с помощью команды <code class="command">camcontrol identify</code>, а кеширование записи выключается при помощи установки параметра <code class="literal">hw.ata.wc=0</code> в файле <code class="filename">/boot/loader.conf</code>; Для SCSI-дисков параметры могут быть получены, используя команду <code class="command">camcontrol identify</code>, а кеширование записи изменяется при помощи утилиты <code class="command">sdparm</code>.</p></li><li class="listitem"><p>В <span class="productname">Solaris</span> кешированием записи на диск управляет команда <code class="command">format -e</code>. (Использование файловой системы Solaris <acronym class="acronym">ZFS</acronym>, при включённом кешировании записи на диск, является безопасным, потому что она использует собственные команды сброса кеша на диск.)</p></li><li class="listitem"><p>В <span class="productname">Windows</span>, если параметр <code class="varname">wal_sync_method</code> установлен в <code class="literal">open_datasync</code> (по умолчанию), кеширование записи на диск может быть выключено снятием галочки <code class="literal">My Computer\Open\<em class="replaceable"><code>disk drive</code></em>\Properties\Hardware\Properties\Policies\Enable write caching on the disk</code>. В качестве альтернативы, можно установить параметр <code class="varname">wal_sync_method</code> в значение <code class="literal">fdatasync</code> (только для NTFS), <code class="literal">fsync</code> или <code class="literal">fsync_writethrough</code>, что предотвращает кеширование записи.</p></li><li class="listitem"><p>В <span class="productname">macOS</span> кеширование записи можно отключить, установив для параметра <code class="varname">wal_sync_method</code> значение <code class="literal">fsync_writethrough</code>.</p></li></ul></div><p>Новые модели SATA-дисков (которые соответствуют стандарту <acronym class="acronym">ATAPI-6</acronym> или более позднему) предлагают команду сброса кеша на диск (<code class="command">FLUSH CACHE EXT</code>), а SCSI-диски уже давно поддерживают похожую команду <code class="command">SYNCHRONIZE CACHE</code>. Эти команды недоступны из <span class="productname">PostgreSQL</span> напрямую, но некоторые файловые системы (например, <acronym class="acronym">ZFS</acronym>, <acronym class="acronym">ext4</acronym>), могут использовать их для сброса данных из кеша на пластины диска при включённом режиме кеша сквозной записи. К сожалению, такие файловые системы ведут себя неоптимально при комбинировании с батареей резервного питания (<acronym class="acronym">BBU</acronym>) дискового контроллера. В таких случаях, команда синхронизации принуждает сохранять все данные на диск из кеша контроллера, сводя преимущество BBU к нулю. Вы можете запустить модуль <a class="xref" href="pgtestfsync.html" title="pg_test_fsync"><span class="refentrytitle"><span class="application">pg_test_fsync</span></span></a>, чтобы увидеть, что вы попали в эту ситуацию. Если это так, преимущества производительности BBU могут быть восстановлены с помощью выключения барьеров записи для файловой системы или переконфигурирования контроллера диска, если это возможно. Если барьеры записи выключены, убедитесь, что батарея годная; при отказе батареи может произойти потеря данных. Есть надежда, что разработчики файловых систем и контроллеров дисков, в конце концов, устранят это неоптимальное поведение.</p><p>Когда операционная система отправляет запрос на запись к аппаратному обеспечению для хранения данных, она мало что может сделать, чтобы убедиться, что данные действительно сохранены в какой-либо энергонезависимой области. Скорее, это является зоной ответственности администратора, убедиться в целостности данных на всех компонентах хранения. Избегайте дисковых контроллеров, которые не имеют батарей резервного питания для кеширования записи. На уровне диска, запретите режим отложенной записи, если диск не может гарантировать, что данные будут записаны перед выключением. Если вы используете SSD, знайте, что многие из них по умолчанию не выполняют команды сброса кеша на диск. Вы можете протестировать надёжность поведения подсистемы ввода/вывода, используя <a class="ulink" href="https://brad.livejournal.com/2116715.html" target="_top"><code class="filename">diskchecker.pl</code></a>.</p><p>Другой риск потери данных состоит в самой записи на пластины диска. Пластины диска разделяются на секторы, обычно по 512 байт каждый. Каждая операция физического чтения или записи обрабатывает целый сектор. Когда дисковый накопитель получает запрос на запись, он может соответствовать нескольким секторам по 512 байт (<span class="productname">PostgreSQL</span> обычно за один раз записывает 8192 байта или 16 секторов) и из-за отказа питания процесс записи может закончится неудачей в любое время, что означает, что некоторые из 512-байтовых секторов будут записаны, а некоторые нет. Чтобы защититься от таких сбоев, <span class="emphasis"><em>перед</em></span> изменением фактической страницы на диске, <span class="productname">PostgreSQL</span> периодически записывает полные образы страниц на постоянное устройство хранения WAL. С помощью этого, во время восстановления после краха, <span class="productname">PostgreSQL</span> может восстановить из WAL страницы, которые записаны частично. Если у вас файловая система, которая защищена от частичной записи страниц (например, ZFS), вы можете выключить работу с образами страниц, выключив параметр <a class="xref" href="runtime-config-wal.html#GUC-FULL-PAGE-WRITES">full_page_writes</a>. Батарея резервного питания (BBU) контроллера диска не защищает от частичной записи страниц, если не гарантируется, что данные записаны в BBU как полные (8kB) страницы.</p><p><span class="productname">PostgreSQL</span> также защищает от некоторых видов повреждения данных на устройствах хранения, которые могут произойти из-за аппаратных ошибок или из-за дефектов поверхности с течением времени, например, при операциях чтения/записи во время сборки мусора. </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Каждая индивидуальная запись в WAL защищена с помощью контрольной суммы по алгоритму CRC-32 (32-bit), что позволяет судить о корректности данных в записи. Значение CRC устанавливается, когда мы пишем каждую запись WAL и проверяется в ходе восстановления после сбоя, восстановления из архива, и при репликации.</p></li><li class="listitem"><p>Страницы данных в настоящее время не защищаются контрольными суммами по умолчанию, хотя полные образы страниц, записанные в WAL, будут защищены; смотрите <a class="link" href="app-initdb.html#APP-INITDB-DATA-CHECKSUMS"><span class="application">initdb</span></a> для деталей о включении в страницы данных информации о контрольных суммах.</p></li><li class="listitem"><p>Для внутренних структур данных, таких как <code class="filename">pg_xact</code>, <code class="filename">pg_subtrans</code>, <code class="filename">pg_multixact</code>, <code class="filename">pg_serial</code>, <code class="filename">pg_notify</code>, <code class="filename">pg_stat</code>, <code class="filename">pg_snapshots</code> не ведётся расчёт контрольной суммы, равно как и для страниц, защищённых посредством полностраничной записи. Однако там, где такие структуры данных являются постоянными, записи WAL пишутся таким образом, чтобы после сбоя было возможно аккуратно повторить последние изменения, а эти записи WAL защищаются так же, как описано выше.</p></li><li class="listitem"><p>Файлы каталога <code class="filename">pg_twophase</code> защищены с помощью контрольной суммы CRC-32.</p></li><li class="listitem"><p>Временные файлы данных, используемые в больших SQL-запросах для сортировки, материализации и промежуточных результатов, в настоящее время не защищаются контрольной суммой, а изменения в этих файлах не отражаются в WAL.</p></li></ul></div><p><span class="productname">PostgreSQL</span> не защищает от корректируемых ошибок памяти; предполагается, что вы будете работать с памятью, которая использует промышленный стандарт коррекции ошибок (ECC, Error Correcting Codes) или лучшую защиту.</p></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="wal.html" title="Глава 30. Надёжность и журнал предзаписи">Пред.</a> </td><td width="20%" align="center"><a accesskey="u" href="wal.html" title="Глава 30. Надёжность и журнал предзаписи">Наверх</a></td><td width="40%" align="right"> <a accesskey="n" href="checksums.html" title="30.2. Контрольные суммы данных">След.</a></td></tr><tr><td width="40%" align="left" valign="top">Глава 30. Надёжность и журнал предзаписи </td><td width="20%" align="center"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="40%" align="right" valign="top"> 30.2. Контрольные суммы данных</td></tr></table></div></body></html>