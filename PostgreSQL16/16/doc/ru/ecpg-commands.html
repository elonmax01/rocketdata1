<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>36.3. Запуск команд SQL</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@lists.postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets Vsnapshot" /><link rel="prev" href="ecpg-connect.html" title="36.2. Управление подключениями к базе данных" /><link rel="next" href="ecpg-variables.html" title="36.4. Использование переменных среды" /></head><body id="docContent" class="container-fluid col-10"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="5" align="center">36.3. Запуск команд SQL</th></tr><tr><td width="10%" align="left"><a accesskey="p" href="ecpg-connect.html" title="36.2. Управление подключениями к базе данных">Пред.</a> </td><td width="10%" align="left"><a accesskey="u" href="ecpg.html" title="Глава 36. ECPG — Встраиваемый SQL в C">Наверх</a></td><th width="60%" align="center">Глава 36. <span class="application">ECPG</span> — Встраиваемый <acronym class="acronym">SQL</acronym> в C</th><td width="10%" align="right"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="10%" align="right"> <a accesskey="n" href="ecpg-variables.html" title="36.4. Использование переменных среды">След.</a></td></tr></table><hr /></div><div class="sect1" id="ECPG-COMMANDS"><div class="titlepage"><div><div><h2 class="title" style="clear: both">36.3. Запуск команд SQL <a href="#ECPG-COMMANDS" class="id_link">#</a></h2></div></div></div><div class="toc"><dl class="toc"><dt><span class="sect2"><a href="ecpg-commands.html#ECPG-EXECUTING">36.3.1. Выполнение SQL-операторов</a></span></dt><dt><span class="sect2"><a href="ecpg-commands.html#ECPG-CURSORS">36.3.2. Использование курсоров</a></span></dt><dt><span class="sect2"><a href="ecpg-commands.html#ECPG-TRANSACTIONS">36.3.3. Управление транзакциями</a></span></dt><dt><span class="sect2"><a href="ecpg-commands.html#ECPG-PREPARED">36.3.4. Подготовленные операторы</a></span></dt></dl></div><p>В приложении со встраиваемым SQL можно запустить любую команду SQL. Ниже приведены несколько примеров, показывающих как это делать.</p><div class="sect2" id="ECPG-EXECUTING"><div class="titlepage"><div><div><h3 class="title">36.3.1. Выполнение SQL-операторов <a href="#ECPG-EXECUTING" class="id_link">#</a></h3></div></div></div><p>Создание таблицы: </p><pre class="programlisting">EXEC SQL CREATE TABLE foo (number integer, ascii char(16));
EXEC SQL CREATE UNIQUE INDEX num1 ON foo(number);
EXEC SQL COMMIT;</pre><p>Добавление строк: </p><pre class="programlisting">EXEC SQL INSERT INTO foo (number, ascii) VALUES (9999, 'doodad');
EXEC SQL COMMIT;</pre><p>Удаление строк: </p><pre class="programlisting">EXEC SQL DELETE FROM foo WHERE number = 9999;
EXEC SQL COMMIT;</pre><p>Изменение: </p><pre class="programlisting">EXEC SQL UPDATE foo
    SET ascii = 'foobar'
    WHERE number = 9999;
EXEC SQL COMMIT;</pre><p>Операторы <code class="literal">SELECT</code>, возвращающие одну строку результата, также могут выполняться непосредственно командой <code class="literal">EXEC SQL</code>. Чтобы обработать наборы результатов с несколькими строками, приложение должно использовать курсоры; см. <a class="xref" href="ecpg-commands.html#ECPG-CURSORS" title="36.3.2. Использование курсоров">Подраздел 36.3.2</a> ниже. (В отдельных случаях приложение может выбрать сразу несколько строк в переменную массива; см. <a class="xref" href="ecpg-variables.html#ECPG-VARIABLES-ARRAYS" title="36.4.4.3.1. Массивы">Подраздел 36.4.4.3.1</a>.)</p><p>Выборка одной строки: </p><pre class="programlisting">EXEC SQL SELECT foo INTO :FooBar FROM table1 WHERE ascii = 'doodad';</pre><p>Так же можно получить параметр конфигурации командой <code class="literal">SHOW</code>: </p><pre class="programlisting">EXEC SQL SHOW search_path INTO :var;</pre><p>Идентификаторы вида <code class="literal">:<em class="replaceable"><code>имя</code></em></code> воспринимаются как <em class="firstterm">переменные среды</em>, то есть они ссылаются на переменные программы C. Они рассматриваются в <a class="xref" href="ecpg-variables.html" title="36.4. Использование переменных среды">Разделе 36.4</a>.</p></div><div class="sect2" id="ECPG-CURSORS"><div class="titlepage"><div><div><h3 class="title">36.3.2. Использование курсоров <a href="#ECPG-CURSORS" class="id_link">#</a></h3></div></div></div><p>Чтобы получить набор результатов, содержащий несколько строк, приложение должно объявить курсор и выбирать каждую строку через него. Использование курсора подразумевает следующие шаги: объявление курсора, открытие его, выборку строки через курсор, повторение предыдущего шага, и наконец, закрытие курсора.</p><p>Выборка с использованием курсоров: </p><pre class="programlisting">EXEC SQL DECLARE foo_bar CURSOR FOR
    SELECT number, ascii FROM foo
    ORDER BY ascii;
EXEC SQL OPEN foo_bar;
EXEC SQL FETCH foo_bar INTO :FooBar, DooDad;
...
EXEC SQL CLOSE foo_bar;
EXEC SQL COMMIT;</pre><p>Более подробно объявление курсора описывается в <a class="xref" href="ecpg-sql-declare.html" title="DECLARE">DECLARE</a>, а выборка строк через курсор — в <a class="xref" href="sql-fetch.html" title="FETCH"><span class="refentrytitle">FETCH</span></a>.</p><div class="note"><h3 class="title">Примечание</h3><p>Команда <code class="command">DECLARE</code> в ECPG на самом деле не передаёт этот оператор серверу PostgreSQL. Курсор открывается на сервере (командой сервера <code class="command">DECLARE</code>) в момент, когда выполняется команда <code class="command">OPEN</code>.</p></div></div><div class="sect2" id="ECPG-TRANSACTIONS"><div class="titlepage"><div><div><h3 class="title">36.3.3. Управление транзакциями <a href="#ECPG-TRANSACTIONS" class="id_link">#</a></h3></div></div></div><p>В режиме по умолчанию операторы фиксируются только когда выполняется <code class="command">EXEC SQL COMMIT</code>. Интерфейс встраиваемого SQL также поддерживает автофиксацию транзакций (так работает <span class="application">libpq</span> по умолчанию); она включается аргументом командной строки <code class="option">-t</code> программы <code class="command">ecpg</code> (см. <a class="xref" href="app-ecpg.html" title="ecpg"><span class="refentrytitle"><span class="application">ecpg</span></span></a>) либо оператором <code class="literal">EXEC SQL SET AUTOCOMMIT TO ON</code>. В режиме автофиксации каждая команда фиксируется автоматически, если только она не помещена в явный блок транзакции. Этот режим можно выключить явным образом, выполнив <code class="literal">EXEC SQL SET AUTOCOMMIT TO OFF</code>.</p><p>Поддерживаются следующие команды управления транзакциями: </p><div class="variablelist"><dl class="variablelist"><dt id="ECPG-TRANSACTIONS-EXEC-SQL-COMMIT"><span class="term"><code class="literal">EXEC SQL COMMIT</code></span> <a href="#ECPG-TRANSACTIONS-EXEC-SQL-COMMIT" class="id_link">#</a></dt><dd><p>Зафиксировать текущую транзакцию.</p></dd><dt id="ECPG-TRANSACTIONS-EXEC-SQL-ROLLBACK"><span class="term"><code class="literal">EXEC SQL ROLLBACK</code></span> <a href="#ECPG-TRANSACTIONS-EXEC-SQL-ROLLBACK" class="id_link">#</a></dt><dd><p>Откатить текущую транзакцию.</p></dd><dt id="ECPG-TRANSACTIONS-EXEC-SQL-PREPARE-TRANSACTION"><span class="term"><code class="literal">EXEC SQL PREPARE TRANSACTION</code><em class="replaceable"><code>ид_транзакции</code></em></span> <a href="#ECPG-TRANSACTIONS-EXEC-SQL-PREPARE-TRANSACTION" class="id_link">#</a></dt><dd><p>Подготовить текущую транзакцию для двухфазной фиксации.</p></dd><dt id="ECPG-TRANSACTIONS-EXEC-SQL-COMMIT-PREPARED"><span class="term"><code class="literal">EXEC SQL COMMIT PREPARED</code><em class="replaceable"><code>ид_транзакции</code></em></span> <a href="#ECPG-TRANSACTIONS-EXEC-SQL-COMMIT-PREPARED" class="id_link">#</a></dt><dd><p>Зафиксировать транзакцию в подготовленном состоянии.</p></dd><dt id="ECPG-TRANSACTIONS-EXEC-SQL-ROLLBACK-PREPARED"><span class="term"><code class="literal">EXEC SQL ROLLBACK PREPARED</code><em class="replaceable"><code>ид_транзакции</code></em></span> <a href="#ECPG-TRANSACTIONS-EXEC-SQL-ROLLBACK-PREPARED" class="id_link">#</a></dt><dd><p>Откатить транзакцию в подготовленном состоянии.</p></dd><dt id="ECPG-TRANSACTIONS-EXEC-SQL-AUTOCOMMIT-ON"><span class="term"><code class="literal">EXEC SQL SET AUTOCOMMIT TO ON</code></span> <a href="#ECPG-TRANSACTIONS-EXEC-SQL-AUTOCOMMIT-ON" class="id_link">#</a></dt><dd><p>Включить режим автофиксации.</p></dd><dt id="ECPG-TRANSACTIONS-EXEC-SQL-AUTOCOMMIT-OFF"><span class="term"><code class="literal">EXEC SQL SET AUTOCOMMIT TO OFF</code></span> <a href="#ECPG-TRANSACTIONS-EXEC-SQL-AUTOCOMMIT-OFF" class="id_link">#</a></dt><dd><p>Отключить режим автофиксации. По умолчанию он отключён.</p></dd></dl></div></div><div class="sect2" id="ECPG-PREPARED"><div class="titlepage"><div><div><h3 class="title">36.3.4. Подготовленные операторы <a href="#ECPG-PREPARED" class="id_link">#</a></h3></div></div></div><p>Когда значения, передаваемые SQL-оператору, неизвестны во время компиляции, или один и тот же оператор будет использоваться многократно, могут быть полезны подготовленные операторы.</p><p>Оператор подготавливается командой <code class="literal">PREPARE</code>. Вместо значений, которые ещё неизвестны, вставляются местозаполнители <span class="quote">«<span class="quote"><code class="literal">?</code></span>»</span>: </p><pre class="programlisting">EXEC SQL PREPARE stmt1 FROM "SELECT oid, datname FROM pg_database WHERE oid = ?";</pre><p>Если оператор возвращает одну строку, приложение может вызвать <code class="literal">EXECUTE</code> после <code class="literal">PREPARE</code> для выполнения этого оператора, указав фактические значения для местозаполнителей в предложении <code class="literal">USING</code>: </p><pre class="programlisting">EXEC SQL EXECUTE stmt1 INTO :dboid, :dbname USING 1;</pre><p>Если оператор возвращает несколько строк, приложение может использовать курсор, объявленный на базе подготовленного оператора. Чтобы привязать входные параметры, курсор нужно открыть с предложением <code class="literal">USING</code>: </p><pre class="programlisting">EXEC SQL PREPARE stmt1 FROM "SELECT oid,datname FROM pg_database WHERE oid &gt; ?";
EXEC SQL DECLARE foo_bar CURSOR FOR stmt1;

/* по достижении конца набора результатов прервать цикл while */
EXEC SQL WHENEVER NOT FOUND DO BREAK;

EXEC SQL OPEN foo_bar USING 100;
...
while (1)
{
    EXEC SQL FETCH NEXT FROM foo_bar INTO :dboid, :dbname;
    ...
}
EXEC SQL CLOSE foo_bar;</pre><p>Когда подготовленный оператор больше не нужен, его следует освободить: </p><pre class="programlisting">EXEC SQL DEALLOCATE PREPARE <em class="replaceable"><code>имя</code></em>;</pre><p>Подробнее оператор <code class="literal">PREPARE</code> описан в <a class="xref" href="ecpg-sql-prepare.html" title="PREPARE">PREPARE</a>. Также обратитесь к <a class="xref" href="ecpg-dynamic.html" title="36.5. Динамический SQL">Разделу 36.5</a> за дополнительными сведениями о местозаполнителях и входных параметрах.</p></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="ecpg-connect.html" title="36.2. Управление подключениями к базе данных">Пред.</a> </td><td width="20%" align="center"><a accesskey="u" href="ecpg.html" title="Глава 36. ECPG — Встраиваемый SQL в C">Наверх</a></td><td width="40%" align="right"> <a accesskey="n" href="ecpg-variables.html" title="36.4. Использование переменных среды">След.</a></td></tr><tr><td width="40%" align="left" valign="top">36.2. Управление подключениями к базе данных </td><td width="20%" align="center"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="40%" align="right" valign="top"> 36.4. Использование переменных среды</td></tr></table></div></body></html>