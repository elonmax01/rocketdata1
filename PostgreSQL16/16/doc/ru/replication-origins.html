<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Глава 50. Отслеживание прогресса репликации</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@lists.postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets Vsnapshot" /><link rel="prev" href="logicaldecoding-two-phase-commits.html" title="49.10. Поддержка двухфазной фиксации для логического декодирования" /><link rel="next" href="archive-modules.html" title="Глава 51. Модули архивирования" /></head><body id="docContent" class="container-fluid col-10"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="5" align="center">Глава 50. Отслеживание прогресса репликации</th></tr><tr><td width="10%" align="left"><a accesskey="p" href="logicaldecoding-two-phase-commits.html" title="49.10. Поддержка двухфазной фиксации для логического декодирования">Пред.</a> </td><td width="10%" align="left"><a accesskey="u" href="server-programming.html" title="Часть V. Серверное программирование">Наверх</a></td><th width="60%" align="center">Часть V. Серверное программирование</th><td width="10%" align="right"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="10%" align="right"> <a accesskey="n" href="archive-modules.html" title="Глава 51. Модули архивирования">След.</a></td></tr></table><hr /></div><div class="chapter" id="REPLICATION-ORIGINS"><div class="titlepage"><div><div><h2 class="title">Глава 50. Отслеживание прогресса репликации</h2></div></div></div><a id="id-1.8.15.2" class="indexterm"></a><a id="id-1.8.15.3" class="indexterm"></a><p>Инфраструктура источников репликации введена для упрощения реализации решений логической репликации на основе <a class="link" href="logicaldecoding.html" title="Глава 49. Логическое декодирование">логического декодирования</a>. Она помогает решить две распространённых проблемы: </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Как надёжно отслеживать прогресс репликации</p></li><li class="listitem"><p>Как менять поведение репликации в зависимости от источника строки; например, для предотвращения циклов при двунаправленной репликации</p></li></ul></div><p>Источники репликации имеют только два свойства: имя и ID. Имя, по которому к источнику следует обращаться из разных систем, задаётся значением типа <code class="type">text</code> в произвольной форме. Его следует выбирать так, чтобы конфликты между источниками репликации, созданными различными средствами репликации были маловероятны; например, добавлять в начало обозначение средства репликации. ID используется только для того, чтобы не приходилось хранить длинное имя там, где требуется минимизировать объём. Он не может разделяться между разными системами.</p><p>Источник репликации можно создать функцией <a class="link" href="functions-admin.html#PG-REPLICATION-ORIGIN-CREATE"><code class="function">pg_replication_origin_create()</code></a>; удалить функцией <a class="link" href="functions-admin.html#PG-REPLICATION-ORIGIN-DROP"><code class="function">pg_replication_origin_drop()</code></a>; и увидеть в системном каталоге <a class="link" href="catalog-pg-replication-origin.html" title="53.44. pg_replication_origin"><code class="structname">pg_replication_origin</code></a>.</p><p>Одной из нетривиальных задач при организации репликации является надёжное отслеживание прогресса воспроизведения. Например, когда применяющий изменения процесс (или весь кластер) умирает, нужно иметь возможность понять, какие данные были переданы успешно. Наивные решения этой проблемы, такие как изменение строки в некоторой таблице для каждой воспроизведённой транзакции, чреваты дополнительной нагрузкой во время выполнения и раздуванием базы данных.</p><p>С использованием инфраструктуры источников репликации сеанс может быть помечен как воспроизводящий изменения с удалённого узла (с помощью функции <a class="link" href="functions-admin.html#PG-REPLICATION-ORIGIN-SESSION-SETUP"><code class="function">pg_replication_origin_session_setup()</code></a>). В дополнение к этому для каждой транзакции из источника можно задать <acronym class="acronym">LSN</acronym> и время фиксации, вызвав <a class="link" href="functions-admin.html#PG-REPLICATION-ORIGIN-XACT-SETUP"><code class="function">pg_replication_origin_xact_setup()</code></a>. Если сделать всё это, прогресс репликации можно будет отслеживать надёжным образом. Прогресс воспроизведения для всех источников репликации можно увидеть в представлении <a class="link" href="view-pg-replication-origin-status.html" title="54.18. pg_replication_origin_status"><code class="structname">pg_replication_origin_status</code></a>. Прогресс отдельного источника, например, при возобновлении репликации, можно получить для любого источника, воспользовавшись функцией <a class="link" href="functions-admin.html#PG-REPLICATION-ORIGIN-PROGRESS"><code class="function">pg_replication_origin_progress()</code></a>, или для источника, настроенного в текущем сеансе, с помощью <a class="link" href="functions-admin.html#PG-REPLICATION-ORIGIN-SESSION-PROGRESS"><code class="function">pg_replication_origin_session_progress()</code></a>.</p><p>В топологиях репликации более сложных, чем простая репликация с одной системы в другую, возможна ещё одна проблема — повторная репликация уже воспроизведённых строк, что может приводить к зацикливанию и снижению эффективности. В качестве механизма выявления и предотвращения повторной репликации так же могут оказаться полезны источники репликации. Если воспользоваться функциями, упомянутыми в предыдущем абзаце, во все поступающие в сеансе транзакции и изменения, передаваемые обработчикам модулей вывода (см. <a class="xref" href="logicaldecoding-output-plugin.html" title="49.6. Модули вывода логического декодирования">Раздел 49.6</a>), добавляется пометка источника репликации для текущего сеанса. Это позволяет обрабатывать их в модуле вывода по-разному, например, игнорировать все строки, кроме имеющих локальное происхождение. Кроме того, обработчик вызова <a class="link" href="logicaldecoding-output-plugin.html#LOGICALDECODING-OUTPUT-PLUGIN-FILTER-ORIGIN" title="49.6.4.7. Обработчик фильтрации источника"><code class="function">filter_by_origin_cb</code></a> позволяет отфильтровать поток изменений логического декодирования в зависимости от источника. Фильтрация через этот обработчик не так гибка, как проверка записей внутри модуля вывода, но зато гораздо эффективнее.</p></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="logicaldecoding-two-phase-commits.html" title="49.10. Поддержка двухфазной фиксации для логического декодирования">Пред.</a> </td><td width="20%" align="center"><a accesskey="u" href="server-programming.html" title="Часть V. Серверное программирование">Наверх</a></td><td width="40%" align="right"> <a accesskey="n" href="archive-modules.html" title="Глава 51. Модули архивирования">След.</a></td></tr><tr><td width="40%" align="left" valign="top">49.10. Поддержка двухфазной фиксации для логического декодирования </td><td width="20%" align="center"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="40%" align="right" valign="top"> Глава 51. Модули архивирования</td></tr></table></div></body></html>