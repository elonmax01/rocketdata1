<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>F.50. xml2 — функции для выполнения запросов XPath и преобразований XSLT</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@lists.postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets Vsnapshot" /><link rel="prev" href="uuid-ossp.html" title="F.49. uuid-ossp — генератор UUID" /><link rel="next" href="contrib-prog.html" title="Приложение G. Дополнительно поставляемые программы" /></head><body id="docContent" class="container-fluid col-10"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="5" align="center">F.50. xml2 — функции для выполнения запросов XPath и преобразований XSLT</th></tr><tr><td width="10%" align="left"><a accesskey="p" href="uuid-ossp.html" title="F.49. uuid-ossp — генератор UUID">Пред.</a> </td><td width="10%" align="left"><a accesskey="u" href="contrib.html" title="Приложение F. Дополнительно поставляемые модули и расширения">Наверх</a></td><th width="60%" align="center">Приложение F. Дополнительно поставляемые модули и расширения</th><td width="10%" align="right"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="10%" align="right"> <a accesskey="n" href="contrib-prog.html" title="Приложение G. Дополнительно поставляемые программы">След.</a></td></tr></table><hr /></div><div class="sect1" id="XML2"><div class="titlepage"><div><div><h2 class="title" style="clear: both">F.50. xml2 — функции для выполнения запросов XPath и преобразований XSLT <a href="#XML2" class="id_link">#</a></h2></div></div></div><div class="toc"><dl class="toc"><dt><span class="sect2"><a href="xml2.html#XML2-DEPRECATION">F.50.1. Уведомление об актуальности</a></span></dt><dt><span class="sect2"><a href="xml2.html#XML2-FUNCTIONS">F.50.2. Описание функций</a></span></dt><dt><span class="sect2"><a href="xml2.html#XML2-XPATH-TABLE">F.50.3. <code class="literal">xpath_table</code></a></span></dt><dt><span class="sect2"><a href="xml2.html#XML2-XSLT">F.50.4. Функции XSLT</a></span></dt><dt><span class="sect2"><a href="xml2.html#XML2-AUTHOR">F.50.5. Автор</a></span></dt></dl></div><a id="id-1.11.7.60.2" class="indexterm"></a><p>Модуль <code class="filename">xml2</code> предоставляет функции для выполнения запросов XPath и преобразований XSLT.</p><div class="sect2" id="XML2-DEPRECATION"><div class="titlepage"><div><div><h3 class="title">F.50.1. Уведомление об актуальности <a href="#XML2-DEPRECATION" class="id_link">#</a></h3></div></div></div><p>Начиная с <span class="productname">PostgreSQL</span> 8.3, функциональность, связанная с XML, основана на стандарте SQL/XML и включена в ядро сервера. Эта функциональность охватывает проверку синтаксиса XML и запросы XPath, что в частности делает и этот модуль, но он имеет абсолютно несовместимый API. Этот модуль планируется удалить в будущей версии PostgreSQL в пользу нового стандартного API, так что мы рекомендуем вам попробовать перевести свои приложения на новый API. Если вы обнаружите, что какая-то функциональность этого модуля не представлена новым API в подходящей форме, пожалуйста, напишите о вашем затруднении в <code class="email">&lt;<a class="email" href="mailto:pgsql-hackers@lists.postgresql.org">pgsql-hackers@lists.postgresql.org</a>&gt;</code>, чтобы этот недостаток был рассмотрен и, возможно, устранён.</p></div><div class="sect2" id="XML2-FUNCTIONS"><div class="titlepage"><div><div><h3 class="title">F.50.2. Описание функций <a href="#XML2-FUNCTIONS" class="id_link">#</a></h3></div></div></div><p>Функции, предоставляемые этим модулем, перечислены в <a class="xref" href="xml2.html#XML2-FUNCTIONS-TABLE" title="Таблица F.36. Функции xml2">Таблице F.36</a>. Эти функции позволяют выполнять простой разбор XML и запросы XPath.</p><div class="table" id="XML2-FUNCTIONS-TABLE"><p class="title"><strong>Таблица F.36. Функции <code class="filename">xml2</code></strong></p><div class="table-contents"><table class="table" summary="Функции xml2" border="1"><colgroup><col /></colgroup><thead><tr><th class="func_table_entry"><p class="func_signature">Функция</p>
       <p>Описание</p></th></tr></thead><tbody><tr><td class="func_table_entry"><p class="func_signature"><code class="function">xml_valid</code> ( <em class="parameter"><code>document</code></em> <code class="type">text</code> ) → <code class="returnvalue">boolean</code></p>
       <p>Разбирает текст переданного документа и возвращает true, если это правильно сформированный XML. (Замечание: это псевдоним стандартной функции PostgreSQL <code class="function">xml_is_well_formed()</code>. Имя <code class="function">xml_valid()</code> технически некорректно, так как понятия правильности формата (well-formed) и допустимости (valid) в XML различаются.)</p></td></tr><tr><td class="func_table_entry"><p class="func_signature"><code class="function">xpath_string</code> ( <em class="parameter"><code>document</code></em> <code class="type">text</code>, <em class="parameter"><code>query</code></em> <code class="type">text</code> ) → <code class="returnvalue">text</code></p>
       <p>Обрабатывает запрос XPath для переданного документа и приводит результат к типу <code class="type">text</code>.</p></td></tr><tr><td class="func_table_entry"><p class="func_signature"><code class="function">xpath_number</code> ( <em class="parameter"><code>document</code></em> <code class="type">text</code>, <em class="parameter"><code>query</code></em> <code class="type">text</code> ) → <code class="returnvalue">real</code></p>
       <p>Обрабатывает запрос XPath для переданного документа и приводит результат к типу <code class="type">real</code>.</p></td></tr><tr><td class="func_table_entry"><p class="func_signature"><code class="function">xpath_bool</code> ( <em class="parameter"><code>document</code></em> <code class="type">text</code>, <em class="parameter"><code>query</code></em> <code class="type">text</code> ) → <code class="returnvalue">boolean</code></p>
       <p>Обрабатывает запрос XPath для переданного документа и приводит результат к типу <code class="type">boolean</code>.</p></td></tr><tr><td class="func_table_entry"><p class="func_signature"><code class="function">xpath_nodeset</code> ( <em class="parameter"><code>document</code></em> <code class="type">text</code>, <em class="parameter"><code>query</code></em> <code class="type">text</code>, <em class="parameter"><code>toptag</code></em> <code class="type">text</code>, <em class="parameter"><code>itemtag</code></em> <code class="type">text</code> ) → <code class="returnvalue">text</code></p>
       <p>Обрабатывает запрос для документа и помещает результат внутрь XML-тегов. Если результат содержит несколько значений, она выдаст: </p><pre class="synopsis">
&lt;toptag&gt;
&lt;itemtag&gt;Значение 1, которое может быть фрагментом XML&lt;/itemtag&gt;
&lt;itemtag&gt;Значение 2....&lt;/itemtag&gt;
&lt;/toptag&gt;
</pre><p> Если <em class="parameter"><code>toptag</code></em> или <em class="parameter"><code>toptag</code></em> — пустая строка, соответствующий тег опускается.</p></td></tr><tr><td class="func_table_entry"><p class="func_signature"><code class="function">xpath_nodeset</code> ( <em class="parameter"><code>document</code></em> <code class="type">text</code>, <em class="parameter"><code>query</code></em> <code class="type">text</code>, <em class="parameter"><code>itemtag</code></em> <code class="type">text</code> ) → <code class="returnvalue">text</code></p>
       <p>Подобна <code class="function">xpath_nodeset(document, query, toptag, itemtag)</code>, но выводит результат без <em class="parameter"><code>toptag</code></em>.</p></td></tr><tr><td class="func_table_entry"><p class="func_signature"><code class="function">xpath_nodeset</code> ( <em class="parameter"><code>document</code></em> <code class="type">text</code>, <em class="parameter"><code>query</code></em> <code class="type">text</code> ) → <code class="returnvalue">text</code></p>
       <p>Подобна <code class="function">xpath_nodeset(document, query, toptag, itemtag)</code>, но выводит результат без обоих тегов.</p></td></tr><tr><td class="func_table_entry"><p class="func_signature"><code class="function">xpath_list</code> ( <em class="parameter"><code>document</code></em> <code class="type">text</code>, <em class="parameter"><code>query</code></em> <code class="type">text</code>, <em class="parameter"><code>separator</code></em> <code class="type">text</code> ) → <code class="returnvalue">text</code></p>
       <p>Обрабатывает запрос XPath для документа и возвращает несколько значений, вставляя между ними заданный разделитель (<em class="parameter"><code>separator</code></em>), например: <code class="literal">Значение 1,Значение 2,Значение 3</code>, если <em class="parameter"><code>separator</code></em> содержит знак <code class="literal">,</code>.</p></td></tr><tr><td class="func_table_entry"><p class="func_signature"><code class="function">xpath_list</code> ( <em class="parameter"><code>document</code></em> <code class="type">text</code>, <em class="parameter"><code>query</code></em> <code class="type">text</code> ) → <code class="returnvalue">text</code></p>
       <p>Это обёртка предыдущей функции, устанавливающая в качестве разделителя знак <code class="literal">,</code>.</p></td></tr></tbody></table></div></div><br class="table-break" /></div><div class="sect2" id="XML2-XPATH-TABLE"><div class="titlepage"><div><div><h3 class="title">F.50.3. <code class="literal">xpath_table</code> <a href="#XML2-XPATH-TABLE" class="id_link">#</a></h3></div></div></div><a id="id-1.11.7.60.6.2" class="indexterm"></a><pre class="synopsis">xpath_table(text key, text document, text relation, text xpaths, text criteria) returns setof record</pre><p>Табличная функция <code class="function">xpath_table</code> выполняет набор запросов XPath для каждого из набора документов и возвращает результаты в виде таблицы. В первом столбце результата возвращается первичный ключ из таблицы документов, так что результат оказывается готовым к применению в соединениях. Параметры функции описаны в <a class="xref" href="xml2.html#XML2-XPATH-TABLE-PARAMETERS" title="Таблица F.37. Параметры xpath_table">Таблице F.37</a>.</p><div class="table" id="XML2-XPATH-TABLE-PARAMETERS"><p class="title"><strong>Таблица F.37. Параметры <code class="function">xpath_table</code></strong></p><div class="table-contents"><table class="table" summary="Параметры xpath_table" border="1"><colgroup><col class="col1" /><col class="col2" /></colgroup><thead><tr><th>Параметр</th><th>Описание</th></tr></thead><tbody><tr><td><em class="parameter"><code>key</code></em></td><td>
       <p>имя <span class="quote">«<span class="quote">ключевого</span>»</span> поля — содержимое этого поля просто окажется в первом столбце выходной таблицы, то есть оно указывает на запись, из которой была получена определённая выходная строка (см. замечание о нескольких значениях ниже)</p>
      </td></tr><tr><td><em class="parameter"><code>document</code></em></td><td>
       <p>имя поля, содержащего XML-документ</p>
      </td></tr><tr><td><em class="parameter"><code>relation</code></em></td><td>
       <p>имя таблицы (или представления), содержащей документы</p>
      </td></tr><tr><td><em class="parameter"><code>xpaths</code></em></td><td>
       <p>одно или несколько выражений XPath, разделённых символом <code class="literal">|</code></p>
      </td></tr><tr><td><em class="parameter"><code>criteria</code></em></td><td>
       <p>содержимое предложения WHERE. Оно не может быть пустым, так что если вам нужно обработать все строки в отношении, напишите <code class="literal">true</code> или <code class="literal">1=1</code></p>
      </td></tr></tbody></table></div></div><br class="table-break" /><p>Эти параметры (за исключением строк XPath) просто подставляются в обычный оператор SQL SELECT, так что у вас есть определённая гибкость — оператор выглядит так:</p><p>
   <code class="literal">SELECT &lt;key&gt;, &lt;document&gt; FROM &lt;relation&gt; WHERE &lt;criteria&gt;</code>
  </p><p>поэтому в этих параметрах можно передать <span class="emphasis"><em>всё</em></span>, что будет корректно воспринято в этих позициях. Этот SELECT должен возвращать ровно два столбца (что и будет иметь место, если только вы не перечислите несколько полей в параметрах key или document). Будьте осторожны — при таком примитивном подходе обязательно нужно проверять все значения, получаемые от пользователя, во избежание атак с инъекцией SQL.</p><p>Эта функция предназначена для использования в выражении <code class="literal">FROM</code>, с предложением <code class="literal">AS</code>, задающим выходные столбцы; например: </p><pre class="programlisting">SELECT * FROM
xpath_table('article_id',
            'article_xml',
            'articles',
            '/article/author|/article/pages|/article/title',
            'date_entered &gt; ''2003-01-01'' ')
AS t(article_id integer, author text, page_count integer, title text);</pre><p> Предложение <code class="literal">AS</code> определяет имена и типы столбцов в выходной таблице. Первым определяется <span class="quote">«<span class="quote">ключевое</span>»</span> поле, а за ним поля, соответствующие запросам XPath. Если запросов XPath больше, чем столбцов в результате, лишние запросы будут игнорироваться. Если же результирующих столбцов больше, чем запросов XPath, дополнительные столбцы принимают значение NULL.</p><p>Заметьте, что в этом примере столбец результата <code class="structname">page_count</code> определён как целочисленный. Данная функция внутри имеет дело со строковыми значениями, так что, когда вы указываете, что в результате нужно получить целое число, она берёт текстовое представление результата XPath и, применяя функции ввода PostgreSQL, преобразует её в целое число (или в тот тип, который указан в предложении <code class="type">AS</code>). Если она не сможет сделать это, произойдёт ошибка — например, если результат пустой — так что если вы допускаете возможность таких проблем с данными, возможно, будет лучше просто оставить для столбца тип <code class="type">text</code>.</p><p>Вызывающий оператор <code class="command">SELECT</code> не обязательно должен быть простым <code class="literal">SELECT *</code> — он может обращаться к выходным столбцам по именам и соединять их с другими таблицами. Эта функция формирует виртуальную таблицу, с которой вы можете выполнять любые операции, какие пожелаете (например, агрегировать, соединять, сортировать данные и т. д.). Поэтому возможен и такой запрос: </p><pre class="programlisting">SELECT t.title, p.fullname, p.email
FROM xpath_table('article_id', 'article_xml', 'articles',
                 '/article/title|/article/author/@id',
                 'xpath_string(article_xml,''/article/@date'') &gt; ''2003-03-20'' ')
       AS t(article_id integer, title text, author_id integer),
     tblPeopleInfo AS p
WHERE t.author_id = p.person_id;</pre><p> в качестве более сложного примера. Разумеется, для удобства вы можете завернуть весь этот запрос в представление.</p><div class="sect3" id="XML2-XPATH-TABLE-MULTIVALUED-RESULTS"><div class="titlepage"><div><div><h4 class="title">F.50.3.1. Результаты с набором значений <a href="#XML2-XPATH-TABLE-MULTIVALUED-RESULTS" class="id_link">#</a></h4></div></div></div><p>Функция <code class="function">xpath_table</code> рассчитана на то, что результатом каждого запроса XPath может быть набор данных, так что количество возвращённых этой функцией строк может не совпадать с количеством входных документов. В первой строке возвращается первый результат каждого запроса, во второй — второй результат и т. д. Если один из запросов возвращает меньше значений, чем другие, вместо недостающих значений будет возвращаться NULL.</p><p>В некоторых случаях пользователь знает, что некоторый запрос XPath будет возвращать только один результат (возможно, уникальный идентификатор документа) — если он используется рядом с запросом XPath, возвращающим несколько результатов, результат с одним значением будет выведен только в первой выходной строке. Чтобы исправить это, можно воспользоваться полем ключа и соединить результат с более простым запросом XPath. Например: </p><pre class="programlisting">CREATE TABLE test (
    id int PRIMARY KEY,
    xml text
);

INSERT INTO test VALUES (1, '&lt;doc num="C1"&gt;
&lt;line num="L1"&gt;&lt;a&gt;1&lt;/a&gt;&lt;b&gt;2&lt;/b&gt;&lt;c&gt;3&lt;/c&gt;&lt;/line&gt;
&lt;line num="L2"&gt;&lt;a&gt;11&lt;/a&gt;&lt;b&gt;22&lt;/b&gt;&lt;c&gt;33&lt;/c&gt;&lt;/line&gt;
&lt;/doc&gt;');

INSERT INTO test VALUES (2, '&lt;doc num="C2"&gt;
&lt;line num="L1"&gt;&lt;a&gt;111&lt;/a&gt;&lt;b&gt;222&lt;/b&gt;&lt;c&gt;333&lt;/c&gt;&lt;/line&gt;
&lt;line num="L2"&gt;&lt;a&gt;111&lt;/a&gt;&lt;b&gt;222&lt;/b&gt;&lt;c&gt;333&lt;/c&gt;&lt;/line&gt;
&lt;/doc&gt;');

SELECT * FROM
  xpath_table('id','xml','test',
              '/doc/@num|/doc/line/@num|/doc/line/a|/doc/line/b|/doc/line/c',
              'true')
  AS t(id int, doc_num varchar(10), line_num varchar(10), val1 int, val2 int, val3 int)
WHERE id = 1 ORDER BY doc_num, line_num

 id | doc_num | line_num | val1 | val2 | val3
----+---------+----------+------+------+------
  1 | C1      | L1       |    1 |    2 |    3
  1 |         | L2       |   11 |   22 |   33</pre><p>Чтобы получить <code class="literal">doc_num</code> в каждой строке, можно вызывать <code class="function">xpath_table</code> дважды и соединить результаты: </p><pre class="programlisting">SELECT t.*,i.doc_num FROM
  xpath_table('id', 'xml', 'test',
              '/doc/line/@num|/doc/line/a|/doc/line/b|/doc/line/c',
              'true')
    AS t(id int, line_num varchar(10), val1 int, val2 int, val3 int),
  xpath_table('id', 'xml', 'test', '/doc/@num', 'true')
    AS i(id int, doc_num varchar(10))
WHERE i.id=t.id AND i.id=1
ORDER BY doc_num, line_num;

 id | line_num | val1 | val2 | val3 | doc_num
----+----------+------+------+------+---------
  1 | L1       |    1 |    2 |    3 | C1
  1 | L2       |   11 |   22 |   33 | C1
(2 rows)</pre></div></div><div class="sect2" id="XML2-XSLT"><div class="titlepage"><div><div><h3 class="title">F.50.4. Функции XSLT <a href="#XML2-XSLT" class="id_link">#</a></h3></div></div></div><p>Если установлена libxslt, доступны следующие функции:</p><div class="sect3" id="XML2-XSLT-XSLT-PROCESS"><div class="titlepage"><div><div><h4 class="title">F.50.4.1. <code class="literal">xslt_process</code> <a href="#XML2-XSLT-XSLT-PROCESS" class="id_link">#</a></h4></div></div></div><a id="id-1.11.7.60.7.3.2" class="indexterm"></a><pre class="synopsis">xslt_process(text document, text stylesheet, text paramlist) returns text</pre><p>Эта функция применяет стиль XSL к документу и возвращает результат преобразования. В <code class="literal">paramlist</code> передаётся список присваиваний значений параметрам, которые будут использоваться в преобразовании, в форме <code class="literal">a=1,b=2</code>. Учтите, что разбор параметров выполнен очень просто: значения параметров не могут содержать запятые!</p><p>Есть также версия <code class="function">xslt_process</code> с двумя аргументами, которая не передаёт никакие параметры преобразованию.</p></div></div><div class="sect2" id="XML2-AUTHOR"><div class="titlepage"><div><div><h3 class="title">F.50.5. Автор <a href="#XML2-AUTHOR" class="id_link">#</a></h3></div></div></div><p>Джон Грей <code class="email">&lt;<a class="email" href="mailto:jgray@azuli.co.uk">jgray@azuli.co.uk</a>&gt;</code></p><p>Разработку этого модуля спонсировала компания Torchbox Ltd. (www.torchbox.com). Этот модуль выпускается под той же лицензией BSD, что и PostgreSQL.</p></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="uuid-ossp.html" title="F.49. uuid-ossp — генератор UUID">Пред.</a> </td><td width="20%" align="center"><a accesskey="u" href="contrib.html" title="Приложение F. Дополнительно поставляемые модули и расширения">Наверх</a></td><td width="40%" align="right"> <a accesskey="n" href="contrib-prog.html" title="Приложение G. Дополнительно поставляемые программы">След.</a></td></tr><tr><td width="40%" align="left" valign="top">F.49. uuid-ossp — генератор UUID </td><td width="20%" align="center"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="40%" align="right" valign="top"> Приложение G. Дополнительно поставляемые программы</td></tr></table></div></body></html>