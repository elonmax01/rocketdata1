<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>51.2. Обработчики модулей архивирования</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@lists.postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets Vsnapshot" /><link rel="prev" href="archive-module-init.html" title="51.1. Функции инициализации" /><link rel="next" href="reference.html" title="Часть VI. Справочное руководство" /></head><body id="docContent" class="container-fluid col-10"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="5" align="center">51.2. Обработчики модулей архивирования</th></tr><tr><td width="10%" align="left"><a accesskey="p" href="archive-module-init.html" title="51.1. Функции инициализации">Пред.</a> </td><td width="10%" align="left"><a accesskey="u" href="archive-modules.html" title="Глава 51. Модули архивирования">Наверх</a></td><th width="60%" align="center">Глава 51. Модули архивирования</th><td width="10%" align="right"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="10%" align="right"> <a accesskey="n" href="reference.html" title="Часть VI. Справочное руководство">След.</a></td></tr></table><hr /></div><div class="sect1" id="ARCHIVE-MODULE-CALLBACKS"><div class="titlepage"><div><div><h2 class="title" style="clear: both">51.2. Обработчики модулей архивирования <a href="#ARCHIVE-MODULE-CALLBACKS" class="id_link">#</a></h2></div></div></div><div class="toc"><dl class="toc"><dt><span class="sect2"><a href="archive-module-callbacks.html#ARCHIVE-MODULE-STARTUP">51.2.1. Обработчик запуска</a></span></dt><dt><span class="sect2"><a href="archive-module-callbacks.html#ARCHIVE-MODULE-CHECK">51.2.2. Обработчик проверки</a></span></dt><dt><span class="sect2"><a href="archive-module-callbacks.html#ARCHIVE-MODULE-ARCHIVE">51.2.3. Обработчик архивирования</a></span></dt><dt><span class="sect2"><a href="archive-module-callbacks.html#ARCHIVE-MODULE-SHUTDOWN">51.2.4. Обработчик выключения</a></span></dt></dl></div><p>Обработчики архивирования определяют, как именно модуль будет выполнять архивирование. Сервер будет вызывать их по мере необходимости для обработки каждого отдельного файла WAL.</p><div class="sect2" id="ARCHIVE-MODULE-STARTUP"><div class="titlepage"><div><div><h3 class="title">51.2.1. Обработчик запуска <a href="#ARCHIVE-MODULE-STARTUP" class="id_link">#</a></h3></div></div></div><p>Обработчик <code class="function">startup_cb</code> вызывается вскоре после загрузки модуля. Этот обработчик можно использовать для любой необходимой дополнительной инициализации. Если есть данные о состоянии модуля архивирования, обработчик может использовать <code class="structfield">state-&gt;private_data</code> для их хранения. </p><pre class="programlisting">typedef void (*ArchiveStartupCB) (ArchiveModuleState *state);</pre></div><div class="sect2" id="ARCHIVE-MODULE-CHECK"><div class="titlepage"><div><div><h3 class="title">51.2.2. Обработчик проверки <a href="#ARCHIVE-MODULE-CHECK" class="id_link">#</a></h3></div></div></div><p>Обработчик <code class="function">check_configured_cb</code> вызывается, чтобы проверить, полностью ли настроен модуль и готов ли он принимать файлы WAL (в частности, что для его параметров конфигурации установлены допустимые значения). Если функция <code class="function">check_configured_cb</code> не определена, сервер всегда предполагает, что модуль готов к работе. </p><pre class="programlisting">typedef bool (*ArchiveCheckConfiguredCB) (ArchiveModuleState *state);</pre><p> Если возвращается <code class="literal">true</code>, сервер перейдёт к архивированию файла, вызвав обработчик <code class="function">archive_file_cb</code>. Если возвращается <code class="literal">false</code>, архивирование не производится и архиватор выдаст в журнал сервера следующее сообщение: </p><pre class="screen">
ВНИМАНИЕ: включён режим archive_mode, но архивирование не настроено
</pre><p> В последнем случае сервер будет периодически вызывать эту функцию, и архивирование начнётся только тогда, когда она вернёт <code class="literal">true</code>.</p></div><div class="sect2" id="ARCHIVE-MODULE-ARCHIVE"><div class="titlepage"><div><div><h3 class="title">51.2.3. Обработчик архивирования <a href="#ARCHIVE-MODULE-ARCHIVE" class="id_link">#</a></h3></div></div></div><p>Обработчик <code class="function">archive_file_cb</code> вызывается для архивирования одного файла WAL. </p><pre class="programlisting">typedef bool (*ArchiveFileCB) (ArchiveModuleState *state, const char *file, const char *path);</pre><p> Если возвращается <code class="literal">true</code>, сервер считает, что файл был успешно заархивирован, и может переработать или удалить исходный файл WAL. Если возвращается <code class="literal">false</code>, сервер сохранит исходный файл WAL и повторит попытку архивирования позже. Аргумент <em class="replaceable"><code>файл</code></em> содержит только имя архивируемого файла WAL, а <em class="replaceable"><code>путь</code></em> содержит полный путь к файлу WAL (включая имя файла).</p></div><div class="sect2" id="ARCHIVE-MODULE-SHUTDOWN"><div class="titlepage"><div><div><h3 class="title">51.2.4. Обработчик выключения <a href="#ARCHIVE-MODULE-SHUTDOWN" class="id_link">#</a></h3></div></div></div><p>Обработчик <code class="function">shutdown_cb</code> вызывается, когда завершается процесс архиватора (например, после ошибки) или изменяется значение <a class="xref" href="runtime-config-wal.html#GUC-ARCHIVE-LIBRARY">archive_library</a>. Если функция <code class="function">shutdown_cb</code> не определена, никакие специальные действия в этих случаях не предпринимаются. Если есть данные о состоянии модуля архивирования, этот обработчик должен удалить их во избежание утечек. </p><pre class="programlisting">typedef void (*ArchiveShutdownCB) (ArchiveModuleState *state);</pre></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="archive-module-init.html" title="51.1. Функции инициализации">Пред.</a> </td><td width="20%" align="center"><a accesskey="u" href="archive-modules.html" title="Глава 51. Модули архивирования">Наверх</a></td><td width="40%" align="right"> <a accesskey="n" href="reference.html" title="Часть VI. Справочное руководство">След.</a></td></tr><tr><td width="40%" align="left" valign="top">51.1. Функции инициализации </td><td width="20%" align="center"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="40%" align="right" valign="top"> Часть VI. Справочное руководство</td></tr></table></div></body></html>