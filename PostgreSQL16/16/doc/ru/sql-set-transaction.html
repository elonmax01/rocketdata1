<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>SET TRANSACTION</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@lists.postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets Vsnapshot" /><link rel="prev" href="sql-set-session-authorization.html" title="SET SESSION AUTHORIZATION" /><link rel="next" href="sql-show.html" title="SHOW" /></head><body id="docContent" class="container-fluid col-10"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="5" align="center">SET TRANSACTION</th></tr><tr><td width="10%" align="left"><a accesskey="p" href="sql-set-session-authorization.html" title="SET SESSION AUTHORIZATION">Пред.</a> </td><td width="10%" align="left"><a accesskey="u" href="sql-commands.html" title="Команды SQL">Наверх</a></td><th width="60%" align="center">Команды SQL</th><td width="10%" align="right"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="10%" align="right"> <a accesskey="n" href="sql-show.html" title="SHOW">След.</a></td></tr></table><hr /></div><div class="refentry" id="SQL-SET-TRANSACTION"><div class="titlepage"></div><a id="id-1.9.3.178.1" class="indexterm"></a><a id="id-1.9.3.178.2" class="indexterm"></a><a id="id-1.9.3.178.3" class="indexterm"></a><a id="id-1.9.3.178.4" class="indexterm"></a><div class="refnamediv"><h2><span class="refentrytitle">SET TRANSACTION</span></h2><p>SET TRANSACTION — установить характеристики текущей транзакции</p></div><div class="refsynopsisdiv"><h2>Синтаксис</h2><pre class="synopsis">SET TRANSACTION <em class="replaceable"><code>режим_транзакции</code></em> [, ...]
SET TRANSACTION SNAPSHOT <em class="replaceable"><code>id_снимка</code></em>
SET SESSION CHARACTERISTICS AS TRANSACTION <em class="replaceable"><code>режим_транзакции</code></em> [, ...]

<span class="phrase">Где <em class="replaceable"><code>режим_транзакции</code></em> может быть следующим:</span>

    ISOLATION LEVEL { SERIALIZABLE | REPEATABLE READ | READ COMMITTED | READ UNCOMMITTED }
    READ WRITE | READ ONLY
    [ NOT ] DEFERRABLE</pre></div><div class="refsect1" id="id-1.9.3.178.8"><h2>Описание</h2><p>Команда <code class="command">SET TRANSACTION</code> устанавливает характеристики текущей транзакции. На последующие транзакции она не влияет. <code class="command">SET SESSION CHARACTERISTICS</code> устанавливает характеристики транзакции по умолчанию для последующих транзакций в рамках сеанса. Заданные по умолчанию характеристики затем можно переопределить для отдельных транзакций командой <code class="command">SET TRANSACTION</code>.</p><p>К характеристикам транзакции относится уровень изоляции транзакции, режим доступа транзакции (чтение/запись или только чтение) и допустимость её откладывания. В дополнение к ним можно выбрать снимок, но только для текущей транзакции, не для сеанса по умолчанию.</p><p>Уровень изоляции транзакции определяет, какие данные может видеть транзакция, когда параллельно с ней выполняются другие транзакции: </p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">READ COMMITTED</code></span></dt><dd><p>Оператор видит только те строки, которые были зафиксированы до начала его выполнения. Этот уровень устанавливается по умолчанию.</p></dd><dt><span class="term"><code class="literal">REPEATABLE READ</code></span></dt><dd><p>Все операторы текущей транзакции видят только те строки, которые были зафиксированы перед первым запросом на выборку или изменение данных, выполненным в этой транзакции.</p></dd><dt><span class="term"><code class="literal">SERIALIZABLE</code></span></dt><dd><p>Все операторы текущей транзакции видят только те строки, которые были зафиксированы перед первым запросом на выборку или изменение данных, выполненным в этой транзакции. Если наложение операций чтения и записи параллельных сериализуемых транзакций может привести к ситуации, невозможной при последовательном их выполнении (когда одна транзакция выполняется за другой), произойдёт откат одной из транзакций с ошибкой <code class="literal">serialization_failure</code> (сбой сериализации).</p></dd></dl></div><p> В стандарте SQL определён ещё один уровень, <code class="literal">READ UNCOMMITTED</code>. В <span class="productname">PostgreSQL</span> уровень <code class="literal">READ UNCOMMITTED</code> обрабатывается как <code class="literal">READ COMMITTED</code>.</p><p>Уровень изоляции транзакции нельзя изменить после выполнения первого запроса на выборку или изменение данных (<code class="command">SELECT</code>, <code class="command">INSERT</code>, <code class="command">DELETE</code>, <code class="command">UPDATE</code>, <code class="command">MERGE</code>, <code class="command">FETCH</code> или <code class="command">COPY</code>) в текущей транзакции. За дополнительными сведениями об изоляции транзакций и управлении параллельным доступом обратитесь к <a class="xref" href="mvcc.html" title="Глава 13. Управление конкурентным доступом">Главе 13</a>.</p><p>Режим доступа транзакции определяет, будет ли транзакция только читать данные или будет и читать, и писать. По умолчанию подразумевается чтение/запись. В транзакции без записи запрещаются следующие команды SQL: <code class="command">INSERT</code>, <code class="command">UPDATE</code>, <code class="command">DELETE</code>, <code class="command">MERGE</code> и <code class="command">COPY FROM</code>, если только целевая таблица не временная; любые команды <code class="literal">CREATE</code>, <code class="literal">ALTER</code> и <code class="literal">DROP</code>, а также <code class="literal">COMMENT</code>, <code class="literal">GRANT</code>, <code class="literal">REVOKE</code>, <code class="literal">TRUNCATE</code>; кроме того, запрещаются <code class="literal">EXPLAIN ANALYZE</code> и <code class="literal">EXECUTE</code>, если команда, которую они должны выполнить, относится к вышеперечисленным. Это высокоуровневое определение режима только для чтения, которое в принципе не исключает запись на диск.</p><p>Свойство <code class="literal">DEFERRABLE</code> оказывает влияние, только если транзакция находится также в режимах <code class="literal">SERIALIZABLE</code> и <code class="literal">READ ONLY</code>. Когда для транзакции установлены все три этих свойства, транзакция может быть заблокирована при первой попытке получить свой снимок данных, после чего она сможет выполняться без дополнительных усилий, обычных для режима <code class="literal">SERIALIZABLE</code>, и без риска привести к сбою сериализации или пострадать от него. Этот режим подходит для длительных операций, например для построения отчётов или резервного копирования.</p><p>Команда <code class="literal">SET TRANSACTION SNAPSHOT</code> позволяет выполнить новую транзакцию со <em class="firstterm">снимком данных</em>, который имеет уже существующая. Эта ранее созданная транзакция должна экспортировать этот снимок с помощью функции <code class="literal">pg_export_snapshot</code> (см. <a class="xref" href="functions-admin.html#FUNCTIONS-SNAPSHOT-SYNCHRONIZATION" title="9.27.5. Функции синхронизации снимков">Подраздел 9.27.5</a>). Эта функция возвращает идентификатор снимка, который и нужно передать команде <code class="literal">SET TRANSACTION SNAPSHOT</code> в качестве идентификатора импортируемого снимка. В данной команде этот идентификатор должен записываться в виде строковой константы, например <code class="literal">'00000003-0000001B-1'</code>. <code class="literal">SET TRANSACTION SNAPSHOT</code> можно выполнить только в начале транзакции, до первого запроса на выборку или изменение данных (<code class="command">SELECT</code>, <code class="command">INSERT</code>, <code class="command">DELETE</code>, <code class="command">UPDATE</code>, <code class="command">MERGE</code>, <code class="command">FETCH</code> или <code class="command">COPY</code>) в текущей транзакции. Более того, для транзакции уже должен быть установлен уровень изоляции <code class="literal">SERIALIZABLE</code> или <code class="literal">REPEATABLE READ</code> (в противном случае снимок будет сразу же потерян, так как на уровне <code class="literal">READ COMMITTED</code> для каждой команды делается новый снимок). Если импортирующая транзакция работает на уровне изоляции <code class="literal">SERIALIZABLE</code>, то транзакция, экспортирующая снимок, также должна работать на этом уровне. Кроме того, транзакции в режиме чтение/запись не могут импортировать снимок из транзакции в режиме «только чтение».</p></div><div class="refsect1" id="id-1.9.3.178.9"><h2>Замечания</h2><p>Если команде <code class="command">SET TRANSACTION</code> не предшествует <code class="command">START TRANSACTION</code> или <code class="command">BEGIN</code>, она выдаёт предупреждение и больше ничего не делает.</p><p>Без <code class="command">SET TRANSACTION</code> можно обойтись, задав требуемые <em class="replaceable"><code>режимы_транзакции</code></em> в операторах <code class="command">BEGIN</code> или <code class="command">START TRANSACTION</code>. Но для <code class="command">SET TRANSACTION SNAPSHOT</code> такой возможности не предусмотрено.</p><p>Режимы транзакции для сеанса по умолчанию можно также задать или прочитать в конфигурационных переменных <a class="xref" href="runtime-config-client.html#GUC-DEFAULT-TRANSACTION-ISOLATION">default_transaction_isolation</a>, <a class="xref" href="runtime-config-client.html#GUC-DEFAULT-TRANSACTION-READ-ONLY">default_transaction_read_only</a> и <a class="xref" href="runtime-config-client.html#GUC-DEFAULT-TRANSACTION-DEFERRABLE">default_transaction_deferrable</a>. (На практике, <code class="command">SET SESSION CHARACTERISTICS</code> — это просто более многословная альтернатива изменению этих переменных командой <code class="command">SET</code>.) Это значит, что значения этих переменных по умолчанию можно задать в файле конфигурации, с помощью команды <code class="command">ALTER DATABASE</code> и т. д. За дополнительными сведениями обратитесь к <a class="xref" href="runtime-config.html" title="Глава 20. Настройка сервера">Главе 20</a>.</p><p>Режимы текущей транзакции можно также задать или прочитать в конфигурационных переменных <a class="xref" href="runtime-config-client.html#GUC-DEFAULT-TRANSACTION-ISOLATION">default_transaction_isolation</a>, <a class="xref" href="runtime-config-client.html#GUC-TRANSACTION-READ-ONLY">transaction_read_only</a> и <a class="xref" href="runtime-config-client.html#GUC-TRANSACTION-DEFERRABLE">transaction_deferrable</a>. Присвоение значения одному из этих параметров равнозначна использованию <code class="command">SET TRANSACTION</code> с теми же ограничениями по применению. Однако эти параметры нельзя задать в конфигурационном файле или каким-то ещё образом, кроме как непосредственно в SQL.</p></div><div class="refsect1" id="id-1.9.3.178.10"><h2>Примеры</h2><p>Чтобы начать новую транзакцию со снимком данных, который получила уже существующая транзакция, его нужно сначала экспортировать из первой транзакции. При этом будет получен идентификатор снимка, например: </p><pre class="programlisting">BEGIN TRANSACTION ISOLATION LEVEL REPEATABLE READ;
SELECT pg_export_snapshot();
 pg_export_snapshot
---------------------
 00000003-0000001B-1
(1 row)</pre><p> Затем этот идентификатор нужно передать команде <code class="command">SET TRANSACTION SNAPSHOT</code> в начале новой транзакции: </p><pre class="programlisting">BEGIN TRANSACTION ISOLATION LEVEL REPEATABLE READ;
SET TRANSACTION SNAPSHOT '00000003-0000001B-1';</pre></div><div class="refsect1" id="R1-SQL-SET-TRANSACTION-3"><h2>Совместимость</h2><p>Эти команды определены в стандарте <acronym class="acronym">SQL</acronym>, за исключением режима транзакции <code class="literal">DEFERRABLE</code> и формы <code class="command">SET TRANSACTION SNAPSHOT</code>, которые являются расширениями <span class="productname">PostgreSQL</span>.</p><p>В стандарте уровнем изоляции по умолчанию является <code class="literal">SERIALIZABLE</code>. В <span class="productname">PostgreSQL</span> уровнем по умолчанию обычно считается <code class="literal">READ COMMITTED</code>, но его можно изменить, как описано выше.</p><p>В стандарте SQL есть ещё одна характеристика транзакции, которую нельзя задать этими командами: размер диагностической области. Эта специфическая концепция встраиваемого SQL, поэтому в сервере <span class="productname">PostgreSQL</span> она не реализована.</p><p>Стандарт SQL требует, чтобы последовательные <em class="replaceable"><code>режимы_транзакций</code></em> разделялись запятыми, но по историческим причинам <span class="productname">PostgreSQL</span> позволяет опустить запятые.</p></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="sql-set-session-authorization.html" title="SET SESSION AUTHORIZATION">Пред.</a> </td><td width="20%" align="center"><a accesskey="u" href="sql-commands.html" title="Команды SQL">Наверх</a></td><td width="40%" align="right"> <a accesskey="n" href="sql-show.html" title="SHOW">След.</a></td></tr><tr><td width="40%" align="left" valign="top">SET SESSION AUTHORIZATION </td><td width="20%" align="center"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="40%" align="right" valign="top"> SHOW</td></tr></table></div></body></html>