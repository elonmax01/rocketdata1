<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>9.29. Функции событийных триггеров</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@lists.postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets Vsnapshot" /><link rel="prev" href="functions-trigger.html" title="9.28. Триггерные функции" /><link rel="next" href="functions-statistics.html" title="9.30. Системные информационные функции" /></head><body id="docContent" class="container-fluid col-10"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="5" align="center">9.29. Функции событийных триггеров</th></tr><tr><td width="10%" align="left"><a accesskey="p" href="functions-trigger.html" title="9.28. Триггерные функции">Пред.</a> </td><td width="10%" align="left"><a accesskey="u" href="functions.html" title="Глава 9. Функции и операторы">Наверх</a></td><th width="60%" align="center">Глава 9. Функции и операторы</th><td width="10%" align="right"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="10%" align="right"> <a accesskey="n" href="functions-statistics.html" title="9.30. Системные информационные функции">След.</a></td></tr></table><hr /></div><div class="sect1" id="FUNCTIONS-EVENT-TRIGGERS"><div class="titlepage"><div><div><h2 class="title" style="clear: both">9.29. Функции событийных триггеров <a href="#FUNCTIONS-EVENT-TRIGGERS" class="id_link">#</a></h2></div></div></div><div class="toc"><dl class="toc"><dt><span class="sect2"><a href="functions-event-triggers.html#PG-EVENT-TRIGGER-DDL-COMMAND-END-FUNCTIONS">9.29.1. Получение изменений в конце команды</a></span></dt><dt><span class="sect2"><a href="functions-event-triggers.html#PG-EVENT-TRIGGER-SQL-DROP-FUNCTIONS">9.29.2. Обработка объектов, удалённых командой DDL</a></span></dt><dt><span class="sect2"><a href="functions-event-triggers.html#PG-EVENT-TRIGGER-TABLE-REWRITE-FUNCTIONS">9.29.3. Обработка события перезаписи таблицы</a></span></dt></dl></div><p><span class="productname">PostgreSQL</span> предоставляет следующие вспомогательные функции для получения информации в событийных триггерах.</p><p>Подробнее о событийных триггерах можно узнать в <a class="xref" href="event-triggers.html" title="Глава 40. Триггеры событий">Главе 40</a>.</p><div class="sect2" id="PG-EVENT-TRIGGER-DDL-COMMAND-END-FUNCTIONS"><div class="titlepage"><div><div><h3 class="title">9.29.1. Получение изменений в конце команды <a href="#PG-EVENT-TRIGGER-DDL-COMMAND-END-FUNCTIONS" class="id_link">#</a></h3></div></div></div><a id="id-1.5.8.35.4.2" class="indexterm"></a><pre class="synopsis"><code class="function">pg_event_trigger_ddl_commands</code> () → <code class="returnvalue">setof record</code></pre><p>Функция <code class="function">pg_event_trigger_ddl_commands</code> возвращает список команд <acronym class="acronym">DDL</acronym>, выполняемых в результате действия пользователя. Вызывать её можно только в функции, реализующей событийный триггер <code class="literal">ddl_command_end</code>. При попытке вызвать её в любом другом контексте возникнет ошибка. Функция <code class="function">pg_event_trigger_ddl_commands</code> возвращает одну строку для каждой базовой команды; для некоторых команд, записываемых в виде одного предложения SQL, может возвращаться несколько строк. Эта функция возвращает следующие столбцы: </p><div class="informaltable"><table class="informaltable" border="1"><colgroup><col /><col /><col /></colgroup><thead><tr><th>Name</th><th>Тип</th><th>Описание</th></tr></thead><tbody><tr><td><code class="literal">classid</code></td><td><code class="type">oid</code></td><td>OID каталога, к которому относится объект</td></tr><tr><td><code class="literal">objid</code></td><td><code class="type">oid</code></td><td>OID самого объекта</td></tr><tr><td><code class="literal">objsubid</code></td><td><code class="type">integer</code></td><td>Идентификатор подобъекта (например, номер для столбца)</td></tr><tr><td><code class="literal">command_tag</code></td><td><code class="type">text</code></td><td>Тег команды</td></tr><tr><td><code class="literal">object_type</code></td><td><code class="type">text</code></td><td>Тип объекта</td></tr><tr><td><code class="literal">schema_name</code></td><td><code class="type">text</code></td><td>Имя схемы, к которой относится объект; если объект не относится ни к какой схеме — <code class="literal">NULL</code>. В кавычки имя не заключается.</td></tr><tr><td><code class="literal">object_identity</code></td><td><code class="type">text</code></td><td>Текстовое представление идентификатора объекта, включающее схему. При необходимости компоненты этого идентификатора заключаются в кавычки.</td></tr><tr><td><code class="literal">in_extension</code></td><td><code class="type">boolean</code></td><td>True, если команда является частью скрипта расширения</td></tr><tr><td><code class="literal">command</code></td><td><code class="type">pg_ddl_command</code></td><td>Полное представление команды, во внутреннем формате. Его нельзя вывести непосредственно, но можно передать другим функциям, чтобы получить различные сведения о команде.</td></tr></tbody></table></div></div><div class="sect2" id="PG-EVENT-TRIGGER-SQL-DROP-FUNCTIONS"><div class="titlepage"><div><div><h3 class="title">9.29.2. Обработка объектов, удалённых командой DDL <a href="#PG-EVENT-TRIGGER-SQL-DROP-FUNCTIONS" class="id_link">#</a></h3></div></div></div><a id="id-1.5.8.35.5.2" class="indexterm"></a><pre class="synopsis"><code class="function">pg_event_trigger_dropped_objects</code> () → <code class="returnvalue">setof record</code></pre><p>Функция <code class="function">pg_event_trigger_dropped_objects</code> выдаёт список всех объектов, удалённых командой, для которых вызывалось событие <code class="literal">sql_drop</code>. При вызове в любом другом контексте происходит ошибка. Эта функция выдаёт следующие столбцы: </p><div class="informaltable"><table class="informaltable" border="1"><colgroup><col /><col /><col /></colgroup><thead><tr><th>Name</th><th>Тип</th><th>Описание</th></tr></thead><tbody><tr><td><code class="literal">classid</code></td><td><code class="type">oid</code></td><td>OID каталога, к которому относился объект</td></tr><tr><td><code class="literal">objid</code></td><td><code class="type">oid</code></td><td>OID самого объекта</td></tr><tr><td><code class="literal">objsubid</code></td><td><code class="type">integer</code></td><td>Идентификатор подобъекта (например, номер для столбца)</td></tr><tr><td><code class="literal">original</code></td><td><code class="type">boolean</code></td><td>True, если это один из корневых удаляемых объектов</td></tr><tr><td><code class="literal">normal</code></td><td><code class="type">boolean</code></td><td>True, если к этому объекту в графе зависимостей привело отношение обычной зависимости</td></tr><tr><td><code class="literal">is_temporary</code></td><td><code class="type">boolean</code></td><td>True, если объект был временным</td></tr><tr><td><code class="literal">object_type</code></td><td><code class="type">text</code></td><td>Тип объекта</td></tr><tr><td><code class="literal">schema_name</code></td><td><code class="type">text</code></td><td>Имя схемы, к которой относился объект; если объект не относился ни к какой схеме — <code class="literal">NULL</code>. В кавычки имя не заключается.</td></tr><tr><td><code class="literal">object_name</code></td><td><code class="type">text</code></td><td>Имя объекта, если сочетание схемы и имени позволяет уникально идентифицировать объект; в противном случае — <code class="literal">NULL</code>. Имя не заключается в кавычки и не дополняется именем схемы.</td></tr><tr><td><code class="literal">object_identity</code></td><td><code class="type">text</code></td><td>Текстовое представление идентификатора объекта, включающее схему. При необходимости компоненты этого идентификатора заключаются в кавычки.</td></tr><tr><td><code class="literal">address_names</code></td><td><code class="type">text[]</code></td><td>Массив, который в сочетании с <code class="literal">object_type</code> и массивом <code class="literal">address_args</code> можно передать функции <code class="function">pg_get_object_address</code>, чтобы воссоздать адрес объекта на удалённом сервере, содержащем одноимённый объект того же рода.</td></tr><tr><td><code class="literal">address_args</code></td><td><code class="type">text[]</code></td><td>Дополнение к массиву <code class="literal">address_names</code></td></tr></tbody></table></div><p>Функцию <code class="function">pg_event_trigger_dropped_objects</code> можно использовать в событийном триггере так: </p><pre class="programlisting">CREATE FUNCTION test_event_trigger_for_drops()
        RETURNS event_trigger LANGUAGE plpgsql AS $$
DECLARE
    obj record;
BEGIN
    FOR obj IN SELECT * FROM pg_event_trigger_dropped_objects()
    LOOP
        RAISE NOTICE '% dropped object: % %.% %',
                     tg_tag,
                     obj.object_type,
                     obj.schema_name,
                     obj.object_name,
                     obj.object_identity;
    END LOOP;
END;
$$;
CREATE EVENT TRIGGER test_event_trigger_for_drops
   ON sql_drop
   EXECUTE FUNCTION test_event_trigger_for_drops();</pre></div><div class="sect2" id="PG-EVENT-TRIGGER-TABLE-REWRITE-FUNCTIONS"><div class="titlepage"><div><div><h3 class="title">9.29.3. Обработка события перезаписи таблицы <a href="#PG-EVENT-TRIGGER-TABLE-REWRITE-FUNCTIONS" class="id_link">#</a></h3></div></div></div><p>В <a class="xref" href="functions-event-triggers.html#FUNCTIONS-EVENT-TRIGGER-TABLE-REWRITE" title="Таблица 9.104. Функции получения информации о перезаписи таблицы">Таблице 9.104</a> показаны функции, выдающие информацию о таблице, для которой произошло событие перезаписи таблицы (<code class="literal">table_rewrite</code>). При попытке вызвать их в другом контексте возникнет ошибка.</p><div class="table" id="FUNCTIONS-EVENT-TRIGGER-TABLE-REWRITE"><p class="title"><strong>Таблица 9.104. Функции получения информации о перезаписи таблицы</strong></p><div class="table-contents"><table class="table" summary="Функции получения информации о перезаписи таблицы" border="1"><colgroup><col /></colgroup><thead><tr><th class="func_table_entry"><p class="func_signature">Функция</p>
       <p>Описание</p></th></tr></thead><tbody><tr><td class="func_table_entry"><p class="func_signature"><a id="id-1.5.8.35.6.3.2.2.1.1.1.1" class="indexterm"></a> <code class="function">pg_event_trigger_table_rewrite_oid</code> () → <code class="returnvalue">oid</code></p>
       <p>Выдаёт OID таблицы, которая будет перезаписана.</p></td></tr><tr><td class="func_table_entry"><p class="func_signature"><a id="id-1.5.8.35.6.3.2.2.2.1.1.1" class="indexterm"></a> <code class="function">pg_event_trigger_table_rewrite_reason</code> () → <code class="returnvalue">integer</code></p>
       <p>Выдаёт код причины, вызвавшей перезапись. Конкретные значения кодов зависят от версии сервера.</p></td></tr></tbody></table></div></div><br class="table-break" /><p>Эти функции можно использовать в событийном триггере так: </p><pre class="programlisting">CREATE FUNCTION test_event_trigger_table_rewrite_oid()
 RETURNS event_trigger
 LANGUAGE plpgsql AS
$$
BEGIN
  RAISE NOTICE 'rewriting table % for reason %',
                pg_event_trigger_table_rewrite_oid()::regclass,
                pg_event_trigger_table_rewrite_reason();
END;
$$;

CREATE EVENT TRIGGER test_table_rewrite_oid
                  ON table_rewrite
   EXECUTE FUNCTION test_event_trigger_table_rewrite_oid();</pre></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="functions-trigger.html" title="9.28. Триггерные функции">Пред.</a> </td><td width="20%" align="center"><a accesskey="u" href="functions.html" title="Глава 9. Функции и операторы">Наверх</a></td><td width="40%" align="right"> <a accesskey="n" href="functions-statistics.html" title="9.30. Системные информационные функции">След.</a></td></tr><tr><td width="40%" align="left" valign="top">9.28. Триггерные функции </td><td width="20%" align="center"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="40%" align="right" valign="top"> 9.30. Системные информационные функции</td></tr></table></div></body></html>