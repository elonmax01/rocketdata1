<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>F.4. auto_explain — протоколирование планов выполнения медленных запросов</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@lists.postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets Vsnapshot" /><link rel="prev" href="auth-delay.html" title="F.3. auth_delay — задержка при ошибке аутентификации" /><link rel="next" href="basebackup-to-shell.html" title="F.5. basebackup_to_shell — пример создания получателей резервной копии для модуля pg_basebackup" /></head><body id="docContent" class="container-fluid col-10"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="5" align="center">F.4. auto_explain — протоколирование планов выполнения медленных запросов</th></tr><tr><td width="10%" align="left"><a accesskey="p" href="auth-delay.html" title="F.3. auth_delay — задержка при ошибке аутентификации">Пред.</a> </td><td width="10%" align="left"><a accesskey="u" href="contrib.html" title="Приложение F. Дополнительно поставляемые модули и расширения">Наверх</a></td><th width="60%" align="center">Приложение F. Дополнительно поставляемые модули и расширения</th><td width="10%" align="right"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="10%" align="right"> <a accesskey="n" href="basebackup-to-shell.html" title="F.5. basebackup_to_shell — пример создания получателей резервной копии для модуля pg_basebackup">След.</a></td></tr></table><hr /></div><div class="sect1" id="AUTO-EXPLAIN"><div class="titlepage"><div><div><h2 class="title" style="clear: both">F.4. auto_explain — протоколирование планов выполнения медленных запросов <a href="#AUTO-EXPLAIN" class="id_link">#</a></h2></div></div></div><div class="toc"><dl class="toc"><dt><span class="sect2"><a href="auto-explain.html#AUTO-EXPLAIN-CONFIGURATION-PARAMETERS">F.4.1. Параметры конфигурации</a></span></dt><dt><span class="sect2"><a href="auto-explain.html#AUTO-EXPLAIN-EXAMPLE">F.4.2. Пример</a></span></dt><dt><span class="sect2"><a href="auto-explain.html#AUTO-EXPLAIN-AUTHOR">F.4.3. Автор</a></span></dt></dl></div><a id="id-1.11.7.14.2" class="indexterm"></a><p>Модуль <code class="filename">auto_explain</code> предоставляет возможность автоматического протоколирования планов выполнения медленных операторов, что позволяет обойтись без выполнения <a class="xref" href="sql-explain.html" title="EXPLAIN"><span class="refentrytitle">EXPLAIN</span></a> вручную. Это особенно полезно для выявления неоптимизированных запросов в больших приложениях.</p><p>Этот модуль не предоставляет функций, доступных из SQL. Чтобы использовать его, просто загрузите его в процесс сервера. Это можно сделать в отдельном сеансе: </p><pre class="programlisting">LOAD 'auto_explain';</pre><p> (Для этого нужно быть суперпользователем.) Более типична конфигурация, когда он загружается в некоторые или все сеансы в результате включения <code class="literal">auto_explain</code> в переменную <a class="xref" href="runtime-config-client.html#GUC-SESSION-PRELOAD-LIBRARIES">session_preload_libraries</a> или в <a class="xref" href="runtime-config-client.html#GUC-SHARED-PRELOAD-LIBRARIES">shared_preload_libraries</a> в файле <code class="filename">postgresql.conf</code>. Загрузив этот модуль, вы можете отслеживать исключительно медленные запросы, вне зависимости от того, когда они происходят. Конечно, это имеет свою цену.</p><div class="sect2" id="AUTO-EXPLAIN-CONFIGURATION-PARAMETERS"><div class="titlepage"><div><div><h3 class="title">F.4.1. Параметры конфигурации <a href="#AUTO-EXPLAIN-CONFIGURATION-PARAMETERS" class="id_link">#</a></h3></div></div></div><p>Есть несколько параметров конфигурации, которые управляют поведением <code class="filename">auto_explain</code>. Заметьте, что поведение по умолчанию сводится к бездействию, так что необходимо установить как минимум переменную <code class="varname">auto_explain.log_min_duration</code>, если вы хотите получить какие-либо результаты.</p><div class="variablelist"><dl class="variablelist"><dt id="AUTO-EXPLAIN-CONFIGURATION-PARAMETERS-LOG-MIN-DURATION"><span class="term"><code class="varname">auto_explain.log_min_duration</code> (<code class="type">integer</code>) <a id="id-1.11.7.14.5.3.1.1.3" class="indexterm"></a></span> <a href="#AUTO-EXPLAIN-CONFIGURATION-PARAMETERS-LOG-MIN-DURATION" class="id_link">#</a></dt><dd><p>Переменная <code class="varname">auto_explain.log_min_duration</code> задаёт время выполнения оператора, в миллисекундах, при превышении которого план оператора будет протоколироваться. При значении, равном <code class="literal">0</code>, протоколируются все планы, а при <code class="literal">-1</code> (по умолчанию) протоколирование планов отключается. Например, если вы установите значение <code class="literal">250ms</code>, протоколироваться будут все запросы, выполняющиеся 250 мс и дольше. Изменить этот параметр могут только суперпользователи.</p></dd><dt id="AUTO-EXPLAIN-CONFIGURATION-PARAMETERS-LOG-PARAMETER-MAX-LENGTH"><span class="term"><code class="varname">auto_explain.log_parameter_max_length</code> (<code class="type">integer</code>) <a id="id-1.11.7.14.5.3.2.1.3" class="indexterm"></a></span> <a href="#AUTO-EXPLAIN-CONFIGURATION-PARAMETERS-LOG-PARAMETER-MAX-LENGTH" class="id_link">#</a></dt><dd><p><code class="varname">auto_explain.log_parameter_max_length</code> управляет протоколированием значений параметров запроса. Значение <code class="literal">-1</code> (по умолчанию) означает запись значений параметров полностью, а <code class="literal">0</code> отключает запись. Значение больше нуля усекает каждое значение параметра до указанного количества байтов. Изменить этот параметр могут только суперпользователи.</p></dd><dt id="AUTO-EXPLAIN-CONFIGURATION-PARAMETERS-LOG-ANALYZE"><span class="term"><code class="varname">auto_explain.log_analyze</code> (<code class="type">boolean</code>) <a id="id-1.11.7.14.5.3.3.1.3" class="indexterm"></a></span> <a href="#AUTO-EXPLAIN-CONFIGURATION-PARAMETERS-LOG-ANALYZE" class="id_link">#</a></dt><dd><p>При включении параметра <code class="varname">auto_explain.log_analyze</code> в протокол будет записываться вывод команды <code class="command">EXPLAIN ANALYZE</code>, а не простой <code class="command">EXPLAIN</code>. По умолчанию этот параметр отключён. Изменить его могут только суперпользователи.</p><div class="note"><h3 class="title">Примечание</h3><p>Когда этот параметр включён, замер времени на уровне узлов плана производится для всех операторов, даже если они выполняются недостаточно долго для протоколирования. Это может оказать крайне негативное влияние на производительность. Отключение <code class="varname">auto_explain.log_timing</code> исключает это влияние, но при этом собирается меньше информации.</p></div></dd><dt id="AUTO-EXPLAIN-CONFIGURATION-PARAMETERS-LOG-BUFFERS"><span class="term"><code class="varname">auto_explain.log_buffers</code> (<code class="type">boolean</code>) <a id="id-1.11.7.14.5.3.4.1.3" class="indexterm"></a></span> <a href="#AUTO-EXPLAIN-CONFIGURATION-PARAMETERS-LOG-BUFFERS" class="id_link">#</a></dt><dd><p>Параметр <code class="varname">auto_explain.log_buffers</code> определяет, будет ли при протоколировании плана выполнения выводиться статистика об использовании буферов; он равносилен указанию <code class="literal">BUFFERS</code> команды <code class="command">EXPLAIN</code>. Этот параметр действует, только если включён параметр <code class="varname">auto_explain.log_analyze</code>. По умолчанию этот параметр отключён. Изменить его могут только суперпользователи.</p></dd><dt id="AUTO-EXPLAIN-CONFIGURATION-PARAMETERS-LOG-WAL"><span class="term"><code class="varname">auto_explain.log_wal</code> (<code class="type">boolean</code>) <a id="id-1.11.7.14.5.3.5.1.3" class="indexterm"></a></span> <a href="#AUTO-EXPLAIN-CONFIGURATION-PARAMETERS-LOG-WAL" class="id_link">#</a></dt><dd><p>Параметр <code class="varname">auto_explain.log_wal</code> определяет, будет ли при протоколировании плана выполнения выводиться статистика об использовании WAL; он равносилен указанию <code class="literal">WAL</code> команды <code class="command">EXPLAIN</code>. Этот параметр действует, только если включён параметр <code class="varname">auto_explain.log_analyze</code>. По умолчанию этот параметр отключён. Изменить его могут только суперпользователи.</p></dd><dt id="AUTO-EXPLAIN-CONFIGURATION-PARAMETERS-LOG-TIMING"><span class="term"><code class="varname">auto_explain.log_timing</code> (<code class="type">boolean</code>) <a id="id-1.11.7.14.5.3.6.1.3" class="indexterm"></a></span> <a href="#AUTO-EXPLAIN-CONFIGURATION-PARAMETERS-LOG-TIMING" class="id_link">#</a></dt><dd><p>Параметр <code class="varname">auto_explain.log_timing</code> определяет, будет ли при протоколировании плана выполнения выводиться длительность на уровне узлов: он равнозначен указанию <code class="literal">TIMING</code> команды <code class="command">EXPLAIN</code>. Издержки от постоянного чтения системных часов могут значительно замедлить запросы в некоторых системах, так что может иметь смысл отключать этот параметр, когда нужно знать только знать количество строк, но не точную длительность каждого узла. Этот параметр действует, только если включён <code class="varname">auto_explain.log_analyze</code>. По умолчанию этот параметр отключён. Изменить его могут только суперпользователи.</p></dd><dt id="AUTO-EXPLAIN-CONFIGURATION-PARAMETERS-LOG-TRIGGERS"><span class="term"><code class="varname">auto_explain.log_triggers</code> (<code class="type">boolean</code>) <a id="id-1.11.7.14.5.3.7.1.3" class="indexterm"></a></span> <a href="#AUTO-EXPLAIN-CONFIGURATION-PARAMETERS-LOG-TRIGGERS" class="id_link">#</a></dt><dd><p>При включении параметра <code class="varname">auto_explain.log_triggers</code> в протокол будет записываться статистика выполнения триггеров. Этот параметр действует, только если включён параметр <code class="varname">auto_explain.log_analyze</code>. По умолчанию этот параметр отключён. Изменить его могут только суперпользователи.</p></dd><dt id="AUTO-EXPLAIN-CONFIGURATION-PARAMETERS-LOG-VERBOSE"><span class="term"><code class="varname">auto_explain.log_verbose</code> (<code class="type">boolean</code>) <a id="id-1.11.7.14.5.3.8.1.3" class="indexterm"></a></span> <a href="#AUTO-EXPLAIN-CONFIGURATION-PARAMETERS-LOG-VERBOSE" class="id_link">#</a></dt><dd><p>Параметр <code class="varname">auto_explain.log_verbose</code> определяет, будут ли при протоколировании плана выполнения выводиться подробные сведения; он равнозначен указанию <code class="literal">VERBOSE</code> команды <code class="command">EXPLAIN</code>. По умолчанию этот параметр отключён. Изменить его могут только суперпользователи.</p></dd><dt id="AUTO-EXPLAIN-CONFIGURATION-PARAMETERS-LOG-SETTINGS"><span class="term"><code class="varname">auto_explain.log_settings</code> (<code class="type">boolean</code>) <a id="id-1.11.7.14.5.3.9.1.3" class="indexterm"></a></span> <a href="#AUTO-EXPLAIN-CONFIGURATION-PARAMETERS-LOG-SETTINGS" class="id_link">#</a></dt><dd><p>Параметр <code class="varname">auto_explain.log_settings</code> определяет, будут ли вместе с планами выполнения выводиться изменённые параметры конфигурации. При его включении выводятся только те параметры, которые влияют на планирование запросов и имеют значения, отличающиеся от встроенных. По умолчанию этот параметр отключён. Изменить его могут только суперпользователи.</p></dd><dt id="AUTO-EXPLAIN-CONFIGURATION-PARAMETERS-LOG-FORMAT"><span class="term"><code class="varname">auto_explain.log_format</code> (<code class="type">enum</code>) <a id="id-1.11.7.14.5.3.10.1.3" class="indexterm"></a></span> <a href="#AUTO-EXPLAIN-CONFIGURATION-PARAMETERS-LOG-FORMAT" class="id_link">#</a></dt><dd><p>Параметр <code class="varname">auto_explain.log_format</code> выбирает формат вывода для <code class="command">EXPLAIN</code>. Он может принимать значение <code class="literal">text</code>, <code class="literal">xml</code>, <code class="literal">json</code> и <code class="literal">yaml</code>. Значение по умолчанию — text. Изменить этот параметр могут только суперпользователи.</p></dd><dt id="AUTO-EXPLAIN-CONFIGURATION-PARAMETERS-LOG-LEVEL"><span class="term"><code class="varname">auto_explain.log_level</code> (<code class="type">enum</code>) <a id="id-1.11.7.14.5.3.11.1.3" class="indexterm"></a></span> <a href="#AUTO-EXPLAIN-CONFIGURATION-PARAMETERS-LOG-LEVEL" class="id_link">#</a></dt><dd><p>Параметр <code class="varname">auto_explain.log_level</code> выбирает уровень, с которым auto_explain будет выводить в протокол планы запросов. Допустимые значения: <code class="literal">DEBUG5</code>, <code class="literal">DEBUG4</code>, <code class="literal">DEBUG3</code>, <code class="literal">DEBUG2</code>, <code class="literal">DEBUG1</code>, <code class="literal">INFO</code>, <code class="literal">NOTICE</code>, <code class="literal">WARNING</code> и <code class="literal">LOG</code>. По умолчанию подразумевается <code class="literal">LOG</code>. Изменить этот параметр могут только суперпользователи.</p></dd><dt id="AUTO-EXPLAIN-CONFIGURATION-PARAMETERS-LOG-NESTED-STATEMENTS"><span class="term"><code class="varname">auto_explain.log_nested_statements</code> (<code class="type">boolean</code>) <a id="id-1.11.7.14.5.3.12.1.3" class="indexterm"></a></span> <a href="#AUTO-EXPLAIN-CONFIGURATION-PARAMETERS-LOG-NESTED-STATEMENTS" class="id_link">#</a></dt><dd><p>При включении параметра <code class="varname">auto_explain.log_nested_statements</code> протоколированию могут подлежать и вложенные операторы (операторы, выполняемые внутри функции). Когда он отключён, протоколируются планы запросов только верхнего уровня. Изменить этот параметр могут только суперпользователи.</p></dd><dt id="AUTO-EXPLAIN-CONFIGURATION-PARAMETERS-SAMPLE-RATE"><span class="term"><code class="varname">auto_explain.sample_rate</code> (<code class="type">real</code>) <a id="id-1.11.7.14.5.3.13.1.3" class="indexterm"></a></span> <a href="#AUTO-EXPLAIN-CONFIGURATION-PARAMETERS-SAMPLE-RATE" class="id_link">#</a></dt><dd><p>Параметр <code class="varname">auto_explain.sample_rate</code> задаёт для auto_explain процент операторов, которые будут отслеживаться в каждом сеансе. Значение по умолчанию — 1, то есть отслеживаются все запросы. Вложенные операторы отслеживаются совместно — либо все, либо никакой из них. Изменить этот параметр могут только суперпользователи.</p></dd></dl></div><p>В обычной ситуации эти параметры устанавливаются в <code class="filename">postgresql.conf</code>, хотя суперпользователи могут изменить их «на лету» в рамках своих сеансов. Типичное их использование может выглядеть так:</p><pre class="programlisting"># postgresql.conf
session_preload_libraries = 'auto_explain'

auto_explain.log_min_duration = '3s'</pre></div><div class="sect2" id="AUTO-EXPLAIN-EXAMPLE"><div class="titlepage"><div><div><h3 class="title">F.4.2. Пример <a href="#AUTO-EXPLAIN-EXAMPLE" class="id_link">#</a></h3></div></div></div><pre class="programlisting">postgres=# LOAD 'auto_explain';
postgres=# SET auto_explain.log_min_duration = 0;
postgres=# SET auto_explain.log_analyze = true;
postgres=# SELECT count(*)
           FROM pg_class, pg_index
           WHERE oid = indrelid AND indisunique;</pre><p>В результате этих команд может быть получен такой вывод:</p><pre class="screen">
LOG:  duration: 3.651 ms  plan:
  Query Text: SELECT count(*)
              FROM pg_class, pg_index
              WHERE oid = indrelid AND indisunique;
  Aggregate  (cost=16.79..16.80 rows=1 width=0) (actual time=3.626..3.627 rows=1 loops=1)
    -&gt;  Hash Join  (cost=4.17..16.55 rows=92 width=0) (actual time=3.349..3.594 rows=92 loops=1)
          Hash Cond: (pg_class.oid = pg_index.indrelid)
          -&gt;  Seq Scan on pg_class  (cost=0.00..9.55 rows=255 width=4) (actual time=0.016..0.140 rows=255 loops=1)
          -&gt;  Hash  (cost=3.02..3.02 rows=92 width=4) (actual time=3.238..3.238 rows=92 loops=1)
                Buckets: 1024  Batches: 1  Memory Usage: 4kB
                -&gt;  Seq Scan on pg_index  (cost=0.00..3.02 rows=92 width=4) (actual time=0.008..3.187 rows=92 loops=1)
                      Filter: indisunique
</pre></div><div class="sect2" id="AUTO-EXPLAIN-AUTHOR"><div class="titlepage"><div><div><h3 class="title">F.4.3. Автор <a href="#AUTO-EXPLAIN-AUTHOR" class="id_link">#</a></h3></div></div></div><p>Такахиро Итагаки <code class="email">&lt;<a class="email" href="mailto:itagaki.takahiro@oss.ntt.co.jp">itagaki.takahiro@oss.ntt.co.jp</a>&gt;</code></p></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="auth-delay.html" title="F.3. auth_delay — задержка при ошибке аутентификации">Пред.</a> </td><td width="20%" align="center"><a accesskey="u" href="contrib.html" title="Приложение F. Дополнительно поставляемые модули и расширения">Наверх</a></td><td width="40%" align="right"> <a accesskey="n" href="basebackup-to-shell.html" title="F.5. basebackup_to_shell — пример создания получателей резервной копии для модуля pg_basebackup">След.</a></td></tr><tr><td width="40%" align="left" valign="top">F.3. auth_delay — задержка при ошибке аутентификации </td><td width="20%" align="center"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="40%" align="right" valign="top"> F.5. basebackup_to_shell — пример создания получателей резервной копии для модуля pg_basebackup</td></tr></table></div></body></html>