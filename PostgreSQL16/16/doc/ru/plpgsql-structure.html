<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>43.2. Структура PL/pgSQL</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@lists.postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets Vsnapshot" /><link rel="prev" href="plpgsql-overview.html" title="43.1. Обзор" /><link rel="next" href="plpgsql-declarations.html" title="43.3. Объявления" /></head><body id="docContent" class="container-fluid col-10"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="5" align="center">43.2. Структура <span class="application">PL/pgSQL</span></th></tr><tr><td width="10%" align="left"><a accesskey="p" href="plpgsql-overview.html" title="43.1. Обзор">Пред.</a> </td><td width="10%" align="left"><a accesskey="u" href="plpgsql.html" title="Глава 43. PL/pgSQL — процедурный язык SQL">Наверх</a></td><th width="60%" align="center">Глава 43. <span class="application">PL/pgSQL</span> — процедурный язык <acronym class="acronym">SQL</acronym></th><td width="10%" align="right"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="10%" align="right"> <a accesskey="n" href="plpgsql-declarations.html" title="43.3. Объявления">След.</a></td></tr></table><hr /></div><div class="sect1" id="PLPGSQL-STRUCTURE"><div class="titlepage"><div><div><h2 class="title" style="clear: both">43.2. Структура <span class="application">PL/pgSQL</span> <a href="#PLPGSQL-STRUCTURE" class="id_link">#</a></h2></div></div></div><p>Функции, написанные на <span class="application">PL/pgSQL</span>, определяются на сервере командами <a class="xref" href="sql-createfunction.html" title="CREATE FUNCTION"><span class="refentrytitle">CREATE FUNCTION</span></a>. Такая команда обычно выглядит, например, так: </p><pre class="programlisting">CREATE FUNCTION somefunc(integer, text) RETURNS integer
AS '<em class="replaceable"><code>тело функции</code></em>'
LANGUAGE plpgsql;</pre><p> Если рассматривать <code class="command">CREATE FUNCTION</code>, тело функции представляет собой просто текстовую строку. Часто для написания тела функции удобнее заключать эту строку в доллары (см. <a class="xref" href="sql-syntax-lexical.html#SQL-SYNTAX-DOLLAR-QUOTING" title="4.1.2.4. Строковые константы, заключённые в доллары">Подраздел 4.1.2.4</a>), а не в обычные апострофы. Если не применять заключение в доллары, все апострофы или обратные косые черты в теле функции придётся экранировать, дублируя их. Почти во всех примерах в этой главе тело функций заключается в доллары.</p><p><span class="application">PL/pgSQL</span> это блочно-структурированный язык. Текст тела функции должен быть <em class="firstterm">блоком</em>. Структура блока: </p><pre class="synopsis">
[<span class="optional"> &lt;&lt;<em class="replaceable"><code>метка</code></em>&gt;&gt; </span>]
[<span class="optional"> DECLARE
    <em class="replaceable"><code>объявления</code></em> </span>]
BEGIN
    <em class="replaceable"><code>операторы</code></em>
END [<span class="optional"> <em class="replaceable"><code>метка</code></em> </span>];
</pre><p>Каждое объявление и каждый оператор в блоке должны завершаться символом «;» (точка с запятой). Блок, вложенный в другой блок, должен иметь точку с запятой после <code class="literal">END</code>, как показано выше. Однако финальный <code class="literal">END</code>, завершающий тело функции, не требует точки с запятой.</p><div class="tip"><h3 class="title">Подсказка</h3><p>Распространённой ошибкой является добавление точки с запятой сразу после <code class="literal">BEGIN</code>. Это неправильно и приведёт к синтаксической ошибке.</p></div><p><em class="replaceable"><code>Метка</code></em> требуется только тогда, когда нужно идентифицировать блок в операторе <code class="literal">EXIT</code>, или дополнить имена переменных, объявленных в этом блоке. Если метка указана после <code class="literal">END</code>, то она должна совпадать с меткой в начале блока.</p><p>Ключевые слова не чувствительны к регистру символов. Как и в обычных SQL-командах, идентификаторы неявно преобразуются к нижнему регистру, если они не взяты в двойные кавычки.</p><p>Комментарии в <span class="application">PL/pgSQL</span> коде работают так же, как и в обычном SQL. Двойное тире (<code class="literal">--</code>) начинает комментарий, который завершается в конце строки. Блочный комментарий начинается с <code class="literal">/*</code> и завершается <code class="literal">*/</code>. Блочные комментарии могут быть вложенными.</p><p>Любой оператор в выполняемой секции блока может быть <em class="firstterm">вложенным блоком</em>. Вложенные блоки используются для логической группировки нескольких операторов или локализации области действия переменных для группы операторов. Во время выполнения вложенного блока переменные, объявленные в нём, скрывают переменные внешних блоков с такими же именами. Чтобы получить доступ к внешним переменным, нужно дополнить их имена меткой блока. Например: </p><pre class="programlisting">CREATE FUNCTION somefunc() RETURNS integer AS $$
&lt;&lt; outerblock &gt;&gt;
DECLARE
    quantity integer := 30;
BEGIN
    RAISE NOTICE 'Сейчас quantity = %', quantity;  -- Выводится 30
    quantity := 50;
    --
    -- Вложенный блок
    --
    DECLARE
        quantity integer := 80;
    BEGIN
        RAISE NOTICE 'Сейчас quantity = %', quantity;  -- Выводится 80
        RAISE NOTICE 'Во внешнем блоке quantity = %', outerblock.quantity;  -- Выводится 50
    END;

    RAISE NOTICE 'Сейчас quantity = %', quantity;  -- Выводится 50

    RETURN quantity;
END;
$$ LANGUAGE plpgsql;</pre><div class="note"><h3 class="title">Примечание</h3><p>Существует скрытый <span class="quote">«<span class="quote">внешний блок</span>»</span>, окружающий тело каждой функции на <span class="application">PL/pgSQL</span>. Этот блок содержит объявления параметров функции (если они есть), а также некоторые специальные переменные, такие как <code class="literal">FOUND</code> (см. <a class="xref" href="plpgsql-statements.html#PLPGSQL-STATEMENTS-DIAGNOSTICS" title="43.5.5. Статус выполнения команды">Подраздел 43.5.5</a>). Этот блок имеет метку, совпадающую с именем функции, таким образом, параметры и специальные переменные могут быть дополнены именем функции.</p></div><p>Важно не путать использование <code class="command">BEGIN</code>/<code class="command">END</code> для группировки операторов в <span class="application">PL/pgSQL</span> с одноимёнными SQL-командами для управления транзакциями. <code class="command">BEGIN</code>/<code class="command">END</code> в <span class="application">PL/pgSQL</span> служат только для группировки предложений; они не начинают и не заканчивают транзакции. Управление транзакциями в <span class="application">PL/pgSQL</span> описывается в <a class="xref" href="plpgsql-transactions.html" title="43.8. Управление транзакциями">Разделе 43.8</a>. Кроме того, блок с предложением <code class="literal">EXCEPTION</code> по сути создаёт вложенную транзакцию, которую можно отменить, не затрагивая внешнюю транзакцию. Подробнее это описано в <a class="xref" href="plpgsql-control-structures.html#PLPGSQL-ERROR-TRAPPING" title="43.6.8. Обработка ошибок">Подразделе 43.6.8</a>.</p></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="plpgsql-overview.html" title="43.1. Обзор">Пред.</a> </td><td width="20%" align="center"><a accesskey="u" href="plpgsql.html" title="Глава 43. PL/pgSQL — процедурный язык SQL">Наверх</a></td><td width="40%" align="right"> <a accesskey="n" href="plpgsql-declarations.html" title="43.3. Объявления">След.</a></td></tr><tr><td width="40%" align="left" valign="top">43.1. Обзор </td><td width="20%" align="center"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="40%" align="right" valign="top"> 43.3. Объявления</td></tr></table></div></body></html>