<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>43.12. Советы по разработке на PL/pgSQL</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@lists.postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets Vsnapshot" /><link rel="prev" href="plpgsql-implementation.html" title="43.11. PL/pgSQL изнутри" /><link rel="next" href="plpgsql-porting.html" title="43.13. Портирование из Oracle PL/SQL" /></head><body id="docContent" class="container-fluid col-10"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="5" align="center">43.12. Советы по разработке на <span class="application">PL/pgSQL</span></th></tr><tr><td width="10%" align="left"><a accesskey="p" href="plpgsql-implementation.html" title="43.11. PL/pgSQL изнутри">Пред.</a> </td><td width="10%" align="left"><a accesskey="u" href="plpgsql.html" title="Глава 43. PL/pgSQL — процедурный язык SQL">Наверх</a></td><th width="60%" align="center">Глава 43. <span class="application">PL/pgSQL</span> — процедурный язык <acronym class="acronym">SQL</acronym></th><td width="10%" align="right"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="10%" align="right"> <a accesskey="n" href="plpgsql-porting.html" title="43.13. Портирование из Oracle PL/SQL">След.</a></td></tr></table><hr /></div><div class="sect1" id="PLPGSQL-DEVELOPMENT-TIPS"><div class="titlepage"><div><div><h2 class="title" style="clear: both">43.12. Советы по разработке на <span class="application">PL/pgSQL</span> <a href="#PLPGSQL-DEVELOPMENT-TIPS" class="id_link">#</a></h2></div></div></div><div class="toc"><dl class="toc"><dt><span class="sect2"><a href="plpgsql-development-tips.html#PLPGSQL-QUOTE-TIPS">43.12.1. Обработка кавычек</a></span></dt><dt><span class="sect2"><a href="plpgsql-development-tips.html#PLPGSQL-EXTRA-CHECKS">43.12.2. Дополнительные проверки во время компиляции и во время выполнения</a></span></dt></dl></div><p>Хороший способ разрабатывать на <span class="application">PL/pgSQL</span> заключается в том, чтобы в одном окне с текстовым редактором по выбору создавать тексты функций, а в другом окне с <span class="application">psql</span> загружать и тестировать эти функции. В таком случае удобно записывать функцию, используя <code class="command">CREATE OR REPLACE FUNCTION</code>. Таким образом, можно легко загрузить файл для обновления определения функции. Например: </p><pre class="programlisting">CREATE OR REPLACE FUNCTION testfunc(integer) RETURNS integer AS $$
          ....
$$ LANGUAGE plpgsql;</pre><p>В <span class="application">psql</span>, можно загрузить или перезагрузить такой файл определения функции, выполнив: </p><pre class="programlisting">\i filename.sql</pre><p> а затем сразу выполнять команды SQL для тестирования функции.</p><p>Ещё один хороший способ разрабатывать на <span class="application">PL/pgSQL</span> связан с использованием GUI инструментов, облегчающих разработку на процедурном языке. Один из примеров такого инструмента <span class="application">pgAdmin</span>, хотя есть и другие. Такие инструменты часто предоставляют удобные возможности, такие как экранирование одинарных кавычек, отладка и повторное создание функций.</p><div class="sect2" id="PLPGSQL-QUOTE-TIPS"><div class="titlepage"><div><div><h3 class="title">43.12.1. Обработка кавычек <a href="#PLPGSQL-QUOTE-TIPS" class="id_link">#</a></h3></div></div></div><p>Код функции на <span class="application">PL/pgSQL</span> указывается в команде <code class="command">CREATE FUNCTION</code> в виде строки. Если записывать строку как обычно, внутри одинарных кавычек, то любой символ одинарной кавычки должен дублироваться, так же как и должен дублироваться каждый знак обратной косой черты (если используется синтаксис с экранированием в строках). Дублирование кавычек в лучшем случае утомительно, а в более сложных случаях код может стать совершенно непонятным, так как легко может потребоваться четыре или более идущих подряд кавычек. Вместо этого при создании тела функции рекомендуется использовать знаки доллара в качестве кавычек (см. <a class="xref" href="sql-syntax-lexical.html#SQL-SYNTAX-DOLLAR-QUOTING" title="4.1.2.4. Строковые константы, заключённые в доллары">Подраздел 4.1.2.4</a>). При таком подходе никогда не потребуется дублировать кавычки, но придётся позаботиться о том, чтобы иметь разные долларовые разделители для каждого уровня вложенности. Например, команду <code class="command">CREATE FUNCTION</code> можно записать так: </p><pre class="programlisting">CREATE OR REPLACE FUNCTION testfunc(integer) RETURNS integer AS $PROC$
          ....
$PROC$ LANGUAGE plpgsql;</pre><p> Внутри можно использовать кавычки для простых текстовых строк и <code class="literal">$$</code> для разграничения фрагментов SQL-команды, собираемой из отдельных строк. Если нужно взять в кавычки текст, который включает <code class="literal">$$</code>, можно использовать <code class="literal">$Q$</code>, и так далее.</p><p>Следующая таблица показывает, как применяются знаки кавычек, если не используется экранирование долларами. Это может быть полезно при переводе кода, не использующего экранирование знаками доллара, в нечто более понятное.</p><div class="variablelist"><dl class="variablelist"><dt id="PLPGSQL-QUOTE-TIPS-1-QUOT"><span class="term">1 кавычка</span> <a href="#PLPGSQL-QUOTE-TIPS-1-QUOT" class="id_link">#</a></dt><dd><p>В начале и конце тела функции, например: </p><pre class="programlisting">CREATE FUNCTION foo() RETURNS integer AS '
          ....
' LANGUAGE plpgsql;</pre><p> Внутри такой функции любая кавычка <span class="emphasis"><em>должна</em></span> дублироваться.</p></dd><dt id="PLPGSQL-QUOTE-TIPS-2-QUOT"><span class="term">2 кавычки</span> <a href="#PLPGSQL-QUOTE-TIPS-2-QUOT" class="id_link">#</a></dt><dd><p>Для строковых литералов внутри тела функции, например: </p><pre class="programlisting">a_output := ''Blah'';
SELECT * FROM users WHERE f_name=''foobar'';</pre><p> При использовании знаков доллара можно просто написать: </p><pre class="programlisting">a_output := 'Blah';
SELECT * FROM users WHERE f_name='foobar';</pre><p> и именно это увидит исполнитель <span class="application">PL/pgSQL</span> в обоих случаях.</p></dd><dt id="PLPGSQL-QUOTE-TIPS-4-QUOT"><span class="term">4 кавычки</span> <a href="#PLPGSQL-QUOTE-TIPS-4-QUOT" class="id_link">#</a></dt><dd><p>Когда нужны одинарные кавычки в строковой константе внутри тела функции, например: </p><pre class="programlisting">a_output := a_output || '' AND name LIKE ''''foobar'''' AND xyz''</pre><p> К <code class="literal">a_output</code> будет добавлено: <code class="literal"> AND name LIKE 'foobar' AND xyz</code></p><p>При использовании знаков доллара это записывается так: </p><pre class="programlisting">a_output := a_output || $$ AND name LIKE 'foobar' AND xyz$$</pre><p> будьте внимательны, при этом не должно быть внешнего долларового разделителя <code class="literal">$$</code>.</p></dd><dt id="PLPGSQL-QUOTE-TIPS-6-QUOT"><span class="term">6 кавычек</span> <a href="#PLPGSQL-QUOTE-TIPS-6-QUOT" class="id_link">#</a></dt><dd><p>Когда нужны одинарные кавычки в строковой константе внутри тела функции, при этом кавычки находятся в конце строковой константы. Например: </p><pre class="programlisting">a_output := a_output || '' AND name LIKE ''''foobar''''''</pre><p> К <code class="literal">a_output</code> будет добавлено: <code class="literal"> AND name LIKE 'foobar'</code>.</p><p>При использовании знаков доллара это записывается так: </p><pre class="programlisting">a_output := a_output || $$ AND name LIKE 'foobar'$$</pre></dd><dt id="PLPGSQL-QUOTE-TIPS-10-QUOT"><span class="term">10 кавычек</span> <a href="#PLPGSQL-QUOTE-TIPS-10-QUOT" class="id_link">#</a></dt><dd><p>Когда нужны две одиночные кавычки в строковой константе (это уже 8 кавычек), примыкающие к концу строковой константы (ещё 2). Вероятно, такое может понадобиться при разработке функции, которая генерирует другие функции, как показано в <a class="xref" href="plpgsql-porting.html#PLPGSQL-PORTING-EX2" title="Пример 43.10. Портирование функции, создающей другую функцию, из PL/SQL в PL/pgSQL">Примере 43.10</a>. Например: </p><pre class="programlisting">a_output := a_output || '' if v_'' ||
    referrer_keys.kind || '' like ''''''''''
    || referrer_keys.key_string || ''''''''''
    then return ''''''  || referrer_keys.referrer_type
    || ''''''; end if;'';</pre><p> Значение <code class="literal">a_output</code> затем будет: </p><pre class="programlisting">if v_... like ''...'' then return ''...''; end if;</pre><p>При использовании знаков доллара: </p><pre class="programlisting">a_output := a_output || $$ if v_$$ || referrer_keys.kind || $$ like '$$
    || referrer_keys.key_string || $$'
    then return '$$  || referrer_keys.referrer_type
    || $$'; end if;$$;</pre><p> где предполагается, что нужны только одиночные кавычки в <code class="literal">a_output</code>, так как потребуется повторное взятие в кавычки перед использованием.</p></dd></dl></div></div><div class="sect2" id="PLPGSQL-EXTRA-CHECKS"><div class="titlepage"><div><div><h3 class="title">43.12.2. Дополнительные проверки во время компиляции и во время выполнения <a href="#PLPGSQL-EXTRA-CHECKS" class="id_link">#</a></h3></div></div></div><p>Чтобы помочь найти и предупредить простые, но часто встречающиеся проблемы, <span class="application">PL/PgSQL</span> предоставляет дополнительные <em class="replaceable"><code>проверки</code></em>. Если они включены в конфигурации, то во время компиляции функций будут выдаваться дополнительные сообщения <code class="literal">WARNING</code> или ошибки <code class="literal">ERROR</code>. Функция, при компиляции которой выдавалось <code class="literal">WARNING</code>, при последующем выполнении не будет выдавать это сообщение и её можно протестировать в отдельной среде разработки.</p><p>В среде разработки и/или тестирования имеет смысл установить значение <code class="literal">"all"</code> для параметра <code class="varname">plpgsql.extra_warnings</code> или <code class="varname">plpgsql.extra_errors</code>.</p><p>Для включения этих проверок предназначены параметры <code class="varname">plpgsql.extra_warnings</code> (для предупреждений) и <code class="varname">plpgsql.extra_errors</code> (для ошибок). Каждому из параметров можно присвоить список значений, разделённых запятыми, значение <code class="literal">"none"</code> или <code class="literal">"all"</code>. По умолчанию используется <code class="literal">"none"</code>. В настоящий момент доступны следующие дополнительные проверки: </p><div class="variablelist"><dl class="variablelist"><dt id="PLPGSQL-EXTRA-CHECKS-SHADOWED-VARIABLES"><span class="term"><code class="varname">shadowed_variables</code></span> <a href="#PLPGSQL-EXTRA-CHECKS-SHADOWED-VARIABLES" class="id_link">#</a></dt><dd><p>Проверяет, что объявление новой переменной не скрывает ранее объявленную переменную.</p></dd><dt id="PLPGSQL-EXTRA-CHECKS-STRICT-MULTI-ASSIGNMENT"><span class="term"><code class="varname">strict_multi_assignment</code></span> <a href="#PLPGSQL-EXTRA-CHECKS-STRICT-MULTI-ASSIGNMENT" class="id_link">#</a></dt><dd><p>Некоторые команды <span class="application">PL/pgSQL</span> допускают присваивание значений сразу нескольким переменным, например <code class="command">SELECT INTO</code>. Обычно количество целевых переменных должно совпадать с количеством исходных, хотя <span class="application">PL/pgSQL</span> будет использовать <code class="literal">NULL</code> вместо пропущенных значений, а дополнительные переменные игнорировать. При включении этой проверки <span class="application">PL/pgSQL</span> будет выдавать предупреждение (<code class="literal">WARNING</code>) или ошибку (<code class="literal">ERROR</code>) при несовпадении количества целевых переменных с количеством исходных.</p></dd><dt id="PLPGSQL-EXTRA-CHECKS-TOO-MANY-ROWS"><span class="term"><code class="varname">too_many_rows</code></span> <a href="#PLPGSQL-EXTRA-CHECKS-TOO-MANY-ROWS" class="id_link">#</a></dt><dd><p>При включении этой проверки <span class="application">PL/pgSQL</span> будет контролировать случаи, когда запрос с предложением <code class="literal">INTO</code> возвращает больше одной строки. Предложение <code class="literal">INTO</code> может обработать только одну строку, поэтому запрос, возвращающий несколько строк, как правило оказывается неэффективным и/или недетерминированным, а следовательно, скорее всего, является ошибочным.</p></dd></dl></div><p> Следующий пример показывает эффект присваивания <code class="varname">plpgsql.extra_warnings</code> значения <code class="varname">shadowed_variables</code>: </p><pre class="programlisting">SET plpgsql.extra_warnings TO 'shadowed_variables';

CREATE FUNCTION foo(f1 int) RETURNS int AS $$
DECLARE
f1 int;
BEGIN
RETURN f1;
END;
$$ LANGUAGE plpgsql;
WARNING:  variable "f1" shadows a previously defined variable
LINE 3: f1 int;
        ^
CREATE FUNCTION</pre><p> Пример ниже показывает эффект присваивания <code class="varname">plpgsql.extra_warnings</code> значения <code class="varname">strict_multi_assignment</code>: </p><pre class="programlisting">SET plpgsql.extra_warnings TO 'strict_multi_assignment';

CREATE OR REPLACE FUNCTION public.foo()
 RETURNS void
 LANGUAGE plpgsql
AS $$
DECLARE
  x int;
  y int;
BEGIN
  SELECT 1 INTO x, y;
  SELECT 1, 2 INTO x, y;
  SELECT 1, 2, 3 INTO x, y;
END;
$$;

SELECT foo();
WARNING:  number of source and target fields in assignment does not match
DETAIL:  strict_multi_assignment check of extra_warnings is active.
HINT:  Make sure the query returns the exact list of columns.
WARNING:  number of source and target fields in assignment does not match
DETAIL:  strict_multi_assignment check of extra_warnings is active.
HINT:  Make sure the query returns the exact list of columns.

 foo
-----

(1 row)</pre></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="plpgsql-implementation.html" title="43.11. PL/pgSQL изнутри">Пред.</a> </td><td width="20%" align="center"><a accesskey="u" href="plpgsql.html" title="Глава 43. PL/pgSQL — процедурный язык SQL">Наверх</a></td><td width="40%" align="right"> <a accesskey="n" href="plpgsql-porting.html" title="43.13. Портирование из Oracle PL/SQL">След.</a></td></tr><tr><td width="40%" align="left" valign="top">43.11. <span class="application">PL/pgSQL</span> изнутри </td><td width="20%" align="center"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="40%" align="right" valign="top"> 43.13. Портирование из <span class="productname">Oracle</span> PL/SQL</td></tr></table></div></body></html>