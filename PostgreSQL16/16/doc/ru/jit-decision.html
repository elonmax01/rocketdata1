<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>32.2. Когда применять JIT?</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@lists.postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets Vsnapshot" /><link rel="prev" href="jit-reason.html" title="32.1. Что такое JIT-компиляция?" /><link rel="next" href="jit-configuration.html" title="32.3. Конфигурация" /></head><body id="docContent" class="container-fluid col-10"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="5" align="center">32.2. Когда применять <acronym class="acronym">JIT</acronym>?</th></tr><tr><td width="10%" align="left"><a accesskey="p" href="jit-reason.html" title="32.1. Что такое JIT-компиляция?">Пред.</a> </td><td width="10%" align="left"><a accesskey="u" href="jit.html" title="Глава 32. JIT-компиляция">Наверх</a></td><th width="60%" align="center">Глава 32. <acronym class="acronym">JIT</acronym>-компиляция</th><td width="10%" align="right"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="10%" align="right"> <a accesskey="n" href="jit-configuration.html" title="32.3. Конфигурация">След.</a></td></tr></table><hr /></div><div class="sect1" id="JIT-DECISION"><div class="titlepage"><div><div><h2 class="title" style="clear: both">32.2. Когда применять <acronym class="acronym">JIT</acronym>? <a href="#JIT-DECISION" class="id_link">#</a></h2></div></div></div><p><acronym class="acronym">JIT</acronym>-компиляция имеет смысл в первую очередь для длительных запросов, нагружающих процессор. Например, такой характер обычно имеют аналитические запросы. Для быстрых запросов накладные расходы, связанные с выполнением <acronym class="acronym">JIT</acronym>-компиляции, часто будут превышать выигрыш от их ускорения.</p><p>Решение об использовании <acronym class="acronym">JIT</acronym>-компиляции принимается на основании общей стоимости запроса (см. <a class="xref" href="planner-stats-details.html" title="Глава 76. Как планировщик использует статистику">Главу 76</a> и <a class="xref" href="runtime-config-query.html#RUNTIME-CONFIG-QUERY-CONSTANTS" title="20.7.2. Константы стоимости для планировщика">Подраздел 20.7.2</a>). Стоимость запроса сравнивается со значением <a class="xref" href="runtime-config-query.html#GUC-JIT-ABOVE-COST">jit_above_cost</a>, и если она оказывается больше, производится <acronym class="acronym">JIT</acronym>-компиляция. Затем принимаются ещё два решения. Во-первых, если его стоимость превышает и значение <a class="xref" href="runtime-config-query.html#GUC-JIT-INLINE-ABOVE-COST">jit_inline_above_cost</a>, тела небольших функций и операторов, фигурирующих в запросе, будут встраиваться в вызывающий код. Во-вторых, если стоимость запроса превышает значение <a class="xref" href="runtime-config-query.html#GUC-JIT-OPTIMIZE-ABOVE-COST">jit_optimize_above_cost</a>, при генерации кода задействуются дорогостоящие оптимизации для улучшения сгенерированного кода. Обе эти операции увеличивают накладные расходы <acronym class="acronym">JIT</acronym>, но могут значительно сократить время выполнения запроса.</p><p>Эти решения принимаются на основе стоимости во время планирования, а не исполнения запроса. Это означает, что в случае использования подготовленных операторов и общего плана (см. <a class="xref" href="sql-prepare.html#SQL-PREPARE-NOTES" title="Замечания">Раздел «Замечания»</a>) принятие решений зависит от параметров конфигурации, действующих во время подготовки запроса, а не во время выполнения.</p><div class="note"><h3 class="title">Примечание</h3><p>Если параметр <a class="xref" href="runtime-config-query.html#GUC-JIT">jit</a> имеет значение <code class="literal">off</code> или сервер не поддерживает <acronym class="acronym">JIT</acronym> (например, потому что он был скомпилирован без <code class="literal">--with-llvm</code>), <acronym class="acronym">JIT</acronym>-компиляция выполняться не будет, даже если она была бы выгодна, исходя из описанных выше критериев. Присвоенное параметру <a class="xref" href="runtime-config-query.html#GUC-JIT">jit</a> значение <code class="literal">off</code> учитывается и во время планирования, и во время выполнения запросов.</p></div><p><a class="xref" href="sql-explain.html" title="EXPLAIN"><span class="refentrytitle">EXPLAIN</span></a> позволяет определить, используется ли <acronym class="acronym">JIT</acronym>-компиляция. Например, так выглядит запрос, не использующий <acronym class="acronym">JIT</acronym>: </p><pre class="screen">
=# EXPLAIN ANALYZE SELECT SUM(relpages) FROM pg_class;
                                                 QUERY PLAN
-------------------------------------------------------------------​------------------------------------------
 Aggregate  (cost=16.27..16.29 rows=1 width=8) (actual time=0.303..0.303 rows=1 loops=1)
   -&gt;  Seq Scan on pg_class  (cost=0.00..15.42 rows=342 width=4) (actual time=0.017..0.111 rows=356 loops=1)
 Planning Time: 0.116 ms
 Execution Time: 0.365 ms
(4 rows)
</pre><p> Учитывая стоимость планирования, отказ от использования <acronym class="acronym">JIT</acronym> вполне обоснован, так как стоимость <acronym class="acronym">JIT</acronym>-компиляции оказалась бы больше, чем выигрыш от оптимизации. Если уменьшить ограничение стоимости, <acronym class="acronym">JIT</acronym> будет использоваться: </p><pre class="screen">
=# SET jit_above_cost = 10;
SET
=# EXPLAIN ANALYZE SELECT SUM(relpages) FROM pg_class;
                                                 QUERY PLAN
-------------------------------------------------------------------​------------------------------------------
 Aggregate  (cost=16.27..16.29 rows=1 width=8) (actual time=6.049..6.049 rows=1 loops=1)
   -&gt;  Seq Scan on pg_class  (cost=0.00..15.42 rows=342 width=4) (actual time=0.019..0.052 rows=356 loops=1)
 Planning Time: 0.133 ms
 JIT:
   Functions: 3
   Options: Inlining false, Optimization false, Expressions true, Deforming true
   Timing: Generation 1.259 ms, Inlining 0.000 ms, Optimization 0.797 ms, Emission 5.048 ms, Total 7.104 ms
 Execution Time: 7.416 ms
</pre><p> В данном случае видно, что <acronym class="acronym">JIT</acronym> используется, но встраивание (Inlining) и дорогостоящие оптимизации (Optimization) не выполнялись. Чтобы их включить, помимо <a class="xref" href="runtime-config-query.html#GUC-JIT-ABOVE-COST">jit_above_cost</a> нужно было также уменьшить <a class="xref" href="runtime-config-query.html#GUC-JIT-INLINE-ABOVE-COST">jit_inline_above_cost</a> и <a class="xref" href="runtime-config-query.html#GUC-JIT-OPTIMIZE-ABOVE-COST">jit_optimize_above_cost</a>.</p></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="jit-reason.html" title="32.1. Что такое JIT-компиляция?">Пред.</a> </td><td width="20%" align="center"><a accesskey="u" href="jit.html" title="Глава 32. JIT-компиляция">Наверх</a></td><td width="40%" align="right"> <a accesskey="n" href="jit-configuration.html" title="32.3. Конфигурация">След.</a></td></tr><tr><td width="40%" align="left" valign="top">32.1. Что такое <acronym class="acronym">JIT</acronym>-компиляция? </td><td width="20%" align="center"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="40%" align="right" valign="top"> 32.3. Конфигурация</td></tr></table></div></body></html>