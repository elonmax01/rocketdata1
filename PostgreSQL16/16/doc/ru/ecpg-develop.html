<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>36.17. Внутреннее устройство</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@lists.postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets Vsnapshot" /><link rel="prev" href="ecpg-oracle-compat.html" title="36.16. Режим совместимости с Oracle" /><link rel="next" href="information-schema.html" title="Глава 37. Информационная схема" /></head><body id="docContent" class="container-fluid col-10"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="5" align="center">36.17. Внутреннее устройство</th></tr><tr><td width="10%" align="left"><a accesskey="p" href="ecpg-oracle-compat.html" title="36.16. Режим совместимости с Oracle">Пред.</a> </td><td width="10%" align="left"><a accesskey="u" href="ecpg.html" title="Глава 36. ECPG — Встраиваемый SQL в C">Наверх</a></td><th width="60%" align="center">Глава 36. <span class="application">ECPG</span> — Встраиваемый <acronym class="acronym">SQL</acronym> в C</th><td width="10%" align="right"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="10%" align="right"> <a accesskey="n" href="information-schema.html" title="Глава 37. Информационная схема">След.</a></td></tr></table><hr /></div><div class="sect1" id="ECPG-DEVELOP"><div class="titlepage"><div><div><h2 class="title" style="clear: both">36.17. Внутреннее устройство <a href="#ECPG-DEVELOP" class="id_link">#</a></h2></div></div></div><p>В этом разделе рассказывается, как препроцессор <span class="application">ECPG</span> устроен внутри. Эта информация может оказаться полезной для пользователей, желающих понять, как использовать <span class="application">ECPG</span>.</p><p>Первые четыре строки, которые <code class="command">ecpg</code> записывает в вывод, фиксированы. Первые две строки содержат комментарии, а следующие две директивы включения, подключающие интерфейс к библиотеке. Затем препроцессор прочитывает файл и продолжает запись в вывод. Обычно он просто печатает всё в устройство вывода.</p><p>Встречая команду <code class="command">EXEC SQL</code>, он вмешивается и изменяет её. Данная команда начинается со слов <code class="command">EXEC SQL</code> и заканчивается знаком <code class="command">;</code>. Всё между ними воспринимается как оператор <acronym class="acronym">SQL</acronym> и разбирается для подстановки переменных.</p><p>Подстановка переменных имеет место, когда символ начинается с двоеточия (<code class="literal">:</code>). ECPG будет искать переменную с таким именем среди переменных, ранее объявленных в секции <code class="literal">EXEC SQL DECLARE</code>.</p><p>Самая важная функция в библиотеке — <code class="function">ECPGdo</code>, которая осуществляет выполнение большинства команд. Она принимает переменное число аргументов (это число легко может достигать 50, и мы надеемся, что это не приведёт к проблемам ни на какой платформе).</p><p>Ей передаются следующие аргументы: </p><div class="variablelist"><dl class="variablelist"><dt id="ECPG-DEVELOP-LINE-NUMBER"><span class="term">Номер строки</span> <a href="#ECPG-DEVELOP-LINE-NUMBER" class="id_link">#</a></dt><dd><p>Номер исходной строки; используется только в сообщениях об ошибках.</p></dd><dt id="ECPG-DEVELOP-STRING"><span class="term">Строка</span> <a href="#ECPG-DEVELOP-STRING" class="id_link">#</a></dt><dd><p>Команда <acronym class="acronym">SQL</acronym>, которая должна быть выполнена. На её содержимое влияют входные переменные, то есть переменные, добавленные в команду, но неизвестные во время компиляции. Места, в которые должны вставляться переменные, обозначаются знаками <code class="literal">?</code>.</p></dd><dt id="ECPG-DEVELOP-INPUT-VARIABLES"><span class="term">Входные переменные</span> <a href="#ECPG-DEVELOP-INPUT-VARIABLES" class="id_link">#</a></dt><dd><p>Для каждой входной переменной формируются десять аргументов. (См. ниже.)</p></dd><dt id="ECPG-DEVELOP-ECPGT-EOIT"><span class="term"><em class="parameter"><code>ECPGt_EOIT</code></em></span> <a href="#ECPG-DEVELOP-ECPGT-EOIT" class="id_link">#</a></dt><dd><p>Перечисление (<code class="type">enum</code>), показывающее, что больше входных переменных нет.</p></dd><dt id="ECPG-DEVELOP-OUTPUT-VARIABLES"><span class="term">Выходные переменные</span> <a href="#ECPG-DEVELOP-OUTPUT-VARIABLES" class="id_link">#</a></dt><dd><p>Для каждой входной переменной формируются десять аргументов. (См. ниже.) Эти переменные заполняются данной функцией.</p></dd><dt id="ECPG-DEVELOP-ECPGT-EORT"><span class="term"><em class="parameter"><code>ECPGt_EORT</code></em></span> <a href="#ECPG-DEVELOP-ECPGT-EORT" class="id_link">#</a></dt><dd><p>Перечисление (<code class="type">enum</code>), показывающее, что больше выходных переменных нет.</p></dd></dl></div><p>Для каждой переменной, включённой в команду <acronym class="acronym">SQL</acronym>, эта функция принимает десять аргументов: </p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Тип в виде специального символа.</p></li><li class="listitem"><p>Указатель на значение или указатель на указатель.</p></li><li class="listitem"><p>Размер переменной, если она имеет тип <code class="type">char</code> или <code class="type">varchar</code>.</p></li><li class="listitem"><p>Число элементов в массиве (при выборке данных в массив).</p></li><li class="listitem"><p>Смещение следующего элемента в массиве (при выборке данных в массив).</p></li><li class="listitem"><p>Тип переменной-индикатора в виде специального символа.</p></li><li class="listitem"><p>Указатель на переменную-индикатор.</p></li><li class="listitem"><p>0</p></li><li class="listitem"><p>Число элементов в массиве индикаторов (при выборке данных в массив).</p></li><li class="listitem"><p>Смещение следующего элемента в массиве индикаторов (при выборке данных в массив).</p></li></ol></div><p>Заметьте, что не все команды SQL обрабатываются таким образом. Например, команда открытия курсора вида: </p><pre class="programlisting">EXEC SQL OPEN <em class="replaceable"><code>курсор</code></em>;</pre><p> не копируется в вывод. Вместо этого в позиции команды <code class="command">OPEN</code> применяется команда <code class="command">DECLARE</code> этого курсора, так как на самом деле курсор открывает она.</p><p>Ниже показан полный пример, демонстрирующий результат обработки препроцессором файла <code class="filename">foo.pgc</code> (детали могут меняться от версии к версии препроцессора): </p><pre class="programlisting">EXEC SQL BEGIN DECLARE SECTION;
int index;
int result;
EXEC SQL END DECLARE SECTION;
...
EXEC SQL SELECT res INTO :result FROM mytable WHERE index = :index;</pre><p> преобразуется в: </p><pre class="programlisting">
/* Processed by ecpg (2.6.0) */
/* These two include files are added by the preprocessor */
#include &lt;ecpgtype.h&gt;;
#include &lt;ecpglib.h&gt;;

/* exec sql begin declare section */

#line 1 "foo.pgc"

 int index;
 int result;
/* exec sql end declare section */
...
ECPGdo(__LINE__, NULL, "SELECT res FROM mytable WHERE index = ?     ",
        ECPGt_int,&amp;(index),1L,1L,sizeof(int),
        ECPGt_NO_INDICATOR, NULL , 0L, 0L, 0L, ECPGt_EOIT,
        ECPGt_int,&amp;(result),1L,1L,sizeof(int),
        ECPGt_NO_INDICATOR, NULL , 0L, 0L, 0L, ECPGt_EORT);
#line 147 "foo.pgc"

</pre><p> (Отступы здесь добавлены для читаемости, препроцессор их не вставляет.)</p></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="ecpg-oracle-compat.html" title="36.16. Режим совместимости с Oracle">Пред.</a> </td><td width="20%" align="center"><a accesskey="u" href="ecpg.html" title="Глава 36. ECPG — Встраиваемый SQL в C">Наверх</a></td><td width="40%" align="right"> <a accesskey="n" href="information-schema.html" title="Глава 37. Информационная схема">След.</a></td></tr><tr><td width="40%" align="left" valign="top">36.16. Режим совместимости с <span class="productname">Oracle</span> </td><td width="20%" align="center"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="40%" align="right" valign="top"> Глава 37. Информационная схема</td></tr></table></div></body></html>