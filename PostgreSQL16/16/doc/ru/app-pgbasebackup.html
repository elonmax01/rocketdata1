<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>pg_basebackup</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@lists.postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets Vsnapshot" /><link rel="prev" href="app-pgamcheck.html" title="pg_amcheck" /><link rel="next" href="pgbench.html" title="pgbench" /></head><body id="docContent" class="container-fluid col-10"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="5" align="center"><span class="application">pg_basebackup</span></th></tr><tr><td width="10%" align="left"><a accesskey="p" href="app-pgamcheck.html" title="pg_amcheck">Пред.</a> </td><td width="10%" align="left"><a accesskey="u" href="reference-client.html" title="Клиентские приложения PostgreSQL">Наверх</a></td><th width="60%" align="center">Клиентские приложения PostgreSQL</th><td width="10%" align="right"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="10%" align="right"> <a accesskey="n" href="pgbench.html" title="pgbench">След.</a></td></tr></table><hr /></div><div class="refentry" id="APP-PGBASEBACKUP"><div class="titlepage"></div><a id="id-1.9.4.10.1" class="indexterm"></a><div class="refnamediv"><h2><span class="refentrytitle"><span class="application">pg_basebackup</span></span></h2><p>pg_basebackup — создать резервную копию кластера <span class="productname">PostgreSQL</span></p></div><div class="refsynopsisdiv"><h2>Синтаксис</h2><div class="cmdsynopsis"><p id="id-1.9.4.10.4.1"><code class="command">pg_basebackup</code> [<em class="replaceable"><code>параметр</code></em>...]</p></div></div><div class="refsect1" id="id-1.9.4.10.5"><h2>Описание</h2><p>Программа <span class="application">pg_basebackup</span> предназначена для создания базовых копий работающего кластера баз данных <span class="productname">PostgreSQL</span>. Процедура создания копии не влияет на работу других клиентов базы. Полученные копии могут использоваться и для восстановления на момент времени (см. <a class="xref" href="continuous-archiving.html" title="26.3. Непрерывное архивирование и восстановление на момент времени (Point-in-Time Recovery, PITR)">Раздел 26.3</a>), и в качестве базового состояния ведомого сервера при реализации трансляции журнала или потоковой репликации (см. <a class="xref" href="warm-standby.html" title="27.2. Трансляция журналов на резервные серверы">Раздел 27.2</a>).</p><p><span class="application">pg_basebackup</span> создаёт точную копию файлов кластера, автоматически включая режим резервного копирования и завершая его. Такие резервные копии всегда создаются для кластера целиком; создать копию отдельных баз данных или объектов базы нельзя. Для выборочного копирования нужно использовать другие средства, например <a class="xref" href="app-pgdump.html" title="pg_dump"><span class="refentrytitle"><span class="application">pg_dump</span></span></a>.</p><p>Копия создаётся через обычное подключение к <span class="productname">PostgreSQL</span>, и при этом используется протокол репликации. Соединение с сервером должен устанавливать пользователь с правом <code class="literal">REPLICATION</code> (см. <a class="xref" href="role-attributes.html" title="22.2. Атрибуты ролей">Раздел 22.2</a>) или суперпользователь, а в <code class="filename">pg_hba.conf</code> должно разрешаться подключение для репликации. Кроме того, на сервере должно быть установлено достаточно большое значение <a class="xref" href="runtime-config-replication.html#GUC-MAX-WAL-SENDERS">max_wal_senders</a>, чтобы мог запуститься минимум один передатчик WAL для резервного копирования и ещё один для потоковой трансляции WAL (если она применяется).</p><p>Можно запустить одновременно несколько команд <code class="command">pg_basebackup</code>, но с точки зрения производительности обычно эффективнее делать всего одну копию одновременно, а затем копировать получаемый результат.</p><p>С помощью <span class="application">pg_basebackup</span> можно получить базовую копию не только с ведущего, но и с ведомого сервера. Чтобы сделать копию с ведомого, настройте его, чтобы он мог принимать подключения репликации (для этого нужно установить подходящие значения <code class="varname">max_wal_senders</code>, <a class="xref" href="runtime-config-replication.html#GUC-HOT-STANDBY">hot_standby</a> и подкорректировать <code class="filename">pg_hba.conf</code>). При этом на ведущем необходимо также включить <a class="xref" href="runtime-config-wal.html#GUC-FULL-PAGE-WRITES">full_page_writes</a>.</p><p>Заметьте, что при копировании с ведомого сервера есть некоторые ограничения: </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Файл истории резервного копирования в целевом кластере баз данных не создаётся.</p></li><li class="listitem"><p><span class="application">pg_basebackup</span> не может принудительно переключить ведомый сервер на новый файл WAL в конце копирования. Поэтому, если используется режим <code class="literal">-X none</code> и активность записи на ведущем сервере низкая, <span class="application">pg_basebackup</span> может довольно долго ждать переключения и архивирования последнего файла WAL, необходимого для полноты копии. В этом случае может иметь смысл выполнить на ведущем сервере <code class="function">pg_switch_wal</code> для немедленного переключения файла WAL.</p></li><li class="listitem"><p>Если ведомый сервер повышается и становится ведущим в процессе копирования, копирование прерывается.</p></li><li class="listitem"><p>Все необходимые для резервной копии WAL-записи должны содержать полные страницы, для чего нужно включить режим <code class="varname">full_page_writes</code> на ведущем сервере.</p></li></ul></div><p>Когда <span class="application">pg_basebackup</span> создаёт базовую копию, в представлении <code class="structname">pg_stat_progress_basebackup</code> отображается состояние этого процесса. За подробностями обратитесь к <a class="xref" href="progress-reporting.html#BASEBACKUP-PROGRESS-REPORTING" title="28.4.6. Отслеживание выполнение базового копирования">Подразделу 28.4.6</a>.</p></div><div class="refsect1" id="id-1.9.4.10.6"><h2>Параметры</h2><p>Следующие аргументы командной строки задают расположение и формат вывода: </p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="option">-D <em class="replaceable"><code>каталог</code></em></code><br /></span><span class="term"><code class="option">--pgdata=<em class="replaceable"><code>каталог</code></em></code></span></dt><dd><p>Целевой каталог, куда будет записана копия. Если он не существует, <span class="application">pg_basebackup</span> создаст его, а также отсутствующие родительские каталоги, при необходимости. Если он существует, он должен быть пустым.</p><p>Если копия создаётся в формате tar, в качестве целевого каталога можно задать <code class="literal">-</code> (минус), и тогда файл tar будет записан в <code class="literal">stdout</code>.</p><p>Этот флаг является обязательным.</p></dd><dt><span class="term"><code class="option">-F <em class="replaceable"><code>формат</code></em></code><br /></span><span class="term"><code class="option">--format=<em class="replaceable"><code>формат</code></em></code></span></dt><dd><p>Устанавливает формат вывода. <em class="replaceable"><code>формат</code></em> может принимать следующие значения: </p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">p</code><br /></span><span class="term"><code class="literal">plain</code></span></dt><dd><p>Записывает выводимые данные в обычные файлы, сохраняя структуру каталогов данных и табличных пространств как на исходном сервере. Если в кластере нет дополнительных табличных пространств, вся база будет помещена в заданный каталог. Иначе основной каталог хранения данных будет помещён в целевой каталог, а все остальные табличные пространства — в те же абсолютные пути, в которых они располагаются на исходном сервере. (Чтобы изменить эти пути, воспользуйтесь параметром <code class="option">--tablespace-mapping</code>).</p><p>Это формат по умолчанию.</p></dd><dt><span class="term"><code class="literal">t</code><br /></span><span class="term"><code class="literal">tar</code></span></dt><dd><p>Записывает в целевой каталог файлы в формате tar. Содержимое основного каталога данных будет записано в файл <code class="filename">base.tar</code>, а каждое дополнительное табличное пространство — в отдельный файл, содержащий в имени OID этого пространства.</p><p>Если в качестве имени целевого каталога задано <code class="literal">-</code> (минус), содержимое tar будет записано в устройство стандартного вывода, что позволяет, например, передать его программе <span class="productname">gzip</span>. Это возможно, только если в кластере нет дополнительных табличных пространств и не используется трансляция WAL.</p></dd></dl></div></dd><dt><span class="term"><code class="option">-R</code><br /></span><span class="term"><code class="option">--write-recovery-conf</code></span></dt><dd><p>Создать файл <a class="link" href="warm-standby.html#FILE-STANDBY-SIGNAL"><code class="filename">standby.signal</code></a> <a id="id-1.9.4.10.6.2.1.3.3.1.2" class="indexterm"></a> и добавить параметры конфигурации в файл <code class="filename">postgresql.auto.conf</code> в целевом каталоге (или внутри архива, если используется формат tar). Это упрощает настройку ведомого сервера при восстановлении этой копии.</p><p>В файл <code class="filename">postgresql.auto.conf</code> будут записаны параметры соединения и слот репликации, если его использует <span class="application">pg_basebackup</span>, так что впоследствии при потоковой репликации будут использоваться те же параметры.</p></dd><dt><span class="term"><code class="option">-t <em class="replaceable"><code>получатель</code></em></code><br /></span><span class="term"><code class="option">--target=<em class="replaceable"><code>получатель</code></em></code></span></dt><dd><p>Указывает серверу, куда отправлять созданную копию. Получателем по умолчанию является <code class="literal">client</code>, то есть резервная копия будет отправлена на компьютер, где работает <span class="application">pg_basebackup</span>. Если же в качестве получателя установлено <code class="literal">server:/some/path</code>, резервная копия будет сохранена на компьютере, где работает сервер, в каталоге <code class="literal">/some/path</code>. Для сохранения резервной копии на сервере требуются права суперпользователя или роли <code class="literal">pg_write_server_files</code>. Если в качестве получателя указать <code class="literal">blackhole</code>, содержимое копии отправляется в <span class="quote">«<span class="quote">чёрную дыру</span>»</span> и нигде не сохраняется. Этот вариант следует использовать только в целях тестирования, так как собственно резервной копии вы не получите.</p><p>Так как приём потока WAL реализован в <span class="application">pg_basebackup</span>, а не на стороне сервера, этот параметр нельзя использовать вместе с <code class="literal">-Xstream</code>. Так как режим <code class="literal">-Xstream</code> используется по умолчанию, указывая данный параметр, необходимо также указать либо <code class="literal">-Xfetch</code>, либо <code class="literal">-Xnone</code>.</p></dd><dt><span class="term"><code class="option">-T <em class="replaceable"><code>старый_каталог</code></em>=<em class="replaceable"><code>новый_каталог</code></em></code><br /></span><span class="term"><code class="option">--tablespace-mapping=<em class="replaceable"><code>старый_каталог</code></em>=<em class="replaceable"><code>новый_каталог</code></em></code></span></dt><dd><p>Переместить табличное пространство из <em class="replaceable"><code>старого_каталога</code></em> в <em class="replaceable"><code>новый_каталог</code></em> в процессе копирования. Чтобы перемещение произошло, в параметре <em class="replaceable"><code>старый_каталог</code></em> путь табличного пространства должен задаваться в точности так, как он определён на исходном сервере. (Но не будет ошибкой, если на исходном сервере не окажется табличного пространства, на которое указывает <em class="replaceable"><code>старый_каталог</code></em>.) В то же время, <em class="replaceable"><code>новый_каталог</code></em> задаёт путь в файловой системе получающего сервера. Как и основной целевой каталог, <em class="replaceable"><code>новый_каталог</code></em> может не существовать, но если он существует, он должен быть пустым. И <em class="replaceable"><code>старый_каталог</code></em>, и <em class="replaceable"><code>новый_каталог</code></em> должны задаваться абсолютными путями. Если в пути встречается символ <code class="literal">=</code>, его необходимо экранировать обратной косой чертой. Этот параметр можно добавить несколько раз для нескольких табличных пространств.</p><p>Если табличное пространство перемещается таким способом, символические ссылки внутри основного каталога хранения данных также приводятся в соответствие с новым местоположением. Таким образом, для экземпляра сервера подготавливается новый каталог данных, в котором все табличные пространства оказываются в новом расположении.</p><p>В настоящее время этот параметр работает только с обычным форматом вывода; если выбран формат tar, параметр игнорируется.</p></dd><dt><span class="term"><code class="option">--waldir=<em class="replaceable"><code>каталог_wal</code></em></code></span></dt><dd><p>Задать каталог, в который будут записаны файлы WAL (журнал предзаписи). По умолчанию файлы WAL будут записываться в подкаталог <code class="filename">pg_wal</code> целевого каталога, но с помощью этого параметра их можно поместить в любое место. Путь <em class="replaceable"><code>каталог_wal</code></em> должен быть абсолютным. Как и основной целевой каталог, <em class="replaceable"><code>каталог_wal</code></em> может не существовать, но если он существует, он должен быть пустым. Этот параметр можно задать, только если копия создаётся в простом формате.</p></dd><dt><span class="term"><code class="option">-X <em class="replaceable"><code>метод</code></em></code><br /></span><span class="term"><code class="option">--wal-method=<em class="replaceable"><code>метод</code></em></code></span></dt><dd><p>Включает в резервную копию все необходимые файлы журнала предзаписи (файлы WAL). В том числе включаются все файлы журнала, сгенерированные в процессе создания резервной копии. Любой метод, кроме <code class="literal">none</code>, позволяет запустить сервер с восстановленным каталогом, не используя архив WAL; таким образом будет получена полностью самодостаточная резервная копия.</p><p>Поддерживаются следующие <em class="replaceable"><code>методы</code></em> получения журналов предзаписи: </p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">n</code><br /></span><span class="term"><code class="literal">none</code></span></dt><dd><p>Не включать журналы предзаписи в резервную копию.</p></dd><dt><span class="term"><code class="literal">f</code><br /></span><span class="term"><code class="literal">fetch</code></span></dt><dd><p>Файлы журнала предзаписи собираются в конце процесса копирования. Таким образом необходимо установить достаточно большое значение параметра <a class="xref" href="runtime-config-replication.html#GUC-WAL-KEEP-SIZE">wal_keep_size</a>, чтобы избежать преждевременного удаления нужных данных журнала. В случае переработки этих данных до завершения процесса копирования возникнет ошибка, а копия будет непригодной к использованию.</p><p>Когда используется формат tar, файлы журнала предзаписи включаются в архив <code class="filename">base.tar</code>.</p></dd><dt><span class="term"><code class="literal">s</code><br /></span><span class="term"><code class="literal">stream</code></span></dt><dd><p>Передавать журнал предзаписи в процессе создания резервной копии. При выборе этого метода открывается второе соединение к серверу, через которое будет передаваться журнал предзаписи параллельно с созданием копии. Таким образом, этот метод требует использования не одного, а двух соединений репликации, но если клиент будет успевать получать данные журнала предзаписи, на исходном сервере не потребуется сохранять дополнительные журналы.</p><p>Когда используется формат tar, файлы журнала предзаписи сохраняются в отдельном архиве с именем <code class="filename">pg_wal.tar</code> (если версия сервера ниже 10, файл будет называться <code class="filename">pg_xlog.tar</code>).</p><p>Это значение по умолчанию.</p></dd></dl></div></dd><dt><span class="term"><code class="option">-z</code><br /></span><span class="term"><code class="option">--gzip</code></span></dt><dd><p>Включает gzip-сжатие выводимого tar-файла с уровнем компрессии по умолчанию. Сжатие поддерживается только для формата tar, при этом ко всем именам файлов tar добавляется суффикс <code class="filename">.gz</code>.</p></dd><dt><span class="term"><code class="option">-Z <em class="replaceable"><code>уровень</code></em></code><br /></span><span class="term"><code class="option">-Z [{client|server}-]<em class="replaceable"><code>метод</code></em>[:<em class="replaceable"><code>дополнительная_информация</code></em>]</code><br /></span><span class="term"><code class="option">--compress=<em class="replaceable"><code>уровень</code></em></code><br /></span><span class="term"><code class="option">--compress=[{client|server}-]<em class="replaceable"><code>метод</code></em>[:<em class="replaceable"><code>дополнительная_информация</code></em>]</code></span></dt><dd><p>Запрашивает сжатие резервной копии. Если добавляется префикс <code class="literal">client</code> или <code class="literal">server</code>, он указывает, где должно выполняться сжатие. Когда сжатие выполняет сервер, объём передаваемых данных уменьшается, но увеличивается нагрузка на процессор сервера. По умолчанию используется <code class="literal">client</code>, за исключением случаев, когда используется ключ <code class="literal">--target</code>. В этих случаях резервная копия не передаётся клиенту, поэтому смысл имеет только сжатие на стороне сервера. В режиме <code class="literal">-Xstream</code> (выбираемом по умолчанию) сжатие на стороне сервера не распространяется на WAL. Чтобы WAL сжимался, примените сжатие на стороне клиента или используйте режим <code class="literal">-Xfetch</code>.</p><p>В качестве метода сжатия можно выбрать <code class="literal">gzip</code>, <code class="literal">lz4</code>, <code class="literal">zstd</code>, <code class="literal">none</code> без сжатия или целое число (если задать 0 — без сжатия, если больше нуля — <code class="literal">gzip</code>). В качестве дополнительной информации можно передать параметры сжатия. Если в строке информации передаётся целое число, оно задаёт уровень сжатия. В противном случае она должна содержать список элементов, разделённых запятыми, в форме <em class="replaceable"><code>ключевое_слово</code></em> или <em class="replaceable"><code>ключевое_слово=значение</code></em>. На данный момент поддерживаются ключевые слова <code class="literal">level</code>, <code class="literal">long</code> и <code class="literal">workers</code>. Если метод сжатия задан целым числом, строку информации использовать нельзя.</p><p>Если уровень сжатия не указан, будет выбран уровень сжатия по умолчанию. Если указан только уровень сжатия, но не указан метод, будет применяться метод сжатия <code class="literal">gzip</code>, когда уровень больше 0, а когда уровень равен 0, сжатие не будет выполняться.</p><p>Когда формат tar сжимается методом <code class="literal">gzip</code>, <code class="literal">lz4</code> или <code class="literal">zstd</code>, ко всем именам файлов tar автоматически добавляется суффикс <code class="filename">.gz</code>, <code class="filename">.lz4</code> или <code class="filename">.zst</code> соответственно. Когда используется простой формат, сжатие на стороне клиента выполнить нельзя, но при этом можно запросить сжатие на стороне сервера. В таком случае сервер будет сжимать копию для передачи, а клиент будет распаковывать и извлекать из неё данные.</p><p>Когда этот параметр используется в сочетании с <code class="literal">-Xstream</code>, <code class="literal">pg_wal.tar</code> будет сжат методом <code class="literal">gzip</code>, если выбрано сжатие gzip на стороне клиента, и не будет сжат, если выбран любой другой алгоритм сжатия или выбрано сжатие на стороне сервера.</p></dd></dl></div><p>Описанные далее аргументы командной строки управляют формированием резервной копии и вызовом программы: </p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="option">-c {fast|spread}</code><br /></span><span class="term"><code class="option">--checkpoint={fast|spread}</code></span></dt><dd><p>Устанавливает режим контрольных точек: fast (быстрый) или spread (протяжённый, по умолчанию). Подробнее см. <a class="xref" href="continuous-archiving.html#BACKUP-LOWLEVEL-BASE-BACKUP" title="26.3.3. Создание базовой резервной копии через низкоуровневый API">Подраздел 26.3.3</a>.</p></dd><dt><span class="term"><code class="option">-C</code><br /></span><span class="term"><code class="option">--create-slot</code></span></dt><dd><p>Указывает, что до начала копирования должен быть создан слот репликации с именем, заданным в <code class="literal">--slot</code>. Если такой слот уже существует, выдаётся ошибка.</p></dd><dt><span class="term"><code class="option">-l <em class="replaceable"><code>метка</code></em></code><br /></span><span class="term"><code class="option">--label=<em class="replaceable"><code>метка</code></em></code></span></dt><dd><p>Устанавливает метку для созданной резервной копии. Если не указана, то по умолчанию будет использовано значение <span class="quote">«<span class="quote"><code class="literal">pg_basebackup base backup</code></span>»</span>.</p></dd><dt><span class="term"><code class="option">-n</code><br /></span><span class="term"><code class="option">--no-clean</code></span></dt><dd><p>По умолчанию, когда программа <code class="command">pg_basebackup</code> прерывается с ошибкой, она удаляет все каталоги, которые она могла создать, прежде чем обнаружила, что не может завершить задание (например, целевой каталог и каталог журнала предзаписи). Данный ключ отключает эту очистку и тем самым полезен для отладки.</p><p>Заметьте, что каталоги табличных пространств не очищаются в любом случае.</p></dd><dt><span class="term"><code class="option">-N</code><br /></span><span class="term"><code class="option">--no-sync</code></span></dt><dd><p>По умолчанию <code class="command">pg_basebackup</code> ждёт, пока все файлы не будут надёжно записаны на диск. С данным параметром <code class="command">pg_basebackup</code> завершается немедленно, то есть выполняется быстрее, но в случае неожиданного сбоя операционной системы резервная копия может оказаться испорченной. Вообще этот параметр предназначен прежде всего для тестирования, для производственной среды он не подходит.</p></dd><dt><span class="term"><code class="option">-P</code><br /></span><span class="term"><code class="option">--progress</code></span></dt><dd><p>Включает отчёт о прогрессе. Если этот режим включён, то во время создания копии будет передаваться примерный процент выполнения. Так как данные в базе могут меняться во время копирования, это значение будет лишь приближённым и может достигать не точно <code class="literal">100%</code>. В частности, когда в копию включается журнал WAL, конечный размер невозможно предсказать заранее, и в этом случае ожидаемый конечный размер будет увеличиваться, превысив ориентировочный полный размер без WAL.</p></dd><dt><span class="term"><code class="option">-r <em class="replaceable"><code>скорость_передачи</code></em></code><br /></span><span class="term"><code class="option">--max-rate=<em class="replaceable"><code>скорость_передачи</code></em></code></span></dt><dd><p>Задаёт максимальную скорость, с которой данные будут загружаться с исходного сервера. Это может быть полезно для ограничения влияния <span class="application">pg_basebackup</span> на сервер. Значение параметра задаётся в килобайтах в секунду. Для указания мегабайт в секунду нужно добавить к числу суффикс <code class="literal">M</code>. Так же принимается суффикс <code class="literal">k</code>, но он ничего не меняет. Допустимые значения лежат в диапазоне от 32 КБ/с до 1024 МБ/с.</p><p>Этот параметр всегда оказывает влияние на передачу каталога данных, а на передачу файлов WAL он влияет, только если выбран метод передачи <code class="literal">fetch</code>.</p></dd><dt><span class="term"><code class="option">-S <em class="replaceable"><code>имя_слота</code></em></code><br /></span><span class="term"><code class="option">--slot=<em class="replaceable"><code>имя_слота</code></em></code></span></dt><dd><p>Этот параметр может применяться только вместе с <code class="literal">-X stream</code>. Он выбирает слот репликации, который будет использоваться для передачи WAL. Если базовая копия предназначена для использования на ведомом сервере с потоковой репликацией через слот, это же имя слота должно задаваться на ведомом в качестве <a class="xref" href="runtime-config-replication.html#GUC-PRIMARY-SLOT-NAME">primary_slot_name</a>. Тем самым гарантируется, что ведущий сервер не удалит никакие необходимые данные WAL после того, как базовая копия будет получена, и до того, как начнётся потоковая репликация на новом ведомом.</p><p>В случае отсутствия ключа <code class="option">-C</code> требуется, чтобы указанный слот репликации уже существовал.</p><p>Если этот ключ не указан и сервер поддерживает временные слоты репликации (они появились в версии 10), для трансляции WAL автоматически используется временный слот репликации.</p></dd><dt><span class="term"><code class="option">-v</code><br /></span><span class="term"><code class="option">--verbose</code></span></dt><dd><p>Включает режим подробного вывода. Будет выводится некоторая дополнительная информация при начале и завершении, а также имена обрабатываемых файлов, если включён отчёт о прогрессе.</p></dd><dt><span class="term"><code class="option">--manifest-checksums=<em class="replaceable"><code>алгоритм</code></em></code></span></dt><dd><p>Задаёт алгоритм контрольных сумм, которые будут рассчитываться для всех файлов, описанных в манифесте копии. В настоящее время поддерживаются алгоритмы <code class="literal">NONE</code> (отсутствует), <code class="literal">CRC32C</code>, <code class="literal">SHA224</code>, <code class="literal">SHA256</code>, <code class="literal">SHA384</code> и <code class="literal">SHA512</code>. По умолчанию применяется <code class="literal">CRC32C</code>.</p><p>Если выбран вариант <code class="literal">NONE</code>, манифест копии не будет содержать контрольные суммы. С любым другим вариантом в манифест будет записана контрольная сумма каждого файла в копии, рассчитанная по выбранному алгоритму. Помимо этого, в манифесте всегда сохраняется контрольная сумма его содержимого, рассчитанная по алгоритму <code class="literal">SHA256</code>. Алгоритмы семейства <code class="literal">SHA</code> требуют значительно больше процессорных ресурсов, чем <code class="literal">CRC32C</code>, поэтому выбор такого алгоритма может повлечь увеличение времени создания копии.</p><p>Функции хеширования SHA обеспечивают криптографическую стойкость хеша каждого файла, и таким образом полезны, когда нужны гарантии, что резервная копия не была модифицирована. С другой стороны, алгоритм CRC32C вычисляет контрольную сумму гораздо быстрее и вполне подходит для выявления изменений, внесённых не злонамеренно, а случайно. Заметьте, что такая защита от злоумышленника, имеющего доступ к сохранённой копии, будет эффективна, только если манифест копии хранится отдельно в безопасном месте или ещё каким-то образом проверяется, что манифест не был изменён с момента создания копии.</p><p>Для проверки целостности копии по созданному манифесту можно воспользоваться программой <a class="xref" href="app-pgverifybackup.html" title="pg_verifybackup"><span class="refentrytitle"><span class="application">pg_verifybackup</span></span></a>.</p></dd><dt><span class="term"><code class="option">--manifest-force-encode</code></span></dt><dd><p>Принудительно включает шестнадцатеричное кодирование всех имён файлов в манифесте. Если этот параметр не задаётся, в шестнадцатеричном виде кодируются только имена файлов не в кодировке UTF-8. Этот параметр в первую очередь предназначен для проверки того, что средства чтения манифеста могут правильно разобрать такие имена.</p></dd><dt><span class="term"><code class="option">--no-estimate-size</code></span></dt><dd><p>Отключает расчёт примерного объёма данных, которые будут передаваться в процессе копирования, в результате чего столбец <code class="structfield">backup_total</code> в представлении <code class="structname">pg_stat_progress_basebackup</code> будет содержать <code class="literal">NULL</code>.</p><p>Без этого указания процесс копирования начнётся с перечисления файлов для подсчёта размера всей базы данных, а затем продолжится отправкой непосредственно данных. Это может немного увеличить общую длительность процесса, в частности, пройдёт больше времени до начала передачи данных. Данный параметр полезен, когда время расчёта объёма оказывается слишком большим.</p><p>Этот параметр нельзя использовать вместе с параметром <code class="option">--progress</code>.</p></dd><dt><span class="term"><code class="option">--no-manifest</code></span></dt><dd><p>Отключает создание манифеста копии. Если этот флаг не указан, сервер будет формировать и передавать в составе копии манифест, который может быть проверен с использованием <a class="xref" href="app-pgverifybackup.html" title="pg_verifybackup"><span class="refentrytitle"><span class="application">pg_verifybackup</span></span></a>. Манифест представляет собой список всех файлов, включённых в копию, за исключением файлов WAL, которые могут быть в неё добавлены. Также в нём сохраняется размер, дата последнего изменения и, возможно, контрольная сумма каждого файла.</p></dd><dt><span class="term"><code class="option">--no-slot</code></span></dt><dd><p>Предотвращает создание временного слота репликации для резервного копирования.</p><p>По умолчанию, если выбрана передача журнала, но имя слота в <code class="option">-S</code> не задано, создаётся временный слот репликации (при условии, что это поддерживает исходный сервер).</p><p>Основное предназначение этого ключа в том, чтобы можно было сделать базовую резервную копию, когда на сервере нет свободных слотов репликации. Использование слота репликации почти всегда предпочтительнее, так как при этом предотвращается удаление сервером необходимых файлов WAL во время резервного копирования.</p></dd><dt><span class="term"><code class="option">--no-verify-checksums</code></span></dt><dd><p>Отключает проверку контрольных сумм, если они включены на сервере, с которого делается резервная копия.</p><p>По умолчанию контрольные суммы проверяются, и при выявлении их несоответствия выдаётся ненулевой код завершения. Однако базовая резервная копия в этом случае не удаляется, как и с ключом <code class="option">--no-clean</code>. Ошибки контрольных сумм также можно просмотреть в представлении <a class="link" href="monitoring-stats.html#MONITORING-PG-STAT-DATABASE-VIEW" title="28.2.16. pg_stat_database"><code class="structname">pg_stat_database</code></a>.</p></dd></dl></div><p>Далее описаны параметры, управляющие подключением к исходному серверу: </p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="option">-d <em class="replaceable"><code>строка_подключения</code></em></code><br /></span><span class="term"><code class="option">--dbname=<em class="replaceable"><code>строка_подключения</code></em></code></span></dt><dd><p>Указывает параметры подключения к серверу в формате <a class="link" href="libpq-connect.html#LIBPQ-CONNSTRING" title="34.1.1. Строки параметров подключения">строки подключения</a>; они будут переопределять любые одноимённые параметры, заданные в командной строке.</p><p>Параметр называется <code class="literal">--dbname</code> для согласованности с другими клиентскими приложениями, но так как <span class="application">pg_basebackup</span> не подключается к какой-либо конкретной базе, любое имя базы данных в строке подключения игнорируется.</p></dd><dt><span class="term"><code class="option">-h <em class="replaceable"><code>сервер</code></em></code><br /></span><span class="term"><code class="option">--host=<em class="replaceable"><code>сервер</code></em></code></span></dt><dd><p>Указывает имя компьютера, на котором работает сервер. Если значение начинается с косой черты, оно определяет каталог Unix-сокета. Значение по умолчанию берётся из переменной окружения <code class="envar">PGHOST</code>, если она установлена. В противном случае выполняется подключение к Unix-сокету.</p></dd><dt><span class="term"><code class="option">-p <em class="replaceable"><code>порт</code></em></code><br /></span><span class="term"><code class="option">--port=<em class="replaceable"><code>порт</code></em></code></span></dt><dd><p>Указывает TCP-порт или расширение файла локального Unix-сокета, через который сервер принимает подключения. Значение по умолчанию определяется переменной окружения <code class="envar">PGPORT</code>, если она установлена, либо числом, заданным при компиляции.</p></dd><dt><span class="term"><code class="option">-s <em class="replaceable"><code>interval</code></em></code><br /></span><span class="term"><code class="option">--status-interval=<em class="replaceable"><code>interval</code></em></code></span></dt><dd><p>Указывает интервал в секундах между сообщениями о состоянии, передаваемыми исходному серверу. Чем меньше указанное значение, тем точнее будет информация о процессе резервного копирования на сервере. Нулевое значение полностью отключает периодическое обновление состояния, хотя эти сообщения будут всё равно посылаться по запросу сервера во избежание отключения по тайм-ауту. Значение по умолчанию — 10 секунд.</p></dd><dt><span class="term"><code class="option">-U <em class="replaceable"><code>имя_пользователя</code></em></code><br /></span><span class="term"><code class="option">--username=<em class="replaceable"><code>имя_пользователя</code></em></code></span></dt><dd><p>Задаёт имя пользователя для подключения.</p></dd><dt><span class="term"><code class="option">-w</code><br /></span><span class="term"><code class="option">--no-password</code></span></dt><dd><p>Не выдавать запрос на ввод пароля. Если сервер требует аутентификацию по паролю и пароль нельзя получить другими средствами, например из файла <code class="filename">.pgpass</code>, попытка соединения не удастся. Этот параметр может быть полезен в пакетных заданиях и скриптах, где нет пользователя, который вводит пароль.</p></dd><dt><span class="term"><code class="option">-W</code><br /></span><span class="term"><code class="option">--password</code></span></dt><dd><p>Принудительно запрашивать пароль перед подключением к исходному серверу.</p><p>Это несущественный параметр, так как <span class="application">pg_basebackup</span> запрашивает пароль автоматически, если сервер проверяет подлинность по паролю. Однако чтобы понять это, <span class="application">pg_basebackup</span> лишний раз подключается к серверу. Поэтому иногда имеет смысл ввести <code class="option">-W</code>, чтобы исключить эту ненужную попытку подключения.</p></dd></dl></div><p>Другие флаги: </p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="option">-V</code><br /></span><span class="term"><code class="option">--version</code></span></dt><dd><p>Вывести версию <span class="application">pg_basebackup</span> и завершиться.</p></dd><dt><span class="term"><code class="option">-?</code><br /></span><span class="term"><code class="option">--help</code></span></dt><dd><p>Вывести справку по аргументам командной строки <span class="application">pg_basebackup</span> и завершиться.</p></dd></dl></div></div><div class="refsect1" id="id-1.9.4.10.7"><h2>Переменные окружения</h2><p>Как и большинство других утилит <span class="productname">PostgreSQL</span>, приложение также использует переменные окружения, поддерживаемые <span class="application">libpq</span> (см. <a class="xref" href="libpq-envars.html" title="34.15. Переменные окружения">Раздел 34.15</a>).</p><p>Переменная окружения <code class="envar">PG_COLOR</code> выбирает вариант использования цвета в диагностических сообщениях. Возможные значения: <code class="literal">always</code> (всегда), <code class="literal">auto</code> (автоматически) и <code class="literal">never</code> (никогда).</p></div><div class="refsect1" id="id-1.9.4.10.8"><h2>Замечания</h2><p>До начала копирования на исходном сервере необходимо выполнить контрольную точку. И если копирование запускается без ключа <code class="literal">--checkpoint=fast</code>, это может занять некоторое время, в течение которого <span class="application">pg_basebackup</span> не будет проявлять никакой активности.</p><p>Резервная копия будет включать в себя все файлы каталога хранения данных и табличных пространств, а также конфигурационные файлы и прочие файлы, размещённые в каталоге данных, за исключением определённых временных файлов, принадлежащих PostgreSQL, и файлов операционной системы. Однако копируются лишь простые файлы и каталоги, кроме них, сохраняются только символические ссылки на табличные пространства. Символические ссылки, указывающие на определённые каталоги, известные PostgreSQL, копируются как пустые каталоги. Другие символические ссылки и файлы спецустройств игнорируются. За дополнительными подробностями обратитесь к <a class="xref" href="protocol-replication.html" title="55.4. Протокол потоковой репликации">Разделу 55.4</a>.</p><p>Если не указан параметр <code class="literal">--tablespace-mapping</code>, в простом формате табличные пространства будут копироваться в тот же путь, который они имеют на исходном сервере. Поэтому при наличии табличных пространств создать базовую копию в простом формате на том же сервере не удастся, так как копия будет направлена в те же каталоги, где располагаются исходные табличные пространства.</p><p>Когда применяется формат tar, пользователь должен позаботиться о том, чтобы все архивы tar были распакованы до запуска сервера PostgreSQL, который будет работать с этими данными. Если имеются дополнительные табличные пространства, архивы tar для них должны быть распакованы в правильные каталоги. В таком случае для этих табличных пространств сервером будут созданы символические ссылки согласно содержимому файла <code class="filename">tablespace_map</code>, включённого в архив <code class="filename">base.tar</code>.</p><p><span class="application">pg_basebackup</span> совместим с серверами той же или более младших версий, но не ниже версии 9.1. Однако режим трансляции WAL (<code class="literal">-X stream</code>) работает только с серверами версии 9.3 и новее, а формат tar (<code class="literal">--format=tar</code>) поддерживается только с версиями не ниже 9.5.</p><p><span class="application">pg_basebackup</span> сохранит разрешения для группы, установленные для файлов данных, если такие разрешения были включены в исходном кластере.</p></div><div class="refsect1" id="id-1.9.4.10.9"><h2>Примеры</h2><p>Создание резервной копии сервера <code class="literal">mydbserver</code> и сохранение её в локальном каталоге <code class="filename">/usr/local/pgsql/data</code>: </p><pre class="screen">
<code class="prompt">$</code> <strong class="userinput"><code>pg_basebackup -h mydbserver -D /usr/local/pgsql/data</code></strong>
</pre><p>Создание резервной копии локального сервера в отдельных сжатых файлах tar для каждого табличного пространства и сохранение их в каталоге <code class="filename">backup</code> с индикатором прогресса в процессе выполнения: </p><pre class="screen">
<code class="prompt">$</code> <strong class="userinput"><code>pg_basebackup -D backup -Ft -z -P</code></strong>
</pre><p>Создание резервной копии локальной базы данных с одним табличным пространством и сжатие её с помощью <span class="productname">bzip2</span>: </p><pre class="screen">
<code class="prompt">$</code> <strong class="userinput"><code>pg_basebackup -D - -Ft -X fetch | bzip2 &gt; backup.tar.bz2</code></strong>
</pre><p> (Эта команда прервётся с ошибкой, если в базе данных будет несколько табличных пространств.)</p><p>Создание резервной копии локальной базы данных с перемещением табличного пространства <code class="filename">/opt/ts</code> в <code class="filename">./backup/ts</code>: </p><pre class="screen">
<code class="prompt">$</code> <strong class="userinput"><code>pg_basebackup -D backup/data -T /opt/ts=$(pwd)/backup/ts</code></strong>
</pre><p>Создание резервной копии локального сервера в отдельных сжатых файлах tar для каждого табличного пространства (при этом используется метод сжатия <span class="application">gzip</span> и уровень сжатия 9) и сохранение их в каталоге <code class="filename">backup</code>: </p><pre class="screen">
<code class="prompt">$</code> <strong class="userinput"><code>pg_basebackup -D backup -Ft --compress=gzip:9</code></strong>
</pre></div><div class="refsect1" id="id-1.9.4.10.10"><h2>См. также</h2><span class="simplelist"><a class="xref" href="app-pgdump.html" title="pg_dump"><span class="refentrytitle"><span class="application">pg_dump</span></span></a>, <a class="xref" href="progress-reporting.html#BASEBACKUP-PROGRESS-REPORTING" title="28.4.6. Отслеживание выполнение базового копирования">Подраздел 28.4.6</a></span></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="app-pgamcheck.html" title="pg_amcheck">Пред.</a> </td><td width="20%" align="center"><a accesskey="u" href="reference-client.html" title="Клиентские приложения PostgreSQL">Наверх</a></td><td width="40%" align="right"> <a accesskey="n" href="pgbench.html" title="pgbench">След.</a></td></tr><tr><td width="40%" align="left" valign="top"><span class="application">pg_amcheck</span> </td><td width="20%" align="center"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="40%" align="right" valign="top"> <span class="application">pgbench</span></td></tr></table></div></body></html>