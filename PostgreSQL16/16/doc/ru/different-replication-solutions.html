<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>27.1. Сравнение различных решений</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@lists.postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets Vsnapshot" /><link rel="prev" href="high-availability.html" title="Глава 27. Отказоустойчивость, балансировка нагрузки и репликация" /><link rel="next" href="warm-standby.html" title="27.2. Трансляция журналов на резервные серверы" /></head><body id="docContent" class="container-fluid col-10"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="5" align="center">27.1. Сравнение различных решений</th></tr><tr><td width="10%" align="left"><a accesskey="p" href="high-availability.html" title="Глава 27. Отказоустойчивость, балансировка нагрузки и репликация">Пред.</a> </td><td width="10%" align="left"><a accesskey="u" href="high-availability.html" title="Глава 27. Отказоустойчивость, балансировка нагрузки и репликация">Наверх</a></td><th width="60%" align="center">Глава 27. Отказоустойчивость, балансировка нагрузки и репликация</th><td width="10%" align="right"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="10%" align="right"> <a accesskey="n" href="warm-standby.html" title="27.2. Трансляция журналов на резервные серверы">След.</a></td></tr></table><hr /></div><div class="sect1" id="DIFFERENT-REPLICATION-SOLUTIONS"><div class="titlepage"><div><div><h2 class="title" style="clear: both">27.1. Сравнение различных решений <a href="#DIFFERENT-REPLICATION-SOLUTIONS" class="id_link">#</a></h2></div></div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term">Отказоустойчивость на разделяемых дисках</span></dt><dd><p>Отказоустойчивость на разделяемых дисках позволяет избежать избыточности синхронизации путём задействования только одной копии базы данных. Она использует единственный дисковый массив, который разделяется между несколькими серверами. Если основной сервер БД откажет, резервный сервер может подключиться и запустить базу данных, что позволит восстановить БД после аварии. Это обеспечивает быстрое переключение без потери данных.</p><p>Функциональность разделяемого оборудования обычно реализована в сетевых устройствах хранения. Так же возможно применение сетевой файловой системы; особое внимание следует уделить тому, чтобы поведение системы полностью соответствовало <acronym class="acronym">POSIX</acronym> (см. <a class="xref" href="creating-cluster.html#CREATING-CLUSTER-NFS" title="19.2.2.1. NFS">Подраздел 19.2.2.1</a>). Существенное ограничение этого метода состоит в том, что в случае отказа или порчи разделяемого дискового массива оба сервера: главный и резервный — станут нерабочими. Другая особенность — резервный сервер никогда не получает доступ к разделяемым дискам во время работы главного.</p></dd><dt><span class="term">Репликация на уровне файловой системы (блочного устройства)</span></dt><dd><p>Видоизменённая версия функциональности разделяемого оборудования представлена в виде репликации на уровне файловой системы, когда все изменения в файловой системе отражаются в файловой системе другого компьютера. Единственное ограничение: синхронизация должна выполняться методом, гарантирующим целостность копии файловой системы на резервном сервере — в частности, запись на резервном сервере должна происходить в том же порядке, что и на главном. <span class="productname">DRBD</span> является популярным решением на основе репликации файловой системы для Linux.</p></dd><dt><span class="term">Трансляция журнала предзаписи</span></dt><dd><p>Серверы тёплого и горячего резерва могут так же поддерживаться актуальными путём чтения потока записей из журнала изменений (<acronym class="acronym">WAL</acronym>). Если основной сервер отказывает, резервный содержит почти все данные с него и может быть быстро преобразован в новый главный сервер БД. Это можно сделать синхронно или асинхронно, но может быть выполнено только на уровне сервера БД целиком.</p><p>Резервный сервер может быть реализован с применением трансляции файлов журналов (см. <a class="xref" href="warm-standby.html" title="27.2. Трансляция журналов на резервные серверы">Раздел 27.2</a>), или потоковой репликации (см. <a class="xref" href="warm-standby.html#STREAMING-REPLICATION" title="27.2.5. Потоковая репликация">Подраздел 27.2.5</a>), или их комбинацией. За информацией о горячем резерве обратитесь к <a class="xref" href="hot-standby.html" title="27.4. Горячий резерв">Разделу 27.4</a>.</p></dd><dt><span class="term">Логическая репликация</span></dt><dd><p>В схеме с логической репликацией сервер баз данных может передавать поток изменений данных на другой сервер. Механизм логической репликации в <span class="productname">PostgreSQL</span> формирует поток логических изменений данных, обрабатывая WAL. Логическая репликация позволяет переносить изменения данных на уровне таблиц. Для логической репликации не требуется, чтобы за определённым сервером закреплялась роль главного или реплицирующего; напротив, данные могут передаваться в разных направлениях. За дополнительными сведениями о логической репликации обратитесь к <a class="xref" href="logical-replication.html" title="Глава 31. Логическая репликация">Главе 31</a>. Используя интерфейс логического декодирования (<a class="xref" href="logicaldecoding.html" title="Глава 49. Логическое декодирование">Глава 49</a>), подобную функциональность могут предоставлять и сторонние расширения.</p></dd><dt><span class="term">Репликация главный-резервный на основе триггеров</span></dt><dd><p>Обычно в схеме репликации на основе триггеров запросы, изменяющие данные, передаются выбранному главному серверу. А главный сервер, обрабатывая такие запросы в разрезе таблиц, асинхронно (как правило) передаёт информацию об изменениях резервным. Резервные серверы могут выполнять запросы параллельно с главным и допускать некоторые изменения локальных данных или операции записи. Применение этого вида репликации часто позволяет снять с главного сервера нагрузку сложных аналитических запросов и запросов к хранилищу данных с главного сервера.</p><p><span class="productname">Slony-I</span> является примером подобного типа репликации, действующей на уровне таблиц, и поддерживает множество резервных серверов. Так как обновления на резервных серверах происходят асинхронно (в пакетах), возможна потеря данных во время отказа.</p></dd><dt><span class="term">Репликация SQL в среднем слое</span></dt><dd><p>В схеме с репликацией SQL в среднем слое, средний слой перехватывает каждый SQL-запрос и пересылает его на один или все серверы. Каждый сервер работает независимо. Модифицирующие запросы должны быть направлены всем серверам, чтобы каждый из них получал все изменения. Но читающие запросы могут посылаться только одному серверу, что позволяет перераспределить читающую нагрузку между всеми серверами.</p><p>Если запросы просто перенаправлять без изменений, функции подобные <code class="function">random()</code>, <code class="function">CURRENT_TIMESTAMP</code> и последовательности могут получить различные значения на разных серверах. Это происходит потому что каждый сервер работает независимо, а эти запросы неизбирательные и действительно не изменяют данные. Если такая ситуация недопустима, или средний слой, или приложение должны запросить подобные значения с одного сервера, затем использовать его в других пишущих запросах. Следует иметь в виду, что все транзакции фиксируются или прерываются на всех серверах, возможно с применением двухфазной фиксации (см. <a class="xref" href="sql-prepare-transaction.html" title="PREPARE TRANSACTION"><span class="refentrytitle">PREPARE TRANSACTION</span></a> и <a class="xref" href="sql-commit-prepared.html" title="COMMIT PREPARED"><span class="refentrytitle">COMMIT PREPARED</span></a>). Репликацию такого типа реализуют, например, <span class="productname">Pgpool-II</span> и <span class="productname">Continuent Tungsten</span>.</p></dd><dt><span class="term">Асинхронная репликация с несколькими ведущими</span></dt><dd><p>Если серверы не находятся постоянно в единой сети или связаны низкоскоростным каналом, как например, ноутбуки или удалённые серверы, обеспечение согласованности данных между ними представляет проблему. Когда используется асинхронная репликация с несколькими ведущими серверами, каждый из них работает независимо и периодически связывается с другими серверами для определения конфликтующих транзакций. Конфликты могут урегулироваться пользователем или по правилам их разрешения. Примером такого типа репликации является Bucardo.</p></dd><dt><span class="term">Синхронная репликация с несколькими ведущими</span></dt><dd><p>При синхронной репликации с несколькими ведущими серверами каждый сервер может принимать запросы на запись, а изменённые данные передаются с получившего их сервера всем остальным, прежде чем транзакция будет подтверждена. Если запись производится интенсивно, это может провоцировать избыточные блокировки и задержки при фиксации, что приводит к снижению производительности. Запросы на чтение могут быть обработаны любым сервером. В некоторых конфигурациях для более эффективного взаимодействия серверов применяются разделяемые диски. Синхронная репликация с несколькими ведущими лучше всего работает, когда преобладают операции чтения, хотя её большой плюс в том, что любой сервер может принимать запросы на запись — нет необходимости искусственно разделять нагрузку между главным и резервными серверами, а так как изменения передаются от одного сервера другим, не возникает проблем с недетерминированными функциями вроде <code class="function">random()</code>.</p><p><span class="productname">PostgreSQL</span> не предоставляет данный тип репликации, но так как <span class="productname">PostgreSQL</span> поддерживает двухфазное подтверждение транзакции (<a class="xref" href="sql-prepare-transaction.html" title="PREPARE TRANSACTION"><span class="refentrytitle">PREPARE TRANSACTION</span></a> и <a class="xref" href="sql-commit-prepared.html" title="COMMIT PREPARED"><span class="refentrytitle">COMMIT PREPARED</span></a>) такое поведение может быть реализовано в коде приложения или среднего слоя.</p></dd></dl></div><p>Возможности представленных выше решений сравниваются в <a class="xref" href="different-replication-solutions.html#HIGH-AVAILABILITY-MATRIX" title="Таблица 27.1. Таблица свойств отказоустойчивости, балансировки нагрузки и репликации">Таблице 27.1</a>.</p><div class="table" id="HIGH-AVAILABILITY-MATRIX"><p class="title"><strong>Таблица 27.1. Таблица свойств отказоустойчивости, балансировки нагрузки и репликации</strong></p><div class="table-contents"><table class="table" summary="Таблица свойств отказоустойчивости, балансировки нагрузки и репликации" border="1"><colgroup><col class="col1" /><col class="col2" /><col class="col3" /><col class="col4" /><col class="col5" /><col class="col6" /><col class="col7" /><col class="col8" /><col class="col9" /></colgroup><thead><tr><th>Тип</th><th>Разделяемый диск</th><th>Репл. файловой системы</th><th>Трансляция журнала предзаписи</th><th>Логическая репл.</th><th>Триггерная репл.</th><th>Репл. SQL в среднем слое</th><th>Асинхр. репл. с н. в.</th><th>Синхр. репл. с н. в.</th></tr></thead><tbody><tr><td>Известные примеры</td><td align="center">NAS</td><td align="center">DRBD</td><td align="center">встроенная потоковая репл.</td><td align="center">встроенная логическая репл., pglogical</td><td align="center">Londiste, Slony</td><td align="center">pgpool-II</td><td align="center">Bucardo</td><td align="center"> </td></tr><tr><td>Метод взаим.</td><td align="center">разделяемые диски</td><td align="center">дисковые блоки</td><td align="center">WAL</td><td align="center">логическое декодирование</td><td align="center">Строки таблицы</td><td align="center">SQL</td><td align="center">Строки таблицы</td><td align="center">Строки таблицы и блокировки строк</td></tr><tr><td>Не требуется специального оборудования</td><td align="center"> </td><td align="center">•</td><td align="center">•</td><td align="center">•</td><td align="center">•</td><td align="center">•</td><td align="center">•</td><td align="center">•</td></tr><tr><td>Допускается несколько ведущих серверов</td><td align="center"> </td><td align="center"> </td><td align="center"> </td><td align="center">•</td><td align="center"> </td><td align="center">•</td><td align="center">•</td><td align="center">•</td></tr><tr><td>Нет доп. нагрузки на ведущем</td><td align="center">•</td><td align="center"> </td><td align="center">•</td><td align="center">•</td><td align="center"> </td><td align="center">•</td><td align="center"> </td><td align="center"> </td></tr><tr><td>Нет задержки при нескольких серверах</td><td align="center">•</td><td align="center"> </td><td align="center">без синхр.</td><td align="center">без синхр.</td><td align="center">•</td><td align="center"> </td><td align="center">•</td><td align="center"> </td></tr><tr><td>Отказ ведущего сервера не может привести к потере данных</td><td align="center">•</td><td align="center">•</td><td align="center">с синхр.</td><td align="center">с синхр.</td><td align="center"> </td><td align="center">•</td><td align="center"> </td><td align="center">•</td></tr><tr><td>Сервер реплики принимает читающие запросы</td><td align="center"> </td><td align="center"> </td><td align="center">с горячим резервом</td><td align="center">•</td><td align="center">•</td><td align="center">•</td><td align="center">•</td><td align="center">•</td></tr><tr><td>Репликация на уровне таблиц</td><td align="center"> </td><td align="center"> </td><td align="center"> </td><td align="center">•</td><td align="center">•</td><td align="center"> </td><td align="center">•</td><td align="center">•</td></tr><tr><td>Не требуется разрешение конфликтов</td><td align="center">•</td><td align="center">•</td><td align="center">•</td><td align="center"> </td><td align="center">•</td><td align="center">•</td><td align="center"> </td><td align="center">•</td></tr></tbody></table></div></div><br class="table-break" /><p>Несколько решений, которые не подпадают под указанные выше категории:</p><div class="variablelist"><dl class="variablelist"><dt><span class="term">Секционирование данных</span></dt><dd><p>При секционировании таблицы расщепляются на наборы данных. Каждый из наборов может быть изменён только на одном сервере. Например, данные могут быть секционированы по офисам, например, Лондон и Париж, с сервером в каждом офисе. В случае необходимости обращения одновременно к данным Лондона и Парижа, приложение может запросить оба сервера, или может быть применена репликация главный-резервный для предоставления копии только для чтения в другом офисе для каждого из серверов.</p></dd><dt><span class="term">Выполнение параллельных запросов на нескольких серверах</span></dt><dd><p>Многие из описанных выше решений позволяют обрабатывать несколько запросов на нескольких серверах, но ни одно из них не поддерживает выполнение одного запроса на нескольких серверах, что позволило бы его ускорить. Данное же решение позволяет нескольким серверам обрабатывать один запрос одновременно. Для этого обычно данные разделяются между серверами, серверы выполняют свои части запросов, выдают результаты центральному серверу, а он, в свою очередь, объединяет полученные данные и выдаёт итоговый результат пользователю. Это решение может быть реализовано с применением набора средств <span class="productname">PL/Proxy</span>.</p></dd></dl></div><p>Также следует заметить, что так как код <span class="productname">PostgreSQL</span> открыт и легко расширяется, некоторые компании взяли за основу <span class="productname">PostgreSQL</span> и создали коммерческие решения с закрытым кодом со своими реализациями свойств отказоустойчивости, репликации и балансировки нагрузки. Эти решения здесь не рассматриваются.</p></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="high-availability.html" title="Глава 27. Отказоустойчивость, балансировка нагрузки и репликация">Пред.</a> </td><td width="20%" align="center"><a accesskey="u" href="high-availability.html" title="Глава 27. Отказоустойчивость, балансировка нагрузки и репликация">Наверх</a></td><td width="40%" align="right"> <a accesskey="n" href="warm-standby.html" title="27.2. Трансляция журналов на резервные серверы">След.</a></td></tr><tr><td width="40%" align="left" valign="top">Глава 27. Отказоустойчивость, балансировка нагрузки и репликация </td><td width="20%" align="center"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="40%" align="right" valign="top"> 27.2. Трансляция журналов на резервные серверы</td></tr></table></div></body></html>