<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>CLUSTER</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@lists.postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets Vsnapshot" /><link rel="prev" href="sql-close.html" title="CLOSE" /><link rel="next" href="sql-comment.html" title="COMMENT" /></head><body id="docContent" class="container-fluid col-10"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="5" align="center">CLUSTER</th></tr><tr><td width="10%" align="left"><a accesskey="p" href="sql-close.html" title="CLOSE">Пред.</a> </td><td width="10%" align="left"><a accesskey="u" href="sql-commands.html" title="Команды SQL">Наверх</a></td><th width="60%" align="center">Команды SQL</th><td width="10%" align="right"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="10%" align="right"> <a accesskey="n" href="sql-comment.html" title="COMMENT">След.</a></td></tr></table><hr /></div><div class="refentry" id="SQL-CLUSTER"><div class="titlepage"></div><a id="id-1.9.3.51.1" class="indexterm"></a><div class="refnamediv"><h2><span class="refentrytitle">CLUSTER</span></h2><p>CLUSTER — кластеризовать таблицу согласно индексу</p></div><div class="refsynopsisdiv"><h2>Синтаксис</h2><pre class="synopsis">CLUSTER [VERBOSE] <em class="replaceable"><code>имя_таблицы</code></em> [ USING <em class="replaceable"><code>имя_индекса</code></em> ]
CLUSTER ( <em class="replaceable"><code>параметр</code></em> [, ...] ) <em class="replaceable"><code>имя_таблицы</code></em> [ USING <em class="replaceable"><code>имя_индекса</code></em> ]
CLUSTER [VERBOSE]

<span class="phrase">здесь допускается <em class="replaceable"><code>параметр</code></em>:</span>

    VERBOSE [ <em class="replaceable"><code>boolean</code></em> ]</pre></div><div class="refsect1" id="id-1.9.3.51.5"><h2>Описание</h2><p>Оператор <code class="command">CLUSTER</code> указывает <span class="productname">PostgreSQL</span> кластеризовать таблицу, заданную параметром <em class="replaceable"><code>имя_таблицы</code></em>, согласно индексу, заданному параметром <em class="replaceable"><code>имя_индекса</code></em>. Указанный индекс уже должен быть определён в таблице <em class="replaceable"><code>имя_таблицы</code></em>.</p><p>В результате кластеризации таблицы её содержимое физически переупорядочивается в зависимости от индекса. Кластеризация является одноразовой операцией: последующие изменения в таблице нарушают порядок кластеризации. Другими словами, система не пытается автоматически сохранять порядок новых или изменённых строк в соответствии с индексом. (Если такое желание возникает, можно периодически повторять кластеризацию, выполняя команду снова. Кроме того, если для заданной таблицы установить параметр <code class="literal">FILLFACTOR</code> меньше 100%, это может помочь сохранить порядок кластеризации при изменениях, так как изменяемые строки будут помещаться в ту же страницу, если в ней достаточно места.)</p><p>Когда таблица кластеризована, <span class="productname">PostgreSQL</span> запоминает, по какому именно индексу. Форма <code class="command">CLUSTER <em class="replaceable"><code>имя_таблицы</code></em></code> повторно кластеризует таблицу по тому же индексу. Для установки индекса, который будет использоваться для будущих операций кластеризации, или очистки предыдущего значения можно также применить команду <code class="literal">CLUSTER</code> или формы <code class="literal">SET WITHOUT CLUSTER</code> команды <a class="link" href="sql-altertable.html" title="ALTER TABLE"><code class="command">ALTER TABLE</code></a>.</p><p><code class="command">CLUSTER</code> без <em class="replaceable"><code>имени_таблицы</code></em> повторно кластеризует все ранее кластеризованные таблицы в текущей базе данных, которые принадлежат вызывающему команду пользователю, или все такие таблицы, если её вызывает суперпользователь. Эту форму <code class="command">CLUSTER</code> нельзя выполнять внутри блока транзакции.</p><p>В процессе кластеризации таблицы для неё запрашивается блокировка <code class="literal">ACCESS EXCLUSIVE</code>. Это препятствует выполнению всех других операций (чтению и записи) с таблицей до завершения <code class="command">CLUSTER</code>.</p></div><div class="refsect1" id="id-1.9.3.51.6"><h2>Параметры</h2><div class="variablelist"><dl class="variablelist"><dt><span class="term"><em class="replaceable"><code>имя_таблицы</code></em></span></dt><dd><p>Имя таблицы (возможно, дополненное схемой).</p></dd><dt><span class="term"><em class="replaceable"><code>имя_индекса</code></em></span></dt><dd><p>Имя индекса.</p></dd><dt><span class="term"><code class="literal">VERBOSE</code></span></dt><dd><p>Выводит отчёт о процессе кластеризации по мере обработки таблиц.</p></dd><dt><span class="term"><em class="replaceable"><code>boolean</code></em></span></dt><dd><p>Включает или отключает заданный параметр. Для включения параметра можно написать <code class="literal">TRUE</code>, <code class="literal">ON</code> или <code class="literal">1</code>, а для отключения — <code class="literal">FALSE</code>, <code class="literal">OFF</code> или <code class="literal">0</code>. Значение <em class="replaceable"><code>boolean</code></em> можно опустить, в этом случае подразумевается <code class="literal">TRUE</code>.</p></dd></dl></div></div><div class="refsect1" id="id-1.9.3.51.7"><h2>Замечания</h2><p>В случаях, когда происходит обращение к случайным единичным строкам таблицы, фактический порядок данных в этой таблице не важен. Но если обращения к одним данным происходят чаще, чем к другим, и есть индекс, который собирает их вместе, применение команды <code class="command">CLUSTER</code> может быть полезным. Например, когда из таблицы запрашивается диапазон индексированных значений, либо одно индексированное значение, которому соответствуют несколько строк, <code class="command">CLUSTER</code> может помочь, так как страница таблицы, найденная по индексу для первой искомой строки, скорее всего, будет содержать и все остальные искомые строки. Таким образом, кластеризация помогает соптимизировать обращения к диску и ускорить запросы.</p><p><code class="command">CLUSTER</code> может переупорядочить таблицу, выполнив либо сканирование указанного индекса, либо (для индексов-B-деревьев) последовательное сканирование, а затем сортировку. Наилучший по скорости вариант будет выбран, исходя из имеющейся статистической информации и параметров планировщика.</p><p>Когда выбирается сканирование индекса, создаётся временная таблица, содержащая данные целевой таблицы по порядку индекса. Также создаются копии всех индексов таблицы. Таким образом, для этой операции требуется объём дискового пространства не меньше, чем размер таблицы и индексов в сумме.</p><p>В случае выбора последовательного сканирования и сортировки создаётся ещё и временный файл для сортировки, так что пиковым требованием будет удвоенный размер таблицы плюс размер индексов. Этот метод часто быстрее, чем сканирование по индексу, но если требование к дисковому пространству неприемлемо, можно отключить его выбор, временно установив <a class="xref" href="runtime-config-query.html#GUC-ENABLE-SORT">enable_sort</a> в <code class="literal">off</code>.</p><p>Перед кластеризацией рекомендуется установить в <a class="xref" href="runtime-config-resource.html#GUC-MAINTENANCE-WORK-MEM">maintenance_work_mem</a> достаточно большое значение (но не больше, чем объём ОЗУ, который вы хотите выделить для операции <code class="command">CLUSTER</code>).</p><p>Так как планировщик записывает статистику, связанную с порядком таблиц, для вновь кластеризуемых таблиц рекомендуется запускать <a class="link" href="sql-analyze.html" title="ANALYZE"><code class="command">ANALYZE</code></a>. В противном случае планировщик может ошибиться с выбором плана запроса.</p><p>Так как <code class="command">CLUSTER</code> запоминает, по каким индексам кластеризованы таблицы, достаточно лишь один раз вручную кластеризовать нужные таблицы, а затем настроить периодический скрипт обслуживания, который будет выполнять <code class="command">CLUSTER</code> без параметров, с тем чтобы эти таблицы регулярно кластеризовались.</p><p>Каждый процесс, выполняющий операцию <code class="command">CLUSTER</code>, будет выдавать информацию о ходе её выполнения, отображаемую в представлении <code class="structname">pg_stat_progress_cluster</code>. За подробностями обратитесь к <a class="xref" href="progress-reporting.html#CLUSTER-PROGRESS-REPORTING" title="28.4.2. Отслеживание выполнения CLUSTER">Подразделу 28.4.2</a>.</p><p>При кластеризации секционированной таблицы каждая из её секций кластеризуется согласно секции заданного секционированного индекса. Индекс при кластеризации секционированной таблицы должен указываться обязательно. <code class="command">CLUSTER</code> нельзя выполнять внутри блока транзакции.</p></div><div class="refsect1" id="id-1.9.3.51.8"><h2>Примеры</h2><p>Кластеризация таблицы <code class="literal">employees</code> согласно её индексу <code class="literal">employees_ind</code>: </p><pre class="programlisting">CLUSTER employees USING employees_ind;</pre><p>Кластеризация таблицы <code class="literal">employees</code> согласно тому же индексу, что был использован ранее: </p><pre class="programlisting">CLUSTER employees;</pre><p>Кластеризация всех таблиц в базе данных, что были кластеризованы ранее: </p><pre class="programlisting">CLUSTER;</pre></div><div class="refsect1" id="id-1.9.3.51.9"><h2>Совместимость</h2><p>Оператор <code class="command">CLUSTER</code> отсутствует в стандарте SQL.</p><p>Синтаксис </p><pre class="synopsis">
CLUSTER <em class="replaceable"><code>имя_индекса</code></em> ON <em class="replaceable"><code>имя_таблицы</code></em>
</pre><p> так же является допустимым для совместимости с <span class="productname">PostgreSQL</span> до версии 8.3.</p></div><div class="refsect1" id="id-1.9.3.51.10"><h2>См. также</h2><span class="simplelist"><a class="xref" href="app-clusterdb.html" title="clusterdb"><span class="refentrytitle"><span class="application">clusterdb</span></span></a>, <a class="xref" href="progress-reporting.html#CLUSTER-PROGRESS-REPORTING" title="28.4.2. Отслеживание выполнения CLUSTER">Подраздел 28.4.2</a></span></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="sql-close.html" title="CLOSE">Пред.</a> </td><td width="20%" align="center"><a accesskey="u" href="sql-commands.html" title="Команды SQL">Наверх</a></td><td width="40%" align="right"> <a accesskey="n" href="sql-comment.html" title="COMMENT">След.</a></td></tr><tr><td width="40%" align="left" valign="top">CLOSE </td><td width="20%" align="center"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="40%" align="right" valign="top"> COMMENT</td></tr></table></div></body></html>