<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>44.9. Явные подтранзакции в PL/Tcl</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@lists.postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets Vsnapshot" /><link rel="prev" href="pltcl-error-handling.html" title="44.8. Обработка ошибок в PL/Tcl" /><link rel="next" href="pltcl-transactions.html" title="44.10. Управление транзакциями" /></head><body id="docContent" class="container-fluid col-10"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="5" align="center">44.9. Явные подтранзакции в PL/Tcl</th></tr><tr><td width="10%" align="left"><a accesskey="p" href="pltcl-error-handling.html" title="44.8. Обработка ошибок в PL/Tcl">Пред.</a> </td><td width="10%" align="left"><a accesskey="u" href="pltcl.html" title="Глава 44. PL/Tcl — процедурный язык Tcl">Наверх</a></td><th width="60%" align="center">Глава 44. PL/Tcl — процедурный язык Tcl</th><td width="10%" align="right"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="10%" align="right"> <a accesskey="n" href="pltcl-transactions.html" title="44.10. Управление транзакциями">След.</a></td></tr></table><hr /></div><div class="sect1" id="PLTCL-SUBTRANSACTIONS"><div class="titlepage"><div><div><h2 class="title" style="clear: both">44.9. Явные подтранзакции в PL/Tcl <a href="#PLTCL-SUBTRANSACTIONS" class="id_link">#</a></h2></div></div></div><a id="id-1.8.9.13.2" class="indexterm"></a><p>Перехват ошибок, произошедших при обращении к базе данных, как описано в <a class="xref" href="pltcl-error-handling.html" title="44.8. Обработка ошибок в PL/Tcl">Разделе 44.8</a>, может привести к нежелательной ситуации, когда часть операций будет успешно выполнена, прежде чем произойдёт сбой. Данные останутся в несогласованном состоянии после обработки такой ошибки. PL/Tcl предлагает решение этой проблемы в форме явных подтранзакций.</p><p>Рассмотрите функцию, реализующую перевод денег между двумя счетами: </p><pre class="programlisting">CREATE FUNCTION transfer_funds() RETURNS void AS $$
    if [catch {
        spi_exec "UPDATE accounts SET balance = balance - 100 WHERE account_name = 'joe'"
        spi_exec "UPDATE accounts SET balance = balance + 100 WHERE account_name = 'mary'"
    } errormsg] {
        set result [format "error transferring funds: %s" $errormsg]
    } else {
        set result "funds transferred successfully"
    }
    spi_exec "INSERT INTO operations (result) VALUES ('[quote $result]')"
$$ LANGUAGE pltcl;</pre><p> Если второй оператор <code class="command">UPDATE</code> выдаст исключение, эта функция запишет в журнал сообщение об ошибке, но результат первого <code class="command">UPDATE</code> будет тем не менее зафиксирован. Другими словами, денежные средства будут списаны со счёта Джо, но не поступят на счёт Мери. Это происходит потому, что каждый вызов <code class="function">spi_exec</code> выполняется в отдельной подтранзакции, а откатывается только одна из подтранзакций.</p><p>В таких случаях вы можете обернуть несколько операций с базой данных в одну явную подтранзакцию, которая будет выполнена успешно или отменена как единое целое. Для этого в PL/Tcl есть команда <code class="function">subtransaction</code>. С ней мы можем переписать нашу функцию так: </p><pre class="programlisting">CREATE FUNCTION transfer_funds2() RETURNS void AS $$
    if [catch {
        subtransaction {
            spi_exec "UPDATE accounts SET balance = balance - 100 WHERE account_name = 'joe'"
            spi_exec "UPDATE accounts SET balance = balance + 100 WHERE account_name = 'mary'"
        }
    } errormsg] {
        set result [format "error transferring funds: %s" $errormsg]
    } else {
        set result "funds transferred successfully"
    }
    spi_exec "INSERT INTO operations (result) VALUES ('[quote $result]')"
$$ LANGUAGE pltcl;</pre><p> Заметьте, что и в этом случае нужно использовать <code class="function">catch</code>. В противном случае ошибка распространится на верхний уровень функции, что не даст произвести желаемое добавление записи в таблицу <code class="structname">operations</code>. Команда <code class="function">subtransaction</code> не перехватывает ошибки, она только обеспечивает откат всех операций с базой данных в своей области действия в случае ошибки.</p><p>Откат явной подтранзакции происходит в случае любых ошибок, сгенерированных вложенным кодом Tcl, а не только ошибок, возникающих при обращении к базе данных. Таким образом, обычное исключение Tcl, возникшее внутри команды <code class="function">subtransaction</code>, также приведёт к откату подтранзакции. Однако при выходе из вложенного кода Tcl без ошибки (например, с помощью команды <code class="function">return</code>) откат не производится.</p></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="pltcl-error-handling.html" title="44.8. Обработка ошибок в PL/Tcl">Пред.</a> </td><td width="20%" align="center"><a accesskey="u" href="pltcl.html" title="Глава 44. PL/Tcl — процедурный язык Tcl">Наверх</a></td><td width="40%" align="right"> <a accesskey="n" href="pltcl-transactions.html" title="44.10. Управление транзакциями">След.</a></td></tr><tr><td width="40%" align="left" valign="top">44.8. Обработка ошибок в PL/Tcl </td><td width="20%" align="center"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="40%" align="right" valign="top"> 44.10. Управление транзакциями</td></tr></table></div></body></html>