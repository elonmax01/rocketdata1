<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Глава 65. Унифицированные записи WAL</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@lists.postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets Vsnapshot" /><link rel="prev" href="index-cost-estimation.html" title="64.6. Функции оценки стоимости индекса" /><link rel="next" href="custom-rmgr.html" title="Глава 66. Пользовательские менеджеры ресурсов WAL" /></head><body id="docContent" class="container-fluid col-10"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="5" align="center">Глава 65. Унифицированные записи WAL</th></tr><tr><td width="10%" align="left"><a accesskey="p" href="index-cost-estimation.html" title="64.6. Функции оценки стоимости индекса">Пред.</a> </td><td width="10%" align="left"><a accesskey="u" href="internals.html" title="Часть VII. Внутреннее устройство">Наверх</a></td><th width="60%" align="center">Часть VII. Внутреннее устройство</th><td width="10%" align="right"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="10%" align="right"> <a accesskey="n" href="custom-rmgr.html" title="Глава 66. Пользовательские менеджеры ресурсов WAL">След.</a></td></tr></table><hr /></div><div class="chapter" id="GENERIC-WAL"><div class="titlepage"><div><div><h2 class="title">Глава 65. Унифицированные записи WAL</h2></div></div></div><p>Хотя у всех внутренних модулей, взаимодействующих с WAL, имеются собственные типы записей WAL, существует также унифицированный тип записей WAL, описывающий изменения в страницах унифицированным образом. Это полезно для расширений, реализующих собственные методы доступа.</p><p>По сравнению с <a class="link" href="custom-rmgr.html" title="Глава 66. Пользовательские менеджеры ресурсов WAL">Пользовательскими менеджерами ресурсов WAL</a> унифицированные записи WAL проще реализовать в расширениях, к тому же для применения этих записей не требуется загружать библиотеку расширения.</p><div class="note"><h3 class="title">Примечание</h3><p>Унифицированные записи WAL игнорируются во время <a class="link" href="logicaldecoding.html" title="Глава 49. Логическое декодирование">логического декодирования</a>. Если для вашего расширения требуется логическое декодирование, рассмотрите возможность использования пользовательского менеджера ресурсов WAL.</p></div><p>API для конструирования унифицированных записей WAL определён в <code class="filename">access/generic_xlog.h</code> и реализован в <code class="filename">access/transam/generic_xlog.c</code>.</p><p>Чтобы сформировать запись изменения данных для WAL, применяя механизм унифицированных записей WAL, выполните следующие действия: </p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p><code class="function">state = GenericXLogStart(relation)</code> — начните формирование унифицированной записи WAL для заданного отношения.</p></li><li class="listitem"><p><code class="function">page = GenericXLogRegisterBuffer(state, buffer, flags)</code> — зарегистрируйте буфер, который будет изменён текущей унифицированной записью WAL. Эта функция возвращает указатель на временную копию страницы буфера, в которой должны производиться изменения. (Модифицировать непосредственно содержимое буфера нельзя.) В третьем аргументе передаётся битовая маска флагов, применимых к этой операции. В настоящее время флаг только один — <code class="literal">GENERIC_XLOG_FULL_IMAGE</code>, который показывает, что в запись WAL нужно включить образ всей страницы, а не только изменения. Обычно этот флаг должен устанавливаться, когда страница новая или полностью перезаписана. Вызов <code class="function">GenericXLogRegisterBuffer</code> можно повторять, если фиксируемое в WAL действие изменяет несколько страниц.</p></li><li class="listitem"><p>Примените изменения к образам страниц, полученным на предыдущем шаге.</p></li><li class="listitem"><p><code class="function">GenericXLogFinish(state)</code> — завершите изменения в буферах и выдайте унифицированную запись WAL.</p></li></ol></div><p>Формирование записи WAL можно прервать на любом шаге, вызвав <code class="function">GenericXLogAbort(state)</code>. При этом будут отменены все изменения, внесённые в копии образов страниц.</p><p>Используя механизм унифицированных записей WAL, необходимо учитывать следующее: </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Модифицировать буферы напрямую нельзя! Все изменения должны производиться в копиях, полученных от функции <code class="function">GenericXLogRegisterBuffer()</code>. Другими словами, код, формирующий унифицированные записи WAL, никогда не должен сам вызывать <code class="function">BufferGetPage()</code>. Однако вызывающий код отвечает за закрепление/открепление и блокировку/разблокировку буферов в подходящие моменты времени. Исключительная блокировка каждого целевого буфера должна удерживаться от вызова <code class="function">GenericXLogRegisterBuffer()</code> до <code class="function">GenericXLogFinish()</code>.</p></li><li class="listitem"><p>Регистрацию буферов (шаг 2) и модификацию образов страниц (шаг 3) можно свободно смешивать, оба этих шага можно повторять в любой последовательности. Но помните, что буферы должны регистрироваться в том же порядке, в каком для них должны получаться блокировки при воспроизведении.</p></li><li class="listitem"><p>Максимальное число буферов, которые можно зарегистрировать для унифицированной записи WAL, составляет <code class="literal">MAX_GENERIC_XLOG_PAGES</code>. При исчерпании этого лимита будет выдана ошибка.</p></li><li class="listitem"><p>Унифицированный тип WAL подразумевает, что страницы, подлежащие изменению, имеют стандартную структуру, в частности между <code class="structfield">pd_lower</code> и <code class="structfield">pd_upper</code> нет полезных данных.</p></li><li class="listitem"><p>Так как изменяются копии страниц буфера, <code class="function">GenericXLogStart()</code> не начинает критическую секцию. Таким образом вы можете безопасно выделять память, выдать ошибку и т. п. между <code class="function">GenericXLogStart()</code> и <code class="function">GenericXLogFinish()</code>. Единственная фактическая критическая секция присутствует внутри <code class="function">GenericXLogFinish()</code>. При выходе по ошибке так же не нужно заботиться о вызове <code class="function">GenericXLogAbort()</code>.</p></li><li class="listitem"><p><code class="function">GenericXLogFinish()</code> помечает буферы как грязные и устанавливает для них LSN. Вам делать явно это не нужно.</p></li><li class="listitem"><p>Для нежурналируемых отношений всё работает так же, за исключением того, что фактически запись в WAL не выдаётся. Таким образом, явно проверять, является ли отношение нежурналируемым, не требуется.</p></li><li class="listitem"><p>Функция воспроизведения унифицированных изменений WAL получит исключительные блокировки буферов в том же порядке, в каком они были зарегистрированы. После воспроизведения всех изменений блокировки в том же порядке и освобождаются.</p></li><li class="listitem"><p>Если для регистрируемого буфера не задаётся <code class="literal">GENERIC_XLOG_FULL_IMAGE</code>, унифицированная запись WAL содержит различие между старым и новым образом страницы, которое вычисляется при побайтовом сравнении. Результат оказывается не очень компактным при перемещении данных в странице, но это может быть доработано в будущем.</p></li></ul></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="index-cost-estimation.html" title="64.6. Функции оценки стоимости индекса">Пред.</a> </td><td width="20%" align="center"><a accesskey="u" href="internals.html" title="Часть VII. Внутреннее устройство">Наверх</a></td><td width="40%" align="right"> <a accesskey="n" href="custom-rmgr.html" title="Глава 66. Пользовательские менеджеры ресурсов WAL">След.</a></td></tr><tr><td width="40%" align="left" valign="top">64.6. Функции оценки стоимости индекса </td><td width="20%" align="center"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="40%" align="right" valign="top"> Глава 66. Пользовательские менеджеры ресурсов WAL</td></tr></table></div></body></html>