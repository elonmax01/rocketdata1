<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>19.6. Обновление кластера PostgreSQL</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@lists.postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets Vsnapshot" /><link rel="prev" href="server-shutdown.html" title="19.5. Выключение сервера" /><link rel="next" href="preventing-server-spoofing.html" title="19.7. Защита от подмены сервера" /></head><body id="docContent" class="container-fluid col-10"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="5" align="center">19.6. Обновление кластера <span class="productname">PostgreSQL</span></th></tr><tr><td width="10%" align="left"><a accesskey="p" href="server-shutdown.html" title="19.5. Выключение сервера">Пред.</a> </td><td width="10%" align="left"><a accesskey="u" href="runtime.html" title="Глава 19. Подготовка к работе и сопровождение сервера">Наверх</a></td><th width="60%" align="center">Глава 19. Подготовка к работе и сопровождение сервера</th><td width="10%" align="right"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="10%" align="right"> <a accesskey="n" href="preventing-server-spoofing.html" title="19.7. Защита от подмены сервера">След.</a></td></tr></table><hr /></div><div class="sect1" id="UPGRADING"><div class="titlepage"><div><div><h2 class="title" style="clear: both">19.6. Обновление кластера <span class="productname">PostgreSQL</span> <a href="#UPGRADING" class="id_link">#</a></h2></div></div></div><div class="toc"><dl class="toc"><dt><span class="sect2"><a href="upgrading.html#UPGRADING-VIA-PGDUMPALL">19.6.1. Обновление данных с применением <span class="application">pg_dumpall</span></a></span></dt><dt><span class="sect2"><a href="upgrading.html#UPGRADING-VIA-PG-UPGRADE">19.6.2. Обновление данных с применением <span class="application">pg_upgrade</span></a></span></dt><dt><span class="sect2"><a href="upgrading.html#UPGRADING-VIA-REPLICATION">19.6.3. Обновление данных с применением репликации</a></span></dt></dl></div><a id="id-1.6.6.9.2" class="indexterm"></a><a id="id-1.6.6.9.3" class="indexterm"></a><p>В этом разделе рассказывается, как обновить ваш кластер базы данных с одной версии <span class="productname">PostgreSQL</span> на другую.</p><p>Текущие номера версий <span class="productname">PostgreSQL</span> состоят из номеров основной и корректирующей (дополнительной) версии. Например, в номере версии 10.1 число 10 обозначает основную версию, а 1 — дополнительную. Для выпусков <span class="productname">PostgreSQL</span> до версии 10.0 номера состояли из трёх чисел (например, 9.5.3). Тогда основная версия образовывалась группой их двух чисел (например, 9.5), а дополнительная задавалась третьим числом (например, 3, что означало, что это третий корректирующий выпуск основной версии 9.5).</p><p>В корректирующих выпусках никогда не меняется внутренний формат хранения, и они всегда совместимы с предыдущими и последующими выпусками той же основной версии. Например, версия 10.1 совместима с версией 10.0 и версией 10.6. Подобным образом, например, версия 9.5.3 совместима с 9.5.0, 9.5.1 и 9.5.6. Для обновления версии на совместимую достаточно просто заменить исполняемые файлы при выключенном сервере и затем запустить сервер. Каталог данных при этом не затрагивается, так что обновить корректирующую версию довольно просто.</p><p>При обновлении <span class="emphasis"><em>основных</em></span> версий <span class="productname">PostgreSQL</span> внутренний формат данных может меняться, что усложняет процедуру обновления. Традиционный способ переноса данных в новую основную версию — выгрузить данные из старой версии, а затем загрузить их в новую (это не самый быстрый вариант). Выполнить обновление быстрее позволяет <a class="xref" href="pgupgrade.html" title="pg_upgrade"><span class="refentrytitle"><span class="application">pg_upgrade</span></span></a>. Также для обновления можно использовать репликацию, как описано ниже. (Если вы используете <span class="productname">PostgreSQL</span> в виде готового продукта, в нём могут содержаться вспомогательные скрипты для обновления основной версии. За подробностями обратитесь к документации используемого вами продукта.)</p><p>Изменения основной версии обычно приносят какие-либо видимые пользователю несовместимости, которые могут требовать доработки приложений. Все подобные изменения описываются в замечаниях к выпуску (<a class="xref" href="release.html" title="Приложение E. Замечания к выпускам">Приложение E</a>); обращайте особое внимание на раздел «Migration» (Миграция). Хотя вы можете перейти с одной основной версии на другую, пропустив промежуточные версии, обязательно ознакомьтесь с замечаниями к каждому выпуску, в том числе для каждой пропускаемой версии.</p><p>Осторожные пользователи обычно тестируют свои клиентские приложения с новой версией, прежде чем переходить на неё полностью; поэтому часто имеет смысл установить рядом старую и новую версии. При тестировании обновления основной версии <span class="productname">PostgreSQL</span> изучите следующие области возможных изменений:</p><div class="variablelist"><dl class="variablelist"><dt><span class="term">Администрирование</span></dt><dd><p>Средства и функции, предоставляемые администраторам для наблюдения и управления сервером, часто меняются и совершенствуются в каждой новой версии.</p></dd><dt><span class="term">SQL</span></dt><dd><p>В этой области чаще наблюдается появление новых возможностей команд SQL, чем изменение поведения существующих, если только об этом не говорится в замечаниях к выпуску.</p></dd><dt><span class="term">API библиотек</span></dt><dd><p>Обычно библиотеки типа <span class="application">libpq</span> только расширяют свою функциональность, если об обратном так же не говорится в замечаниях к выпуску.</p></dd><dt><span class="term">Системные каталоги</span></dt><dd><p>Изменения в системных каталогах обычно влияют только на средства управления базами данных.</p></dd><dt><span class="term">API сервера для кода на C</span></dt><dd><p>Сюда относятся изменения в API серверных функций, которые написаны на языке программирования C. Такие изменения затрагивают код, обращающийся к служебным функциям глубоко внутри сервера.</p></dd></dl></div><div class="sect2" id="UPGRADING-VIA-PGDUMPALL"><div class="titlepage"><div><div><h3 class="title">19.6.1. Обновление данных с применением <span class="application">pg_dumpall</span> <a href="#UPGRADING-VIA-PGDUMPALL" class="id_link">#</a></h3></div></div></div><p>Один из вариантов обновления заключается в выгрузке данных из одной основной версии <span class="productname">PostgreSQL</span> и загрузке их в другую — для этого необходимо использовать средство <span class="emphasis"><em>логического</em></span> копирования, например <span class="application">pg_dumpall</span>; копирование на уровне файловой системы не подходит. (В самом сервере есть проверки, которые не дадут использовать каталог данных от несовместимой версии <span class="productname">PostgreSQL</span>, так что если попытаться запустить с существующим каталогом данных неправильную версию сервера, никакого вреда не будет.)</p><p>Для создания копии рекомендуется применять программы <span class="application">pg_dump</span> и <span class="application">pg_dumpall</span> от <span class="emphasis"><em>новой</em></span> версии <span class="productname">PostgreSQL</span>, чтобы воспользоваться улучшенными функциями, которые могли в них появиться. Текущие версии этих программ способны читать данные любой версии сервера, начиная с 9.2.</p><p>В следующих указаниях предполагается, что сервер установлен в каталоге <code class="filename">/usr/local/pgsql</code>, а данные находятся в <code class="filename">/usr/local/pgsql/data</code>. Вам нужно подставить свои пути.</p><div class="procedure"><ol class="procedure" type="1"><li class="step"><p>При запуске резервного копирования убедитесь в том, что в базе данных не производятся изменения. Изменения не повлияют на целостность полученной копии, но изменённые данные, само собой, в неё не попадут. Если потребуется, измените разрешения в файле <code class="filename">/usr/local/pgsql/data/pg_hba.conf</code> (или подобном), чтобы подключиться к серверу могли только вы. За дополнительными сведениями об управлении доступом обратитесь к <a class="xref" href="client-authentication.html" title="Глава 21. Аутентификация клиентского приложения">Главе 21</a>.</p><p><a id="id-1.6.6.9.11.5.1.2.1" class="indexterm"></a> Чтобы получить копию всех ваших данных, введите: </p><pre class="screen">
<strong class="userinput"><code>pg_dumpall &gt; <em class="replaceable"><code>выходной_файл</code></em></code></strong>
</pre><p>Для создания резервной копии вы можете воспользоваться программой <span class="application">pg_dumpall</span> от текущей версии сервера; за подробностями обратитесь к <a class="xref" href="backup-dump.html#BACKUP-DUMP-ALL" title="26.1.2. Использование pg_dumpall">Подразделу 26.1.2</a>. Однако для лучшего результата стоит попробовать <span class="application">pg_dumpall</span> из <span class="productname">PostgreSQL</span> 16.3, так как в эту версию вошли исправления ошибок и усовершенствования, по сравнению с предыдущими версиями. Хотя этот совет может показаться абсурдным, ведь новая версия ещё не установлена, ему стоит последовать, если вы планируете установить новую версию рядом со старой. В этом случае вы сможете выполнить установку как обычно, а перенести данные позже. Это также сократит время обновления.</p></li><li class="step"><p>Остановите старый сервер: </p><pre class="screen">
<strong class="userinput"><code>pg_ctl stop</code></strong>
</pre><p> В системах, где <span class="productname">PostgreSQL</span> запускается при загрузке, должен быть скрипт запуска, с которым можно сделать то же самое. Например, в <span class="systemitem">Red Hat Linux</span> может сработать такой вариант: </p><pre class="screen">
<strong class="userinput"><code>/etc/rc.d/init.d/postgresql stop</code></strong>
</pre><p> Подробнее запуск и остановка сервера описаны в <a class="xref" href="runtime.html" title="Глава 19. Подготовка к работе и сопровождение сервера">Главе 19</a>.</p></li><li class="step"><p>При восстановлении из резервной копии удалите или переименуйте старый каталог, где был установлен сервер, если его имя не привязано к версии. Разумнее будет переименовать каталог, а не удалять его, чтобы его можно было восстановить в случае проблем. Однако учтите, что этот каталог может занимать много места на диске. Переименовать каталог можно, например так: </p><pre class="screen">
<strong class="userinput"><code>mv /usr/local/pgsql /usr/local/pgsql.old</code></strong>
</pre><p> (Этот каталог нужно переименовывать (перемещать) как единое целое, чтобы относительные пути в нём не изменились.)</p></li><li class="step"><p>Установите новую версию <span class="productname">PostgreSQL</span> как описано в <a class="xref" href="installation.html" title="Глава 17. Установка из исходного кода">Главе 17</a>.</p></li><li class="step"><p>При необходимости создайте новый кластер баз данных. Помните, что следующие команды нужно выполнять под именем специального пользователя БД (вы уже действуете под этим именем, если производите обновление). </p><pre class="programlisting">
<strong class="userinput"><code>/usr/local/pgsql/bin/initdb -D /usr/local/pgsql/data</code></strong>
</pre></li><li class="step"><p>Перенесите изменения, внесённые в предыдущие версии <code class="filename">pg_hba.conf</code> и <code class="filename">postgresql.conf</code>.</p></li><li class="step"><p>Запустите сервер баз данных, так же применяя учётную запись специального пользователя БД: </p><pre class="programlisting">
<strong class="userinput"><code>/usr/local/pgsql/bin/postgres -D /usr/local/pgsql/data</code></strong>
</pre></li><li class="step"><p>Наконец, восстановите данные из резервной копии, выполнив: </p><pre class="screen">
<strong class="userinput"><code>/usr/local/pgsql/bin/psql -d postgres -f <em class="replaceable"><code>выходной_файл</code></em></code></strong>
</pre><p> (При этом будет использоваться <span class="emphasis"><em>новый</em></span> <span class="application">psql</span>.)</p></li></ol></div><p>Минимизировать время отключения сервера можно, установив новый сервер в другой каталог и запустив параллельно оба сервера, старый и новый, с разными портами. Затем можно будет перенести данные примерно так: </p><pre class="programlisting">pg_dumpall -p 5432 | psql -d postgres -p 5433</pre></div><div class="sect2" id="UPGRADING-VIA-PG-UPGRADE"><div class="titlepage"><div><div><h3 class="title">19.6.2. Обновление данных с применением <span class="application">pg_upgrade</span> <a href="#UPGRADING-VIA-PG-UPGRADE" class="id_link">#</a></h3></div></div></div><p>Модуль <a class="xref" href="pgupgrade.html" title="pg_upgrade"><span class="refentrytitle"><span class="application">pg_upgrade</span></span></a> позволяет обновить инсталляцию <span class="productname">PostgreSQL</span> с одной основной версии на другую непосредственно на месте. Такое обновление может выполняться за считанные минуты, особенно в режиме <code class="option">--link</code>. Для него требуются примерно те же подготовительные действия, что и для варианта с <span class="application">pg_dumpall</span>: запустить/остановить сервер, выполнить <span class="application">initdb</span>. Все эти действия описаны в <a class="link" href="pgupgrade.html" title="pg_upgrade">документации</a> <span class="application">pg_upgrade</span>.</p></div><div class="sect2" id="UPGRADING-VIA-REPLICATION"><div class="titlepage"><div><div><h3 class="title">19.6.3. Обновление данных с применением репликации <a href="#UPGRADING-VIA-REPLICATION" class="id_link">#</a></h3></div></div></div><p>Методы логической репликации также могут применяться для создания резервного сервера с обновлённой версией <span class="productname">PostgreSQL</span>. Это возможно благодаря тому, что логическая репликация поддерживается между разными основными версиями <span class="productname">PostgreSQL</span>. Резервный сервер может располагаться как на том же компьютере, так и на другом. Как только синхронизация с главным сервером (где работает старая версия <span class="productname">PostgreSQL</span>) будет завершена, можно сделать главным новый сервер, а старый экземпляр базы данных просто отключить. При таком переключении обновление возможно осуществить, прервав работу сервера всего на несколько секунд.</p><p>Этот вариант обновления можно осуществить, используя как встроенные средства логической репликации, так и внешние системы логической репликации, такие как <span class="productname">pglogical</span>, <span class="productname">Slony</span>, <span class="productname">Londiste</span> и <span class="productname">Bucardo</span>.</p></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="server-shutdown.html" title="19.5. Выключение сервера">Пред.</a> </td><td width="20%" align="center"><a accesskey="u" href="runtime.html" title="Глава 19. Подготовка к работе и сопровождение сервера">Наверх</a></td><td width="40%" align="right"> <a accesskey="n" href="preventing-server-spoofing.html" title="19.7. Защита от подмены сервера">След.</a></td></tr><tr><td width="40%" align="left" valign="top">19.5. Выключение сервера </td><td width="20%" align="center"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="40%" align="right" valign="top"> 19.7. Защита от подмены сервера</td></tr></table></div></body></html>