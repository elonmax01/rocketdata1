<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>75.1. Правила объявления системных каталогов</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@lists.postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets Vsnapshot" /><link rel="prev" href="bki.html" title="Глава 75. Объявление и начальное содержимое системных каталогов" /><link rel="next" href="system-catalog-initial-data.html" title="75.2. Исходные данные системных каталогов" /></head><body id="docContent" class="container-fluid col-10"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="5" align="center">75.1. Правила объявления системных каталогов</th></tr><tr><td width="10%" align="left"><a accesskey="p" href="bki.html" title="Глава 75. Объявление и начальное содержимое системных каталогов">Пред.</a> </td><td width="10%" align="left"><a accesskey="u" href="bki.html" title="Глава 75. Объявление и начальное содержимое системных каталогов">Наверх</a></td><th width="60%" align="center">Глава 75. Объявление и начальное содержимое системных каталогов</th><td width="10%" align="right"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="10%" align="right"> <a accesskey="n" href="system-catalog-initial-data.html" title="75.2. Исходные данные системных каталогов">След.</a></td></tr></table><hr /></div><div class="sect1" id="SYSTEM-CATALOG-DECLARATIONS"><div class="titlepage"><div><div><h2 class="title" style="clear: both">75.1. Правила объявления системных каталогов <a href="#SYSTEM-CATALOG-DECLARATIONS" class="id_link">#</a></h2></div></div></div><p>Ключевой частью заголовочного файла каталога является описание структуры на C, определяющее вид каждой строки каталога. Оно начинается с макроса <code class="literal">CATALOG</code>, который, если говорить о компиляторе C, является просто сокращённой записью <code class="literal">typedef struct FormData_<em class="replaceable"><code>имя_каталога</code></em></code>. Каждое поле в этой структуре порождает столбец каталога. Поля можно дополнить макросами свойств BKI, объявленными в <code class="filename">genbki.h</code>. Например, для поля можно задать значение по умолчанию или указать, допускается ли в нём NULL. Строку <code class="literal">CATALOG</code> можно также дополнить некоторыми другими макросами свойств BKI, объявленными в <code class="filename">genbki.h</code> и определяющими другие свойства каталога в целом, например, является ли он общим.</p><p>Код кеша системного каталога (и в принципе почти весь код, манипулирующий каталогом) предполагает, что имеющие постоянный размер части всех кортежей системных каталогов присутствуют фактически, так как он отображает на них объявления структуры на C. Таким образом, все поля переменной длины и поля, принимающие NULL, должны располагаться в конце, и обращаться к ним как к полям структуры нельзя. Например, если присвоить полю <code class="structname">pg_type</code>.<code class="structfield">typrelid</code> значение NULL, обращение в каком-либо месте кода к <code class="literal">typetup-&gt;typrelid</code> (или, что ещё хуже, к полю <code class="literal">typetup-&gt;typelem</code>, следующему за <code class="structfield">typrelid</code>) будет некорректным. Это приведёт к случайным ошибкам или даже нарушениям сегментации.</p><p>В качестве частичной защиты от ошибок такого типа поля переменной длины или поля, принимающие NULL, следует скрыть от компилятора C. Это реализуется посредством обёртки <code class="literal">#ifdef CATALOG_VARLEN</code> ... <code class="literal">#endif</code> (где <code class="literal">CATALOG_VARLEN</code> — символ, который всегда будет неопределённым). Это не позволяет коду на C беспрепятственно обращаться к полям, которые могут отсутствовать или располагаться по некоторому другому смещению. В качестве дополнительной меры, препятствующей созданию некорректных строк, мы требуем, чтобы все столбцы, которые не должны принимать NULL, помечались соответствующим образом в <code class="structname">pg_attribute</code>. Код начальной загрузки автоматически пометит столбцы каталога как <code class="literal">NOT NULL</code>, если они имеют фиксированную длину и перед ними нет столбцов, принимающих NULL, или столбцов переменной длины. Там, где это правило применяется некорректно, можно исправить пометку, добавив дополнительные указания <code class="literal">BKI_FORCE_NOT_NULL</code> или <code class="literal">BKI_FORCE_NULL</code>.</p><p>Код клиентской части не должен включать никакие заголовочные файлы каталогов <code class="filename">pg_xxx.h</code>, так как эти файлы могут содержать код на C, который не будет компилироваться вне кода сервера. (Обычно это происходит из-за того, что эти файлы также содержат объявления функций в файлах <code class="filename">src/backend/catalog/</code>.) Вместо этого клиентский код может включить соответствующий сгенерированный заголовок <code class="filename">pg_xxx_d.h</code> с определениями различных OID и другими данными, которые могут быть полезны на стороне клиента. Если вам нужно, чтобы макросы или другой код в заголовочных файлах каталогов были видимы в клиентском коде, заключите соответствущую секцию в условие <code class="literal">#ifdef EXPOSE_TO_CLIENT_CODE</code> ... <code class="literal">#endif</code>, чтобы <code class="filename">genbki.pl</code> скопировал эту секцию в заголовок <code class="filename">pg_xxx_d.h</code>.</p><p>Некоторые каталоги настолько основополагающие, что их нельзя создать даже командой <acronym class="acronym">BKI</acronym> <code class="literal">create</code>, которая используется для большинства каталогов, так как эта команда должна записать информацию, описывающую новый каталог, в эти базовые каталоги. Они называются каталогами <em class="firstterm">начальной загрузки</em> и для определения их требуется много дополнительные действий: вы должны вручную подготовить соответствующие записи для них в предварительно загружаемых данных <code class="structname">pg_class</code> и <code class="structname">pg_type</code>, и эти записи потребуется модифицировать при последующих изменениях в структуре каталога. (Каталогам начальной загрузки также нужны предварительно загруженные записи в <code class="structname">pg_attribute</code>, но, к счастью, сейчас с этим управляется скрипт <code class="filename">genbki.pl</code>.) По возможности избегайте включения новых каталогов в категорию каталогов начальной загрузки.</p></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="bki.html" title="Глава 75. Объявление и начальное содержимое системных каталогов">Пред.</a> </td><td width="20%" align="center"><a accesskey="u" href="bki.html" title="Глава 75. Объявление и начальное содержимое системных каталогов">Наверх</a></td><td width="40%" align="right"> <a accesskey="n" href="system-catalog-initial-data.html" title="75.2. Исходные данные системных каталогов">След.</a></td></tr><tr><td width="40%" align="left" valign="top">Глава 75. Объявление и начальное содержимое системных каталогов </td><td width="20%" align="center"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="40%" align="right" valign="top"> 75.2. Исходные данные системных каталогов</td></tr></table></div></body></html>