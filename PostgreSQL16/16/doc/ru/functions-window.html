<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>9.22. Оконные функции</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@lists.postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets Vsnapshot" /><link rel="prev" href="functions-aggregate.html" title="9.21. Агрегатные функции" /><link rel="next" href="functions-subquery.html" title="9.23. Выражения подзапросов" /></head><body id="docContent" class="container-fluid col-10"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="5" align="center">9.22. Оконные функции</th></tr><tr><td width="10%" align="left"><a accesskey="p" href="functions-aggregate.html" title="9.21. Агрегатные функции">Пред.</a> </td><td width="10%" align="left"><a accesskey="u" href="functions.html" title="Глава 9. Функции и операторы">Наверх</a></td><th width="60%" align="center">Глава 9. Функции и операторы</th><td width="10%" align="right"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="10%" align="right"> <a accesskey="n" href="functions-subquery.html" title="9.23. Выражения подзапросов">След.</a></td></tr></table><hr /></div><div class="sect1" id="FUNCTIONS-WINDOW"><div class="titlepage"><div><div><h2 class="title" style="clear: both">9.22. Оконные функции <a href="#FUNCTIONS-WINDOW" class="id_link">#</a></h2></div></div></div><a id="id-1.5.8.28.2" class="indexterm"></a><p><em class="firstterm">Оконные функции</em> дают возможность выполнять вычисления с набором строк, каким-либо образом связанным с текущей строкой запроса. Вводную информацию об этом можно получить в <a class="xref" href="tutorial-window.html" title="3.5. Оконные функции">Разделе 3.5</a>, а подробнее узнать о синтаксисе можно в <a class="xref" href="sql-expressions.html#SYNTAX-WINDOW-FUNCTIONS" title="4.2.8. Вызовы оконных функций">Подразделе 4.2.8</a>.</p><p>Встроенные оконные функции перечислены в <a class="xref" href="functions-window.html#FUNCTIONS-WINDOW-TABLE" title="Таблица 9.64. Оконные функции общего назначения">Таблице 9.64</a>. Заметьте, что эти функции <span class="emphasis"><em>должны</em></span> вызываться именно как оконные, т. е. при вызове необходимо использовать предложение <code class="literal">OVER</code>.</p><p>В дополнение к этим функциям в качестве оконных можно использовать любые встроенные или обычные пользовательские агрегатные функции (но не сортирующие и не гипотезирующие); список встроенных агрегатных функций приведён в <a class="xref" href="functions-aggregate.html" title="9.21. Агрегатные функции">Разделе 9.21</a>. Агрегатные функции работают как оконные, только когда за их вызовом следует предложение <code class="literal">OVER</code>; в противном случае они работают как обычные функции и выдают для всего набора единственную строку.</p><div class="table" id="FUNCTIONS-WINDOW-TABLE"><p class="title"><strong>Таблица 9.64. Оконные функции общего назначения</strong></p><div class="table-contents"><table class="table" summary="Оконные функции общего назначения" border="1"><colgroup><col /></colgroup><thead><tr><th class="func_table_entry"><p class="func_signature">Функция</p>
       <p>Описание</p></th></tr></thead><tbody><tr><td class="func_table_entry"><p class="func_signature"><a id="id-1.5.8.28.6.2.2.1.1.1.1" class="indexterm"></a> <code class="function">row_number</code> () → <code class="returnvalue">bigint</code></p>
       <p>Возвращает номер текущей строки в её разделе, начиная с 1.</p></td></tr><tr><td class="func_table_entry"><p class="func_signature"><a id="id-1.5.8.28.6.2.2.2.1.1.1" class="indexterm"></a> <code class="function">rank</code> () → <code class="returnvalue">bigint</code></p>
       <p>Возвращает ранг текущей строки с пропусками; то же, что и <code class="function">row_number</code> для первой родственной ей строки.</p></td></tr><tr><td class="func_table_entry"><p class="func_signature"><a id="id-1.5.8.28.6.2.2.3.1.1.1" class="indexterm"></a> <code class="function">dense_rank</code> () → <code class="returnvalue">bigint</code></p>
       <p>Возвращает ранг текущей строки без пропусков; по сути эта функция считает группы родственных строк.</p></td></tr><tr><td class="func_table_entry"><p class="func_signature"><a id="id-1.5.8.28.6.2.2.4.1.1.1" class="indexterm"></a> <code class="function">percent_rank</code> () → <code class="returnvalue">double precision</code></p>
       <p>Вычисляет относительный ранг текущей строки, то есть (<code class="function">rank</code> - 1) / (общее число строк раздела - 1). Таким образом, результат лежит в интервале от 0 до 1, включительно.</p></td></tr><tr><td class="func_table_entry"><p class="func_signature"><a id="id-1.5.8.28.6.2.2.5.1.1.1" class="indexterm"></a> <code class="function">cume_dist</code> () → <code class="returnvalue">double precision</code></p>
       <p>Возвращает кумулятивное распределение, то есть (число строк раздела, предшествующих или родственных текущей строке) / (общее число строк раздела). Таким образом, результат лежит в интервале от 1/<em class="parameter"><code>N</code></em> до 1.</p></td></tr><tr><td class="func_table_entry"><p class="func_signature"><a id="id-1.5.8.28.6.2.2.6.1.1.1" class="indexterm"></a> <code class="function">ntile</code> ( <em class="parameter"><code>num_buckets</code></em> <code class="type">integer</code> ) → <code class="returnvalue">integer</code></p>
       <p>Возвращает целое от 1 до значения аргумента для разбиения раздела на части максимально близких размеров.</p></td></tr><tr><td class="func_table_entry"><p class="func_signature"><a id="id-1.5.8.28.6.2.2.7.1.1.1" class="indexterm"></a> <code class="function">lag</code> ( <em class="parameter"><code>value</code></em> <code class="type">anycompatible</code> [<span class="optional">, <em class="parameter"><code>offset</code></em> <code class="type">integer</code> [<span class="optional">, <em class="parameter"><code>default</code></em> <code class="type">anycompatible</code></span>]</span>] ) → <code class="returnvalue">anycompatible</code></p>
       <p>Возвращает значение <em class="parameter"><code>value</code></em>, вычисленное для строки, сдвинутой на <em class="parameter"><code>offset</code></em> строк от текущей к началу раздела; если такой строки нет, возвращается значение <em class="parameter"><code>default</code></em> (оно должно быть совместимого с <em class="parameter"><code>value</code></em> типа). Оба аргумента, <em class="parameter"><code>offset</code></em> и <em class="parameter"><code>default</code></em>, вычисляются для текущей строки. Если они не указываются, <em class="parameter"><code>offset</code></em> считается равным 1, а <em class="parameter"><code>default</code></em> — <code class="literal">NULL</code>.</p></td></tr><tr><td class="func_table_entry"><p class="func_signature"><a id="id-1.5.8.28.6.2.2.8.1.1.1" class="indexterm"></a> <code class="function">lead</code> ( <em class="parameter"><code>value</code></em> <code class="type">anycompatible</code> [<span class="optional">, <em class="parameter"><code>offset</code></em> <code class="type">integer</code> [<span class="optional">, <em class="parameter"><code>default</code></em> <code class="type">anycompatible</code></span>]</span>] ) → <code class="returnvalue">anycompatible</code></p>
       <p>Возвращает значение <em class="parameter"><code>value</code></em>, вычисленное для строки, сдвинутой на <em class="parameter"><code>offset</code></em> строк от текущей к концу раздела; если такой строки нет, возвращается значение <em class="parameter"><code>default</code></em> (оно должно быть совместимого с <em class="parameter"><code>value</code></em> типа). Оба аргумента, <em class="parameter"><code>offset</code></em> и <em class="parameter"><code>default</code></em>, вычисляются для текущей строки. Если они не указываются, <em class="parameter"><code>offset</code></em> считается равным 1, а <em class="parameter"><code>default</code></em> — <code class="literal">NULL</code>.</p></td></tr><tr><td class="func_table_entry"><p class="func_signature"><a id="id-1.5.8.28.6.2.2.9.1.1.1" class="indexterm"></a> <code class="function">first_value</code> ( <em class="parameter"><code>value</code></em> <code class="type">anyelement</code> ) → <code class="returnvalue">anyelement</code></p>
       <p>Возвращает значение (<em class="parameter"><code>value</code></em>), вычисленное для первой строки в рамке окна.</p></td></tr><tr><td class="func_table_entry"><p class="func_signature"><a id="id-1.5.8.28.6.2.2.10.1.1.1" class="indexterm"></a> <code class="function">last_value</code> ( <em class="parameter"><code>value</code></em> <code class="type">anyelement</code> ) → <code class="returnvalue">anyelement</code></p>
       <p>Возвращает значение (<em class="parameter"><code>value</code></em>), вычисленное для последней строки в рамке окна.</p></td></tr><tr><td class="func_table_entry"><p class="func_signature"><a id="id-1.5.8.28.6.2.2.11.1.1.1" class="indexterm"></a> <code class="function">nth_value</code> ( <em class="parameter"><code>value</code></em> <code class="type">anyelement</code>, <em class="parameter"><code>n</code></em> <code class="type">integer</code> ) → <code class="returnvalue">anyelement</code></p>
       <p>Возвращает значение (<em class="parameter"><code>value</code></em>), вычисленное в <em class="parameter"><code>n</code></em>-ой строке в рамке окна (считая с 1), или <code class="literal">NULL</code>, если такой строки нет.</p></td></tr></tbody></table></div></div><br class="table-break" /><p>Результат всех функций, перечисленных в <a class="xref" href="functions-window.html#FUNCTIONS-WINDOW-TABLE" title="Таблица 9.64. Оконные функции общего назначения">Таблице 9.64</a>, зависит от порядка сортировки, заданного предложением <code class="literal">ORDER BY</code> в определении соответствующего окна. Строки, которые являются одинаковыми при рассмотрении только столбцов <code class="literal">ORDER BY</code>, считаются <em class="firstterm">родственными</em>. Четыре функции, вычисляющие ранг (включая <code class="function">cume_dist</code>), реализованы так, что их результат будет одинаковым для всех родственных строк.</p><p>Заметьте, что функции <code class="function">first_value</code>, <code class="function">last_value</code> и <code class="function">nth_value</code> рассматривают только строки в <span class="quote">«<span class="quote">рамке окна</span>»</span>, которая по умолчанию содержит строки от начала раздела до последней родственной строки для текущей. Поэтому результаты <code class="function">last_value</code> и иногда <code class="function">nth_value</code> могут быть не очень полезны. В таких случаях можно переопределить рамку, добавив в предложение <code class="literal">OVER</code> подходящее указание рамки (<code class="literal">RANGE</code>, <code class="literal">ROWS</code> или <code class="literal">GROUPS</code>). Подробнее эти указания описаны в <a class="xref" href="sql-expressions.html#SYNTAX-WINDOW-FUNCTIONS" title="4.2.8. Вызовы оконных функций">Подразделе 4.2.8</a>.</p><p>Когда в качестве оконной функции используется агрегатная, она обрабатывает строки в рамке текущей строки. Агрегатная функция с <code class="literal">ORDER BY</code> и определением рамки окна по умолчанию будет вычисляться как <span class="quote">«<span class="quote">бегущая сумма</span>»</span>, что может не соответствовать желаемому результату. Чтобы агрегатная функция работала со всем разделом, следует опустить <code class="literal">ORDER BY</code> или использовать <code class="literal">ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING</code>. Используя другие указания в определении рамки, можно получить и другие эффекты.</p><div class="note"><h3 class="title">Примечание</h3><p>В стандарте SQL определены параметры <code class="literal">RESPECT NULLS</code> или <code class="literal">IGNORE NULLS</code> для функций <code class="function">lead</code>, <code class="function">lag</code>, <code class="function">first_value</code>, <code class="function">last_value</code> и <code class="function">nth_value</code>. В <span class="productname">PostgreSQL</span> такие параметры не реализованы: эти функции ведут себя так, как положено в стандарте по умолчанию (или с подразумеваемым параметром <code class="literal">RESPECT NULLS</code>). Также функция <code class="function">nth_value</code> не поддерживает предусмотренные стандартом параметры <code class="literal">FROM FIRST</code> и <code class="literal">FROM LAST</code>: реализовано только поведение по умолчанию (с подразумеваемым параметром <code class="literal">FROM FIRST</code>). (Получить эффект параметра <code class="literal">FROM LAST</code> можно, изменив порядок <code class="literal">ORDER BY</code> на обратный.)</p></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="functions-aggregate.html" title="9.21. Агрегатные функции">Пред.</a> </td><td width="20%" align="center"><a accesskey="u" href="functions.html" title="Глава 9. Функции и операторы">Наверх</a></td><td width="40%" align="right"> <a accesskey="n" href="functions-subquery.html" title="9.23. Выражения подзапросов">След.</a></td></tr><tr><td width="40%" align="left" valign="top">9.21. Агрегатные функции </td><td width="20%" align="center"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="40%" align="right" valign="top"> 9.23. Выражения подзапросов</td></tr></table></div></body></html>