<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>38.7. Категории изменчивости функций</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@lists.postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets Vsnapshot" /><link rel="prev" href="xfunc-overload.html" title="38.6. Перегрузка функций" /><link rel="next" href="xfunc-pl.html" title="38.8. Функции на процедурных языках" /></head><body id="docContent" class="container-fluid col-10"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="5" align="center">38.7. Категории изменчивости функций</th></tr><tr><td width="10%" align="left"><a accesskey="p" href="xfunc-overload.html" title="38.6. Перегрузка функций">Пред.</a> </td><td width="10%" align="left"><a accesskey="u" href="extend.html" title="Глава 38. Расширение SQL">Наверх</a></td><th width="60%" align="center">Глава 38. Расширение <acronym class="acronym">SQL</acronym></th><td width="10%" align="right"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="10%" align="right"> <a accesskey="n" href="xfunc-pl.html" title="38.8. Функции на процедурных языках">След.</a></td></tr></table><hr /></div><div class="sect1" id="XFUNC-VOLATILITY"><div class="titlepage"><div><div><h2 class="title" style="clear: both">38.7. Категории изменчивости функций <a href="#XFUNC-VOLATILITY" class="id_link">#</a></h2></div></div></div><a id="id-1.8.3.10.2" class="indexterm"></a><a id="id-1.8.3.10.3" class="indexterm"></a><a id="id-1.8.3.10.4" class="indexterm"></a><a id="id-1.8.3.10.5" class="indexterm"></a><p>Для каждой функции определяется характеристика <em class="firstterm">изменчивости</em>, с возможными вариантами: <code class="literal">VOLATILE</code>, <code class="literal">STABLE</code> и <code class="literal">IMMUTABLE</code>. Если эта характеристика не задаётся явно в команде <a class="link" href="sql-createfunction.html" title="CREATE FUNCTION"><code class="command">CREATE FUNCTION</code></a>, по умолчанию подразумевается <code class="literal">VOLATILE</code>. Категория изменчивости представляет собой обещание некоторого поведения функции для оптимизатора: </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Изменчивая функция (<code class="literal">VOLATILE</code>) может делать всё, что угодно, в том числе, модифицировать базу данных. Она может возвращать различные результаты при нескольких вызовах с одинаковыми аргументами. Оптимизатор не делает никаких предположений о поведении таких функций. В запросе, использующем изменчивую функцию, она будет вычисляться заново для каждой строки, когда потребуется её результат.</p></li><li class="listitem"><p>Стабильная функция (<code class="literal">STABLE</code>) не может модифицировать базу данных и гарантированно возвращает одинаковый результат, получая одинаковые аргументы, для всех строк в одном операторе. Эта характеристика позволяет оптимизатору заменить множество вызовов этой функции одним. В частности, выражение, содержащее такую функцию, можно безопасно использовать в условии поиска по индексу. (Так как при поиске по индексу целевое значение вычисляется только один раз, а не для каждой строки, использовать функцию с характеристикой <code class="literal">VOLATILE</code> в условии поиска по индексу нельзя.)</p></li><li class="listitem"><p>Постоянная функция (<code class="literal">IMMUTABLE</code>) не может модифицировать базу данных и гарантированно всегда возвращает одинаковые результаты для одних и тех же аргументов. Эта характеристика позволяет оптимизатору предварительно вычислить функцию, когда она вызывается в запросе с постоянными аргументами. Например, запрос вида <code class="literal">SELECT ... WHERE x = 2 + 2</code> можно упростить до <code class="literal">SELECT ... WHERE x = 4</code>, так как нижележащая функция оператора сложения помечена как <code class="literal">IMMUTABLE</code>.</p></li></ul></div><p>Для наилучших результатов оптимизации, функции следует назначать самую строгую характеристику изменчивости, которой она соответствует.</p><p>Любая функция с побочными эффектами <span class="emphasis"><em>должна</em></span> быть помечена как <code class="literal">VOLATILE</code>, чтобы обращения к ней не исключались при оптимизации. Даже если функция не имеет побочных эффектов, её нужно пометить как <code class="literal">VOLATILE</code>, если её значение может меняться при выполнении одного запроса; таковы функции <code class="literal">random()</code>, <code class="literal">currval()</code> и <code class="literal">timeofday()</code>.</p><p>Другой важный пример представляет семейство функций <code class="function">current_timestamp</code>, которые имеют характеристику <code class="literal">STABLE</code>, потому что их значения не меняются в рамках одной транзакции.</p><p>Характеристики <code class="literal">STABLE</code> и <code class="literal">IMMUTABLE</code> мало различаются, когда речь идёт о простых интерактивных запросах, которые планируются и сразу же выполняются; не имеет большого значения, будет ли функция выполнена однократно на этапе планирования или в начале выполнения. Существенное различие проявляется, когда план сохраняется и многократно используется позже. Если функция помечена как <code class="literal">IMMUTABLE</code>, тогда как на самом деле она не является постоянной, она может быть сведена к константе во время планирования, так что при последующих выполнениях плана вместо неё будет использоваться неактуальное значение. Это опасно при использовании подготовленных операторов или языков функций, кеширующих планы (например, <span class="application">PL/pgSQL</span>).</p><p>У функций, написанных на SQL или на любом другом стандартном процедурном языке, есть ещё одно важное свойство, определяемое характеристикой изменчивости, а именно видимость изменений, произведённых командой SQL, которая вызывает эту функцию. Функция <code class="literal">VOLATILE</code> будет видеть такие изменения, тогда как <code class="literal">STABLE</code> и <code class="literal">IMMUTABLE</code> — нет. Это поведение реализуется посредством снимков в MVCC (см. <a class="xref" href="mvcc.html" title="Глава 13. Управление конкурентным доступом">Главу 13</a>): <code class="literal">STABLE</code> и <code class="literal">IMMUTABLE</code> используют снимок, полученный в начале вызывающего запроса, тогда как функции <code class="literal">VOLATILE</code> получают свежий снимок в начале каждого запроса, который они выполняют.</p><div class="note"><h3 class="title">Примечание</h3><p>Функции, написанные на C, могут работать со снимками как угодно, но обычно лучше сделать так, чтобы они действовали аналогично.</p></div><p>Вследствие такой организации работы со снимками, функцию, содержащую только команды <code class="command">SELECT</code>, можно безопасно пометить как <code class="literal">STABLE</code>, даже если она выбирает данные из таблиц, которые могут быть изменены параллельными запросами. <span class="productname">PostgreSQL</span> выполнит все команды в функции <code class="literal">STABLE</code> со снимком, полученным для вызывающего запроса, так что они будут видеть одно представление базы данных на протяжении всего запроса.</p><p>То же самое поведение со снимками распространяется на команды <code class="command">SELECT</code> в функциях <code class="literal">IMMUTABLE</code>. Вообще в функциях <code class="literal">IMMUTABLE</code> обычно неразумно выбирать данные из таблиц, так как «постоянство» функции будет нарушено, если содержимое таблиц изменится. Однако <span class="productname">PostgreSQL</span> не принуждает вас явно отказаться от этого.</p><p>Одна из распространённых ошибок — помечать функцию как <code class="literal">IMMUTABLE</code>, при том, что её результаты зависят от параметра конфигурации. Например, функция, работающая с временем, может выдавать результаты, зависящие от параметра <a class="xref" href="runtime-config-client.html#GUC-TIMEZONE">TimeZone</a>. Для надёжности такие функции следует помечать как <code class="literal">STABLE</code>.</p><div class="note"><h3 class="title">Примечание</h3><p><span class="productname">PostgreSQL</span> требует, чтобы функции <code class="literal">STABLE</code> и <code class="literal">IMMUTABLE</code> не содержали SQL-команд, кроме <code class="command">SELECT</code>, для предотвращения модификации данных. (Это не совсем непробиваемое ограничение, так как эти функции всё же могут вызывать функции <code class="literal">VOLATILE</code>, способные модифицировать базу данных. Если вы реализуете такую схему, вы увидите, что функция <code class="literal">STABLE</code> и <code class="literal">IMMUTABLE</code> не замечает изменений в базе данных, произведённых вызванной функцией, так как они не проявляются в её снимке данных.)</p></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="xfunc-overload.html" title="38.6. Перегрузка функций">Пред.</a> </td><td width="20%" align="center"><a accesskey="u" href="extend.html" title="Глава 38. Расширение SQL">Наверх</a></td><td width="40%" align="right"> <a accesskey="n" href="xfunc-pl.html" title="38.8. Функции на процедурных языках">След.</a></td></tr><tr><td width="40%" align="left" valign="top">38.6. Перегрузка функций </td><td width="20%" align="center"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="40%" align="right" valign="top"> 38.8. Функции на процедурных языках</td></tr></table></div></body></html>