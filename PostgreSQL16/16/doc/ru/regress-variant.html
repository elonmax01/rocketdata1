<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>33.3. Вариативные сравнительные файлы</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@lists.postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets Vsnapshot" /><link rel="prev" href="regress-evaluation.html" title="33.2. Оценка результатов тестирования" /><link rel="next" href="regress-tap.html" title="33.4. TAP-тесты" /></head><body id="docContent" class="container-fluid col-10"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="5" align="center">33.3. Вариативные сравнительные файлы</th></tr><tr><td width="10%" align="left"><a accesskey="p" href="regress-evaluation.html" title="33.2. Оценка результатов тестирования">Пред.</a> </td><td width="10%" align="left"><a accesskey="u" href="regress.html" title="Глава 33. Регрессионные тесты">Наверх</a></td><th width="60%" align="center">Глава 33. Регрессионные тесты</th><td width="10%" align="right"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="10%" align="right"> <a accesskey="n" href="regress-tap.html" title="33.4. TAP-тесты">След.</a></td></tr></table><hr /></div><div class="sect1" id="REGRESS-VARIANT"><div class="titlepage"><div><div><h2 class="title" style="clear: both">33.3. Вариативные сравнительные файлы <a href="#REGRESS-VARIANT" class="id_link">#</a></h2></div></div></div><p>Поскольку некоторые тесты по сути выдают результаты, зависящие от окружения, мы предлагаем несколько вариантов <span class="quote">«<span class="quote">ожидаемых</span>»</span> файлов результата. Каждый регрессионный тест может иметь несколько сравнительных файлов, показывающих возможные результаты на разных платформах. Существует два независимых механизма для определения, какой именно сравнительный файл будет выбран для каждого теста.</p><p>Первый механизм позволяет выбирать сравнительный файл для конкретной платформы. Есть файл сопоставления <code class="filename">src/test/regress/resultmap</code>, в котором определяется, какой сравнительный файл выбирать для каждой платформы. Чтобы устранить ложные <span class="quote">«<span class="quote">сбои</span>»</span> тестирования для конкретной платформы, для начала вы должны выбрать или создать вариант сравнительного файла, а потом добавить строку в файл <code class="filename">resultmap</code>.</p><p>Каждая строка в файле сопоставления выглядит как </p><pre class="synopsis">
testname:output:platformpattern=comparisonfilename
</pre><p> Имя теста (<code class="literal">testname</code>) здесь - просто название конкретного модуля регрессионного теста. Значение <code class="literal">output</code> показывает, вывод какого файла проверять. Для стандартного регрессионного теста это всегда <code class="literal">out</code>. Значение соответствует расширению выходного файла. <code class="literal">platformpattern</code> представляет собой шаблон в стиле Unix-утилиты <code class="command">expr</code> (т. е. регулярное выражение с неявным <code class="literal">^</code> якорем в начале). Этот шаблон сравнивается с именем платформы, которое выводится из <code class="command">config.guess</code>. <code class="literal">comparisonfilename</code> это имя сравнительного файла, который будет использован.</p><p>Например, в некоторых системах нет функции <code class="literal">strtof</code> или она работает некорректно, а с нашей заменой для неё возникают ошибки округления в регрессионном тесте <code class="filename">float4</code>. Поэтому мы предлагаем вариант сравниваемого файла <code class="filename">float4-misrounded-input.out</code>, который содержит результаты, ожидаемые в таких системах. Чтобы замаскировать сообщение о ложном <span class="quote">«<span class="quote">сбое</span>»</span> на платформах <span class="systemitem">Cygwin</span>, файл <code class="filename">resultmap</code> содержит: </p><pre class="programlisting">float4:out:.*-.*-cygwin.*=float4-misrounded-input.out</pre><p> Указанный файл будет выбран в системе, в которой результат <code class="command">config.guess</code> совпадёт с <code class="literal">.*-.*-cygwin.*</code>. В других строках <code class="filename">resultmap</code> могут выбираться варианты сравниваемых файлов для других платформ, если это требуется.</p><p>Второй механизм выбора более автоматический: он просто выбирает <span class="quote">«<span class="quote">подходящую пару</span>»</span> из нескольких предлагаемых сравнительных файлов. Драйвер скрипта регрессионного теста рассматривает стандартный сравнительный файл для теста, <code class="literal"><em class="replaceable"><code>имя_теста</code></em>.out</code>, вариативный файл <code class="literal"><em class="replaceable"><code>имя_теста</code></em>_<em class="replaceable"><code>цифра</code></em>.out</code> (где <em class="replaceable"><code>цифра</code></em> любое однозначное число от <code class="literal">0</code> до <code class="literal">9</code>). Если какой-нибудь из этих файлов полностью совпадает, тест считается пройденным. В противном случае для отчёта об ошибке выбирается файл с наименьшим различием. (Если в <code class="filename">resultmap</code> есть запись для конкретного теста, <em class="replaceable"><code>имя_теста</code></em> будет заменено именем, полученным из файла <code class="filename">resultmap</code>.)</p><p>Например, для теста <code class="literal">char</code> сравнительный файл <code class="filename">char.out</code> содержит результаты, ожидаемые для локалей <code class="literal">C</code> и <code class="literal">POSIX</code>, тогда как файл <code class="filename">char_1.out</code> содержит результаты, характерные для многих других локалей.</p><p>Механизм «лучшей пары» был разработан, чтобы справляться с результатами, зависящими от локали, но он может применяться в любой ситуации, когда сложно предсказать результаты, исходя только из названия платформы. Ограниченность этого метода проявляется лишь в том, что драйвер теста не может сказать, какой вариант правилен для данного окружения; просто выбирается вариант, который кажется наиболее подходящим. Поэтому безопаснее всего использовать этот метод только для вариативных результатов, которые вы хотели бы видеть одинаково надёжными для любого контекста.</p></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="regress-evaluation.html" title="33.2. Оценка результатов тестирования">Пред.</a> </td><td width="20%" align="center"><a accesskey="u" href="regress.html" title="Глава 33. Регрессионные тесты">Наверх</a></td><td width="40%" align="right"> <a accesskey="n" href="regress-tap.html" title="33.4. TAP-тесты">След.</a></td></tr><tr><td width="40%" align="left" valign="top">33.2. Оценка результатов тестирования </td><td width="20%" align="center"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="40%" align="right" valign="top"> 33.4. TAP-тесты</td></tr></table></div></body></html>