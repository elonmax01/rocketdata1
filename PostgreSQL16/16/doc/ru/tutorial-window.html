<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>3.5. Оконные функции</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@lists.postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets Vsnapshot" /><link rel="prev" href="tutorial-transactions.html" title="3.4. Транзакции" /><link rel="next" href="tutorial-inheritance.html" title="3.6. Наследование" /></head><body id="docContent" class="container-fluid col-10"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="5" align="center">3.5. Оконные функции</th></tr><tr><td width="10%" align="left"><a accesskey="p" href="tutorial-transactions.html" title="3.4. Транзакции">Пред.</a> </td><td width="10%" align="left"><a accesskey="u" href="tutorial-advanced.html" title="Глава 3. Расширенные возможности">Наверх</a></td><th width="60%" align="center">Глава 3. Расширенные возможности</th><td width="10%" align="right"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="10%" align="right"> <a accesskey="n" href="tutorial-inheritance.html" title="3.6. Наследование">След.</a></td></tr></table><hr /></div><div class="sect1" id="TUTORIAL-WINDOW"><div class="titlepage"><div><div><h2 class="title" style="clear: both">3.5. Оконные функции <a href="#TUTORIAL-WINDOW" class="id_link">#</a></h2></div></div></div><a id="id-1.4.5.6.2" class="indexterm"></a><p><em class="firstterm">Оконная функция</em> выполняет вычисления для набора строк, некоторым образом связанных с текущей строкой. Её действие можно сравнить с вычислением, производимым агрегатной функцией. Однако с оконными функциями строки не группируются в одну выходную строку, что имеет место с обычными, не оконными, агрегатными функциями. Вместо этого, эти строки остаются отдельными сущностями. Внутри же, оконная функция, как и агрегатная, может обращаться не только к текущей строке результата запроса.</p><p>Вот пример, показывающий, как сравнить зарплату каждого сотрудника со средней зарплатой его отдела: </p><pre class="programlisting">SELECT depname, empno, salary, avg(salary) OVER (PARTITION BY depname)
  FROM empsalary;</pre><p> </p><pre class="screen">
  depname  | empno | salary |          avg
-----------+-------+--------+-----------------------
 develop   |    11 |   5200 | 5020.0000000000000000
 develop   |     7 |   4200 | 5020.0000000000000000
 develop   |     9 |   4500 | 5020.0000000000000000
 develop   |     8 |   6000 | 5020.0000000000000000
 develop   |    10 |   5200 | 5020.0000000000000000
 personnel |     5 |   3500 | 3700.0000000000000000
 personnel |     2 |   3900 | 3700.0000000000000000
 sales     |     3 |   4800 | 4866.6666666666666667
 sales     |     1 |   5000 | 4866.6666666666666667
 sales     |     4 |   4800 | 4866.6666666666666667
(10 rows)
</pre><p> Первые три столбца извлекаются непосредственно из таблицы <code class="structname">empsalary</code>, при этом для каждой строки таблицы есть строка результата. В четвёртом столбце оказалось среднее значение, вычисленное по всем строкам, имеющим то же значение <code class="structfield">depname</code>, что и текущая строка. (Фактически среднее вычисляет та же обычная, не оконная функция <code class="function">avg</code>, но предложение <code class="literal">OVER</code> превращает её в оконную, так что её действие ограничивается рамками окон.)</p><p>Вызов оконной функции всегда содержит предложение <code class="literal">OVER</code>, следующее за названием и аргументами оконной функции. Это синтаксически отличает её от обычной, не оконной агрегатной функции. Предложение <code class="literal">OVER</code> определяет, как именно нужно разделить строки запроса для обработки оконной функцией. Предложение <code class="literal">PARTITION BY</code>, дополняющее <code class="literal">OVER</code>, разделяет строки по группам, или разделам, объединяя одинаковые значения выражений <code class="literal">PARTITION BY</code>. Оконная функция вычисляется по строкам, попадающим в один раздел с текущей строкой.</p><p>Вы можете также определять порядок, в котором строки будут обрабатываться оконными функциями, используя <code class="literal">ORDER BY</code> в <code class="literal">OVER</code>. (Порядок <code class="literal">ORDER BY</code> для окна может даже не совпадать с порядком, в котором выводятся строки.) Например: </p><pre class="programlisting">SELECT depname, empno, salary,
       rank() OVER (PARTITION BY depname ORDER BY salary DESC)
FROM empsalary;</pre><p> </p><pre class="screen">
  depname  | empno | salary | rank
-----------+-------+--------+------
 develop   |     8 |   6000 |    1
 develop   |    10 |   5200 |    2
 develop   |    11 |   5200 |    2
 develop   |     9 |   4500 |    4
 develop   |     7 |   4200 |    5
 personnel |     2 |   3900 |    1
 personnel |     5 |   3500 |    2
 sales     |     1 |   5000 |    1
 sales     |     4 |   4800 |    2
 sales     |     3 |   4800 |    2
(10 rows)
</pre><p> Как показано здесь, функция <code class="function">rank</code> выдаёт порядковый номер для каждого уникального значения в разделе текущей строки, по которому выполняет сортировку предложение <code class="literal">ORDER BY</code>. У функции <code class="function">rank</code> нет параметров, так как её поведение полностью определяется предложением <code class="literal">OVER</code>.</p><p>Строки, обрабатываемые оконной функцией, представляют собой <span class="quote">«<span class="quote">виртуальные таблицы</span>»</span>, созданные из предложения <code class="literal">FROM</code> и затем прошедшие через фильтрацию и группировку <code class="literal">WHERE</code> и <code class="literal">GROUP BY</code> и, возможно, условие <code class="literal">HAVING</code>. Например, строка, отфильтрованная из-за нарушения условия <code class="literal">WHERE</code>, не будет видна для оконных функций. Запрос может содержать несколько оконных функций, разделяющих данные по-разному с применением разных предложений <code class="literal">OVER</code>, но все они будут обрабатывать один и тот же набор строк этой виртуальной таблицы.</p><p>Мы уже видели, что <code class="literal">ORDER BY</code> можно опустить, если порядок строк не важен. Также возможно опустить <code class="literal">PARTITION BY</code>, в этом случае образуется один раздел, содержащий все строки.</p><p>Есть ещё одно важное понятие, связанное с оконными функциями: для каждой строки существует набор строк в её разделе, называемый <em class="firstterm">рамкой окна</em>. Некоторые оконные функции обрабатывают только строки рамки окна, а не всего раздела. По умолчанию с указанием <code class="literal">ORDER BY</code> рамка состоит из всех строк от начала раздела до текущей строки и строк, равных текущей по значению выражения <code class="literal">ORDER BY</code>. Без <code class="literal">ORDER BY</code> рамка по умолчанию состоит из всех строк раздела. <a href="#ftn.id-1.4.5.6.9.5" class="footnote"><sup class="footnote" id="id-1.4.5.6.9.5">[5]</sup></a> Посмотрите на пример использования <code class="function">sum</code>:</p><pre class="programlisting">SELECT salary, sum(salary) OVER () FROM empsalary;</pre><pre class="screen"> salary |  sum
--------+-------
   5200 | 47100
   5000 | 47100
   3500 | 47100
   4800 | 47100
   3900 | 47100
   4200 | 47100
   4500 | 47100
   4800 | 47100
   6000 | 47100
   5200 | 47100
(10 rows)</pre><p>Так как в этом примере нет указания <code class="literal">ORDER BY</code> в предложении <code class="literal">OVER</code>, рамка окна содержит все строки раздела, а он, в свою очередь, без предложения <code class="literal">PARTITION BY</code> включает все строки таблицы; другими словами, сумма вычисляется по всей таблице и мы получаем один результат для каждой строки результата. Но если мы добавим <code class="literal">ORDER BY</code>, мы получим совсем другие результаты:</p><pre class="programlisting">SELECT salary, sum(salary) OVER (ORDER BY salary) FROM empsalary;</pre><pre class="screen"> salary |  sum
--------+-------
   3500 |  3500
   3900 |  7400
   4200 | 11600
   4500 | 16100
   4800 | 25700
   4800 | 25700
   5000 | 30700
   5200 | 41100
   5200 | 41100
   6000 | 47100
(10 rows)</pre><p>Здесь в сумме накапливаются зарплаты от первой (самой низкой) до текущей, включая повторяющиеся текущие значения (обратите внимание на результат в строках с одинаковой зарплатой).</p><p>Оконные функции разрешается использовать в запросе только в списке <code class="literal">SELECT</code> и предложении <code class="literal">ORDER BY</code>. Во всех остальных предложениях, включая <code class="literal">GROUP BY</code>, <code class="literal">HAVING</code> и <code class="literal">WHERE</code>, они запрещены. Это объясняется тем, что логически они выполняются после этих предложений, а также после не оконных агрегатных функций, и значит агрегатную функцию можно вызывать в аргументах оконной, но не наоборот.</p><p>Если вам нужно отфильтровать или сгруппировать строки после вычисления оконных функций, вы можете использовать вложенный запрос. Например: </p><pre class="programlisting">SELECT depname, empno, salary, enroll_date
FROM
  (SELECT depname, empno, salary, enroll_date,
    rank() OVER (PARTITION BY depname ORDER BY salary DESC, empno) AS pos
   FROM empsalary
  ) AS ss
WHERE pos &lt; 3;</pre><p> Данный запрос покажет только те строки внутреннего запроса, у которых <code class="literal">rank</code> (порядковый номер) меньше 3.</p><p>Когда в запросе вычисляются несколько оконных функций для одинаково определённых окон, конечно можно написать для каждой из них отдельное предложение <code class="literal">OVER</code>, но при этом оно будет дублироваться, что неизбежно будет провоцировать ошибки. Поэтому лучше определение окна выделить в предложение <code class="literal">WINDOW</code>, а затем ссылаться на него в <code class="literal">OVER</code>. Например: </p><pre class="programlisting">SELECT sum(salary) OVER w, avg(salary) OVER w
  FROM empsalary
  WINDOW w AS (PARTITION BY depname ORDER BY salary DESC);</pre><p>Подробнее об оконных функциях можно узнать в <a class="xref" href="sql-expressions.html#SYNTAX-WINDOW-FUNCTIONS" title="4.2.8. Вызовы оконных функций">Подразделе 4.2.8</a>, <a class="xref" href="functions-window.html" title="9.22. Оконные функции">Разделе 9.22</a>, <a class="xref" href="queries-table-expressions.html#QUERIES-WINDOW" title="7.2.5. Обработка оконных функций">Подразделе 7.2.5</a> и в справке <a class="xref" href="sql-select.html" title="SELECT"><span class="refentrytitle">SELECT</span></a>.</p><div class="footnotes"><br /><hr style="width:100; text-align:left;margin-left: 0" /><div id="ftn.id-1.4.5.6.9.5" class="footnote"><p><a href="#id-1.4.5.6.9.5" class="para"><sup class="para">[5] </sup></a>Рамки окна можно определять и другими способами, но в этом введении они не рассматриваются. Узнать о них подробнее вы можете в <a class="xref" href="sql-expressions.html#SYNTAX-WINDOW-FUNCTIONS" title="4.2.8. Вызовы оконных функций">Подразделе 4.2.8</a>.</p></div></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="tutorial-transactions.html" title="3.4. Транзакции">Пред.</a> </td><td width="20%" align="center"><a accesskey="u" href="tutorial-advanced.html" title="Глава 3. Расширенные возможности">Наверх</a></td><td width="40%" align="right"> <a accesskey="n" href="tutorial-inheritance.html" title="3.6. Наследование">След.</a></td></tr><tr><td width="40%" align="left" valign="top">3.4. Транзакции </td><td width="20%" align="center"><a accesskey="h" href="index.html" title="Документация к PostgreSQL 16.3">Начало</a></td><td width="40%" align="right" valign="top"> 3.6. Наследование</td></tr></table></div></body></html>